<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Getting Started - Rails Dokümantasyonu - Türkçe</title>
    <link rel="stylesheet" href="/assets/css/rails.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">

    <link rel="icon" type="image/svg" href="/assets/img/logo_rails-circle.svg">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo">
                    <a href="/rails/">
                        <img src="/assets/img/logo_rails-circle.svg" alt="Rails Logo" class="logo-image">
                    </a>
                </h1>
                <nav class="nav">
                    <a href="/">Ana Sayfa</a>
                    <!-- <a href="https://dilankaya127.github.io">Portföy</a> -->
                    <a href="https://github.com/dilankaya127/rails-tr-TR">GitHub</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="guide-container">
  <button id="toc-toggle" class="toc-toggle">☰ İçindekiler</button>

  <aside class="guide-sidebar">
    <div class="guide-toc">
      <!-- <h3>İçindekiler</h3> -->
      <div id="toc"></div>
      <button class="toc-close" aria-label="İçindekileri Kapat">✕</button>
    </div>

    <!-- <div class="guide-nav">
            <h3>Diğer(Tüm) Kılavuzlar</h3>
            <ul>
                <li><a href="/rails/guides/tr/getting_started">Rails ile Başlarken</a></li>
                <li><a href="/rails/guides/en/active_record_basics">Active Record Temelleri</a></li>
                <li><a href="/rails/guides//en/action_controller_overview">Action Controller</a></li>
                <li><a href="/rails/guides/tr/action_cable_overview">Action Cable</a></li>
            </ul>
        </div> -->
  </aside>

  <article class="guide-content">
    <!-- <header class="guide-header">
            <h1>Getting Started</h1>
            
        </header> -->

    <div class="guide-body"><p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1 id="getting-started-with-rails">Getting Started with Rails</h1>

<p>This guide covers getting up and running with Ruby on Rails.</p>

<p>After reading this guide, you will know:</p>

<ul>
  <li>How to install Rails, create a new Rails application, and connect your
application to a database.</li>
  <li>The general layout of a Rails application.</li>
  <li>The basic principles of MVC (Model, View, Controller) and RESTful design.</li>
  <li>How to quickly generate the starting pieces of a Rails application.</li>
  <li>How to deploy your app to production using Kamal.</li>
</ul>

<hr />

<h2 id="introduction">Introduction</h2>

<p>Welcome to Ruby on Rails! In this guide, we’ll walk through the core concepts of
building web applications with Rails. You don’t need any experience with Rails
to follow along with this guide.</p>

<p>Rails is a web framework built for the Ruby programming language. Rails takes
advantage of many features of Ruby so we <strong>strongly</strong> recommend learning the
basics of Ruby so that you understand some of the basic terms and vocabulary you
will see in this tutorial.</p>

<ul>
  <li><a href="https://www.ruby-lang.org/en/documentation/">Official Ruby Programming Language website</a></li>
  <li><a href="https://github.com/EbookFoundation/free-programming-books/blob/main/books/free-programming-books-langs.md#ruby">List of Free Programming Books</a></li>
</ul>

<h2 id="rails-philosophy">Rails Philosophy</h2>

<p>Rails is a web application development framework written in the Ruby programming
language. It is designed to make programming web applications easier by making
assumptions about what every developer needs to get started. It allows you to
write less code while accomplishing more than many other languages and
frameworks. Experienced Rails developers also report that it makes web
application development more fun.</p>

<p>Rails is opinionated software. It makes the assumption that there is a “best”
way to do things, and it’s designed to encourage that way - and in some cases to
discourage alternatives. If you learn “The Rails Way” you’ll probably discover a
tremendous increase in productivity. If you persist in bringing old habits from
other languages to your Rails development, and trying to use patterns you
learned elsewhere, you may have a less happy experience.</p>

<p>The Rails philosophy includes two major guiding principles:</p>

<ul>
  <li><strong>Don’t Repeat Yourself:</strong> DRY is a principle of software development which
states that “Every piece of knowledge must have a single, unambiguous,
authoritative representation within a system”. By not writing the same
information over and over again, our code is more maintainable, more
extensible, and less buggy.</li>
  <li><strong>Convention Over Configuration:</strong> Rails has opinions about the best way to do
many things in a web application, and defaults to this set of conventions,
rather than require that you define them yourself through endless
configuration files.</li>
</ul>

<h2 id="creating-a-new-rails-app">Creating a New Rails App</h2>

<p>We’re going to build a project called <code class="language-plaintext highlighter-rouge">store</code> - a simple e-commerce app that
demonstrates several of Rails’ built-in features.</p>

<p>TIP: Any commands prefaced with a dollar sign <code class="language-plaintext highlighter-rouge">$</code> should be run in the terminal.</p>

<h3 id="prerequisites">Prerequisites</h3>

<p>For this project, you will need:</p>

<ul>
  <li>Ruby 3.2 or newer</li>
  <li>Rails 8.1.0 or newer</li>
  <li>A code editor</li>
</ul>

<p>Follow the <a href="install_ruby_on_rails.html">Install Ruby on Rails Guide</a> if you need
to install Ruby and/or Rails.</p>

<p>Let’s verify the correct version of Rails is installed. To display the current
version, open a terminal and run the following. You should see a version number
printed out:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails <span class="nt">--version</span>
Rails 8.1.0
</code></pre></div></div>

<p>The version shown should be Rails 8.1.0 or higher.</p>

<h3 id="creating-your-first-rails-app">Creating Your First Rails App</h3>

<p>Rails comes with several commands to make life easier. Run <code class="language-plaintext highlighter-rouge">rails --help</code> to see
all of the commands.</p>

<p><code class="language-plaintext highlighter-rouge">rails new</code> generates the foundation of a fresh Rails application for you, so
let’s start there.</p>

<p>To create our <code class="language-plaintext highlighter-rouge">store</code> application, run the following command in your terminal:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rails new store
</code></pre></div></div>

<p>NOTE: You can customize the application Rails generates by using flags. To see
these options, run <code class="language-plaintext highlighter-rouge">rails new --help</code>.</p>

<p>After your new application is created, switch to its directory:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cd </span>store
</code></pre></div></div>

<h3 id="directory-structure">Directory Structure</h3>

<p>Let’s take a quick glance at the files and directories that are included in a
new Rails application. You can open this folder in your code editor or run
<code class="language-plaintext highlighter-rouge">ls -la</code> in your terminal to see the files and directories.</p>

<table>
  <thead>
    <tr>
      <th>File/Folder</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>app/</td>
      <td>Contains the controllers, models, views, helpers, mailers, jobs, and assets for your application. <strong>You’ll focus mostly on this folder for the remainder of this guide.</strong></td>
    </tr>
    <tr>
      <td>bin/</td>
      <td>Contains the <code class="language-plaintext highlighter-rouge">rails</code> script that starts your app and can contain other scripts you use to set up, update, deploy, or run your application.</td>
    </tr>
    <tr>
      <td>config/</td>
      <td>Contains configuration for your application’s routes, database, and more. This is covered in more detail in <a href="configuring.html">Configuring Rails Applications</a>.</td>
    </tr>
    <tr>
      <td>config.ru</td>
      <td><a href="https://rack.github.io">Rack</a> configuration for Rack-based servers used to start the application.</td>
    </tr>
    <tr>
      <td>db/</td>
      <td>Contains your current database schema, as well as the database migrations.</td>
    </tr>
    <tr>
      <td>Dockerfile</td>
      <td>Configuration file for Docker.</td>
    </tr>
    <tr>
      <td>Gemfile<br />Gemfile.lock</td>
      <td>These files allow you to specify what gem dependencies are needed for your Rails application. These files are used by the <a href="https://bundler.io">Bundler</a> gem.</td>
    </tr>
    <tr>
      <td>lib/</td>
      <td>Extended modules for your application.</td>
    </tr>
    <tr>
      <td>log/</td>
      <td>Application log files.</td>
    </tr>
    <tr>
      <td>public/</td>
      <td>Contains static files and compiled assets. When your app is running, this directory will be exposed as-is.</td>
    </tr>
    <tr>
      <td>Rakefile</td>
      <td>This file locates and loads tasks that can be run from the command line. The task definitions are defined throughout the components of Rails. Rather than changing <code class="language-plaintext highlighter-rouge">Rakefile</code>, you should add your own tasks by adding files to the <code class="language-plaintext highlighter-rouge">lib/tasks</code> directory of your application.</td>
    </tr>
    <tr>
      <td>README.md</td>
      <td>This is a brief instruction manual for your application. You should edit this file to tell others what your application does, how to set it up, and so on.</td>
    </tr>
    <tr>
      <td>script/</td>
      <td>Contains one-off or general purpose <a href="https://github.com/rails/rails/blob/main/railties/lib/rails/generators/rails/script/USAGE">scripts</a> and <a href="https://github.com/rails/rails/blob/main/railties/lib/rails/generators/rails/benchmark/USAGE">benchmarks</a>.</td>
    </tr>
    <tr>
      <td>storage/</td>
      <td>Contains SQLite databases and Active Storage files for Disk Service. This is covered in <a href="active_storage_overview.html">Active Storage Overview</a>.</td>
    </tr>
    <tr>
      <td>test/</td>
      <td>Unit tests, fixtures, and other test apparatus. These are covered in <a href="testing.html">Testing Rails Applications</a>.</td>
    </tr>
    <tr>
      <td>tmp/</td>
      <td>Temporary files (like cache and pid files).</td>
    </tr>
    <tr>
      <td>vendor/</td>
      <td>A place for all third-party code. In a typical Rails application this includes vendored gems.</td>
    </tr>
    <tr>
      <td>.dockerignore</td>
      <td>This file tells Docker which files it should not copy into the container.</td>
    </tr>
    <tr>
      <td>.gitattributes</td>
      <td>This file defines metadata for specific paths in a Git repository. This metadata can be used by Git and other tools to enhance their behavior. See the <a href="https://git-scm.com/docs/gitattributes">gitattributes documentation</a> for more information.</td>
    </tr>
    <tr>
      <td>.git/</td>
      <td>Contains Git repository files.</td>
    </tr>
    <tr>
      <td>.github/</td>
      <td>Contains GitHub specific files.</td>
    </tr>
    <tr>
      <td>.gitignore</td>
      <td>This file tells Git which files (or patterns) it should ignore. See <a href="https://help.github.com/articles/ignoring-files">GitHub - Ignoring files</a> for more information about ignoring files.</td>
    </tr>
    <tr>
      <td>.kamal/</td>
      <td>Contains Kamal secrets and deployment hooks.</td>
    </tr>
    <tr>
      <td>.rubocop.yml</td>
      <td>This file contains the configuration for RuboCop.</td>
    </tr>
    <tr>
      <td>.ruby-version</td>
      <td>This file contains the default Ruby version.</td>
    </tr>
  </tbody>
</table>

<h3 id="model-view-controller-basics">Model-View-Controller Basics</h3>

<p>Rails code is organized using the Model-View-Controller (MVC) architecture. With
MVC, we have three main concepts where the majority of our code lives:</p>

<ul>
  <li>Model - Manages the data in your application. Typically, your database tables.</li>
  <li>View - Handles rendering responses in different formats like HTML, JSON, XML,
etc.</li>
  <li>Controller - Handles user interactions and the logic for each request.</li>
</ul>

<picture class="flowdiagram">
  <source srcset="images/getting_started/mvc_architecture_dark.jpg" media="(prefers-color-scheme:dark)" />
  <img src="images/getting_started/mvc_architecture_light.jpg" />
</picture>

<p>Now that we’ve got a basic understanding of MVC, let’s see how it’s used in
Rails.</p>

<h2 id="hello-rails">Hello, Rails!</h2>

<p>Let’s start easy by creating our application’s database and boot up our Rails server for the first time.</p>

<p>In your terminal, run the following commands in the <code class="language-plaintext highlighter-rouge">store</code> directory:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails db:create
</code></pre></div></div>

<p>This will initially create the application’s database.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails server
</code></pre></div></div>

<p>NOTE: When we run commands inside an application directory, we should use
<code class="language-plaintext highlighter-rouge">bin/rails</code>. This makes sure the application’s version of Rails is used.</p>

<p>This will start up a web server called Puma that will serve static files and
your Rails application:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">=&gt;</span> Booting Puma
<span class="o">=&gt;</span> Rails 8.1.0 application starting <span class="k">in </span>development
<span class="o">=&gt;</span> Run <span class="sb">`</span>bin/rails server <span class="nt">--help</span><span class="sb">`</span> <span class="k">for </span>more startup options
Puma starting <span class="k">in </span>single mode...
<span class="k">*</span> Puma version: 6.4.3 <span class="o">(</span>ruby 3.3.5-p100<span class="o">)</span> <span class="o">(</span><span class="s2">"The Eagle of Durango"</span><span class="o">)</span>
<span class="k">*</span>  Min threads: 3
<span class="k">*</span>  Max threads: 3
<span class="k">*</span>  Environment: development
<span class="k">*</span>          PID: 12345
<span class="k">*</span> Listening on http://127.0.0.1:3000
<span class="k">*</span> Listening on http://[::1]:3000
Use Ctrl-C to stop
</code></pre></div></div>

<p>To see your Rails application, open http://localhost:3000 in your browser. You
will see the default Rails welcome page:</p>

<p><img src="images/getting_started/rails_welcome.png" alt="Rails welcome page" /></p>

<p>It works!</p>

<p>This page is the <em>smoke test</em> for a new Rails application, ensuring that
everything is working behind the scenes to serve a page.</p>

<p>To stop the Rails server anytime, press <code class="language-plaintext highlighter-rouge">Ctrl-C</code> in your terminal.</p>

<h3 id="autoloading-in-development">Autoloading in Development</h3>

<p>Developer happiness is a cornerstone philosophy of Rails and one way of
achieving this is with automatic code reloading in development.</p>

<p>Once you start the Rails server, new files or changes to existing files are
detected and automatically loaded or reloaded as necessary. This allows you to
focus on building without having to restart your Rails server after every
change.</p>

<p>You may also notice that Rails applications rarely use <code class="language-plaintext highlighter-rouge">require</code> statements like
you may have seen in other programming languages. Rails uses naming conventions
to require files automatically so you can focus on writing your application
code.</p>

<p>See
<a href="autoloading_and_reloading_constants.html">Autoloading and Reloading Constants</a>
for more details.</p>

<h2 id="creating-a-database-model">Creating a Database Model</h2>

<p>Active Record is a feature of Rails that maps relational databases to Ruby code.
It helps generate the structured query language (SQL) for interacting with the
database like creating, updating, and deleting tables and records. Our
application is using SQLite which is the default for Rails.</p>

<p>Let’s start by adding a database table to our Rails application to add products
to our simple e-commerce store.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate model Product name:string
</code></pre></div></div>

<p>This command tells Rails to generate a model named <code class="language-plaintext highlighter-rouge">Product</code> which has a <code class="language-plaintext highlighter-rouge">name</code>
column and type of <code class="language-plaintext highlighter-rouge">string</code> in the database. Later on, you’ll learn how to add
other column types.</p>

<p>You’ll see the following in your terminal:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      invoke  active_record
      create    db/migrate/20240426151900_create_products.rb
      create    app/models/product.rb
      invoke    test_unit
      create      <span class="nb">test</span>/models/product_test.rb
      create      <span class="nb">test</span>/fixtures/products.yml
</code></pre></div></div>

<p>This command does several things. It creates…</p>

<ol>
  <li>A migration in the <code class="language-plaintext highlighter-rouge">db/migrate</code> folder.</li>
  <li>An Active Record model in <code class="language-plaintext highlighter-rouge">app/models/product.rb</code>.</li>
  <li>Tests and test fixtures for this model.</li>
</ol>

<p>NOTE: Model names are <em>singular</em>, because an instantiated model represents a
single record in the database (i.e., You are creating a <em>product</em> to add to the
database.).</p>

<h3 id="database-migrations">Database Migrations</h3>

<p>A <em>migration</em> is a set of changes we want to make to our database.</p>

<p>By defining migrations, we’re telling Rails how to change the database to add,
change, or remove tables, columns or other attributes of our database. This
helps keep track of changes we make in development (only on our computer) so
they can be deployed to production (live, online!) safely.</p>

<p>In your code editor, open the migration Rails created for us so we can see what
the migration does. This is located in
<code class="language-plaintext highlighter-rouge">db/migrate/&lt;timestamp&gt;_create_products.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This migration is telling Rails to create a new database table named <code class="language-plaintext highlighter-rouge">products</code>.</p>

<p>NOTE: In contrast to the model above, Rails makes the database table names
<em>plural</em>, because the database holds all of the instances of each model (i.e.,
You are creating a database of <em>products</em>).</p>

<p>The <code class="language-plaintext highlighter-rouge">create_table</code> block then defines which columns and types should be defined
in this database table.</p>

<p><code class="language-plaintext highlighter-rouge">t.string :name</code> tells Rails to create a column in the <code class="language-plaintext highlighter-rouge">products</code> table called
<code class="language-plaintext highlighter-rouge">name</code> and set the type as <code class="language-plaintext highlighter-rouge">string</code>.</p>

<p><code class="language-plaintext highlighter-rouge">t.timestamps</code> is a shortcut for defining two columns on your models:
<code class="language-plaintext highlighter-rouge">created_at:datetime</code> and <code class="language-plaintext highlighter-rouge">updated_at:datetime</code>. You’ll see these columns on
most Active Record models in Rails and they are automatically set by Active
Record when creating or updating records.</p>

<h3 id="running-migrations">Running Migrations</h3>

<p>Now that you have defined what changes to make to the database, use the
following command to run the migrations:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails db:migrate
</code></pre></div></div>

<p>This command checks for any new migrations and applies them to your database.
Its output looks like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">==</span> 20240426151900 CreateProducts: migrating <span class="o">===================================</span>
<span class="nt">--</span> create_table<span class="o">(</span>:products<span class="o">)</span>
   -&gt; 0.0030s
<span class="o">==</span> 20240426151900 CreateProducts: migrated <span class="o">(</span>0.0031s<span class="o">)</span> <span class="o">==========================</span>
</code></pre></div></div>

<p>TIP: If you make a mistake, you can run <code class="language-plaintext highlighter-rouge">bin/rails db:rollback</code> to undo the last
migration.</p>

<h2 id="rails-console">Rails Console</h2>

<p>Now that we have created our products table, we can interact with it in Rails.
Let’s try it out.</p>

<p>For this, we’re going to use a Rails feature called the <em>console</em>. The console
is a helpful, interactive tool for testing our code in our Rails application.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails console
</code></pre></div></div>

<p>You will be presented with a prompt like the following:</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Loading development environment (Rails 8.1.0)
store(dev)&gt;
</span></code></pre></div></div>

<p>Here we can type code that will be executed when we hit <code class="language-plaintext highlighter-rouge">Enter</code>. Let’s try
printing out the Rails version:</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; Rails.version
</span><span class="p">=&gt;</span> <span class="s2">"8.1.0"</span>
</code></pre></div></div>

<p>It works!</p>

<h2 id="active-record-model-basics">Active Record Model Basics</h2>

<p>When we ran the Rails model generator to create the <code class="language-plaintext highlighter-rouge">Product</code> model, it created
a file at <code class="language-plaintext highlighter-rouge">app/models/product.rb</code>. This file creates a class that uses Active
Record for interacting with our <code class="language-plaintext highlighter-rouge">products</code> database table.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You might be surprised that there is no code in this class. How does Rails know
what defines this model?</p>

<p>When the <code class="language-plaintext highlighter-rouge">Product</code> model is used, Rails will query the database table for the
column names and types and automatically generate code for these attributes.
Rails saves us from writing this boilerplate code and instead takes care of it
for us behind the scenes so we can focus on our application logic instead.</p>

<p>Let’s use the Rails console to see what columns Rails detects for the Product
model.</p>

<p>Run:</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; Product.column_names
</span></code></pre></div></div>

<p>And you should see:</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"id"</span><span class="p">,</span> <span class="s2">"name"</span><span class="p">,</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="s2">"updated_at"</span><span class="p">]</span>
</code></pre></div></div>

<p>Rails asked the database for column information above and used that information
to define attributes on the <code class="language-plaintext highlighter-rouge">Product</code> class dynamically so you don’t have to
manually define each of them. This is one example of how Rails makes development
a breeze.</p>

<h3 id="creating-records">Creating Records</h3>

<p>We can instantiate a new Product record with the following code:</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; product = Product.new(name: "T-Shirt")
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">Product</span><span class="p">:</span><span class="mh">0x000000012e616c30</span> <span class="ss">id: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"T-Shirt"</span><span class="p">,</span> <span class="ss">created_at: </span><span class="kp">nil</span><span class="p">,</span> <span class="ss">updated_at: </span><span class="kp">nil</span><span class="kt">&gt;</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">product</code> variable is an instance of <code class="language-plaintext highlighter-rouge">Product</code>. It has not been saved to the
database, and so does not have an ID, created_at, or updated_at timestamps.</p>

<p>We can call <code class="language-plaintext highlighter-rouge">save</code> to write the record to the database.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; product.save
  TRANSACTION (0.1ms)  BEGIN immediate TRANSACTION /*application='Store'*/
  Product Create (0.9ms)  INSERT INTO "products" ("name", "created_at", "updated_at") VALUES ('T-Shirt', '2024-11-09 16:35:01.117836', '2024-11-09 16:35:01.117836') RETURNING "id" /*application='Store'*/
  TRANSACTION (0.9ms)  COMMIT TRANSACTION /*application='Store'*/
</span><span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre></div></div>

<p>When <code class="language-plaintext highlighter-rouge">save</code> is called, Rails takes the attributes in memory and generates an
<code class="language-plaintext highlighter-rouge">INSERT</code> SQL query to insert this record into the database.</p>

<p>Rails also updates the object in memory with the database record <code class="language-plaintext highlighter-rouge">id</code> along with
the <code class="language-plaintext highlighter-rouge">created_at</code> and <code class="language-plaintext highlighter-rouge">updated_at</code> timestamps. We can see that by printing out
the <code class="language-plaintext highlighter-rouge">product</code> variable.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; product
</span><span class="gp">=&gt; #&lt;Product:0x00000001221f6260 id: 1, name: "T-Shirt", created_at: "2024-11-09 16:35:01.117836000 +0000", updated_at: "2024-11-09 16:35:01.117836000 +0000"&gt;</span><span class="w">
</span></code></pre></div></div>

<p>Similar to <code class="language-plaintext highlighter-rouge">save</code>, we can use <code class="language-plaintext highlighter-rouge">create</code> to instantiate and save an Active Record
object in a single call.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; Product.create(name: "Pants")
  TRANSACTION (0.1ms)  BEGIN immediate TRANSACTION /*application='Store'*/
  Product Create (0.4ms)  INSERT INTO "products" ("name", "created_at", "updated_at") VALUES ('Pants', '2024-11-09 16:36:01.856751', '2024-11-09 16:36:01.856751') RETURNING "id" /*application='Store'*/
  TRANSACTION (0.1ms)  COMMIT TRANSACTION /*application='Store'*/
</span><span class="gp">=&gt; #&lt;Product:0x0000000120485c80 id: 2, name: "Pants", created_at: "2024-11-09 16:36:01.856751000 +0000", updated_at: "2024-11-09 16:36:01.856751000 +0000"&gt;</span><span class="w">
</span></code></pre></div></div>

<h3 id="querying-records">Querying Records</h3>

<p>We can also look up records from the database using our Active Record model.</p>

<p>To find all the Product records in the database, we can use the <code class="language-plaintext highlighter-rouge">all</code> method.
This is a <em>class</em> method, which is why we can use it on Product (versus an
instance method that we would call on the product instance, like <code class="language-plaintext highlighter-rouge">save</code> above).</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; Product.all
  Product Load (0.1ms)  SELECT "products".* FROM "products" /* loading for pp */ LIMIT 11 /*application='Store'*/
</span><span class="gp">=&gt; [#&lt;Product:0x0000000121845158 id: 1, name: "T-Shirt", created_at: "2024-11-09 16:35:01.117836000 +0000", updated_at: "2024-11-09 16:35:01.117836000 +0000"&gt;</span><span class="p">,</span>
<span class="gp"> #&lt;Product:0x0000000121845018 id: 2, name: "Pants", created_at: "2024-11-09 16:36:01.856751000 +0000", updated_at: "2024-11-09 16:36:01.856751000 +0000"&gt;</span><span class="p">]</span>
</code></pre></div></div>

<p>This generates a <code class="language-plaintext highlighter-rouge">SELECT</code> SQL query to load all records from the <code class="language-plaintext highlighter-rouge">products</code>
table. Each record is automatically converted into an instance of our Product
Active Record model so we can easily work with them from Ruby.</p>

<p>TIP: The <code class="language-plaintext highlighter-rouge">all</code> method returns an <code class="language-plaintext highlighter-rouge">ActiveRecord::Relation</code> object which is an
Array-like collection of database records with features to filter, sort, and
execute other database operations.</p>

<h3 id="filtering--ordering-records">Filtering &amp; Ordering Records</h3>

<p>What if we want to filter the results from our database? We can use <code class="language-plaintext highlighter-rouge">where</code> to
filter records by a column.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; Product.where(name: "Pants")
  Product Load (1.5ms)  SELECT "products".* FROM "products" WHERE "products"."name" = 'Pants' /* loading for pp */ LIMIT 11 /*application='Store'*/
</span><span class="gp">=&gt; [#&lt;Product:0x000000012184d858 id: 2, name: "Pants", created_at: "2024-11-09 16:36:01.856751000 +0000", updated_at: "2024-11-09 16:36:01.856751000 +0000"&gt;</span><span class="p">]</span>
</code></pre></div></div>

<p>This generates a <code class="language-plaintext highlighter-rouge">SELECT</code> SQL query but also adds a <code class="language-plaintext highlighter-rouge">WHERE</code> clause to filter the
records that have a <code class="language-plaintext highlighter-rouge">name</code> matching <code class="language-plaintext highlighter-rouge">"Pants"</code>. This also returns an
<code class="language-plaintext highlighter-rouge">ActiveRecord::Relation</code> because multiple records may have the same name.</p>

<p>We can use <code class="language-plaintext highlighter-rouge">order(name: :asc)</code> to sort records by name in ascending alphabetical order.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; Product.order(name: :asc)
  Product Load (0.3ms)  SELECT "products".* FROM "products" /* loading for pp */ ORDER BY "products"."name" ASC LIMIT 11 /*application='Store'*/
</span><span class="gp">=&gt; [#&lt;Product:0x0000000120e02a88 id: 2, name: "Pants", created_at: "2024-11-09 16:36:01.856751000 +0000", updated_at: "2024-11-09 16:36:01.856751000 +0000"&gt;</span><span class="p">,</span>
<span class="gp"> #&lt;Product:0x0000000120e02948 id: 1, name: "T-Shirt", created_at: "2024-11-09 16:35:01.117836000 +0000", updated_at: "2024-11-09 16:35:01.117836000 +0000"&gt;</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="finding-records">Finding Records</h3>

<p>What if we want to find one specific record?</p>

<p>We can do this by using the <code class="language-plaintext highlighter-rouge">find</code> class method to look up a single record by
ID. Call the method and pass in the specific ID by using the following code:</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; Product.find(1)
  Product Load (0.2ms)  SELECT "products".* FROM "products" WHERE "products"."id" = 1 LIMIT 1 /*application='Store'*/
</span><span class="gp">=&gt; #&lt;Product:0x000000012054af08 id: 1, name: "T-Shirt", created_at: "2024-11-09 16:35:01.117836000 +0000", updated_at: "2024-11-09 16:35:01.117836000 +0000"&gt;</span><span class="w">
</span></code></pre></div></div>

<p>This generates a <code class="language-plaintext highlighter-rouge">SELECT</code> query but specifies a <code class="language-plaintext highlighter-rouge">WHERE</code> for the <code class="language-plaintext highlighter-rouge">id</code> column
matching the ID of <code class="language-plaintext highlighter-rouge">1</code> that was passed in. It also adds a <code class="language-plaintext highlighter-rouge">LIMIT</code> to only return
a single record.</p>

<p>This time, we get a <code class="language-plaintext highlighter-rouge">Product</code> instance instead of an <code class="language-plaintext highlighter-rouge">ActiveRecord::Relation</code>
since we’re only retrieving a single record from the database.</p>

<h3 id="updating-records">Updating Records</h3>

<p>Records can be updated in 2 ways: using <code class="language-plaintext highlighter-rouge">update</code> or assigning attributes and
calling <code class="language-plaintext highlighter-rouge">save</code>.</p>

<p>We can call <code class="language-plaintext highlighter-rouge">update</code> on a Product instance and pass in a Hash of new attributes
to save to the database. This will assign the attributes, run validations, and
save the changes to the database in one method call.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; product = Product.find(1)
store(dev)&gt; product.update(name: "Shoes")
  TRANSACTION (0.1ms)  BEGIN immediate TRANSACTION /*application='Store'*/
  Product Update (0.3ms)  UPDATE "products" SET "name" = 'Shoes', "updated_at" = '2024-11-09 22:38:19.638912' WHERE "products"."id" = 1 /*application='Store'*/
  TRANSACTION (0.4ms)  COMMIT TRANSACTION /*application='Store'*/
</span><span class="p">=&gt;</span> <span class="kp">true</span>
</code></pre></div></div>

<p>This updated the name of the “T-Shirt” product to “Shoes” in the database.
Confirm this by running <code class="language-plaintext highlighter-rouge">Product.all</code> again.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; Product.all
</span></code></pre></div></div>

<p>You will see two products: Shoes and Pants.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">  Product Load (0.3ms)  SELECT "products".* FROM "products" /* loading for pp */ LIMIT 11 /*application='Store'*/
</span><span class="p">=&gt;</span>
<span class="p">[</span><span class="kt">#&lt;</span><span class="no">Product</span><span class="p">:</span><span class="mh">0x000000012c0f7300</span>
  <span class="ss">id: </span><span class="mi">1</span><span class="p">,</span>
  <span class="ss">name: </span><span class="s2">"Shoes"</span><span class="p">,</span>
  <span class="ss">created_at: </span><span class="s2">"2024-12-02 20:29:56.303546000 +0000"</span><span class="p">,</span>
<span class="gp">  updated_at: "2024-12-02 20:30:14.127456000 +0000"&gt;</span><span class="p">,</span>
<span class="c"> #&lt;Product:0x000000012c0f71c0
</span><span class="go">  id: 2,
  name: "Pants",
  created_at: "2024-12-02 20:30:02.997261000 +0000",
</span><span class="gp">  updated_at: "2024-12-02 20:30:02.997261000 +0000"&gt;</span><span class="p">]</span>
</code></pre></div></div>

<p>Alternatively, we can assign attributes and call <code class="language-plaintext highlighter-rouge">save</code> when we’re ready to
validate and save changes to the database.</p>

<p>Let’s change the name “Shoes” back to “T-Shirt”.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; product = Product.find(1)
store(dev)&gt; product.name = "T-Shirt"
</span><span class="p">=&gt;</span> <span class="s2">"T-Shirt"</span>
<span class="n">store</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">product</span><span class="p">.</span><span class="nf">save</span>
  <span class="no">TRANSACTION</span> <span class="p">(</span><span class="mf">0.1</span><span class="n">ms</span><span class="p">)</span>  <span class="k">BEGIN</span> <span class="n">immediate</span> <span class="no">TRANSACTION</span> <span class="sr">/*application='Store'*/</span>
  <span class="no">Product</span> <span class="no">Update</span> <span class="p">(</span><span class="mf">0.2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">UPDATE</span> <span class="s2">"products"</span> <span class="no">SET</span> <span class="s2">"name"</span> <span class="o">=</span> <span class="s1">'T-Shirt'</span><span class="p">,</span> <span class="s2">"updated_at"</span> <span class="o">=</span> <span class="s1">'2024-11-09 22:39:09.693548'</span> <span class="no">WHERE</span> <span class="s2">"products"</span><span class="o">.</span><span class="s2">"id"</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/*</span><span class="n">application</span><span class="o">=</span><span class="s1">'Store'</span><span class="o">*</span><span class="sr">/
  TRANSACTION (0.0ms)  COMMIT TRANSACTION /</span><span class="o">*</span><span class="n">application</span><span class="o">=</span><span class="s1">'Store'</span><span class="o">*</span><span class="sr">/
=&gt; true
</span></code></pre></div></div>

<h3 id="deleting-records">Deleting Records</h3>

<p>The <code class="language-plaintext highlighter-rouge">destroy</code> method can be used to delete a record from the database.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; product.destroy
  TRANSACTION (0.1ms)  BEGIN immediate TRANSACTION /*application='Store'*/
  Product Destroy (0.4ms)  DELETE FROM "products" WHERE "products"."id" = 1 /*application='Store'*/
  TRANSACTION (0.1ms)  COMMIT TRANSACTION /*application='Store'*/
</span><span class="gp">=&gt; #&lt;Product:0x0000000125813d48 id: 1, name: "T-Shirt", created_at: "2024-11-09 22:39:38.498730000 +0000", updated_at: "2024-11-09 22:39:38.498730000 +0000"&gt;</span><span class="w">
</span></code></pre></div></div>

<p>This deleted the T-Shirt product from our database. We can confirm this with
<code class="language-plaintext highlighter-rouge">Product.all</code> to see that it only returns Pants.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; Product.all
  Product Load (1.9ms)  SELECT "products".* FROM "products" /* loading for pp */ LIMIT 11 /*application='Store'*/
</span><span class="p">=&gt;</span>
<span class="p">[</span><span class="kt">#&lt;</span><span class="no">Product</span><span class="p">:</span><span class="mh">0x000000012abde4c8</span>
  <span class="ss">id: </span><span class="mi">2</span><span class="p">,</span>
  <span class="ss">name: </span><span class="s2">"Pants"</span><span class="p">,</span>
  <span class="ss">created_at: </span><span class="s2">"2024-11-09 22:33:19.638912000 +0000"</span><span class="p">,</span>
<span class="gp">  updated_at: "2024-11-09 22:33:19.638912000 +0000"&gt;</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="validations">Validations</h3>

<p>Active Record provides <em>validations</em> which allows you to ensure data inserted
into the database adheres to certain rules.</p>

<p>Let’s add a <code class="language-plaintext highlighter-rouge">presence</code> validation to the Product model to ensure that all
products must have a <code class="language-plaintext highlighter-rouge">name</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You might remember that Rails automatically reloads changes during development.
However, if the console is running when you make updates to the code, you’ll
need to manually refresh it. So let’s do this now by running ‘reload!’.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; reload!
Reloading...
</span></code></pre></div></div>

<p>Let’s try to create a Product without a name in the Rails console.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; product = Product.new
store(dev)&gt; product.save
</span><span class="p">=&gt;</span> <span class="kp">false</span>
</code></pre></div></div>

<p>This time <code class="language-plaintext highlighter-rouge">save</code> returns <code class="language-plaintext highlighter-rouge">false</code> because the <code class="language-plaintext highlighter-rouge">name</code> attribute wasn’t specified.</p>

<p>Rails automatically runs validations during create, update, and save operations
to ensure valid input. To see a list of errors generated by validations, we can
call <code class="language-plaintext highlighter-rouge">errors</code> on the instance.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; product.errors
</span><span class="p">=&gt;</span> <span class="kt">#&lt;</span><span class="no">ActiveModel</span><span class="o">::</span><span class="no">Errors</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">ActiveModel</span><span class="o">::</span><span class="no">Error</span> <span class="n">attribute</span><span class="o">=</span><span class="nb">name</span><span class="p">,</span> <span class="n">type</span><span class="o">=</span><span class="n">blank</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{}</span><span class="kt">&gt;</span><span class="p">]</span><span class="kt">&gt;</span>
</code></pre></div></div>

<p>This returns an <code class="language-plaintext highlighter-rouge">ActiveModel::Errors</code> object that can tell us exactly which
errors are present.</p>

<p>It also can generate friendly error messages for us that we can use in our user
interface.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; product.errors.full_messages
</span><span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"Name can't be blank"</span><span class="p">]</span>
</code></pre></div></div>

<p>Now let’s build a web interface for our Products.</p>

<p>We are done with the console for now, so you can exit out of it by running
<code class="language-plaintext highlighter-rouge">exit</code>.</p>

<h2 id="a-requests-journey-through-rails">A Request’s Journey Through Rails</h2>

<p>To get Rails saying “Hello”, you need to create at minimum a <em>route</em>, a
<em>controller</em> with an <em>action</em>, and a <em>view</em>. A route maps a request to a
controller action. A controller action performs the necessary work to handle the
request, and prepares any data for the view. A view displays data in a desired
format.</p>

<p>In terms of implementation: Routes are rules written in a Ruby
<a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL (Domain-Specific Language)</a>.
Controllers are Ruby classes, and their public methods are actions. And views
are templates, usually written in a mixture of HTML and Ruby.</p>

<p>That’s the short of it, but we’re going to walk through each of these steps in
more detail next.</p>

<h2 id="routes">Routes</h2>

<p>In Rails, a route is the part of the URL that determines how an incoming HTTP
request is directed to the appropriate controller and action for processing.
First, let’s do a quick refresher on URLs and HTTP Request methods.</p>

<h3 id="parts-of-a-url">Parts of a URL</h3>

<p>Let’s examine the different parts of a URL:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://example.org/products?sale=true&amp;sort=asc
</code></pre></div></div>

<p>In this URL, each part has a name:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">https</code> is the <strong>protocol</strong></li>
  <li><code class="language-plaintext highlighter-rouge">example.org</code> is the <strong>host</strong></li>
  <li><code class="language-plaintext highlighter-rouge">/products</code> is the <strong>path</strong></li>
  <li><code class="language-plaintext highlighter-rouge">?sale=true&amp;sort=asc</code> are the <strong>query parameters</strong></li>
</ul>

<h3 id="http-methods-and-their-purpose">HTTP Methods and Their Purpose</h3>

<p>HTTP requests use methods to tell a server what action it should perform for a
given URL. Here are the most common methods:</p>

<ul>
  <li>A <code class="language-plaintext highlighter-rouge">GET</code> request tells the server to retrieve the data for a given URL (e.g.,
loading a page or fetching a record).</li>
  <li>A <code class="language-plaintext highlighter-rouge">POST</code> request will submit data to the URL for processing (usually creating
a new record).</li>
  <li>A <code class="language-plaintext highlighter-rouge">PUT</code> or <code class="language-plaintext highlighter-rouge">PATCH</code> request submits data to a URL to update an existing record.</li>
  <li>A <code class="language-plaintext highlighter-rouge">DELETE</code> request to a URL tells the server to delete a record.</li>
</ul>

<h3 id="rails-routes">Rails Routes</h3>

<p>A <code class="language-plaintext highlighter-rouge">route</code> in Rails refers to a line of code that pairs an HTTP Method and a URL
path. The route also tells Rails which <code class="language-plaintext highlighter-rouge">controller</code> and <code class="language-plaintext highlighter-rouge">action</code> should respond
to a request.</p>

<p>To define a route in Rails, let’s go back to your code editor and add the
following route to <code class="language-plaintext highlighter-rouge">config/routes.rb</code></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">routes</span><span class="p">.</span><span class="nf">draw</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"/products"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#index"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This route tells Rails to look for GET requests to the <code class="language-plaintext highlighter-rouge">/products</code> path. In this
example, we specified <code class="language-plaintext highlighter-rouge">"products#index"</code> for where to route the request.</p>

<p>When Rails sees a request that matches, it will send the request to the
<code class="language-plaintext highlighter-rouge">ProductsController</code> and the <code class="language-plaintext highlighter-rouge">index</code> action inside of that controller. This is
how Rails will process the request and return a response to the browser.</p>

<p>You’ll notice that we don’t need to specify the protocol, domain, or query
params in our routes. That’s basically because the protocol and domain make sure
the request reaches your server. From there, Rails picks up the request and
knows which path to use for responding to the request based on what routes are
defined. The query params are like options that Rails can use to apply to the
request, so they are typically used in the controller for filtering the data.</p>

<picture class="flowdiagram">
  <source srcset="images/getting_started/routing_dark.jpg" media="(prefers-color-scheme:dark)" />
  <img src="images/getting_started/routing_light.jpg" />
</picture>

<p>Let’s look at another example. Add this line after the previous route:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">post</span> <span class="s2">"/products"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#create"</span>
</code></pre></div></div>

<p>Here, we’ve told Rails to take POST requests to “/products” and process them
with the <code class="language-plaintext highlighter-rouge">ProductsController</code> using the <code class="language-plaintext highlighter-rouge">create</code> action.</p>

<p>Routes may also need to match URLs with certain patterns. So how does that work?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span> <span class="s2">"/products/:id"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#show"</span>
</code></pre></div></div>

<p>This route has <code class="language-plaintext highlighter-rouge">:id</code> in it. This is called a <code class="language-plaintext highlighter-rouge">parameter</code> and it captures a
portion of the URL to be used later for processing the request.</p>

<p>If a user visits <code class="language-plaintext highlighter-rouge">/products/1</code>, the <code class="language-plaintext highlighter-rouge">:id</code> param is set to <code class="language-plaintext highlighter-rouge">1</code> and can be used in
the controller action to look up and display the Product record with an ID of 1.
<code class="language-plaintext highlighter-rouge">/products/2</code> would display Product with an ID of 2 and so on.</p>

<p>Route parameters don’t have to be Integers, either.</p>

<p>For example, you could have a blog with articles and match <code class="language-plaintext highlighter-rouge">/blog/hello-world</code>
with the following route:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span> <span class="s2">"/blog/:title"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"blog#show"</span>
</code></pre></div></div>

<p>Rails will capture <code class="language-plaintext highlighter-rouge">hello-world</code> out of <code class="language-plaintext highlighter-rouge">/blog/hello-world</code> and this can be used
to look up the blog post with the matching title.</p>

<h4 id="crud-routes">CRUD Routes</h4>

<p>There are 4 common actions you will generally need for a resource: Create, Read,
Update, Delete (CRUD). This translates to 8 typical routes:</p>

<ul>
  <li>Index - Shows all the records</li>
  <li>New - Renders a form for creating a new record</li>
  <li>Create - Processes the new form submission, handling errors and creating the
record</li>
  <li>Show - Renders a specific record for viewing</li>
  <li>Edit - Renders a form for updating a specific record</li>
  <li>Update (full) - Handles the edit form submission, handling errors and updating the entire record, and typically triggered by a PUT request.</li>
  <li>Update (partial) - Handles the edit form submission, handling errors and updating specific attributes of the record, and typically triggered by a PATCH request.</li>
  <li>Destroy - Handles deleting a specific record</li>
</ul>

<p>We can add routes for these CRUD actions with the following:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span> <span class="s2">"/products"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#index"</span>

<span class="n">get</span> <span class="s2">"/products/new"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#new"</span>
<span class="n">post</span> <span class="s2">"/products"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#create"</span>

<span class="n">get</span> <span class="s2">"/products/:id"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#show"</span>

<span class="n">get</span> <span class="s2">"/products/:id/edit"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#edit"</span>
<span class="n">patch</span> <span class="s2">"/products/:id"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#update"</span>
<span class="n">put</span> <span class="s2">"/products/:id"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#update"</span>

<span class="n">delete</span> <span class="s2">"/products/:id"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"products#destroy"</span>
</code></pre></div></div>

<h4 id="resource-routes">Resource Routes</h4>

<p>Typing out these routes every time is redundant, so Rails provides a shortcut
for defining them. To create all of the same CRUD routes, replace the above
routes with this single line:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resources</span> <span class="ss">:products</span>
</code></pre></div></div>

<p>TIP: If you don’t want all these CRUD actions, you specify exactly what you
need. Check out the <a href="routing.html">routing guide</a> for details.</p>

<h3 id="routes-command">Routes Command</h3>

<p>Rails provides a command that displays all the routes your application responds
to.</p>

<p>In your terminal, run the following command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails routes
</code></pre></div></div>

<p>You’ll see this in the output which are the routes generated by
<code class="language-plaintext highlighter-rouge">resources :products</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                                  Prefix Verb   URI Pattern                                                                                       Controller#Action
                                products GET    /products(.:format)                                                                               products#index
                                         POST   /products(.:format)                                                                               products#create
                             new_product GET    /products/new(.:format)                                                                           products#new
                            edit_product GET    /products/:id/edit(.:format)                                                                      products#edit
                                 product GET    /products/:id(.:format)                                                                           products#show
                                         PATCH  /products/:id(.:format)                                                                           products#update
                                         PUT    /products/:id(.:format)                                                                           products#update
                                         DELETE /products/:id(.:format)                                                                           products#destroy
</code></pre></div></div>

<p>You’ll also see routes from other built-in Rails features like health checks.</p>

<h2 id="controllers--actions">Controllers &amp; Actions</h2>

<p>Now that we’ve defined routes for Products, let’s implement the controller and
actions to handle requests to these URLs.</p>

<p>This command will generate a <code class="language-plaintext highlighter-rouge">ProductsController</code> with an index action. Since
we’ve already set up routes, we can skip that part of the generator using a
flag.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate controller Products index <span class="nt">--skip-routes</span>
      create  app/controllers/products_controller.rb
      invoke  erb
      create    app/views/products
      create    app/views/products/index.html.erb
      invoke  test_unit
      create    <span class="nb">test</span>/controllers/products_controller_test.rb
      invoke  helper
      create    app/helpers/products_helper.rb
      invoke    test_unit
</code></pre></div></div>

<p>This command generates a handful of files for our controller:</p>

<ul>
  <li>The controller itself</li>
  <li>A views folder for the controller we generated</li>
  <li>A view file for the action we specified when generating the controller</li>
  <li>A test file for this controller</li>
  <li>A helper file for extracting logic in our views</li>
</ul>

<p>Let’s take a look at the ProductsController defined in
<code class="language-plaintext highlighter-rouge">app/controllers/products_controller.rb</code>. It looks like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>NOTE: You may notice the file name <code class="language-plaintext highlighter-rouge">products_controller.rb</code> is an underscored
version of the Class this file defines, <code class="language-plaintext highlighter-rouge">ProductsController</code>. This pattern helps
Rails to automatically load code without having to use <code class="language-plaintext highlighter-rouge">require</code> like you may
have seen in other languages.</p>

<p>The <code class="language-plaintext highlighter-rouge">index</code> method here is an Action. Even though it’s an empty method, Rails
will default to rendering a template with the matching name.</p>

<p>The <code class="language-plaintext highlighter-rouge">index</code> action will render <code class="language-plaintext highlighter-rouge">app/views/products/index.html.erb</code>. If we open
up that file in our code editor, we’ll see the HTML it renders.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Products#index<span class="nt">&lt;/h1&gt;</span>
<span class="nt">&lt;p&gt;</span>Find me in app/views/products/index.html.erb<span class="nt">&lt;/p&gt;</span>
</code></pre></div></div>

<h3 id="making-requests">Making Requests</h3>

<p>Let’s see this in our browser. First, run <code class="language-plaintext highlighter-rouge">bin/rails server</code> in your terminal to
start the Rails server. Then open http://localhost:3000 and you will see the
Rails welcome page.</p>

<p>If we open http://localhost:3000/products in the browser, Rails will render the
products index HTML.</p>

<p>Our browser requested <code class="language-plaintext highlighter-rouge">/products</code> and Rails matched this route to
<code class="language-plaintext highlighter-rouge">products#index</code>. Rails sent the request to the <code class="language-plaintext highlighter-rouge">ProductsController</code> and called
the <code class="language-plaintext highlighter-rouge">index</code> action. Since this action was empty, Rails rendered the matching
template at <code class="language-plaintext highlighter-rouge">app/views/products/index.html.erb</code> and returned that to our
browser. Pretty cool!</p>

<p>If we open <code class="language-plaintext highlighter-rouge">config/routes.rb</code>, we can tell Rails the root route should render
the Products index action by adding this line:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">root</span> <span class="s2">"products#index"</span>
</code></pre></div></div>

<p>Now when you visit http://localhost:3000, Rails will render Products#index.</p>

<h3 id="instance-variables">Instance Variables</h3>

<p>Let’s take this a step further and render some records from our database.</p>

<p>In the <code class="language-plaintext highlighter-rouge">index</code> action, let’s add a database query and assign it to an instance
variable. Rails uses instance variables (variables that start with an @) to
share data with the views.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In <code class="language-plaintext highlighter-rouge">app/views/products/index.html.erb</code>, we can replace the HTML with this ERB:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">debug</span> <span class="vi">@products</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>ERB is short for <a href="https://docs.ruby-lang.org/en/master/ERB.html">Embedded Ruby</a>
and allows us to execute Ruby code to dynamically generate HTML with Rails. The
<code class="language-plaintext highlighter-rouge">&lt;%= %&gt;</code> tag tells ERB to execute the Ruby code inside and output the return
value. In our case, this takes <code class="language-plaintext highlighter-rouge">@products</code>, converts it to YAML, and outputs the
YAML.</p>

<p>Now refresh http://localhost:3000/ in your browser and you’ll see that the
output has changed. What you’re seeing is the records in your database being
displayed in YAML format.</p>

<p>The <code class="language-plaintext highlighter-rouge">debug</code> helper prints out variables in YAML format to help with debugging.
For example, if you weren’t paying attention and typed singular <code class="language-plaintext highlighter-rouge">@product</code>
instead of plural <code class="language-plaintext highlighter-rouge">@products</code>, the debug helper could help you identify that the
variable was not set correctly in the controller.</p>

<p>TIP: Check out the <a href="action_view_helpers.html">Action View Helpers guide</a> to see
more helpers that are available.</p>

<p>Let’s update <code class="language-plaintext highlighter-rouge">app/views/products/index.html.erb</code> to render all of our product
names.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Products<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"products"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Using ERB, this code loops through each product in the <code class="language-plaintext highlighter-rouge">@products</code>
<code class="language-plaintext highlighter-rouge">ActiveRecord::Relation</code> object and renders a <code class="language-plaintext highlighter-rouge">&lt;div&gt;</code> tag containing the product
name.</p>

<p>We’ve used a new ERB tag this time as well. <code class="language-plaintext highlighter-rouge">&lt;% %&gt;</code> evaluates the Ruby code but
does not output the return value. That ignores the output of <code class="language-plaintext highlighter-rouge">@products.each</code>
which would output an array that we don’t want in our HTML.</p>

<h3 id="crud-actions">CRUD Actions</h3>

<p>We need to be able to access individual products. This is the R in CRUD to read
a resource.</p>

<p>We’ve already defined the route for individual products with our
<code class="language-plaintext highlighter-rouge">resources :products</code> route. This generates <code class="language-plaintext highlighter-rouge">/products/:id</code> as a route that
points to <code class="language-plaintext highlighter-rouge">products#show</code>.</p>

<p>Now we need to add that action to the <code class="language-plaintext highlighter-rouge">ProductsController</code> and define what
happens when it is called.</p>

<h3 id="showing-individual-products">Showing Individual Products</h3>

<p>Open the Products controller and add the <code class="language-plaintext highlighter-rouge">show</code> action like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">show</code> action here defines the <em>singular</em> <code class="language-plaintext highlighter-rouge">@product</code> because it’s loading a
single record from the database, in other words: Show this one product. We use
plural <code class="language-plaintext highlighter-rouge">@products</code> in <code class="language-plaintext highlighter-rouge">index</code> because we’re loading multiple products.</p>

<p>To query the database, we use <code class="language-plaintext highlighter-rouge">params</code> to access the request parameters. In this
case, we’re using the <code class="language-plaintext highlighter-rouge">:id</code> from our route <code class="language-plaintext highlighter-rouge">/products/:id</code>. When we visit
<code class="language-plaintext highlighter-rouge">/products/1</code>, the params hash contains <code class="language-plaintext highlighter-rouge">{id: 1}</code> which results in our <code class="language-plaintext highlighter-rouge">show</code>
action calling <code class="language-plaintext highlighter-rouge">Product.find(1)</code> to load Product with ID of <code class="language-plaintext highlighter-rouge">1</code> from the
database.</p>

<p>We need a view for the show action next. Following the Rails naming conventions,
the <code class="language-plaintext highlighter-rouge">ProductsController</code> expects views in <code class="language-plaintext highlighter-rouge">app/views</code> in a subfolder named
<code class="language-plaintext highlighter-rouge">products</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">show</code> action expects a file in <code class="language-plaintext highlighter-rouge">app/views/products/show.html.erb</code>. Let’s
create that file in our editor and add the following contents:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Back"</span><span class="p">,</span> <span class="n">products_path</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>It would be helpful for the index page to link to the show page for each product
so we can click on them to navigate. We can update the
<code class="language-plaintext highlighter-rouge">app/views/products/index.html.erb</code> view to link to this new page to use an
anchor tag to the path for the <code class="language-plaintext highlighter-rouge">show</code> action.</p>

<pre><code class="language-erb#6,8">&lt;h1&gt;Products&lt;/h1&gt;

&lt;div id="products"&gt;
  &lt;% @products.each do |product| %&gt;
    &lt;div&gt;
      &lt;a href="/products/&lt;%= product.id %&gt;"&gt;
        &lt;%= product.name %&gt;
      &lt;/a&gt;
    &lt;/div&gt;
  &lt;% end %&gt;
&lt;/div&gt;
</code></pre>

<p>Refresh this page in your browser and you’ll see that this works, but we can do
better.</p>

<p>Rails provides helper methods for generating paths and URLs. When you run
<code class="language-plaintext highlighter-rouge">bin/rails routes</code>, you’ll see the Prefix column. This prefix matches the
helpers you can use for generating URLs with Ruby code.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                                  Prefix Verb   URI Pattern                                                                                       Controller#Action
                                products GET    /products(.:format)                                                                               products#index
                                 product GET    /products/:id(.:format)                                                                           products#show
</code></pre></div></div>

<p>These route prefixes give us helpers like the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">products_path</code> generates <code class="language-plaintext highlighter-rouge">"/products"</code></li>
  <li><code class="language-plaintext highlighter-rouge">products_url</code> generates <code class="language-plaintext highlighter-rouge">"http://localhost:3000/products"</code></li>
  <li><code class="language-plaintext highlighter-rouge">product_path(1)</code> generates <code class="language-plaintext highlighter-rouge">"/products/1"</code></li>
  <li><code class="language-plaintext highlighter-rouge">product_url(1)</code> generates <code class="language-plaintext highlighter-rouge">"http://localhost:3000/products/1"</code></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">_path</code> returns a relative path which the browser understands is for the current
domain.</p>

<p><code class="language-plaintext highlighter-rouge">_url</code> returns a full URL including the protocol, host, and port.</p>

<p>URL helpers are useful for rendering emails that will be viewed outside of the
browser.</p>

<p>Combined with the <code class="language-plaintext highlighter-rouge">link_to</code> helper, we can generate anchor tags and use the URL
helper to do this cleanly in Ruby. <code class="language-plaintext highlighter-rouge">link_to</code> accepts the display content for the
link (<code class="language-plaintext highlighter-rouge">product.name</code>) and the path or URL to link to for the <code class="language-plaintext highlighter-rouge">href</code> attribute
(<code class="language-plaintext highlighter-rouge">product</code>).</p>

<p>Let’s refactor this to use these helpers:</p>

<pre><code class="language-erb#6">&lt;h1&gt;Products&lt;/h1&gt;

&lt;div id="products"&gt;
  &lt;% @products.each do |product| %&gt;
    &lt;div&gt;
      &lt;%= link_to product.name, product_path(product.id) %&gt;
    &lt;/div&gt;
  &lt;% end %&gt;
&lt;/div&gt;
</code></pre>

<h3 id="creating-products">Creating Products</h3>

<p>So far we’ve had to create products in the Rails console, but let’s make this
work in the browser.</p>

<p>We need to create two actions for create:</p>

<ol>
  <li>The new product form to collect product information</li>
  <li>The create action in the controller to save the product and check for errors</li>
</ol>

<p>Let’s start with our controller actions.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ProductsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@products</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">new</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">new</code> action instantiates a new <code class="language-plaintext highlighter-rouge">Product</code> which we will use for displaying
the form fields.</p>

<p>We can update <code class="language-plaintext highlighter-rouge">app/views/products/index.html.erb</code> to link to the new action.</p>

<pre><code class="language-erb#3">&lt;h1&gt;Products&lt;/h1&gt;

&lt;%= link_to "New product", new_product_path %&gt;

&lt;div id="products"&gt;
  &lt;% @products.each do |product| %&gt;
    &lt;div&gt;
      &lt;%= link_to product.name, product_path(product.id) %&gt;
    &lt;/div&gt;
  &lt;% end %&gt;
&lt;/div&gt;
</code></pre>

<p>Let’s create <code class="language-plaintext highlighter-rouge">app/views/products/new.html.erb</code> to render the form for this new
<code class="language-plaintext highlighter-rouge">Product</code>.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>New product<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">model: </span><span class="vi">@product</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">submit</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>In this view, we are using the Rails <code class="language-plaintext highlighter-rouge">form_with</code> helper to generate an HTML form
to create products. This helper uses a <em>form builder</em> to handle things like CSRF
tokens, generating the URL based upon the <code class="language-plaintext highlighter-rouge">model:</code> provided, and even tailoring
the submit button text to the model.</p>

<p>If you open this page in your browser and View Source, the HTML for the form
will look like this:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/products"</span> <span class="na">accept-charset=</span><span class="s">"UTF-8"</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"authenticity_token"</span> <span class="na">value=</span><span class="s">"UHQSKXCaFqy_aoK760zpSMUPy6TMnsLNgbPMABwN1zpW-Jx6k-2mISiF0ulZOINmfxPdg5xMyZqdxSW1UK-H-Q"</span> <span class="na">autocomplete=</span><span class="s">"off"</span><span class="nt">&gt;</span>

  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"product_name"</span><span class="nt">&gt;</span>Name<span class="nt">&lt;/label&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"product[name]"</span> <span class="na">id=</span><span class="s">"product_name"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">name=</span><span class="s">"commit"</span> <span class="na">value=</span><span class="s">"Create Product"</span> <span class="na">data-disable-with=</span><span class="s">"Create Product"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>The form builder has included a CSRF token for security, configured the form for
UTF-8 support, set the input field names and even added a disabled state for the
submit button.</p>

<p>Because we passed a new <code class="language-plaintext highlighter-rouge">Product</code> instance to the form builder, it automatically
generated a form configured to send a <code class="language-plaintext highlighter-rouge">POST</code> request to <code class="language-plaintext highlighter-rouge">/products</code>, which is
the default route for creating a new record.</p>

<p>To handle this, we first need to implement the <code class="language-plaintext highlighter-rouge">create</code> action in our
controller.</p>

<pre><code class="language-ruby#14-26">class ProductsController &lt; ApplicationController
  def index
    @products = Product.all
  end

  def show
    @product = Product.find(params[:id])
  end

  def new
    @product = Product.new
  end

  def create
    @product = Product.new(product_params)
    if @product.save
      redirect_to @product
    else
      render :new, status: :unprocessable_entity
    end
  end

  private
    def product_params
      params.expect(product: [ :name ])
    end
end
</code></pre>

<h4 id="strong-parameters">Strong Parameters</h4>

<p>The <code class="language-plaintext highlighter-rouge">create</code> action handles the data submitted by the form, but it needs to be
filtered for security. That’s where the <code class="language-plaintext highlighter-rouge">product_params</code> method comes into play.</p>

<p>In <code class="language-plaintext highlighter-rouge">product_params</code>, we tell Rails to inspect the params and ensure there is a
key named <code class="language-plaintext highlighter-rouge">:product</code> with an array of parameters as the value. The only
permitted parameters for products is <code class="language-plaintext highlighter-rouge">:name</code> and Rails will ignore any other
parameters. This protects our application from malicious users who might try to
hack our application.</p>

<h4 id="handling-errors">Handling Errors</h4>

<p>After assigning these params to the new <code class="language-plaintext highlighter-rouge">Product</code>, we can try to save it to the
database. <code class="language-plaintext highlighter-rouge">@product.save</code> tells Active Record to run validations and save the
record to the database.</p>

<p>If <code class="language-plaintext highlighter-rouge">save</code> is successful, we want to redirect to the new product. When
<code class="language-plaintext highlighter-rouge">redirect_to</code> is given an Active Record object, Rails generates a path for that
record’s show action.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">redirect_to</span> <span class="vi">@product</span>
</code></pre></div></div>

<p>Since <code class="language-plaintext highlighter-rouge">@product</code> is a <code class="language-plaintext highlighter-rouge">Product</code> instance, Rails pluralizes the model name and
includes the object’s ID in the path to produce <code class="language-plaintext highlighter-rouge">"/products/2"</code> for the
redirect.</p>

<p>When <code class="language-plaintext highlighter-rouge">save</code> is unsuccessful and the record wasn’t valid, we want to re-render
the form so the user can fix the invalid data. In the <code class="language-plaintext highlighter-rouge">else</code> clause, we tell
Rails to <code class="language-plaintext highlighter-rouge">render :new</code>. Rails knows we’re in the <code class="language-plaintext highlighter-rouge">Products</code> controller, so it
should render <code class="language-plaintext highlighter-rouge">app/views/products/new.html.erb</code>. Since we’ve set the <code class="language-plaintext highlighter-rouge">@product</code>
variable in <code class="language-plaintext highlighter-rouge">create</code>, we can render that template and the form will be populated
with our <code class="language-plaintext highlighter-rouge">Product</code> data even though it wasn’t able to be saved in the database.</p>

<p>We also set the HTTP status to 422 Unprocessable Entity to tell the browser this
POST request failed and to handle it accordingly.</p>

<h3 id="editing-products">Editing Products</h3>

<p>The process of editing records is very similar to creating records. Instead of
<code class="language-plaintext highlighter-rouge">new</code> and <code class="language-plaintext highlighter-rouge">create</code> actions, we will have <code class="language-plaintext highlighter-rouge">edit</code> and <code class="language-plaintext highlighter-rouge">update</code>.</p>

<p>Let’s implement them in the controller with the following:</p>

<pre><code class="language-ruby#23-34">class ProductsController &lt; ApplicationController
  def index
    @products = Product.all
  end

  def show
    @product = Product.find(params[:id])
  end

  def new
    @product = Product.new
  end

  def create
    @product = Product.new(product_params)
    if @product.save
      redirect_to @product
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
    @product = Product.find(params[:id])
  end

  def update
    @product = Product.find(params[:id])
    if @product.update(product_params)
      redirect_to @product
    else
      render :edit, status: :unprocessable_entity
    end
  end

  private
    def product_params
      params.expect(product: [ :name ])
    end
end
</code></pre>

<p>Next we can add an Edit link to <code class="language-plaintext highlighter-rouge">app/views/products/show.html.erb</code>:</p>

<pre><code class="language-erb#4">&lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;

&lt;%= link_to "Back", products_path %&gt;
&lt;%= link_to "Edit", edit_product_path(@product) %&gt;
</code></pre>

<h4 id="before-actions">Before Actions</h4>

<p>Since <code class="language-plaintext highlighter-rouge">edit</code> and <code class="language-plaintext highlighter-rouge">update</code> require an existing database record like <code class="language-plaintext highlighter-rouge">show</code> we can
deduplicate this into a <code class="language-plaintext highlighter-rouge">before_action</code>.</p>

<p>A <code class="language-plaintext highlighter-rouge">before_action</code> allows you to extract shared code between actions and run it
<em>before</em> the action. In the above controller code,
<code class="language-plaintext highlighter-rouge">@product = Product.find(params[:id])</code> is defined in three different methods.
Extracting this query to a before action called <code class="language-plaintext highlighter-rouge">set_product</code> cleans up our code
for each action.</p>

<p>This is a good example of the DRY (Don’t Repeat Yourself) philosophy in action.</p>

<pre><code class="language-ruby#2,8-9,24-25,27-33,36-38">class ProductsController &lt; ApplicationController
  before_action :set_product, only: %i[ show edit update ]

  def index
    @products = Product.all
  end

  def show
  end

  def new
    @product = Product.new
  end

  def create
    @product = Product.new(product_params)
    if @product.save
      redirect_to @product
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
  end

  def update
    if @product.update(product_params)
      redirect_to @product
    else
      render :edit, status: :unprocessable_entity
    end
  end

  private
    def set_product
      @product = Product.find(params[:id])
    end

    def product_params
      params.expect(product: [ :name ])
    end
end
</code></pre>

<h4 id="extracting-partials">Extracting Partials</h4>

<p>We’ve already written a form for creating new products. Wouldn’t it be nice if
we could reuse that for edit and update? We can, using a feature called
“partials” that allows you to reuse a view in multiple places.</p>

<p>We can move the form into a file called <code class="language-plaintext highlighter-rouge">app/views/products/_form.html.erb</code>. The
filename starts with an underscore to denote this is a partial.</p>

<p>We also want to replace any instance variables with a local variable, which we
can define when we render the partial. We’ll do this by replacing <code class="language-plaintext highlighter-rouge">@product</code>
with <code class="language-plaintext highlighter-rouge">product</code>.</p>

<pre><code class="language-erb#1">&lt;%= form_with model: product do |form| %&gt;
  &lt;div&gt;
    &lt;%= form.label :name %&gt;
    &lt;%= form.text_field :name %&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;%= form.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>

<p>TIP: Using local variables allows partials to be reused multiple times on the
same page with a different value each time. This comes in handy rendering lists
of items like an index page.</p>

<p>To use this partial in our <code class="language-plaintext highlighter-rouge">app/views/products/new.html.erb</code> view, we can
replace the form with a render call:</p>

<pre><code class="language-erb#3">&lt;h1&gt;New product&lt;/h1&gt;

&lt;%= render "form", product: @product %&gt;
&lt;%= link_to "Cancel", products_path %&gt;
</code></pre>

<p>The edit view becomes almost the exact same thing thanks to the form partial.
Let’s create <code class="language-plaintext highlighter-rouge">app/views/products/edit.html.erb</code> with the following:</p>

<pre><code class="language-erb#3">&lt;h1&gt;Edit product&lt;/h1&gt;

&lt;%= render "form", product: @product %&gt;
&lt;%= link_to "Cancel", @product %&gt;
</code></pre>

<p>To learn more about view partials, check out the
<a href="action_view_overview.html">Action View Guide</a>.</p>

<h3 id="deleting-products">Deleting Products</h3>

<p>The last feature we need to implement is deleting products. We will add a
<code class="language-plaintext highlighter-rouge">destroy</code> action to our <code class="language-plaintext highlighter-rouge">ProductsController</code> to handle <code class="language-plaintext highlighter-rouge">DELETE /products/:id</code>
requests.</p>

<p>Adding <code class="language-plaintext highlighter-rouge">destroy</code> to <code class="language-plaintext highlighter-rouge">before_action :set_product</code> lets us set the <code class="language-plaintext highlighter-rouge">@product</code>
instance variable in the same way we do for the other actions.</p>

<pre><code class="language-ruby#2,35-38">class ProductsController &lt; ApplicationController
  before_action :set_product, only: %i[ show edit update destroy ]

  def index
    @products = Product.all
  end

  def show
  end

  def new
    @product = Product.new
  end

  def create
    @product = Product.new(product_params)
    if @product.save
      redirect_to @product
    else
      render :new, status: :unprocessable_entity
    end
  end

  def edit
  end

  def update
    if @product.update(product_params)
      redirect_to @product
    else
      render :edit, status: :unprocessable_entity
    end
  end

  def destroy
    @product.destroy
    redirect_to products_path
  end

  private
    def set_product
      @product = Product.find(params[:id])
    end

    def product_params
      params.expect(product: [ :name ])
    end
end
</code></pre>

<p>To make this work, we need to add a Delete button to
<code class="language-plaintext highlighter-rouge">app/views/products/show.html.erb</code>:</p>

<pre><code class="language-erb#5">&lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;

&lt;%= link_to "Back", products_path %&gt;
&lt;%= link_to "Edit", edit_product_path(@product) %&gt;
&lt;%= button_to "Delete", @product, method: :delete, data: { turbo_confirm: "Are you sure?" } %&gt;
</code></pre>

<p><code class="language-plaintext highlighter-rouge">button_to</code> generates a form with a single button in it with the “Delete” text.
When this button is clicked, it submits the form which makes a <code class="language-plaintext highlighter-rouge">DELETE</code> request
to <code class="language-plaintext highlighter-rouge">/products/:id</code> which triggers the <code class="language-plaintext highlighter-rouge">destroy</code> action in our controller.</p>

<p>The <code class="language-plaintext highlighter-rouge">turbo_confirm</code> data attribute tells the Turbo JavaScript library to ask the
user to confirm before submitting the form. We’ll dig more into that shortly.</p>

<h2 id="adding-authentication">Adding Authentication</h2>

<p>Anyone can edit or delete products which isn’t safe. Let’s add some security by
requiring a user to be authenticated to manage products.</p>

<p>Rails comes with an authentication generator that we can use. It creates User
and Session models and the controllers and views necessary to login to our
application.</p>

<p>Head back to your terminal and run the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate authentication
</code></pre></div></div>

<p>Then migrate the database to add the User and Session tables.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails db:migrate
</code></pre></div></div>

<p>Open the Rails console to create a User.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails console
</code></pre></div></div>

<p>Use <code class="language-plaintext highlighter-rouge">User.create!</code> method to create a User in the Rails console. Feel free to
use your own email and password instead of the example.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; User.create! email_address: "you@example.org", password: "s3cr3t", password_confirmation: "s3cr3t"
</span></code></pre></div></div>

<p>Restart your Rails server so it picks up the <code class="language-plaintext highlighter-rouge">bcrypt</code> gem added by the
generator. BCrypt is used for securely hashing passwords for authentication.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails server
</code></pre></div></div>

<p>When you visit any page, Rails will prompt for a username and password. Enter
the email and password you used when creating the User record.</p>

<p>Try it out by visiting http://localhost:3000/products/new</p>

<p>If you enter the correct username and password, it will allow you through. Your
browser will also store these credentials for future requests so you don’t have
to type it in every page view.</p>

<h3 id="adding-log-out">Adding Log Out</h3>

<p>To log out of the application, we can add a button to the top of
<code class="language-plaintext highlighter-rouge">app/views/layouts/application.html.erb</code>. This layout is where you put HTML that
you want to include in every page like a header or footer.</p>

<p>Add a small <code class="language-plaintext highlighter-rouge">&lt;nav&gt;</code> section inside the <code class="language-plaintext highlighter-rouge">&lt;body&gt;</code> with a link to Home and a Log
out button and wrap <code class="language-plaintext highlighter-rouge">yield</code> with a <code class="language-plaintext highlighter-rouge">&lt;main&gt;</code> tag.</p>

<pre><code class="language-erb#5-8,10,12">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;!-- ... --&gt;
  &lt;body&gt;
    &lt;nav&gt;
      &lt;%= link_to "Home", root_path %&gt;
      &lt;%= button_to "Log out", session_path, method: :delete if authenticated? %&gt;
    &lt;/nav&gt;

    &lt;main&gt;
      &lt;%= yield %&gt;
    &lt;/main&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>This will display a Log out button only if the user is authenticated. When
clicked, it will send a DELETE request to the session path which will log the
user out.</p>

<h3 id="allowing-unauthenticated-access">Allowing Unauthenticated Access</h3>

<p>However, our store’s product index and show pages should be accessible to
everyone. By default, the Rails authentication generator will restrict all pages
to authenticated users only.</p>

<p>To allow guests to view products, we can allow unauthenticated access in our
controller.</p>

<pre><code class="language-ruby#2">class ProductsController &lt; ApplicationController
  allow_unauthenticated_access only: %i[ index show ]
  # ...
end
</code></pre>

<p>Log out and visit the products index and show pages to see they’re accessible
without being authenticated.</p>

<h3 id="showing-links-for-authenticated-users-only">Showing Links for Authenticated Users Only</h3>

<p>Since only logged in users can create products, we can modify the
<code class="language-plaintext highlighter-rouge">app/views/products/index.html.erb</code> view to only display the new product link if
the user is authenticated.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"New product"</span><span class="p">,</span> <span class="n">new_product_path</span> <span class="k">if</span> <span class="n">authenticated?</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>Click the Log out button and you’ll see the New link is hidden. Log in at
http://localhost:3000/session/new and you’ll see the New link on the index page.</p>

<p>Optionally, you can include a link to this route in the navbar to add a Login
link if not authenticated.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"Login"</span><span class="p">,</span> <span class="n">new_session_path</span> <span class="k">unless</span> <span class="n">authenticated?</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>You can also update the Edit and Delete links on the
<code class="language-plaintext highlighter-rouge">app/views/products/show.html.erb</code> view to only display if authenticated.</p>

<pre><code class="language-erb#4,7">&lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;

&lt;%= link_to "Back", products_path %&gt;
&lt;% if authenticated? %&gt;
  &lt;%= link_to "Edit", edit_product_path(@product) %&gt;
  &lt;%= button_to "Delete", @product, method: :delete, data: { turbo_confirm: "Are you sure?" } %&gt;
&lt;% end %&gt;
</code></pre>

<h2 id="caching-products">Caching Products</h2>

<p>Sometimes caching specific parts of a page can improve performance. Rails
simplifies this process with Solid Cache, a database-backed cache store that
comes included by default.</p>

<p>Using the <code class="language-plaintext highlighter-rouge">cache</code> method, we can store HTML in the cache. Let’s cache the header
in <code class="language-plaintext highlighter-rouge">app/views/products/show.html.erb</code>.</p>

<pre><code class="language-erb#1,3">&lt;% cache @product do %&gt;
  &lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;
&lt;% end %&gt;
</code></pre>

<p>By passing <code class="language-plaintext highlighter-rouge">@product</code> into <code class="language-plaintext highlighter-rouge">cache</code>, Rails generates a unique cache key for the
product. Active Record objects have a <code class="language-plaintext highlighter-rouge">cache_key</code> method that returns a String
like <code class="language-plaintext highlighter-rouge">"products/1"</code>. The <code class="language-plaintext highlighter-rouge">cache</code> helper in the views combines this with the
template digest to create a unique key for this HTML.</p>

<p>To enable caching in development, run the following command in your terminal.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails dev:cache
</code></pre></div></div>

<p>When you visit a product’s show action (like <code class="language-plaintext highlighter-rouge">/products/2</code>), you’ll see the new
caching lines in your Rails server logs:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Read fragment views/products/show:a5a585f985894cd27c8b3d49bb81de3a/products/1-20240918154439539125 <span class="o">(</span>1.6ms<span class="o">)</span>
Write fragment views/products/show:a5a585f985894cd27c8b3d49bb81de3a/products/1-20240918154439539125 <span class="o">(</span>4.0ms<span class="o">)</span>
</code></pre></div></div>

<p>The first time we open this page, Rails will generate a cache key and ask the
cache store if it exists. This is the <code class="language-plaintext highlighter-rouge">Read fragment</code> line.</p>

<p>Since this is the first page view, the cache does not exist so the HTML is
generated and written to the cache. We can see this as the <code class="language-plaintext highlighter-rouge">Write fragment</code> line
in the logs.</p>

<p>Refresh the page and you’ll see the logs no longer contain the <code class="language-plaintext highlighter-rouge">Write fragment</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Read fragment views/products/show:a5a585f985894cd27c8b3d49bb81de3a/products/1-20240918154439539125 <span class="o">(</span>1.3ms<span class="o">)</span>
</code></pre></div></div>

<p>The cache entry was written by the last request, so Rails finds the cache entry
on the second request. Rails also changes the cache key when records are updated
to ensure that it never renders stale cache data.</p>

<p>Learn more in the <a href="caching_with_rails.html">Caching with Rails</a> guide.</p>

<h2 id="rich-text-fields-with-action-text">Rich Text Fields with Action Text</h2>

<p>Many applications need rich text with embeds (i.e. multimedia elements) and
Rails provides this functionality out of the box with Action Text.</p>

<p>To use Action Text, you’ll first run the installer:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails action_text:install
<span class="nv">$ </span>bundle <span class="nb">install</span>
<span class="nv">$ </span>bin/rails db:migrate
</code></pre></div></div>

<p>Restart your Rails server to make sure all the new features are loaded.</p>

<p>Now, let’s add a rich text description field to our product.</p>

<p>First, add the following to the <code class="language-plaintext highlighter-rouge">Product</code> model:</p>

<pre><code class="language-ruby#2">class Product &lt; ApplicationRecord
  has_rich_text :description
  validates :name, presence: true
end
</code></pre>

<p>The form can now be updated to include a rich text field for editing the
description in <code class="language-plaintext highlighter-rouge">app/views/products/_form.html.erb</code> before the submit button.</p>

<pre><code class="language-erb#4-7">&lt;%= form_with model: product do |form| %&gt;
  &lt;%# ... %&gt;

  &lt;div&gt;
    &lt;%= form.label :description, style: "display: block" %&gt;
    &lt;%= form.rich_textarea :description %&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;%= form.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>

<p>Our controller also needs to permit this new parameter when the form is
submitted, so we’ll update the permitted params to include description in
<code class="language-plaintext highlighter-rouge">app/controllers/products_controller.rb</code></p>

<pre><code class="language-ruby#3">    # Only allow a list of trusted parameters through.
    def product_params
      params.expect(product: [ :name, :description ])
    end
</code></pre>

<p>We also need to update the show view to display the description in
<code class="language-plaintext highlighter-rouge">app/views/products/show.html.erb</code>:</p>

<pre><code class="language-erb#3">&lt;% cache @product do %&gt;
  &lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;
  &lt;%= @product.description %&gt;
&lt;% end %&gt;
</code></pre>

<p>The cache key generated by Rails also changes when the view is modified. This
makes sure the cache stays in sync with the latest version of the view template.</p>

<p>Create a new product and add a description with bold and italic text. You’ll see
that the show page displays the formatted text and editing the product retains
this rich text in the text area.</p>

<p>Check out the <a href="action_text_overview.html">Action Text Overview</a> to learn more.</p>

<h2 id="file-uploads-with-active-storage">File Uploads with Active Storage</h2>

<p>Action Text is built upon another feature of Rails called Active Storage that
makes it easy to upload files.</p>

<p>Try editing a product and dragging an image into the rich text editor, then
update the record. You’ll see that Rails uploads this image and renders it
inside the rich text editor. Cool, right?!</p>

<p>We can also use Active Storage directly. Let’s add a featured image to the
<code class="language-plaintext highlighter-rouge">Product</code> model.</p>

<pre><code class="language-ruby#2">class Product &lt; ApplicationRecord
  has_one_attached :featured_image
  has_rich_text :description
  validates :name, presence: true
end
</code></pre>

<p>Then we can add a file upload field to our product form before the submit
button:</p>

<pre><code class="language-erb#4-7">&lt;%= form_with model: product do |form| %&gt;
  &lt;%# ... %&gt;

  &lt;div&gt;
    &lt;%= form.label :featured_image, style: "display: block" %&gt;
    &lt;%= form.file_field :featured_image, accept: "image/*" %&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;%= form.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>

<p>Add <code class="language-plaintext highlighter-rouge">:featured_image</code> as a permitted parameter in
<code class="language-plaintext highlighter-rouge">app/controllers/products_controller.rb</code></p>

<pre><code class="language-ruby#3">    # Only allow a list of trusted parameters through.
    def product_params
      params.expect(product: [ :name, :description, :featured_image ])
    end
</code></pre>

<p>Lastly, we want to display the featured image for our product in
<code class="language-plaintext highlighter-rouge">app/views/products/show.html.erb</code>. Add the following to the top.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">featured_image</span> <span class="k">if</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">featured_image</span><span class="p">.</span><span class="nf">attached?</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>Try uploading an image for a product and you’ll see the image displayed on the
show page after saving.</p>

<p>Check out the <a href="active_storage_overview.html">Active Storage Overview</a> for more
details.</p>

<h2 id="internationalization-i18n">Internationalization (I18n)</h2>

<p>Rails makes it easy to translate your app into other languages.</p>

<p>The <code class="language-plaintext highlighter-rouge">translate</code> or <code class="language-plaintext highlighter-rouge">t</code> helper in our views looks up a translation by name and
returns the text for the current locale.</p>

<p>In <code class="language-plaintext highlighter-rouge">app/views/products/index.html.erb</code>, let’s update the header tag to use a
translation.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="n">t</span> <span class="s2">"hello"</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
</code></pre></div></div>

<p>Refreshing the page, we see <code class="language-plaintext highlighter-rouge">Hello world</code> is the header text now. Where did that
come from?</p>

<p>Since the default language is in English, Rails looks in <code class="language-plaintext highlighter-rouge">config/locales/en.yml</code>
(which was created during <code class="language-plaintext highlighter-rouge">rails new</code>) for a matching key under the locale.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">en</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Hello</span><span class="nv"> </span><span class="s">world"</span>
</code></pre></div></div>

<p>Let’s create a new locale file in our editor for Spanish and add a translation
in <code class="language-plaintext highlighter-rouge">config/locales/es.yml</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">es</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Hola</span><span class="nv"> </span><span class="s">mundo"</span>
</code></pre></div></div>

<p>We need to tell Rails which locale to use. The simplest option is to look for a
locale param in the URL. We can do this in
<code class="language-plaintext highlighter-rouge">app/controllers/application_controller.rb</code> with the following:</p>

<pre><code class="language-ruby#4,6-9">class ApplicationController &lt; ActionController::Base
  # ...

  around_action :switch_locale

  def switch_locale(&amp;action)
    locale = params[:locale] || I18n.default_locale
    I18n.with_locale(locale, &amp;action)
  end
end
</code></pre>

<p>This will run every request and look for <code class="language-plaintext highlighter-rouge">locale</code> in the params or fallback to
the default locale. It sets the locale for the request and resets it after it’s
finished.</p>

<ul>
  <li>Visit http://localhost:3000/products?locale=en, you will see the English
translation.</li>
  <li>Visit http://localhost:3000/products?locale=es, you will see the Spanish
translation.</li>
  <li>Visit http://localhost:3000/products without a locale param, it will fallback
to English.</li>
</ul>

<p>Let’s update the index header to use a real translation instead of
<code class="language-plaintext highlighter-rouge">"Hello world"</code>.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="n">t</span> <span class="s2">".title"</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
</code></pre></div></div>

<p>TIP: Notice the <code class="language-plaintext highlighter-rouge">.</code> before <code class="language-plaintext highlighter-rouge">title</code>? This tells Rails to use a relative locale
lookup. Relative lookups include the controller and action automatically in the
key so you don’t have to type them every time. For <code class="language-plaintext highlighter-rouge">.title</code> with the English
locale, it will look up <code class="language-plaintext highlighter-rouge">en.products.index.title</code>.</p>

<p>In <code class="language-plaintext highlighter-rouge">config/locales/en.yml</code> we want to add the <code class="language-plaintext highlighter-rouge">title</code> key under <code class="language-plaintext highlighter-rouge">products</code> and
<code class="language-plaintext highlighter-rouge">index</code> to match our controller, view, and translation name.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">en</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Hello</span><span class="nv"> </span><span class="s">world"</span>
  <span class="na">products</span><span class="pi">:</span>
    <span class="na">index</span><span class="pi">:</span>
      <span class="na">title</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Products"</span>
</code></pre></div></div>

<p>In the Spanish locales file, we can do the same thing:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">es</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Hola</span><span class="nv"> </span><span class="s">mundo"</span>
  <span class="na">products</span><span class="pi">:</span>
    <span class="na">index</span><span class="pi">:</span>
      <span class="na">title</span><span class="pi">:</span> <span class="s2">"</span><span class="s">Productos"</span>
</code></pre></div></div>

<p>You’ll now see “Products” when viewing the English locale and “Productos” when
viewing the Spanish locale.</p>

<p>Learn more about the <a href="i18n.html">Rails Internationalization (I18n) API</a>.</p>

<h2 id="adding-in-stock-notifications">Adding In Stock Notifications</h2>

<p>A common feature of e-commerce stores is an email subscription to get notified
when a product is back in stock. Now that we’ve seen the basics of Rails, let’s
add this feature to our store.</p>

<h3 id="basic-inventory-tracking">Basic Inventory Tracking</h3>

<p>First, let’s add an inventory count to the Product model so we can keep track of
stock. We can generate this migration using the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate migration AddInventoryCountToProducts inventory_count:integer
</code></pre></div></div>

<p>Then let’s run the migration.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails db:migrate
</code></pre></div></div>

<p>We’ll need to add the inventory count to the product form in
<code class="language-plaintext highlighter-rouge">app/views/products/_form.html.erb</code>.</p>

<pre><code class="language-erb#4-7">&lt;%= form_with model: product do |form| %&gt;
  &lt;%# ... %&gt;

  &lt;div&gt;
    &lt;%= form.label :inventory_count, style: "display: block" %&gt;
    &lt;%= form.number_field :inventory_count %&gt;
  &lt;/div&gt;

  &lt;div&gt;
    &lt;%= form.submit %&gt;
  &lt;/div&gt;
&lt;% end %&gt;
</code></pre>

<p>The controller also needs <code class="language-plaintext highlighter-rouge">:inventory_count</code> added to the permitted parameters.</p>

<pre><code class="language-ruby#2">    def product_params
      params.expect(product: [ :name, :description, :featured_image, :inventory_count ])
    end
</code></pre>

<p>It would also be helpful to validate that our inventory count is never a
negative number, so let’s also add a validation for that in our model.</p>

<pre><code class="language-ruby#6">class Product &lt; ApplicationRecord
  has_one_attached :featured_image
  has_rich_text :description

  validates :name, presence: true
  validates :inventory_count, numericality: { greater_than_or_equal_to: 0 }
end
</code></pre>

<p>With these changes, we can now update the inventory count of products in our
store.</p>

<h3 id="adding-subscribers-to-products">Adding Subscribers to Products</h3>

<p>In order to notify users that a product is back in stock, we need to keep track
of these subscribers.</p>

<p>Let’s generate a model called Subscriber to store these email addresses and
associate them with the respective product.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate model Subscriber product:belongs_to email
</code></pre></div></div>

<p>Then run the new migration:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails db:migrate
</code></pre></div></div>

<p>By including <code class="language-plaintext highlighter-rouge">product:belongs_to</code> above, we told Rails that subscribers and
products have a one-to-many relationship, meaning a Subscriber “belongs to” a
single Product instance.</p>

<p>A Product, however, can have many subscribers, so we then add
<code class="language-plaintext highlighter-rouge">has_many :subscribers, dependent: :destroy</code> to our Product model to add the
second part of this association between the two models. This tells Rails how to
join queries between the two database tables.</p>

<pre><code class="language-ruby#2">class Product &lt; ApplicationRecord
  has_many :subscribers, dependent: :destroy
  has_one_attached :featured_image
  has_rich_text :description

  validates :name, presence: true
  validates :inventory_count, numericality: { greater_than_or_equal_to: 0 }
end
</code></pre>

<p>Now we need a controller to create these subscribers. Let’s create that in
<code class="language-plaintext highlighter-rouge">app/controllers/subscribers_controller.rb</code> with the following code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SubscribersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">allow_unauthenticated_access</span>
  <span class="n">before_action</span> <span class="ss">:set_product</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@product</span><span class="p">.</span><span class="nf">subscribers</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">subscriber_params</span><span class="p">).</span><span class="nf">first_or_create</span>
    <span class="n">redirect_to</span> <span class="vi">@product</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"You are now subscribed."</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">set_product</span>
    <span class="vi">@product</span> <span class="o">=</span> <span class="no">Product</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:product_id</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">subscriber_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">expect</span><span class="p">(</span><span class="ss">subscriber: </span><span class="p">[</span> <span class="ss">:email</span> <span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Our redirect sets a notice in the Rails flash. The flash is used for storing
messages to display on the next page.</p>

<p>To display the flash message, let’s add the notice to
<code class="language-plaintext highlighter-rouge">app/views/layouts/application.html.erb</code> inside the body:</p>

<pre><code class="language-erb#4">&lt;html&gt;
  &lt;!-- ... --&gt;
  &lt;body&gt;
    &lt;div class="notice"&gt;&lt;%= notice %&gt;&lt;/div&gt;
    &lt;!-- ... --&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>

<p>To subscribe users to a specific product, we’ll use a nested route so we know
which product the subscriber belongs to. In <code class="language-plaintext highlighter-rouge">config/routes.rb</code> change
<code class="language-plaintext highlighter-rouge">resources :products</code> to the following:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">resources</span> <span class="ss">:products</span> <span class="k">do</span>
    <span class="n">resources</span> <span class="ss">:subscribers</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span> <span class="ss">:create</span> <span class="p">]</span>
  <span class="k">end</span>
</code></pre></div></div>

<p>On the product show page, we can check if there is inventory and display the
amount in stock. Otherwise, we can display an out of stock message with the
subscribe form to get notified when it is back in stock.</p>

<p>Create a new partial at <code class="language-plaintext highlighter-rouge">app/views/products/_inventory.html.erb</code> and add the
following:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">product</span><span class="p">.</span><span class="nf">inventory_count?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="n">product</span><span class="p">.</span><span class="nf">inventory_count</span> <span class="cp">%&gt;</span> in stock<span class="nt">&lt;/p&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;p&gt;</span>Out of stock<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>Email me when available.<span class="nt">&lt;/p&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">form_with</span> <span class="ss">model: </span><span class="p">[</span><span class="n">product</span><span class="p">,</span> <span class="no">Subscriber</span><span class="p">.</span><span class="nf">new</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">form</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">email_field</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">placeholder: </span><span class="s2">"you@example.com"</span><span class="p">,</span> <span class="ss">required: </span><span class="kp">true</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">form</span><span class="p">.</span><span class="nf">submit</span> <span class="s2">"Submit"</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>Then update <code class="language-plaintext highlighter-rouge">app/views/products/show.html.erb</code> to render this partial after the
<code class="language-plaintext highlighter-rouge">cache</code> block.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s2">"inventory"</span><span class="p">,</span> <span class="ss">product: </span><span class="vi">@product</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<h3 id="in-stock-email-notifications">In Stock Email Notifications</h3>

<p>Action Mailer is a feature of Rails that allows you to send emails. We’ll use it
to notify subscribers when a product is back in stock.</p>

<p>We can generate a mailer with the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails g mailer Product in_stock
</code></pre></div></div>

<p>This generates a class at <code class="language-plaintext highlighter-rouge">app/mailers/product_mailer.rb</code> with an <code class="language-plaintext highlighter-rouge">in_stock</code>
method.</p>

<p>Update this method to mail to a subscriber’s email address.</p>

<pre><code class="language-ruby#7-10">class ProductMailer &lt; ApplicationMailer
  # Subject can be set in your I18n file at config/locales/en.yml
  # with the following lookup:
  #
  #   en.product_mailer.in_stock.subject
  #
  def in_stock
    @product = params[:product]
    mail to: params[:subscriber].email
  end
end
</code></pre>

<p>The mailer generator also generates two email templates in our views folder: one
for HTML and one for Text. We can update those to include a message and link to
the product.</p>

<p>Change <code class="language-plaintext highlighter-rouge">app/views/product_mailer/in_stock.html.erb</code> to:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>Good news!<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;p&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">)</span> <span class="cp">%&gt;</span> is back in stock.<span class="nt">&lt;/p&gt;</span>
</code></pre></div></div>

<p>And <code class="language-plaintext highlighter-rouge">app/views/product_mailer/in_stock.text.erb</code> to:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Good news!

<span class="cp">&lt;%=</span> <span class="vi">@product</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span> is back in stock.
<span class="cp">&lt;%=</span> <span class="n">product_url</span><span class="p">(</span><span class="vi">@product</span><span class="p">)</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>We use <code class="language-plaintext highlighter-rouge">product_url</code> instead of <code class="language-plaintext highlighter-rouge">product_path</code> in mailers because email clients
need to know the full URL to open in the browser when the link is clicked.</p>

<p>We can test an email by opening the Rails console and loading a product and
subscriber to send to:</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">store(dev)&gt; product = Product.first
store(dev)&gt; subscriber = product.subscribers.find_or_create_by(email: "subscriber@example.org")
store(dev)&gt; ProductMailer.with(product: product, subscriber: subscriber).in_stock.deliver_later
</span></code></pre></div></div>

<p>You’ll see that it prints out an email in the logs.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ProductMailer#in_stock: processed outbound mail in 63.0ms
Delivered mail 66a3a9afd5d4a_108b04a4c41443@local.mail (33.1ms)
Date: Fri, 26 Jul 2024 08:50:39 -0500
From: from@example.com
To: subscriber@example.com
Message-ID: &lt;66a3a9afd5d4a_108b04a4c41443@local.mail&gt;
Subject: In stock
Mime-Version: 1.0
Content-Type: multipart/alternative;
 boundary="--==_mimepart_66a3a9afd235e_108b04a4c4136f";
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_66a3a9afd235e_108b04a4c4136f
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

Good news!

T-Shirt is back in stock.
http://localhost:3000/products/1


----==_mimepart_66a3a9afd235e_108b04a4c4136f
Content-Type: text/html;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

&lt;!-- BEGIN app/views/layouts/mailer.html.erb --&gt;&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;meta http-equiv="Content-Type" content="text/html; charset=utf-8"&gt;
    &lt;style&gt;
      /* Email styles need to be inline */
    &lt;/style&gt;
  &lt;/head&gt;

  &lt;body&gt;
    &lt;!-- BEGIN app/views/product_mailer/in_stock.html.erb --&gt;&lt;h1&gt;Good news!&lt;/h1&gt;

&lt;p&gt;&lt;a href="http://localhost:3000/products/1"&gt;T-Shirt&lt;/a&gt; is back in stock.&lt;/p&gt;
&lt;!-- END app/views/product_mailer/in_stock.html.erb --&gt;
  &lt;/body&gt;
&lt;/html&gt;
&lt;!-- END app/views/layouts/mailer.html.erb --&gt;
----==_mimepart_66a3a9afd235e_108b04a4c4136f--

Performed ActionMailer::MailDeliveryJob (Job ID: 5e2bd5f2-f54f-4088-ace3-3f6eb15aaf46) from Async(default) in 111.34ms
</code></pre></div></div>

<p>To trigger these emails, we can use a callback in the Product model to send
emails anytime the inventory count changes from 0 to a positive number.</p>

<pre><code class="language-ruby#9-19">class Product &lt; ApplicationRecord
  has_many :subscribers, dependent: :destroy
  has_one_attached :featured_image
  has_rich_text :description

  validates :name, presence: true
  validates :inventory_count, numericality: { greater_than_or_equal_to: 0 }

  after_update_commit :notify_subscribers, if: :back_in_stock?

  def back_in_stock?
    inventory_count_previously_was.zero? &amp;&amp; inventory_count &gt; 0
  end

  def notify_subscribers
    subscribers.each do |subscriber|
      ProductMailer.with(product: self, subscriber: subscriber).in_stock.deliver_later
    end
  end
end
</code></pre>

<p><code class="language-plaintext highlighter-rouge">after_update_commit</code> is an Active Record callback that is fired after changes
are saved to the database. <code class="language-plaintext highlighter-rouge">if: :back_in_stock?</code> tells the callback to run only
if the <code class="language-plaintext highlighter-rouge">back_in_stock?</code> method returns true.</p>

<p>Active Record keeps track of changes to attributes so <code class="language-plaintext highlighter-rouge">back_in_stock?</code> checks
the previous value of <code class="language-plaintext highlighter-rouge">inventory_count</code> using <code class="language-plaintext highlighter-rouge">inventory_count_previously_was</code>.
Then we can compare that against the current inventory count to determine if the
product is back in stock.</p>

<p><code class="language-plaintext highlighter-rouge">notify_subscribers</code> uses the Active Record association to query the
<code class="language-plaintext highlighter-rouge">subscribers</code> table for all subscribers for this specific product and then
queues up the <code class="language-plaintext highlighter-rouge">in_stock</code> email to be sent to each of them.</p>

<h3 id="extracting-a-concern">Extracting a Concern</h3>

<p>The Product model now has a decent amount of code for handling notifications. To
better organize our code, we can extract this to an <code class="language-plaintext highlighter-rouge">ActiveSupport::Concern</code>. A
Concern is a Ruby module with some syntactic sugar to make using them easier.</p>

<p>First let’s create the Notifications module.</p>

<p>Create a file at <code class="language-plaintext highlighter-rouge">app/models/product/notifications.rb</code> with the following:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Product::Notifications</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">has_many</span> <span class="ss">:subscribers</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
    <span class="n">after_update_commit</span> <span class="ss">:notify_subscribers</span><span class="p">,</span> <span class="ss">if: :back_in_stock?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">back_in_stock?</span>
    <span class="n">inventory_count_previously_was</span><span class="p">.</span><span class="nf">zero?</span> <span class="o">&amp;&amp;</span> <span class="n">inventory_count</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">notify_subscribers</span>
    <span class="n">subscribers</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">subscriber</span><span class="o">|</span>
      <span class="no">ProductMailer</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">product: </span><span class="nb">self</span><span class="p">,</span> <span class="ss">subscriber: </span><span class="n">subscriber</span><span class="p">).</span><span class="nf">in_stock</span><span class="p">.</span><span class="nf">deliver_later</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When you include a module in a class, any code inside the <code class="language-plaintext highlighter-rouge">included</code> block runs
as if it’s part of that class. At the same time, the methods defined in the
module become regular methods you can call on objects (instances) of that class.</p>

<p>Now that the code triggering the notification has been extracted into the
Notification module, the Product model can be simplified to include the
Notifications module.</p>

<pre><code class="language-ruby#2">class Product &lt; ApplicationRecord
  include Notifications

  has_one_attached :featured_image
  has_rich_text :description

  validates :name, presence: true
  validates :inventory_count, numericality: { greater_than_or_equal_to: 0 }
end
</code></pre>

<p>Concerns are a great way to organize features of your Rails application. As you
add more features to the Product, the class will become messy. Instead, we can
use Concerns to extract each feature out into a self-contained module like
<code class="language-plaintext highlighter-rouge">Product::Notifications</code> which contains all the functionality for handling
subscribers and how notifications are sent.</p>

<p>Extracting code into concerns also helps make features reusable. For example, we
could introduce a new model that also needs subscriber notifications. This
module could be used in multiple models to provide the same functionality.</p>

<h3 id="unsubscribe-links">Unsubscribe Links</h3>

<p>A subscriber may want to unsubscribe at some point, so let’s build that next.</p>

<p>First, we need a route for unsubscribing that will be the URL we include in
emails.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">resource</span> <span class="ss">:unsubscribe</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span> <span class="ss">:show</span> <span class="p">]</span>
</code></pre></div></div>

<p>Active Record has a feature called <code class="language-plaintext highlighter-rouge">generates_token_for</code> that can generate
unique tokens to find database records for different purposes. We can use this
for generating a unique unsubscribe token to use in the email’s unsubscribe URL.</p>

<pre><code class="language-ruby#3">class Subscriber &lt; ApplicationRecord
  belongs_to :product
  generates_token_for :unsubscribe
end
</code></pre>

<p>Our controller will first look up the Subscriber record from the token in the
URL. Once the subscriber is found, it will destroy the record and redirect to
the homepage. Create <code class="language-plaintext highlighter-rouge">app/controllers/unsubscribes_controller.rb</code> and add the
following code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UnsubscribesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">allow_unauthenticated_access</span>
  <span class="n">before_action</span> <span class="ss">:set_subscriber</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@subscriber</span><span class="o">&amp;</span><span class="p">.</span><span class="nf">destroy</span>
    <span class="n">redirect_to</span> <span class="n">root_path</span><span class="p">,</span> <span class="ss">notice: </span><span class="s2">"Unsubscribed successfully."</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">set_subscriber</span>
    <span class="vi">@subscriber</span> <span class="o">=</span> <span class="no">Subscriber</span><span class="p">.</span><span class="nf">find_by_token_for</span><span class="p">(</span><span class="ss">:unsubscribe</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="ss">:token</span><span class="p">])</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Last but not least, let’s add the unsubscribe link to our email templates.</p>

<p>In <code class="language-plaintext highlighter-rouge">app/views/product_mailer/in_stock.html.erb</code>, add a <code class="language-plaintext highlighter-rouge">link_to</code>:</p>

<pre><code class="language-erb#5">&lt;h1&gt;Good news!&lt;/h1&gt;

&lt;p&gt;&lt;%= link_to @product.name, product_url(@product) %&gt; is back in stock.&lt;/p&gt;

&lt;%= link_to "Unsubscribe", unsubscribe_url(token: params[:subscriber].generate_token_for(:unsubscribe)) %&gt;
</code></pre>

<p>In <code class="language-plaintext highlighter-rouge">app/views/product_mailer/in_stock.text.erb</code>, add the URL in plain text:</p>

<pre><code class="language-erb#6">Good news!

&lt;%= @product.name %&gt; is back in stock.
&lt;%= product_url(@product) %&gt;

Unsubscribe: &lt;%= unsubscribe_url(token: params[:subscriber].generate_token_for(:unsubscribe)) %&gt;
</code></pre>

<p>When the unsubscribe link is clicked, the subscriber record will be deleted from
the database. The controller also safely handles invalid or expired tokens
without raising any errors.</p>

<p>Use the Rails console to send another email and test the unsubscribe link in the
logs.</p>

<h2 id="adding-css--javascript">Adding CSS &amp; JavaScript</h2>

<p>CSS &amp; JavaScript are core to building web applications, so let’s learn how to
use them with Rails.</p>

<h3 id="propshaft">Propshaft</h3>

<p>Rails’ asset pipeline is called Propshaft. It takes your CSS, JavaScript,
images, and other assets and serves them to your browser. In production,
Propshaft keeps track of each version of your assets so they can be cached to
make your pages faster. Check out the
<a href="asset_pipeline.html">Asset Pipeline guide</a> to learn more about how this works.</p>

<p>Let’s modify <code class="language-plaintext highlighter-rouge">app/assets/stylesheets/application.css</code> and change our font to
sans-serif.</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">body</span> <span class="p">{</span>
  <span class="nl">font-family</span><span class="p">:</span> <span class="n">Arial</span><span class="p">,</span> <span class="n">Helvetica</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">nav</span> <span class="p">{</span>
  <span class="nl">justify-content</span><span class="p">:</span> <span class="nb">flex-end</span><span class="p">;</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">flex</span><span class="p">;</span>
  <span class="nl">font-size</span><span class="p">:</span> <span class="m">0.875em</span><span class="p">;</span>
  <span class="nl">gap</span><span class="p">:</span> <span class="m">0.5rem</span><span class="p">;</span>
  <span class="nl">max-width</span><span class="p">:</span> <span class="m">1024px</span><span class="p">;</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span> <span class="nb">auto</span><span class="p">;</span>
  <span class="nl">padding</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">nav</span> <span class="nt">a</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">inline-block</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">main</span> <span class="p">{</span>
  <span class="nl">max-width</span><span class="p">:</span> <span class="m">1024px</span><span class="p">;</span>
  <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span> <span class="nb">auto</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.notice</span> <span class="p">{</span>
  <span class="nl">color</span><span class="p">:</span> <span class="nx">green</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">section</span><span class="nc">.product</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">flex</span><span class="p">;</span>
  <span class="nl">gap</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span>
  <span class="nl">flex-direction</span><span class="p">:</span> <span class="nb">row</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">section</span><span class="nc">.product</span> <span class="nt">img</span> <span class="p">{</span>
  <span class="nl">border-radius</span><span class="p">:</span> <span class="m">8px</span><span class="p">;</span>
  <span class="nl">flex-basis</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
  <span class="nl">max-width</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then we’ll update <code class="language-plaintext highlighter-rouge">app/views/products/show.html.erb</code> to use these new styles.</p>

<pre><code class="language-erb#1,3,6,18-19">&lt;p&gt;&lt;%= link_to "Back", products_path %&gt;&lt;/p&gt;

&lt;section class="product"&gt;
  &lt;%= image_tag @product.featured_image if @product.featured_image.attached? %&gt;

  &lt;section class="product-info"&gt;
    &lt;% cache @product do %&gt;
      &lt;h1&gt;&lt;%= @product.name %&gt;&lt;/h1&gt;
      &lt;%= @product.description %&gt;
    &lt;% end %&gt;

    &lt;%= render "inventory", product: @product %&gt;

    &lt;% if authenticated? %&gt;
      &lt;%= link_to "Edit", edit_product_path(@product) %&gt;
      &lt;%= button_to "Delete", @product, method: :delete, data: { turbo_confirm: "Are you sure?" } %&gt;
    &lt;% end %&gt;
  &lt;/section&gt;
&lt;/section&gt;
</code></pre>

<p>Refresh your page and you’ll see the CSS has been applied.</p>

<h3 id="import-maps">Import Maps</h3>

<p>Rails uses import maps for JavaScript by default. This allows you to write
modern JavaScript modules with no build steps.</p>

<p>You can find the JavaScript pins in <code class="language-plaintext highlighter-rouge">config/importmap.rb</code>. This file maps the
JavaScript package names with the source file which is used to generate the
importmap tag in the browser.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Pin npm packages by running ./bin/importmap</span>

<span class="n">pin</span> <span class="s2">"application"</span>
<span class="n">pin</span> <span class="s2">"@hotwired/turbo-rails"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"turbo.min.js"</span>
<span class="n">pin</span> <span class="s2">"@hotwired/stimulus"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"stimulus.min.js"</span>
<span class="n">pin</span> <span class="s2">"@hotwired/stimulus-loading"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"stimulus-loading.js"</span>
<span class="n">pin_all_from</span> <span class="s2">"app/javascript/controllers"</span><span class="p">,</span> <span class="ss">under: </span><span class="s2">"controllers"</span>
<span class="n">pin</span> <span class="s2">"trix"</span>
<span class="n">pin</span> <span class="s2">"@rails/actiontext"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"actiontext.esm.js"</span>
</code></pre></div></div>

<p>TIP: Each pin maps a JavaScript package name (e.g., <code class="language-plaintext highlighter-rouge">"@hotwired/turbo-rails"</code>)
to a specific file or URL (e.g., <code class="language-plaintext highlighter-rouge">"turbo.min.js"</code>). <code class="language-plaintext highlighter-rouge">pin_all_from</code> maps all
files in a directory (e.g., <code class="language-plaintext highlighter-rouge">app/javascript/controllers</code>) to a namespace (e.g.,
<code class="language-plaintext highlighter-rouge">"controllers"</code>).</p>

<p>Import maps keep the setup clean and minimal, while still supporting modern
JavaScript features.</p>

<p>What are these JavaScript files already in our import map? They are a frontend
framework called Hotwire that Rails uses by default.</p>

<h3 id="hotwire">Hotwire</h3>

<p>Hotwire is a JavaScript framework designed to take full advantage of server-side
generated HTML. It is comprised of 3 core components:</p>

<ol>
  <li><a href="https://turbo.hotwired.dev/"><strong>Turbo</strong></a> handles navigation, form
submissions, page components, and updates without writing any custom
JavaScript.</li>
  <li><a href="https://stimulus.hotwired.dev/"><strong>Stimulus</strong></a> provides a framework for when
you need custom JavaScript to add functionality to the page.</li>
  <li><a href="https://native.hotwired.dev/"><strong>Native</strong></a> allows you to make hybrid mobile
apps by embedding your web app and progressively enhancing it with native
mobile features.</li>
</ol>

<p>We haven’t written any JavaScript yet, but we have been using Hotwire on the
frontend. For instance, the form you created to add and edit a product was
powered by Turbo.</p>

<p>Learn more in the <a href="asset_pipeline.html">Asset Pipeline</a> and
<a href="working_with_javascript_in_rails.html">Working with JavaScript in Rails</a>
guides.</p>

<h2 id="testing">Testing</h2>

<p>Rails comes with a robust test suite. Let’s write a test to ensure that the
correct number of emails are sent when a product is back in stock.</p>

<h3 id="fixtures">Fixtures</h3>

<p>When you generate a model using Rails, it automatically creates a corresponding
fixture file in the <code class="language-plaintext highlighter-rouge">test/fixtures</code> directory.</p>

<p>Fixtures are predefined sets of data that populate your test database before
running tests. They allow you to define records with easy-to-remember names,
making it simple to access them in your tests.</p>

<p>This file will be empty by default - you need to populate it with fixtures for
your tests.</p>

<p>Let’s update the product fixtures file at <code class="language-plaintext highlighter-rouge">test/fixtures/products.yml</code> with the
following:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">tshirt</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">T-Shirt</span>
  <span class="na">inventory_count</span><span class="pi">:</span> <span class="m">15</span>
</code></pre></div></div>

<p>And for subscribers, let’s add these two fixtures to
<code class="language-plaintext highlighter-rouge">test/fixtures/subscribers.yml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">david</span><span class="pi">:</span>
  <span class="na">product</span><span class="pi">:</span> <span class="s">tshirt</span>
  <span class="na">email</span><span class="pi">:</span> <span class="s">david@example.org</span>

<span class="na">chris</span><span class="pi">:</span>
  <span class="na">product</span><span class="pi">:</span> <span class="s">tshirt</span>
  <span class="na">email</span><span class="pi">:</span> <span class="s">chris@example.org</span>
</code></pre></div></div>

<p>You’ll notice that we can reference the <code class="language-plaintext highlighter-rouge">Product</code> fixture by name here. Rails
associates this automatically for us in the database so we don’t have to manage
record IDs and associations in tests.</p>

<p>These fixtures will be automatically inserted into the database when we run our
test suite.</p>

<h3 id="testing-emails">Testing Emails</h3>

<p>In <code class="language-plaintext highlighter-rouge">test/models/product_test.rb</code>, let’s add a test:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestHelper</span>

  <span class="nb">test</span> <span class="s2">"sends email notifications when back in stock"</span> <span class="k">do</span>
    <span class="n">product</span> <span class="o">=</span> <span class="n">products</span><span class="p">(</span><span class="ss">:tshirt</span><span class="p">)</span>

    <span class="c1"># Set product out of stock</span>
    <span class="n">product</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">inventory_count: </span><span class="mi">0</span><span class="p">)</span>

    <span class="n">assert_emails</span> <span class="mi">2</span> <span class="k">do</span>
      <span class="n">product</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="ss">inventory_count: </span><span class="mi">99</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let’s break down what this test is doing.</p>

<p>First, we include the Action Mailer test helpers so we can monitor emails sent
during the test.</p>

<p>The <code class="language-plaintext highlighter-rouge">tshirt</code> fixture is loaded using the <code class="language-plaintext highlighter-rouge">products()</code> fixture helper and returns
the Active Record object for that record. Each fixture generates a helper in the
test suite to make it easy to reference fixtures by name since their database
IDs may be different each run.</p>

<p>Then we ensure the tshirt is out of stock by updating it’s inventory to 0.</p>

<p>Next, we use <code class="language-plaintext highlighter-rouge">assert_emails</code> to ensure 2 emails were generated by the code
inside the block. To trigger the emails, we update the product’s inventory count
inside the block. This triggers the <code class="language-plaintext highlighter-rouge">notify_subscribers</code> callback in the Product
model to send emails. Once that’s done executing, <code class="language-plaintext highlighter-rouge">assert_emails</code> counts the
emails and ensures it matches the expected count.</p>

<p>We can run the test suite with <code class="language-plaintext highlighter-rouge">bin/rails test</code> or an individual test file by
passing the filename.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/models/product_test.rb
Running 1 tests <span class="k">in </span>a single process <span class="o">(</span>parallelization threshold is 50<span class="o">)</span>
Run options: <span class="nt">--seed</span> 3556

<span class="c"># Running:</span>

<span class="nb">.</span>

Finished <span class="k">in </span>0.343842s, 2.9083 runs/s, 5.8166 assertions/s.
1 runs, 2 assertions, 0 failures, 0 errors, 0 skips
</code></pre></div></div>

<p>Our test passes!</p>

<p>Rails also generated an example test for <code class="language-plaintext highlighter-rouge">ProductMailer</code> at
<code class="language-plaintext highlighter-rouge">test/mailers/product_mailer_test.rb</code>. Let’s update it to make it also pass.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ProductMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"in_stock"</span> <span class="k">do</span>
    <span class="n">mail</span> <span class="o">=</span> <span class="no">ProductMailer</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">product: </span><span class="n">products</span><span class="p">(</span><span class="ss">:tshirt</span><span class="p">),</span> <span class="ss">subscriber: </span><span class="n">subscribers</span><span class="p">(</span><span class="ss">:david</span><span class="p">)).</span><span class="nf">in_stock</span>
    <span class="n">assert_equal</span> <span class="s2">"In stock"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">subject</span>
    <span class="n">assert_equal</span> <span class="p">[</span> <span class="s2">"david@example.org"</span> <span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">to</span>
    <span class="n">assert_equal</span> <span class="p">[</span> <span class="s2">"from@example.com"</span> <span class="p">],</span> <span class="n">mail</span><span class="p">.</span><span class="nf">from</span>
    <span class="n">assert_match</span> <span class="s2">"Good news!"</span><span class="p">,</span> <span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">encoded</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let’s run the entire test suite now and ensure all the tests pass.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test
</span>Running 2 tests <span class="k">in </span>a single process <span class="o">(</span>parallelization threshold is 50<span class="o">)</span>
Run options: <span class="nt">--seed</span> 16302

<span class="c"># Running:</span>

..

Finished <span class="k">in </span>0.665856s, 3.0037 runs/s, 10.5128 assertions/s.
2 runs, 7 assertions, 0 failures, 0 errors, 0 skips
</code></pre></div></div>

<p>You can use this as a starting place to continue building out a test suite with
full coverage of the application features.</p>

<p>Learn more about <a href="testing.html">Testing Rails Applications</a></p>

<h2 id="consistently-formatted-code-with-rubocop">Consistently Formatted Code with RuboCop</h2>

<p>When writing code we may sometimes use inconsistent formatting. Rails comes with
a linter called RuboCop that helps keep our code formatted consistently.</p>

<p>We can check our code for consistency by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rubocop
</code></pre></div></div>

<p>This will print out any offenses and tell you what they are.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Inspecting 53 files
.....................................................

53 files inspected, no offenses detected
</code></pre></div></div>

<p>RuboCop can automatically fix offenses using the <code class="language-plaintext highlighter-rouge">--autocorrect</code> flag (or its short version <code class="language-plaintext highlighter-rouge">-a</code>).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bin/rubocop -a
</code></pre></div></div>

<h2 id="security">Security</h2>

<p>Rails includes the Brakeman gem for checking security issues with your
application - vulnerabilities that can lead to attacks such as session
hijacking, session fixation, or redirection.</p>

<p>Run <code class="language-plaintext highlighter-rouge">bin/brakeman</code> and it will analyze your application and output a report.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/brakeman
Loading scanner...
...

<span class="o">==</span> Overview <span class="o">==</span>

Controllers: 6
Models: 6
Templates: 15
Errors: 0
Security Warnings: 0

<span class="o">==</span> Warning Types <span class="o">==</span>


No warnings found
</code></pre></div></div>

<p>Learn more about <a href="security.html">Securing Rails Applications</a></p>

<h2 id="continuous-integration-with-github-actions">Continuous Integration with GitHub Actions</h2>

<p>Rails apps generate a <code class="language-plaintext highlighter-rouge">.github</code> folder that includes a prewritten GitHub Actions
configuration that runs rubocop, brakeman, and our test suite.</p>

<p>When we push our code to a GitHub repository with GitHub Actions enabled, it
will automatically run these steps and report back success or failure for each.
This allows us to monitor our code changes for defects and issues and ensure
consistent quality for our work.</p>

<h2 id="deploying-to-production">Deploying to Production</h2>

<p>And now the fun part: let’s deploy your app.</p>

<p>Rails comes with a deployment tool called <a href="https://kamal-deploy.org">Kamal</a> that
we can use to deploy our application directly to a server. Kamal uses Docker
containers to run your application and deploy with zero downtime.</p>

<p>By default, Rails comes with a production-ready Dockerfile that Kamal will use
to build the Docker image, creating a containerized version of your application
with all its dependencies and configurations. This Dockerfile uses
<a href="https://github.com/basecamp/thruster">Thruster</a> to compress and serve assets
efficiently in production.</p>

<p>To deploy with Kamal, we need:</p>

<ul>
  <li>A server running Ubuntu LTS with 1GB RAM or more. The server should run the
Ubuntu operating system with a Long-Term Support (LTS) version so it receives
regular security and bug fixes. Hetzner, DigitalOcean, and other hosting
services provide servers to get started.</li>
  <li>A <a href="https://hub.docker.com">Docker Hub</a> account and access token. Docker Hub
stores the image of the application so it can be downloaded and run on the
server.</li>
</ul>

<p>On Docker Hub, <a href="https://hub.docker.com/repository/create">create a Repository</a>
for your application image. Use “store” as the name for the repository.</p>

<p>Open <code class="language-plaintext highlighter-rouge">config/deploy.yml</code> and replace <code class="language-plaintext highlighter-rouge">192.168.0.1</code> with your server’s IP address
and <code class="language-plaintext highlighter-rouge">your-user</code> with your Docker Hub username.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Name of your application. Used to uniquely configure containers.</span>
<span class="na">service</span><span class="pi">:</span> <span class="s">store</span>

<span class="c1"># Name of the container image.</span>
<span class="na">image</span><span class="pi">:</span> <span class="s">your-user/store</span>

<span class="c1"># Deploy to these servers.</span>
<span class="na">servers</span><span class="pi">:</span>
  <span class="na">web</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">192.168.0.1</span>

<span class="c1"># Credentials for your image host.</span>
<span class="na">registry</span><span class="pi">:</span>
  <span class="c1"># Specify the registry server, if you're not using Docker Hub</span>
  <span class="c1"># server: registry.digitalocean.com / ghcr.io / ...</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">your-user</span>
</code></pre></div></div>

<p>Under the <code class="language-plaintext highlighter-rouge">proxy:</code> section, you can add a domain to enable SSL for your
application too. Make sure your DNS record points to the server and Kamal will
use LetsEncrypt to issue an SSL certificate for the domain.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">proxy</span><span class="pi">:</span>
  <span class="na">ssl</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">app.example.com</span>
</code></pre></div></div>

<p><a href="https://app.docker.com/settings/personal-access-tokens/create">Create an access token</a>
with Read &amp; Write permissions on Docker’s website so Kamal can push the Docker
image for your application.</p>

<p>Then export the access token in the terminal so Kamal can find it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">KAMAL_REGISTRY_PASSWORD</span><span class="o">=</span>your-access-token
</code></pre></div></div>

<p>Run the following command to set up your server and deploy your application for
the first time.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/kamal setup
</code></pre></div></div>

<p>Congratulations! Your new Rails application is live and in production!</p>

<p>To view your new Rails app in action, open your browser and enter your server’s
IP address. You should see your store up and running.</p>

<p>After this, when you make changes to your app and want to push them to
production, you can run the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/kamal deploy
</code></pre></div></div>

<h3 id="adding-a-user-to-production">Adding a User to Production</h3>

<p>To create and edit products in production, we need a User record in the
production database.</p>

<p>You can use Kamal to open a production Rails console.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/kamal console
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">store</span><span class="p">(</span><span class="n">prod</span><span class="p">)</span><span class="o">&gt;</span> <span class="no">User</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">email_address: </span><span class="s2">"you@example.org"</span><span class="p">,</span> <span class="ss">password: </span><span class="s2">"s3cr3t"</span><span class="p">,</span> <span class="ss">password_confirmation: </span><span class="s2">"s3cr3t"</span><span class="p">)</span>
</code></pre></div></div>

<p>Now you can log in to production with this email and password and manage
products.</p>

<h3 id="background-jobs-using-solid-queue">Background Jobs using Solid Queue</h3>

<p>Background jobs allow you to run tasks asynchronously behind-the-scenes in a
separate process, preventing them from interrupting the user experience. Imagine
sending in stock emails to 10,000 recipients. It could take a while, so we can
offload that task to a background job to keep the Rails app responsive.</p>

<p>In development, Rails uses the <code class="language-plaintext highlighter-rouge">:async</code> queue adapter to process background jobs
with ActiveJob. Async stores pending jobs in memory but it will lose pending
jobs on restart. This is great for development, but not production.</p>

<p>To make background jobs more robust, Rails uses <code class="language-plaintext highlighter-rouge">solid_queue</code> for production
environments. Solid Queue stores jobs in the database and executes them in a
separate process.</p>

<p>Solid Queue is enabled for our production Kamal deployment using the
<code class="language-plaintext highlighter-rouge">SOLID_QUEUE_IN_PUMA: true</code> environment variable to <code class="language-plaintext highlighter-rouge">config/deploy.yml</code>. This
tells our web server, Puma, to start and stop the Solid Queue process
automatically.</p>

<p>When emails are sent with Action Mailer’s <code class="language-plaintext highlighter-rouge">deliver_later</code>, these emails will be
sent to Active Job for sending in the background so they don’t delay the HTTP
request. With Solid Queue in production, emails will be sent in the background,
automatically retried if they fail to send, and jobs are kept safe in the
database during restarts.</p>

<picture class="flowdiagram">
  <source srcset="images/getting_started/background_jobs_dark.jpg" media="(prefers-color-scheme:dark)" />
  <img src="images/getting_started/background_jobs_light.jpg" />
</picture>

<h2 id="whats-next">What’s Next?</h2>

<p>Congratulations on building and deploying your first Rails application!</p>

<p>We recommend continuing to add features and deploy updates to continue learning.
Here are some ideas:</p>

<ul>
  <li>Improve the design with CSS</li>
  <li>Add product reviews</li>
  <li>Finish translating the app into another language</li>
  <li>Add a checkout flow for payments</li>
  <li>Add wishlists for users to save products</li>
  <li>Add a carousel for product images</li>
</ul>

<p>We also recommend learning more by reading other Ruby on Rails Guides:</p>

<ul>
  <li><a href="active_record_basics.html">Active Record Basics</a></li>
  <li><a href="layouts_and_rendering.html">Layouts and Rendering in Rails</a></li>
  <li><a href="testing.html">Testing Rails Applications</a></li>
  <li><a href="debugging_rails_applications.html">Debugging Rails Applications</a></li>
  <li><a href="security.html">Securing Rails Applications</a></li>
</ul>

<p>Happy building!</p>
</div>

    <footer class="guide-footer">
      <div class="feedback">
        <h3>Geri Bildirim</h3>
        <p>
          Bu kılavuzun kalitesini artırmamıza yardımcı olmak için geri
          bildirimlerinizi bekliyoruz.
        </p>
        <p>
          Lütfen
          <a href="https://github.com/dilankaya127/rails-tr-TR"
            >GitHub Issues</a
          >
          üzerinden katkıda bulunun.
        </p>
      </div>
    </footer>
  </article>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toc = document.getElementById("toc");
    const headings = document.querySelectorAll(
      ".guide-content h2, .guide-content h3, .guide-content h4"
    );

    if (headings.length > 0) {
      const tocList = document.createElement("ul");
      const headingMap = new Map();

      headings.forEach(function (heading, index) {
        const id = "heading-" + index;
        heading.id = id;

        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = "#" + id;
        a.textContent = heading.textContent;
        a.className = "toc-" + heading.tagName.toLowerCase();

        li.appendChild(a);
        tocList.appendChild(li);

        headingMap.set(id, a);
      });

      toc.appendChild(tocList);

      // Başlıkların görünürlük oranlarını takip et
      const visibilityMap = new Map();

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const id = entry.target.getAttribute("id");
            visibilityMap.set(id, entry.intersectionRatio);
          });

          // En çok görünür olan başlığı bul
          let mostVisibleId = null;
          let maxRatio = 0;

          visibilityMap.forEach((ratio, id) => {
            if (ratio > maxRatio) {
              mostVisibleId = id;
              maxRatio = ratio;
            }
          });

          if (mostVisibleId) {
            headingMap.forEach((linkEl) => linkEl.classList.remove("active"));
            const activeLink = headingMap.get(mostVisibleId);
            if (activeLink) {
              activeLink.classList.add("active");

              // Ortalamak için:
              const linkTop = activeLink.offsetTop;
              const linkHeight = activeLink.offsetHeight;
              const tocScrollParent = toc;
              const tocHeight = tocScrollParent.offsetHeight;

              tocScrollParent.scrollTo({
                top: linkTop - tocHeight / 2 + linkHeight / 2,
                behavior: "smooth",
              });
            }
          }
        },
        {
          threshold: [0, 0.25, 0.5, 0.75, 1.0],
        }
      );

      headings.forEach((heading) => {
        observer.observe(heading);
      });

      const toggleBtn = document.getElementById("toc-toggle");
      const sidebar = document.querySelector(".guide-sidebar");

      toggleBtn.addEventListener("click", function () {
        sidebar.classList.toggle("open");
      });
      const closeBtn = document.querySelector(".toc-close");

      closeBtn?.addEventListener("click", function () {
        sidebar.classList.remove("open");
      });
    }
  });
</script>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Rails Kılavuzları Türkçe Çevirisi. Gönüllüler tarafından hazırlanmıştır.</p>
            <p>Orijinal dokümantasyon <a href="https://guides.rubyonrails.org">Ruby on Rails</a> ekibine aittir.</p>
        </div>
    </footer>

    <script>hljs.highlightAll();</script>
</body>
</html>