<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Active Record Encryption - Rails Dokümantasyonu - Türkçe
    </title>
    <link
      rel="stylesheet"
      href="/assets/css/rails.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css"
    />

    <link
      rel="icon"
      type="image/svg"
      href="/assets/images/logo_rails-circle.svg"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-Y6Q8S53SSQ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-Y6Q8S53SSQ");
    </script>
  </head>
  <body>
    <header class="header">
      <div class="container">
        <div class="header-content">
          <h1 class="logo">
            <a href="/rails/">
              <img
                src="/assets/images/logo_rails-circle.svg"
                alt="Rails Logo"
                class="logo-image"
              />
            </a>
          </h1>
          <nav class="nav">
            <a href="/">Ana Sayfa</a>
            <!-- <a href="https://dilankaya127.github.io">Portföy</a> -->

            <div class="dropdown">
              <a class="dropbtn">Kılavuzlar</a>
              <div class="dropdown-content multi-column">
                 
                <div class="dropdown-column">
                  <h4>Buradan Başlayın</h4>
                  
                  <a href="/rails/guides/tr/getting_started">Rails ile Başlarken</a>
                  
                  <a href="/rails/guides/tr/install_ruby_on_rails">Ruby on Rails İndirme Kılavuzu</a>
                  
                </div>
                      
                <div class="dropdown-column">
                  <h4>Controllers</h4>
                  
                  <a href="/rails/guides/tr/action_controller_overview">Action Controller</a>
                  
                </div>
                  
                <div class="dropdown-column">
                  <h4>Diğer Bileşenler</h4>
                  
                  <a href="/rails/guides/tr/action_cable_overview">Action Cable</a>
                  
                </div>
                               
              </div>
            </div>
            <a href="https://github.com/dilankaya127/rails-tr-TR">GitHub</a>
          </nav>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="container">
        <div class="guide-container">
  <button id="toc-toggle" class="toc-toggle">☰ İçindekiler</button>

  <aside class="guide-sidebar">
    <div class="guide-toc">
      <!-- <h3>İçindekiler</h3> -->
      <div id="toc"></div>
      <button class="toc-close" aria-label="İçindekileri Kapat">✕</button>
    </div>

    <!-- <div class="guide-nav">
            <h3>Diğer(Tüm) Kılavuzlar</h3>
            <ul>
                <li><a href="/rails/guides/tr/getting_started">Rails ile Başlarken</a></li>
                <li><a href="/rails/guides/en/active_record_basics">Active Record Temelleri</a></li>
                <li><a href="/rails/guides//en/action_controller_overview">Action Controller</a></li>
                <li><a href="/rails/guides/tr/action_cable_overview">Action Cable</a></li>
            </ul>
        </div> -->
  </aside>

  <article class="guide-content">
    <!-- <header class="guide-header">
            <h1>Active Record Encryption</h1>
            
        </header> -->

    <div class="guide-body"><p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1 id="active-record-encryption">Active Record Encryption</h1>

<p>This guide covers encrypting your database information using Active Record.</p>

<p>After reading this guide, you will know:</p>

<ul>
  <li>How to set up database encryption with Active Record.</li>
  <li>How to migrate unencrypted data.</li>
  <li>How to make different encryption schemes coexist.</li>
  <li>How to use the API.</li>
  <li>How to configure the library and how to extend it.</li>
</ul>

<hr />

<p>Active Record supports application-level encryption. It works by declaring which attributes should be encrypted and seamlessly encrypting and decrypting them when necessary. The encryption layer sits between the database and the application. The application will access unencrypted data, but the database will store it encrypted.</p>

<h2 id="why-encrypt-data-at-the-application-level">Why Encrypt Data at the Application Level?</h2>

<p>Active Record Encryption exists to protect sensitive information in your application. A typical example is personally identifiable information from users. But why would you want application-level encryption if you are already encrypting your database at rest?</p>

<p>As an immediate practical benefit, encrypting sensitive attributes adds an additional security layer. For example, if an attacker gained access to your database, a snapshot of it, or your application logs, they wouldn’t be able to make sense of the encrypted information. Additionally, encryption can prevent developers from unintentionally exposing users’ sensitive data in application logs.</p>

<p>But more importantly, by using Active Record Encryption, you define what constitutes sensitive information in your application at the code level. Active Record Encryption enables granular control of data access in your application and services consuming data from your application. For example, consider <a href="https://github.com/basecamp/console1984">auditable Rails consoles that protect encrypted data</a> or check the built-in system to <a href="#filtering-params-named-as-encrypted-columns">filter controller params automatically</a>.</p>

<h2 id="basic-usage">Basic Usage</h2>

<h3 id="setup">Setup</h3>

<p>Run <code class="language-plaintext highlighter-rouge">bin/rails db:encryption:init</code> to generate a random key set:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails db:encryption:init
Add this entry to the credentials of the target environment:

active_record_encryption:
  primary_key: EGY8WhulUOXixybod7ZWwMIL68R9o5kC
  deterministic_key: aPA5XyALhf75NNnMzaspW7akTfZp0lPY
  key_derivation_salt: xEY0dt6TZcAMg52K7O84wYzkjvbA62Hz
</code></pre></div></div>

<p>These values can be stored by copying and pasting the generated values into your existing <a href="/security.html#custom-credentials">Rails credentials</a>. Alternatively, these values can be configured from other sources, such as environment variables:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY"</span><span class="p">]</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">deterministic_key</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"ACTIVE_RECORD_ENCRYPTION_DETERMINISTIC_KEY"</span><span class="p">]</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">key_derivation_salt</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT"</span><span class="p">]</span>
</code></pre></div></div>

<p>NOTE: These generated values are 32 bytes in length. If you generate these yourself, the minimum lengths you should use are 12 bytes for the primary key (this will be used to derive the AES 32 bytes key) and 20 bytes for the salt.</p>

<h3 id="declaration-of-encrypted-attributes">Declaration of Encrypted Attributes</h3>

<p>Encryptable attributes are defined at the model level. These are regular Active Record attributes backed by a column with the same name.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">encrypts</span> <span class="ss">:title</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The library will transparently encrypt these attributes before saving them in the database and will decrypt them upon retrieval:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span> <span class="ss">title: </span><span class="s2">"Encrypt it all!"</span>
<span class="n">article</span><span class="p">.</span><span class="nf">title</span> <span class="c1"># =&gt; "Encrypt it all!"</span>
</code></pre></div></div>

<p>But, under the hood, the executed SQL looks like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">`articles`</span> <span class="p">(</span><span class="nv">`title`</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'{</span><span class="se">\"</span><span class="s1">p</span><span class="se">\"</span><span class="s1">:</span><span class="se">\"</span><span class="s1">n7J0/ol+a7DRMeaE</span><span class="se">\"</span><span class="s1">,</span><span class="se">\"</span><span class="s1">h</span><span class="se">\"</span><span class="s1">:{</span><span class="se">\"</span><span class="s1">iv</span><span class="se">\"</span><span class="s1">:</span><span class="se">\"</span><span class="s1">DXZMDWUKfp3bg/Yu</span><span class="se">\"</span><span class="s1">,</span><span class="se">\"</span><span class="s1">at</span><span class="se">\"</span><span class="s1">:</span><span class="se">\"</span><span class="s1">X1/YjMHbHD4talgF9dt61A==</span><span class="se">\"</span><span class="s1">}}'</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="important-about-storage-and-column-size">Important: About Storage and Column Size</h4>

<p>Encryption requires extra space because of Base64 encoding and the metadata stored along with the encrypted payloads. When using the built-in envelope encryption key provider, you can estimate the worst-case overhead at around 255 bytes. This overhead is negligible at larger sizes. Not only because it gets diluted but because the library uses compression by default, which can offer up to 30% storage savings over the unencrypted version for larger payloads.</p>

<p>There is an important concern about string column sizes: in modern databases the column size determines the <em>number of characters</em> it can allocate, not the number of bytes. For example, with UTF-8, each character can take up to four bytes, so, potentially, a column in a database using UTF-8 can store up to four times its size in terms of <em>number of bytes</em>. Now, encrypted payloads are binary strings serialized as Base64, so they can be stored in regular <code class="language-plaintext highlighter-rouge">string</code> columns. Because they are a sequence of ASCII bytes, an encrypted column can take up to four times its clear version size. So, even if the bytes stored in the database are the same, the column must be four times bigger.</p>

<p>In practice, this means:</p>

<ul>
  <li>When encrypting short texts written in Western alphabets (mostly ASCII characters), you should account for that 255 additional overhead when defining the column size.</li>
  <li>When encrypting short texts written in non-Western alphabets, such as Cyrillic, you should multiply the column size by 4. Notice that the storage overhead is 255 bytes at most.</li>
  <li>When encrypting long texts, you can ignore column size concerns.</li>
</ul>

<p>Some examples:</p>

<table>
  <thead>
    <tr>
      <th>Content to encrypt</th>
      <th>Original column size</th>
      <th>Recommended encrypted column size</th>
      <th>Storage overhead (worst case)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Email addresses</td>
      <td>string(255)</td>
      <td>string(510)</td>
      <td>255 bytes</td>
    </tr>
    <tr>
      <td>Short sequence of emojis</td>
      <td>string(255)</td>
      <td>string(1020)</td>
      <td>255 bytes</td>
    </tr>
    <tr>
      <td>Summary of texts written in non-western alphabets</td>
      <td>string(500)</td>
      <td>string(2000)</td>
      <td>255 bytes</td>
    </tr>
    <tr>
      <td>Arbitrary long text</td>
      <td>text</td>
      <td>text</td>
      <td>negligible</td>
    </tr>
  </tbody>
</table>

<h3 id="deterministic-and-non-deterministic-encryption">Deterministic and Non-deterministic Encryption</h3>

<p>By default, Active Record Encryption uses a non-deterministic approach to encryption. Non-deterministic, in this context, means that encrypting the same content with the same password twice will result in different ciphertexts. This approach improves security by making crypto-analysis of ciphertexts harder, and querying the database impossible.</p>

<p>You can use the <code class="language-plaintext highlighter-rouge">deterministic:</code>  option to generate initialization vectors in a deterministic way, effectively enabling querying encrypted data.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">encrypts</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">deterministic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="no">Author</span><span class="p">.</span><span class="nf">find_by_email</span><span class="p">(</span><span class="s2">"some@email.com"</span><span class="p">)</span> <span class="c1"># You can query the model normally</span>
</code></pre></div></div>

<p>The non-deterministic approach is recommended unless you need to query the data.</p>

<p>NOTE: In non-deterministic mode, Active Record uses AES-GCM with a 256-bits key and a random initialization vector. In deterministic mode, it also uses AES-GCM, but the initialization vector is generated as an HMAC-SHA-256 digest of the key and contents to encrypt.</p>

<p>NOTE: You can disable deterministic encryption by omitting a <code class="language-plaintext highlighter-rouge">deterministic_key</code>.</p>

<h2 id="features">Features</h2>

<h3 id="action-text">Action Text</h3>

<p>You can encrypt Action Text attributes by passing <code class="language-plaintext highlighter-rouge">encrypted: true</code> in their declaration.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_rich_text</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">encrypted: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>NOTE: Passing individual encryption options to Action Text attributes is not supported yet. It will use non-deterministic encryption with the global encryption options configured.</p>

<h3 id="fixtures">Fixtures</h3>

<p>You can get Rails fixtures encrypted automatically by adding this option to your <code class="language-plaintext highlighter-rouge">test.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">encrypt_fixtures</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<p>When enabled, all the encryptable attributes will be encrypted according to the encryption settings defined in the model.</p>

<h4 id="action-text-fixtures">Action Text Fixtures</h4>

<p>To encrypt Action Text fixtures, you should place them in <code class="language-plaintext highlighter-rouge">fixtures/action_text/encrypted_rich_texts.yml</code>.</p>

<h3 id="supported-types">Supported Types</h3>

<p><code class="language-plaintext highlighter-rouge">active_record.encryption</code> will serialize values using the underlying type before encrypting them, but, unless using a custom <code class="language-plaintext highlighter-rouge">message_serializer</code>, <em>they must be serializable as strings</em>. Structured types like <code class="language-plaintext highlighter-rouge">serialized</code> are supported out of the box.</p>

<p>If you need to support a custom type, the recommended way is to use a <a href="https://api.rubyonrails.org/classes/ActiveRecord/AttributeMethods/Serialization/ClassMethods.html">serialized attribute</a>. The declaration of the serialized attribute should go <strong>before</strong> the encryption declaration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># CORRECT</span>
<span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">serialize</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Title</span>
  <span class="n">encrypts</span> <span class="ss">:title</span>
<span class="k">end</span>

<span class="c1"># INCORRECT</span>
<span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">encrypts</span> <span class="ss">:title</span>
  <span class="n">serialize</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Title</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="ignoring-case">Ignoring Case</h3>

<p>You might need to ignore casing when querying deterministically encrypted data. Two approaches make accomplishing this easier:</p>

<p>You can use the <code class="language-plaintext highlighter-rouge">:downcase</code> option when declaring the encrypted attribute to downcase the content before encryption occurs.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span>
  <span class="n">encrypts</span> <span class="ss">:email_address</span><span class="p">,</span> <span class="ss">deterministic: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">downcase: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When using <code class="language-plaintext highlighter-rouge">:downcase</code>, the original case is lost. In some situations, you might want to ignore the case only when querying while also storing the original case. For those situations, you can use the option <code class="language-plaintext highlighter-rouge">:ignore_case</code>. This requires you to add a new column named <code class="language-plaintext highlighter-rouge">original_&lt;column_name&gt;</code> to store the content with the case unchanged:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Label</span>
  <span class="n">encrypts</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">deterministic: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">ignore_case: </span><span class="kp">true</span> <span class="c1"># the content with the original case will be stored in the column `original_name`</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="support-for-unencrypted-data">Support for Unencrypted Data</h3>

<p>To ease migrations of unencrypted data, the library includes the option <code class="language-plaintext highlighter-rouge">config.active_record.encryption.support_unencrypted_data</code>. When set to <code class="language-plaintext highlighter-rouge">true</code>:</p>

<ul>
  <li>Trying to read encrypted attributes that are not encrypted will work normally, without raising any error.</li>
  <li>Queries with deterministically encrypted attributes will include the “clear text” version of them to support finding both encrypted and unencrypted content. You need to set <code class="language-plaintext highlighter-rouge">config.active_record.encryption.extend_queries = true</code> to enable this.</li>
</ul>

<p><strong>This option is meant to be used during transition periods</strong> while clear data and encrypted data must coexist. Both are set to <code class="language-plaintext highlighter-rouge">false</code> by default, which is the recommended goal for any application: errors will be raised when working with unencrypted data.</p>

<h3 id="support-for-previous-encryption-schemes">Support for Previous Encryption Schemes</h3>

<p>Changing encryption properties of attributes can break existing data. For example, imagine you want to make a deterministic attribute non-deterministic. If you just change the declaration in the model, reading existing ciphertexts will fail because the encryption method is different now.</p>

<p>To support these situations, you can declare previous encryption schemes that will be used in two scenarios:</p>

<ul>
  <li>When reading encrypted data, Active Record Encryption will try previous encryption schemes if the current scheme doesn’t work.</li>
  <li>When querying deterministic data, it will add ciphertexts using previous schemes so that queries work seamlessly with data encrypted with different schemes. You must set <code class="language-plaintext highlighter-rouge">config.active_record.encryption.extend_queries = true</code> to enable this.</li>
</ul>

<p>You can configure previous encryption schemes:</p>

<ul>
  <li>Globally</li>
  <li>On a per-attribute basis</li>
</ul>

<h4 id="global-previous-encryption-schemes">Global Previous Encryption Schemes</h4>

<p>You can add previous encryption schemes by adding them as a list of properties using the <code class="language-plaintext highlighter-rouge">previous</code> config property in your <code class="language-plaintext highlighter-rouge">application.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">previous</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span> <span class="ss">key_provider: </span><span class="no">MyOldKeyProvider</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span> <span class="p">]</span>
</code></pre></div></div>

<h4 id="per-attribute-encryption-schemes">Per-attribute Encryption Schemes</h4>

<p>Use <code class="language-plaintext highlighter-rouge">:previous</code> when declaring the attribute:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Article</span>
  <span class="n">encrypts</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">deterministic: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">previous: </span><span class="p">{</span> <span class="ss">deterministic: </span><span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="encryption-schemes-and-deterministic-attributes">Encryption Schemes and Deterministic Attributes</h4>

<p>When adding previous encryption schemes:</p>

<ul>
  <li>With <strong>non-deterministic encryption</strong>, new information will always be encrypted with the <em>newest</em> (current) encryption scheme.</li>
  <li>With <strong>deterministic encryption</strong>, new information will always be encrypted with the <em>oldest</em> encryption scheme by default.</li>
</ul>

<p>Typically, with deterministic encryption, you want ciphertexts to remain constant. You can change this behavior by setting <code class="language-plaintext highlighter-rouge">deterministic: { fixed: false }</code>. In that case, it will use the <em>newest</em> encryption scheme for encrypting new data.</p>

<h3 id="unique-constraints">Unique Constraints</h3>

<p>NOTE: Unique constraints can only be used with deterministically encrypted data.</p>

<h4 id="unique-validations">Unique Validations</h4>

<p>Unique validations are supported normally as long as extended queries are enabled (<code class="language-plaintext highlighter-rouge">config.active_record.encryption.extend_queries = true</code>).</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span>
  <span class="n">validates</span> <span class="ss">:email_address</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
  <span class="n">encrypts</span> <span class="ss">:email_address</span><span class="p">,</span> <span class="ss">deterministic: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">downcase: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>They will also work when combining encrypted and unencrypted data, and when configuring previous encryption schemes.</p>

<p>NOTE: If you want to ignore case, make sure to use <code class="language-plaintext highlighter-rouge">downcase:</code> or <code class="language-plaintext highlighter-rouge">ignore_case:</code> in the <code class="language-plaintext highlighter-rouge">encrypts</code> declaration. Using the <code class="language-plaintext highlighter-rouge">case_sensitive:</code> option in the validation won’t work.</p>

<h4 id="unique-indexes">Unique Indexes</h4>

<p>To support unique indexes on deterministically encrypted columns, you need to ensure their ciphertext doesn’t ever change.</p>

<p>To encourage this, deterministic attributes will always use the oldest available encryption scheme by default when multiple encryption schemes are configured. Otherwise, it’s your job to ensure encryption properties don’t change for these attributes, or the unique indexes won’t work.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span>
  <span class="n">encrypts</span> <span class="ss">:email_address</span><span class="p">,</span> <span class="ss">deterministic: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="filtering-params-named-as-encrypted-columns">Filtering Params Named as Encrypted Columns</h3>

<p>By default, encrypted columns are configured to be <a href="configuring.html#config-filter-parameters">automatically filtered in Rails logs</a>. You can disable this behavior by adding the following to your <code class="language-plaintext highlighter-rouge">application.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">add_to_filter_parameters</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre></div></div>

<p>If filtering is enabled, but you want to exclude specific columns from automatic filtering, add them to <code class="language-plaintext highlighter-rouge">config.active_record.encryption.excluded_from_filter_parameters</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">excluded_from_filter_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="ss">:catchphrase</span><span class="p">]</span>
</code></pre></div></div>

<p>When generating the filter parameter, Rails will use the model name as a prefix. E.g: For <code class="language-plaintext highlighter-rouge">Person#name</code>, the filter parameter will be <code class="language-plaintext highlighter-rouge">person.name</code>.</p>

<h3 id="encoding">Encoding</h3>

<p>The library will preserve the encoding for string values encrypted non-deterministically.</p>

<p>Because encoding is stored along with the encrypted payload, values encrypted deterministically will force UTF-8 encoding by default. Therefore the same value with a different encoding will result in a different ciphertext when encrypted. You usually want to avoid this to keep queries and uniqueness constraints working, so the library will perform the conversion automatically on your behalf.</p>

<p>You can configure the desired default encoding for deterministic encryption with:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">forced_encoding_for_deterministic_encryption</span> <span class="o">=</span> <span class="no">Encoding</span><span class="o">::</span><span class="no">US_ASCII</span>
</code></pre></div></div>

<p>And you can disable this behavior and preserve the encoding in all cases with:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">forced_encoding_for_deterministic_encryption</span> <span class="o">=</span> <span class="kp">nil</span>
</code></pre></div></div>

<h3 id="compression">Compression</h3>

<p>The library compresses encrypted payloads by default. This can save up to 30% of the storage space for larger payloads. You can disable compression by setting <code class="language-plaintext highlighter-rouge">compress: false</code> for encrypted attributes:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">encrypts</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">compress: </span><span class="kp">false</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can also configure the algorithm used for the compression. The default compressor is <code class="language-plaintext highlighter-rouge">Zlib</code>. You can implement your own compressor by creating a class or module that responds to <code class="language-plaintext highlighter-rouge">#deflate(data)</code> and <code class="language-plaintext highlighter-rouge">#inflate(data)</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"zstd-ruby"</span>

<span class="k">module</span> <span class="nn">ZstdCompressor</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">deflate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="no">Zstd</span><span class="p">.</span><span class="nf">compress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">inflate</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="no">Zstd</span><span class="p">.</span><span class="nf">decompress</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">User</span>
  <span class="n">encrypts</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">compressor: </span><span class="no">ZstdCompressor</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can configure the compressor globally:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">compressor</span> <span class="o">=</span> <span class="no">ZstdCompressor</span>
</code></pre></div></div>

<h2 id="key-management">Key Management</h2>

<p>Key providers implement key management strategies. You can configure key providers globally or on a per-attribute basis.</p>

<h3 id="built-in-key-providers">Built-in Key Providers</h3>

<h4 id="derivedsecretkeyprovider">DerivedSecretKeyProvider</h4>

<p>A key provider that will serve keys derived from the provided passwords using PBKDF2.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">key_provider</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Encryption</span><span class="o">::</span><span class="no">DerivedSecretKeyProvider</span><span class="p">.</span><span class="nf">new</span><span class="p">([</span><span class="s2">"some passwords"</span><span class="p">,</span> <span class="s2">"to derive keys from. "</span><span class="p">,</span> <span class="s2">"These should be in"</span><span class="p">,</span> <span class="s2">"credentials"</span><span class="p">])</span>
</code></pre></div></div>

<p>NOTE: By default, <code class="language-plaintext highlighter-rouge">active_record.encryption</code> configures a <code class="language-plaintext highlighter-rouge">DerivedSecretKeyProvider</code> with the keys defined in <code class="language-plaintext highlighter-rouge">active_record.encryption.primary_key</code>.</p>

<h4 id="envelopeencryptionkeyprovider">EnvelopeEncryptionKeyProvider</h4>

<p>Implements a simple <a href="https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#enveloping">envelope encryption</a> strategy:</p>

<ul>
  <li>It generates a random key for each data-encryption operation</li>
  <li>It stores the data-key with the data itself, encrypted with a primary key defined in the credential <code class="language-plaintext highlighter-rouge">active_record.encryption.primary_key</code>.</li>
</ul>

<p>You can configure Active Record to use this key provider by adding this to your <code class="language-plaintext highlighter-rouge">application.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">key_provider</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Encryption</span><span class="o">::</span><span class="no">EnvelopeEncryptionKeyProvider</span><span class="p">.</span><span class="nf">new</span>
</code></pre></div></div>

<p>As with other built-in key providers, you can provide a list of primary keys in <code class="language-plaintext highlighter-rouge">active_record.encryption.primary_key</code> to implement key-rotation schemes.</p>

<h3 id="custom-key-providers">Custom Key Providers</h3>

<p>For more advanced key-management schemes, you can configure a custom key provider in an initializer:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Encryption</span><span class="p">.</span><span class="nf">key_provider</span> <span class="o">=</span> <span class="no">MyKeyProvider</span><span class="p">.</span><span class="nf">new</span>
</code></pre></div></div>

<p>A key provider must implement this interface:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyKeyProvider</span>
  <span class="k">def</span> <span class="nf">encryption_key</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">decryption_keys</span><span class="p">(</span><span class="n">encrypted_message</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Both methods return <code class="language-plaintext highlighter-rouge">ActiveRecord::Encryption::Key</code> objects:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">encryption_key</code> returns the key used for encrypting some content</li>
  <li><code class="language-plaintext highlighter-rouge">decryption_keys</code> returns a list of potential keys for decrypting a given message</li>
</ul>

<p>A key can include arbitrary tags that will be stored unencrypted with the message. You can use <code class="language-plaintext highlighter-rouge">ActiveRecord::Encryption::Message#headers</code> to examine those values when decrypting.</p>

<h3 id="attribute-specific-key-providers">Attribute-specific Key Providers</h3>

<p>You can configure a key provider on a per-attribute basis with the <code class="language-plaintext highlighter-rouge">:key_provider</code> option:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">encrypts</span> <span class="ss">:summary</span><span class="p">,</span> <span class="ss">key_provider: </span><span class="no">ArticleKeyProvider</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="attribute-specific-keys">Attribute-specific Keys</h3>

<p>You can configure a given key on a per-attribute basis with the <code class="language-plaintext highlighter-rouge">:key</code> option:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">encrypts</span> <span class="ss">:summary</span><span class="p">,</span> <span class="ss">key: </span><span class="s2">"some secret key for article summaries"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Active Record uses the key to derive the key used to encrypt and decrypt the data.</p>

<h3 id="rotating-keys">Rotating Keys</h3>

<p><code class="language-plaintext highlighter-rouge">active_record.encryption</code> can work with lists of keys to support implementing key-rotation schemes:</p>

<ul>
  <li>The <strong>last key</strong> will be used for encrypting new content.</li>
  <li>All the keys will be tried when decrypting content until one works.</li>
</ul>

<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">active_record_encryption</span><span class="pi">:</span>
  <span class="na">primary_key</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">a1cc4d7b9f420e40a337b9e68c5ecec6</span> <span class="c1"># Previous keys can still decrypt existing content</span>
    <span class="pi">-</span> <span class="s">bc17e7b413fd4720716a7633027f8cc4</span> <span class="c1"># Active, encrypts new content</span>
  <span class="na">key_derivation_salt</span><span class="pi">:</span> <span class="s">a3226b97b3b2f8372d1fc6d497a0c0d3</span>
</code></pre></div></div>

<p>This enables workflows in which you keep a short list of keys by adding new keys, re-encrypting content, and deleting old keys.</p>

<p>NOTE: Rotating keys is not currently supported for deterministic encryption.</p>

<p>NOTE: Active Record Encryption doesn’t provide automatic management of key rotation processes yet. All the pieces are there, but this hasn’t been implemented yet.</p>

<h3 id="storing-key-references">Storing Key References</h3>

<p>You can configure <code class="language-plaintext highlighter-rouge">active_record.encryption.store_key_references</code> to make <code class="language-plaintext highlighter-rouge">active_record.encryption</code> store a reference to the encryption key in the encrypted message itself.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">store_key_references</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<p>Doing so makes for more performant decryption because the system can now locate keys directly instead of trying lists of keys. The price to pay is storage: encrypted data will be a bit bigger.</p>

<h2 id="api">API</h2>

<h3 id="basic-api">Basic API</h3>

<p>ActiveRecord encryption is meant to be used declaratively, but it offers an API for advanced usage scenarios.</p>

<h4 id="encrypt-and-decrypt">Encrypt and Decrypt</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">article</span><span class="p">.</span><span class="nf">encrypt</span> <span class="c1"># encrypt or re-encrypt all the encryptable attributes</span>
<span class="n">article</span><span class="p">.</span><span class="nf">decrypt</span> <span class="c1"># decrypt all the encryptable attributes</span>
</code></pre></div></div>

<h4 id="read-ciphertext">Read Ciphertext</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">article</span><span class="p">.</span><span class="nf">ciphertext_for</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="check-if-the-attribute-is-encrypted-or-not">Check if the Attribute is Encrypted or Not</h4>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">article</span><span class="p">.</span><span class="nf">encrypted_attribute?</span><span class="p">(</span><span class="ss">:title</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="configuration">Configuration</h2>

<h3 id="configuration-options">Configuration Options</h3>

<p>You can configure Active Record Encryption options in your <code class="language-plaintext highlighter-rouge">application.rb</code> (most common scenario) or in a specific environment config file <code class="language-plaintext highlighter-rouge">config/environments/&lt;env name&gt;.rb</code> if you want to set them on a per-environment basis.</p>

<p>WARNING: It’s recommended to use Rails built-in credentials support to store keys. If you prefer to set them manually via config properties, make sure you don’t commit them with your code (e.g. use environment variables).</p>

<h4 id="configactive_recordencryptionsupport_unencrypted_data"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.support_unencrypted_data</code></h4>

<p>When true, unencrypted data can be read normally. When false, it will raise errors. Default: <code class="language-plaintext highlighter-rouge">false</code>.</p>

<h4 id="configactive_recordencryptionextend_queries"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.extend_queries</code></h4>

<p>When true, queries referencing deterministically encrypted attributes will be modified to include additional values if needed. Those additional values will be the clean version of the value (when <code class="language-plaintext highlighter-rouge">config.active_record.encryption.support_unencrypted_data</code> is true) and values encrypted with previous encryption schemes, if any (as provided with the <code class="language-plaintext highlighter-rouge">previous:</code> option). Default: <code class="language-plaintext highlighter-rouge">false</code> (experimental).</p>

<h4 id="configactive_recordencryptionencrypt_fixtures"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.encrypt_fixtures</code></h4>

<p>When true, encryptable attributes in fixtures will be automatically encrypted when loaded. Default: <code class="language-plaintext highlighter-rouge">false</code>.</p>

<h4 id="configactive_recordencryptionstore_key_references"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.store_key_references</code></h4>

<p>When true, a reference to the encryption key is stored in the headers of the encrypted message. This makes for faster decryption when multiple keys are in use. Default: <code class="language-plaintext highlighter-rouge">false</code>.</p>

<h4 id="configactive_recordencryptionadd_to_filter_parameters"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.add_to_filter_parameters</code></h4>

<p>When true, encrypted attribute names are added automatically to <a href="configuring.html#config-filter-parameters"><code class="language-plaintext highlighter-rouge">config.filter_parameters</code></a> and won’t be shown in logs. Default: <code class="language-plaintext highlighter-rouge">true</code>.</p>

<h4 id="configactive_recordencryptionexcluded_from_filter_parameters"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.excluded_from_filter_parameters</code></h4>

<p>You can configure a list of params that won’t be filtered out when <code class="language-plaintext highlighter-rouge">config.active_record.encryption.add_to_filter_parameters</code> is true. Default: <code class="language-plaintext highlighter-rouge">[]</code>.</p>

<h4 id="configactive_recordencryptionvalidate_column_size"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.validate_column_size</code></h4>

<p>Adds a validation based on the column size. This is recommended to prevent storing huge values using highly compressible payloads. Default: <code class="language-plaintext highlighter-rouge">true</code>.</p>

<h4 id="configactive_recordencryptionprimary_key"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.primary_key</code></h4>

<p>The key or lists of keys used to derive root data-encryption keys. The way they are used depends on the key provider configured. It’s preferred to configure it via the <code class="language-plaintext highlighter-rouge">active_record_encryption.primary_key</code> credential.</p>

<h4 id="configactive_recordencryptiondeterministic_key"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.deterministic_key</code></h4>

<p>The key or list of keys used for deterministic encryption. It’s preferred to configure it via the <code class="language-plaintext highlighter-rouge">active_record_encryption.deterministic_key</code> credential.</p>

<h4 id="configactive_recordencryptionkey_derivation_salt"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.key_derivation_salt</code></h4>

<p>The salt used when deriving keys. It’s preferred to configure it via the <code class="language-plaintext highlighter-rouge">active_record_encryption.key_derivation_salt</code> credential.</p>

<h4 id="configactive_recordencryptionforced_encoding_for_deterministic_encryption"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.forced_encoding_for_deterministic_encryption</code></h4>

<p>The default encoding for attributes encrypted deterministically. You can disable forced encoding by setting this option to <code class="language-plaintext highlighter-rouge">nil</code>. It’s <code class="language-plaintext highlighter-rouge">Encoding::UTF_8</code> by default.</p>

<h4 id="configactive_recordencryptionhash_digest_class"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.hash_digest_class</code></h4>

<p>The digest algorithm used to derive keys. <code class="language-plaintext highlighter-rouge">OpenSSL::Digest::SHA256</code> by default.</p>

<h4 id="configactive_recordencryptionsupport_sha1_for_non_deterministic_encryption"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.support_sha1_for_non_deterministic_encryption</code></h4>

<p>Supports decrypting data encrypted non-deterministically with a digest class SHA1. The default is false, which
means it will only support the digest algorithm configured in <code class="language-plaintext highlighter-rouge">config.active_record.encryption.hash_digest_class</code>.</p>

<h4 id="configactive_recordencryptioncompressor"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.compressor</code></h4>

<p>The compressor used to compress encrypted payloads. It should respond to <code class="language-plaintext highlighter-rouge">deflate</code> and <code class="language-plaintext highlighter-rouge">inflate</code>. The default is <code class="language-plaintext highlighter-rouge">Zlib</code>. You can find more information about compressors in the <a href="#compression">Compression</a> section.</p>

<h3 id="encryption-contexts">Encryption Contexts</h3>

<p>An encryption context defines the encryption components that are used in a given moment. There is a default encryption context based on your global configuration, but you can configure a custom context for a given attribute or when running a specific block of code.</p>

<p>NOTE: Encryption contexts are a flexible but advanced configuration mechanism. Most users should not have to care about them.</p>

<p>The main components of encryption contexts are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">encryptor</code>: exposes the internal API for encrypting and decrypting data.  It interacts with a <code class="language-plaintext highlighter-rouge">key_provider</code> to build encrypted messages and deal with their serialization. The encryption/decryption itself is done by the <code class="language-plaintext highlighter-rouge">cipher</code> and the serialization by <code class="language-plaintext highlighter-rouge">message_serializer</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">cipher</code>: the encryption algorithm itself (AES 256 GCM)</li>
  <li><code class="language-plaintext highlighter-rouge">key_provider</code>: serves encryption and decryption keys.</li>
  <li><code class="language-plaintext highlighter-rouge">message_serializer</code>: serializes and deserializes encrypted payloads (<code class="language-plaintext highlighter-rouge">Message</code>).</li>
</ul>

<p>NOTE: If you decide to build your own <code class="language-plaintext highlighter-rouge">message_serializer</code>, it’s important to use safe mechanisms that can’t deserialize arbitrary objects. A commonly supported scenario is encrypting existing unencrypted data. An attacker can leverage this to enter a tampered payload before encryption takes place and perform RCE attacks. This means custom serializers should avoid <code class="language-plaintext highlighter-rouge">Marshal</code>, <code class="language-plaintext highlighter-rouge">YAML.load</code> (use <code class="language-plaintext highlighter-rouge">YAML.safe_load</code>  instead), or <code class="language-plaintext highlighter-rouge">JSON.load</code> (use <code class="language-plaintext highlighter-rouge">JSON.parse</code> instead).</p>

<h4 id="global-encryption-context">Global Encryption Context</h4>

<p>The global encryption context is the one used by default and is configured as other configuration properties in your <code class="language-plaintext highlighter-rouge">application.rb</code> or environment config files.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">key_provider</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Encryption</span><span class="o">::</span><span class="no">EnvelopeEncryptionKeyProvider</span><span class="p">.</span><span class="nf">new</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">encryptor</span> <span class="o">=</span> <span class="no">MyEncryptor</span><span class="p">.</span><span class="nf">new</span>
</code></pre></div></div>

<h4 id="per-attribute-encryption-contexts">Per-attribute Encryption Contexts</h4>

<p>You can override encryption context params by passing them in the attribute declaration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Attribute</span>
  <span class="n">encrypts</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">encryptor: </span><span class="no">MyAttributeEncryptor</span><span class="p">.</span><span class="nf">new</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="encryption-context-when-running-a-block-of-code">Encryption Context When Running a Block of Code</h4>

<p>You can use <code class="language-plaintext highlighter-rouge">ActiveRecord::Encryption.with_encryption_context</code> to set an encryption context for a given block of code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Encryption</span><span class="p">.</span><span class="nf">with_encryption_context</span><span class="p">(</span><span class="ss">encryptor: </span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Encryption</span><span class="o">::</span><span class="no">NullEncryptor</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="built-in-encryption-contexts">Built-in Encryption Contexts</h4>

<h5 id="disable-encryption">Disable Encryption</h5>

<p>You can run code without encryption:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Encryption</span><span class="p">.</span><span class="nf">without_encryption</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This means that reading encrypted text will return the ciphertext, and saved content will be stored unencrypted.</p>

<h5 id="protect-encrypted-data">Protect Encrypted Data</h5>

<p>You can run code without encryption but prevent overwriting encrypted content:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Encryption</span><span class="p">.</span><span class="nf">protecting_encrypted_data</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This can be handy if you want to protect encrypted data while still running arbitrary code against it (e.g. in a Rails console).</p>
</div>
  </article>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toc = document.getElementById("toc");
    const headings = document.querySelectorAll(
      ".guide-content h2, .guide-content h3, .guide-content h4"
    );

    if (headings.length > 0) {
      const tocList = document.createElement("ul");
      const headingMap = new Map();

      // Türkçe karakterleri URL-dostu hale getiren fonksiyon
      function turkishToSlug(text) {
        const turkishChars = {
          'ç': 'c', 'Ç': 'c',
          'ğ': 'g', 'Ğ': 'g',
          'ı': 'i', 'I': 'i',
          'İ': 'i', 'i': 'i',
          'ö': 'o', 'Ö': 'o',
          'ş': 's', 'Ş': 's',
          'ü': 'u', 'Ü': 'u'
        };
        
        return text
          .split('')
          .map(char => turkishChars[char] || char)
          .join('')
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-+|-+$/g, '');
      }

      // Aynı ID'nin tekrarlanmasını önlemek için sayaç
      const idCounts = new Map();

      headings.forEach(function (heading, index) {
        // Başlık metninden anlamlı ID oluştur
        const headingText = heading.textContent.trim();
        let baseId = turkishToSlug(headingText);
        
        // Boş ID kontrolü
        if (!baseId) {
          baseId = "heading-" + index;
        }
        
        // Tekrarlanan ID'leri önle
        let finalId = baseId;
        if (idCounts.has(baseId)) {
          const count = idCounts.get(baseId) + 1;
          idCounts.set(baseId, count);
          finalId = baseId + "-" + count;
        } else {
          idCounts.set(baseId, 1);
        }
        
        heading.id = finalId;

        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = "#" + finalId;
        a.textContent = headingText;
        a.className = "toc-" + heading.tagName.toLowerCase();

        li.appendChild(a);
        tocList.appendChild(li);

        headingMap.set(finalId, a);
      });

      toc.appendChild(tocList);

      // Başlıkların görünürlük oranlarını takip et
      const visibilityMap = new Map();

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const id = entry.target.getAttribute("id");
            visibilityMap.set(id, entry.intersectionRatio);
          });

          // En çok görünür olan başlığı bul
          let mostVisibleId = null;
          let maxRatio = 0;

          visibilityMap.forEach((ratio, id) => {
            if (ratio > maxRatio) {
              mostVisibleId = id;
              maxRatio = ratio;
            }
          });

          if (mostVisibleId) {
            headingMap.forEach((linkEl) => linkEl.classList.remove("active"));
            const activeLink = headingMap.get(mostVisibleId);
            if (activeLink) {
              activeLink.classList.add("active");

              // Ortalamak için:
              const linkTop = activeLink.offsetTop;
              const linkHeight = activeLink.offsetHeight;
              const tocScrollParent = toc;
              const tocHeight = tocScrollParent.offsetHeight;

              tocScrollParent.scrollTo({
                top: linkTop - tocHeight / 2 + linkHeight / 2,
                behavior: "smooth",
              });
            }
          }
        },
        {
          threshold: [0, 0.25, 0.5, 0.75, 1.0],
        }
      );

      headings.forEach((heading) => {
        observer.observe(heading);
      });

      const toggleBtn = document.getElementById("toc-toggle");
      const sidebar = document.querySelector(".guide-sidebar");

      toggleBtn.addEventListener("click", function () {
        sidebar.classList.toggle("open");
      });
      const closeBtn = document.querySelector(".toc-close");

      closeBtn?.addEventListener("click", function () {
        sidebar.classList.remove("open");
      });
    }
  });
</script>
        <!-- <footer class="guide-footer"> -->
        <div class="feedback">
          <h3>Geri Bildirim</h3>
          <p>
            Bu rehberin kalitesinin iyileştirilmesine yardımcı olmanızı
            öneririz.
          </p>
          <p>
            Herhangi bir yazım hatası veya olgusal hata görürseniz lütfen
            katkıda bulunun. Başlamak için,
            <a
              href="https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation"
              >dokümantasyon katkıları</a
            >
            bölümünü okuyabilirsiniz.
          </p>
          <p>
            Ayrıca eksik veya güncel olmayan içerik de bulabilirsiniz. Lütfen
            main için eksik olan belgeleri ekleyin. Sorunların main dalda zaten
            düzeltilip düzeltilmediğini doğrulamak için önce
            <a href="https://edgeguides.rubyonrails.org/">Edge Guides</a>'ı
            kontrol ettiğinizden emin olun. Stil ve kurallar için
            <a
              href="https://guides.rubyonrails.org/v8.0/ruby_on_rails_guides_guidelines.html"
              >Ruby on Rails Guides Guidelines</a
            >'ı kontrol edin.
          </p>
          <p>
            Herhangi bir sebepten dolayı düzeltebileceğiniz bir şey bulursanız
            ancak kendiniz patch yapamıyorsanız lütfen bir
            <a href="https://github.com/rails/rails/issues">issue</a> açın.
          </p>
          <p>
            Ve son olarak, Ruby on Rails dokümantasyonu ile ilgili her türlü
            tartışma resmi
            <a href="https://discuss.rubyonrails.org/c/rubyonrails-docs/6"
              >Ruby on Rails Forum</a
            >'unda memnuniyetle karşılanacaktır.
          </p>
        </div>
      </div>
    </main>

    <button id="scrollToTop" class="scroll-to-top" aria-label="Yukarı çık">
      <svg
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <polyline points="18,15 12,9 6,15"></polyline>
      </svg>
    </button>

    <footer class="footer">
      <div class="container">
        <p>
          Bu çalışma <a href=" Creative Commons Attribution-ShareAlike 4.0 International">Creative Commons Attribution-ShareAlike 4.0 International</a> Lisansı kapsamında lisanslanmıştır.
          </p>
        <p>
          "Rails", "Ruby on Rails" ve Rails logosu David Heinemeier Hansson'un ticari markalarıdır. Tüm hakları saklıdır.
        </p><br/>
        <p>
          &copy; 2025 Rails Kılavuzları Türkçe Çevirisi.
          <a href="https://github.com/DilanKaya127">Dilan Kaya</a> tarafından
          hazırlanmıştır.
          Orijinal dokümantasyon
          <a href="https://guides.rubyonrails.org">Ruby on Rails</a> ekibine
          aittir.
        </p>
        

      </div>
    </footer>

    <script>
      hljs.highlightAll();
      // Yukarı çık butonu işlevselliği
      const scrollToTopBtn = document.getElementById("scrollToTop");

      // Scroll pozisyonunu kontrol et
      window.addEventListener("scroll", function () {
        if (window.pageYOffset > 500) {
          scrollToTopBtn.classList.add("visible");
        } else {
          scrollToTopBtn.classList.remove("visible");
        }
      });

      // Butona tıklandığında yukarı çık
      scrollToTopBtn.addEventListener("click", function () {
        window.scrollTo({
          top: 0,
          behavior: "smooth",
        });
      });
    </script>
  </body>
</html>
