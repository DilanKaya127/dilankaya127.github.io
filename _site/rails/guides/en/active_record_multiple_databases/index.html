<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Active Record Multiple Databases - Rails Dokümantasyonu - Türkçe
    </title>
    <link
      rel="stylesheet"
      href="/assets/css/rails.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css"
    />

    <link
      rel="icon"
      type="image/svg"
      href="/assets/img/logo_rails-circle.svg"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <!-- Google tag (gtag.js) -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-Y6Q8S53SSQ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());

      gtag("config", "G-Y6Q8S53SSQ");
    </script>
  </head>
  <body>
    <header class="header">
      <div class="container">
        <div class="header-content">
          <h1 class="logo">
            <a href="/rails/">
              <img
                src="/assets/img/logo_rails-circle.svg"
                alt="Rails Logo"
                class="logo-image"
              />
            </a>
          </h1>
          <nav class="nav">
            <a href="/">Ana Sayfa</a>
            <!-- <a href="https://dilankaya127.github.io">Portföy</a> -->

            <div class="dropdown">
              <a class="dropbtn">Kılavuzlar</a>
              <div class="dropdown-content multi-column">
                 
                <div class="dropdown-column">
                  <h4>Buradan Başlayın</h4>
                  
                  <a href="/rails/guides/tr/getting_started">Rails ile Başlarken</a>
                  
                </div>
                      
                <div class="dropdown-column">
                  <h4>Controllers</h4>
                  
                  <a href="/rails/guides/tr/action_controller_overview">Action Controller</a>
                  
                </div>
                  
                <div class="dropdown-column">
                  <h4>Diğer Bileşenler</h4>
                  
                  <a href="/rails/guides/tr/action_cable_overview">Action Cable</a>
                  
                </div>
                               
              </div>
            </div>
            <a href="https://github.com/dilankaya127/rails-tr-TR">GitHub</a>
          </nav>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="container"><div class="guide-container">
  <button id="toc-toggle" class="toc-toggle">☰ İçindekiler</button>

  <aside class="guide-sidebar">
    <div class="guide-toc">
      <!-- <h3>İçindekiler</h3> -->
      <div id="toc"></div>
      <button class="toc-close" aria-label="İçindekileri Kapat">✕</button>
    </div>

    <!-- <div class="guide-nav">
            <h3>Diğer(Tüm) Kılavuzlar</h3>
            <ul>
                <li><a href="/rails/guides/tr/getting_started">Rails ile Başlarken</a></li>
                <li><a href="/rails/guides/en/active_record_basics">Active Record Temelleri</a></li>
                <li><a href="/rails/guides//en/action_controller_overview">Action Controller</a></li>
                <li><a href="/rails/guides/tr/action_cable_overview">Action Cable</a></li>
            </ul>
        </div> -->
  </aside>

  <article class="guide-content">
    <!-- <header class="guide-header">
            <h1>Active Record Multiple Databases</h1>
            
        </header> -->

    <div class="guide-body"><p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1 id="multiple-databases-with-active-record">Multiple Databases with Active Record</h1>

<p>This guide covers using multiple databases with your Rails application.</p>

<p>After reading this guide you will know:</p>

<ul>
  <li>How to set up your application for multiple databases.</li>
  <li>How automatic connection switching works.</li>
  <li>How to use horizontal sharding for multiple databases.</li>
  <li>What features are supported and what’s still a work in progress.</li>
</ul>

<hr />

<p>As an application grows in popularity and usage, you’ll need to scale the application
to support your new users and their data. One way in which your application may need
to scale is on the database level. Rails supports using multiple databases, so you don’t
have to store your data all in one place.</p>

<p>At this time the following features are supported:</p>

<ul>
  <li>Multiple writer databases and a replica for each</li>
  <li>Automatic connection switching for the model you’re working with</li>
  <li>Automatic swapping between the writer and replica depending on the HTTP verb and recent writes</li>
  <li>Rails tasks for creating, dropping, migrating, and interacting with the multiple databases</li>
</ul>

<p>The following features are not (yet) supported:</p>

<ul>
  <li>Load balancing replicas</li>
</ul>

<h2 id="setting-up-your-application">Setting up Your Application</h2>

<p>While Rails tries to do most of the work for you, there are still some steps you’ll
need to do to get your application ready for multiple databases.</p>

<p>Let’s say we have an application with a single writer database, and we need to add a
new database for some new tables we’re adding. The name of the new database will be
“animals”.</p>

<p><code class="language-plaintext highlighter-rouge">config/database.yml</code> looks like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">production</span><span class="pi">:</span>
  <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
  <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
  <span class="na">username</span><span class="pi">:</span> <span class="s">root</span>
  <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['ROOT_PASSWORD'] %&gt;</span>
</code></pre></div></div>

<p>Let’s add a second database called “animals” and replicas for both databases as
well. To do this, we need to change our <code class="language-plaintext highlighter-rouge">config/database.yml</code> from a 2-tier to a
3-tier config.</p>

<p>If a <code class="language-plaintext highlighter-rouge">primary</code> configuration key is provided, it will be used as the “default” configuration. If
there is no configuration named <code class="language-plaintext highlighter-rouge">primary</code>, Rails will use the first configuration as default
for each environment. The default configurations will use the default Rails filenames. For example,
primary configurations will use <code class="language-plaintext highlighter-rouge">db/schema.rb</code> for the schema file, whereas all the other entries
will use <code class="language-plaintext highlighter-rouge">db/[CONFIGURATION_NAMESPACE]_schema.rb</code> for the filename.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">production</span><span class="pi">:</span>
  <span class="na">primary</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">root</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['ROOT_PASSWORD'] %&gt;</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
  <span class="na">primary_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">root_readonly</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['ROOT_READONLY_PASSWORD'] %&gt;</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">animals</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_animals_database</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">animals_root</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['ANIMALS_ROOT_PASSWORD'] %&gt;</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">migrations_paths</span><span class="pi">:</span> <span class="s">db/animals_migrate</span>
  <span class="na">animals_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_animals_database</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">animals_readonly</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">&lt;%= ENV['ANIMALS_READONLY_PASSWORD'] %&gt;</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre></div></div>

<p>Connection URLs for databases can also be configured using environment variables. The variable
name is formed by concatenating the connection name with <code class="language-plaintext highlighter-rouge">_DATABASE_URL</code>. For example, setting
<code class="language-plaintext highlighter-rouge">ANIMALS_DATABASE_URL="mysql2://username:password@host/database"</code> is merged into the <code class="language-plaintext highlighter-rouge">animals</code>
configuration in <code class="language-plaintext highlighter-rouge">database.yml</code> in the <code class="language-plaintext highlighter-rouge">production</code> environment. See
<a href="configuring.html#configuring-a-database">Configuring a Database</a> for details about how the
merging works.</p>

<p>When using multiple databases, there are a few important settings.</p>

<p>First, the database name for <code class="language-plaintext highlighter-rouge">primary</code> and <code class="language-plaintext highlighter-rouge">primary_replica</code> should be the same because they contain
the same data. This is also the case for <code class="language-plaintext highlighter-rouge">animals</code> and <code class="language-plaintext highlighter-rouge">animals_replica</code>.</p>

<p>Second, the username for the writers and replicas should be different, and the
replica user’s database permissions should be set to only read and not write.</p>

<p>When using a replica database, you need to add a <code class="language-plaintext highlighter-rouge">replica: true</code> entry to the replica in
<code class="language-plaintext highlighter-rouge">config/database.yml</code>. This is because Rails otherwise has no way of knowing which one is a replica
and which one is the writer. Rails will not run certain tasks, such as migrations, against replicas.</p>

<p>Lastly, for new writer databases, you need to set the <code class="language-plaintext highlighter-rouge">migrations_paths</code> key to the directory
where you will store migrations for that database. We’ll look more at <code class="language-plaintext highlighter-rouge">migrations_paths</code>
later on in this guide.</p>

<p>You can also configure the schema dump file by setting <code class="language-plaintext highlighter-rouge">schema_dump</code> to a custom schema file name
or completely skip the schema dumping by setting <code class="language-plaintext highlighter-rouge">schema_dump: false</code>.</p>

<p>Now that we have a new database, let’s set up the connection model.</p>

<p>The primary database replica may be configured in <code class="language-plaintext highlighter-rouge">ApplicationRecord</code> this way:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :primary</span><span class="p">,</span> <span class="ss">reading: :primary_replica</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you use a differently named class for your application record you need to
set <code class="language-plaintext highlighter-rouge">primary_abstract_class</code> instead, so that Rails knows which class <code class="language-plaintext highlighter-rouge">ActiveRecord::Base</code>
should share a connection with.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">PrimaryApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">primary_abstract_class</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :primary</span><span class="p">,</span> <span class="ss">reading: :primary_replica</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In that case, classes that connect to <code class="language-plaintext highlighter-rouge">primary</code>/<code class="language-plaintext highlighter-rouge">primary_replica</code> can inherit
from your primary abstract class like standard Rails applications do with
<code class="language-plaintext highlighter-rouge">ApplicationRecord</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">PrimaryApplicationRecord</span>
<span class="k">end</span>
</code></pre></div></div>

<p>On the other hand, we need to set up our models persisted in the “animals” database:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AnimalsRecord</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :animals</span><span class="p">,</span> <span class="ss">reading: :animals_replica</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Those models should inherit from that common abstract class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Dog</span> <span class="o">&lt;</span> <span class="no">AnimalsRecord</span>
  <span class="c1"># Talks automatically to the animals database.</span>
<span class="k">end</span>
</code></pre></div></div>

<p>By default, Rails expects the database roles to be <code class="language-plaintext highlighter-rouge">writing</code> and <code class="language-plaintext highlighter-rouge">reading</code> for the primary
and replica respectively. If you have a legacy system you may already have roles set up that
you don’t want to change. In that case you can set a new role name in your application config.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">writing_role</span> <span class="o">=</span> <span class="ss">:default</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">reading_role</span> <span class="o">=</span> <span class="ss">:readonly</span>
</code></pre></div></div>

<p>It’s important to connect to your database in a single model and then inherit from that model
for the tables rather than connect multiple individual models to the same database. Database
clients have a limit to the number of open connections there can be, and if you do this, it will
multiply the number of connections you have since Rails uses the model class name for the
connection specification name.</p>

<p>Now that we have the <code class="language-plaintext highlighter-rouge">config/database.yml</code> and the new model set up, it’s time
to create the databases. Rails ships with all the commands you need to use
multiple databases.</p>

<p>You can run <code class="language-plaintext highlighter-rouge">bin/rails --help</code> to see all the commands you’re able to run. You should see the following:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nt">--help</span>
...
db:create                          <span class="c"># Create the database from DATABASE_URL or config/database.yml for the ...</span>
db:create:animals                  <span class="c"># Create animals database for current environment</span>
db:create:primary                  <span class="c"># Create primary database for current environment</span>
db:drop                            <span class="c"># Drop the database from DATABASE_URL or config/database.yml for the cu...</span>
db:drop:animals                    <span class="c"># Drop animals database for current environment</span>
db:drop:primary                    <span class="c"># Drop primary database for current environment</span>
db:migrate                         <span class="c"># Migrate the database (options: VERSION=x, VERBOSE=false, SCOPE=blog)</span>
db:migrate:animals                 <span class="c"># Migrate animals database for current environment</span>
db:migrate:primary                 <span class="c"># Migrate primary database for current environment</span>
db:migrate:status                  <span class="c"># Display status of migrations</span>
db:migrate:status:animals          <span class="c"># Display status of migrations for animals database</span>
db:migrate:status:primary          <span class="c"># Display status of migrations for primary database</span>
db:reset                           <span class="c"># Drop and recreates all databases from their schema for the current environment and loads the seeds</span>
db:reset:animals                   <span class="c"># Drop and recreates the animals database from its schema for the current environment and loads the seeds</span>
db:reset:primary                   <span class="c"># Drop and recreates the primary database from its schema for the current environment and loads the seeds</span>
db:rollback                        <span class="c"># Roll the schema back to the previous version (specify steps w/ STEP=n)</span>
db:rollback:animals                <span class="c"># Rollback animals database for current environment (specify steps w/ STEP=n)</span>
db:rollback:primary                <span class="c"># Rollback primary database for current environment (specify steps w/ STEP=n)</span>
db:schema:dump                     <span class="c"># Create a database schema file (either db/schema.rb or db/structure.sql  ...</span>
db:schema:dump:animals             <span class="c"># Create a database schema file (either db/schema.rb or db/structure.sql  ...</span>
db:schema:dump:primary             <span class="c"># Create a db/schema.rb file that is portable against any DB supported  ...</span>
db:schema:load                     <span class="c"># Load a database schema file (either db/schema.rb or db/structure.sql  ...</span>
db:schema:load:animals             <span class="c"># Load a database schema file (either db/schema.rb or db/structure.sql  ...</span>
db:schema:load:primary             <span class="c"># Load a database schema file (either db/schema.rb or db/structure.sql  ...</span>
db:setup                           <span class="c"># Create all databases, loads all schemas, and initializes with the seed data (use db:reset to also drop all databases first)</span>
db:setup:animals                   <span class="c"># Create the animals database, loads the schema, and initializes with the seed data (use db:reset:animals to also drop the database first)</span>
db:setup:primary                   <span class="c"># Create the primary database, loads the schema, and initializes with the seed data (use db:reset:primary to also drop the database first)</span>
...
</code></pre></div></div>

<p>Running a command like <code class="language-plaintext highlighter-rouge">bin/rails db:create</code> will create both the primary and animals databases.
Note that there is no command for creating the database users, and you’ll need to do that manually
to support the read-only users for your replicas. If you want to create just the animals
database you can run <code class="language-plaintext highlighter-rouge">bin/rails db:create:animals</code>.</p>

<h2 id="connecting-to-databases-without-managing-schema-and-migrations">Connecting to Databases without Managing Schema and Migrations</h2>

<p>If you would like to connect to an external database without any database
management tasks such as schema management, migrations, seeds, etc., you can set
the per database config option <code class="language-plaintext highlighter-rouge">database_tasks: false</code>. By default it is
set to true.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">production</span><span class="pi">:</span>
  <span class="na">primary</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_database</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
  <span class="na">animals</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_animals_database</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">database_tasks</span><span class="pi">:</span> <span class="kc">false</span>
</code></pre></div></div>

<h2 id="generators-and-migrations">Generators and Migrations</h2>

<p>Migrations for multiple databases should live in their own folders prefixed with the
name of the database key in the configuration.</p>

<p>You also need to set <code class="language-plaintext highlighter-rouge">migrations_paths</code> in the database configurations to tell
Rails where to find the migrations.</p>

<p>For example the <code class="language-plaintext highlighter-rouge">animals</code> database would look for migrations in the <code class="language-plaintext highlighter-rouge">db/animals_migrate</code> directory and
<code class="language-plaintext highlighter-rouge">primary</code> would look in <code class="language-plaintext highlighter-rouge">db/migrate</code>. Rails generators now take a <code class="language-plaintext highlighter-rouge">--database</code> option
so that the file is generated in the correct directory. The command can be run like so:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate migration CreateDogs name:string <span class="nt">--database</span> animals
</code></pre></div></div>

<p>If you are using Rails generators, the scaffold and model generators will create the abstract
class for you. Simply pass the database key to the command line.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate scaffold Dog name:string <span class="nt">--database</span> animals
</code></pre></div></div>

<p>A class with the camelized database name and <code class="language-plaintext highlighter-rouge">Record</code> will be created. In this
example the database is “animals” so we end up with <code class="language-plaintext highlighter-rouge">AnimalsRecord</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AnimalsRecord</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :animals</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The generated model will automatically inherit from <code class="language-plaintext highlighter-rouge">AnimalsRecord</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Dog</span> <span class="o">&lt;</span> <span class="no">AnimalsRecord</span>
<span class="k">end</span>
</code></pre></div></div>

<p>NOTE: Since Rails doesn’t know which database is the replica for your writer you will need to
add this to the abstract class after you’re done.</p>

<p>Rails will only generate <code class="language-plaintext highlighter-rouge">AnimalsRecord</code> once. It will not be overwritten by new
scaffolds or deleted if the scaffold is deleted.</p>

<p>If you already have an abstract class and its name differs from <code class="language-plaintext highlighter-rouge">AnimalsRecord</code>, you can pass
the <code class="language-plaintext highlighter-rouge">--parent</code> option to indicate you want a different abstract class:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate scaffold Dog name:string <span class="nt">--database</span> animals <span class="nt">--parent</span> Animals::Record
</code></pre></div></div>

<p>This will skip generating <code class="language-plaintext highlighter-rouge">AnimalsRecord</code> since you’ve indicated to Rails that you want to
use a different parent class.</p>

<h2 id="activating-automatic-role-switching">Activating Automatic Role Switching</h2>

<p>Finally, in order to use the read-only replica in your application, you’ll need to activate
the middleware for automatic switching.</p>

<p>Automatic switching allows the application to switch from the writer to the replica or the replica
to the writer based on the HTTP verb and whether there was a recent write by the requesting user.</p>

<p>If the application receives a POST, PUT, DELETE, or PATCH request, the application will
automatically write to the writer database. If the request is not one of those methods,
but the application recently made a write, the writer database will also be used. All
other requests will use the replica database.</p>

<p>To activate the automatic connection switching middleware you can run the automatic swapping
generator:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails g active_record:multi_db
</code></pre></div></div>

<p>And then uncomment the following lines:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">delay: </span><span class="mi">2</span><span class="p">.</span><span class="nf">seconds</span> <span class="p">}</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver_context</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span><span class="o">::</span><span class="no">Session</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Rails guarantees “read your own write” and will send your GET or HEAD request to the
writer if it’s within the <code class="language-plaintext highlighter-rouge">delay</code> window. By default the delay is set to 2 seconds. You
should change this based on your database infrastructure. Rails doesn’t guarantee “read
a recent write” for other users within the delay window and will send GET and HEAD requests
to the replicas unless they wrote recently.</p>

<p>The automatic connection switching in Rails is relatively primitive and deliberately doesn’t
do a whole lot. The goal is a system that demonstrates how to do automatic connection
switching that is flexible enough to be customizable by app developers.</p>

<p>The setup in Rails allows you to easily change how the switching is done and what
parameters it’s based on. Let’s say you want to use a cookie instead of a session to
decide when to swap connections. You can write your own class:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyCookieResolver</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">call</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">new</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="nf">cookies</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>
    <span class="vi">@cookies</span> <span class="o">=</span> <span class="n">cookies</span>
  <span class="k">end</span>

  <span class="nb">attr_reader</span> <span class="ss">:cookies</span>

  <span class="k">def</span> <span class="nf">last_write_timestamp</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">convert_timestamp_to_time</span><span class="p">(</span><span class="n">cookies</span><span class="p">[</span><span class="ss">:last_write</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">update_last_write_timestamp</span>
    <span class="n">cookies</span><span class="p">[</span><span class="ss">:last_write</span><span class="p">]</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">convert_time_to_timestamp</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And then pass it to the middleware:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">delay: </span><span class="mi">2</span><span class="p">.</span><span class="nf">seconds</span> <span class="p">}</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Middleware</span><span class="o">::</span><span class="no">DatabaseSelector</span><span class="o">::</span><span class="no">Resolver</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">database_resolver_context</span> <span class="o">=</span> <span class="no">MyCookieResolver</span>
</code></pre></div></div>

<h2 id="using-manual-connection-switching">Using Manual Connection Switching</h2>

<p>There are some cases where you may want your application to connect to a writer or a replica
and the automatic connection switching isn’t adequate. For example, you may know that for a
particular request you always want to send the request to a replica, even when you are in a
POST request path.</p>

<p>To do this Rails provides a <code class="language-plaintext highlighter-rouge">connected_to</code> method that will switch to the connection you
need.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># All code in this block will be connected to the reading role.</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The “role” in the <code class="language-plaintext highlighter-rouge">connected_to</code> call looks up the connections that are connected on that
connection handler (or role). The <code class="language-plaintext highlighter-rouge">reading</code> connection handler will hold all the connections
that were connected via <code class="language-plaintext highlighter-rouge">connects_to</code> with the role name of <code class="language-plaintext highlighter-rouge">reading</code>.</p>

<p>Note that <code class="language-plaintext highlighter-rouge">connected_to</code> with a role will look up an existing connection and switch
using the connection specification name. This means that if you pass an unknown role
like <code class="language-plaintext highlighter-rouge">connected_to(role: :nonexistent)</code> you will get an error that says
<code class="language-plaintext highlighter-rouge">ActiveRecord::ConnectionNotEstablished (No connection pool for 'ActiveRecord::Base' found for the 'nonexistent' role.)</code></p>

<p>If you want Rails to ensure any queries performed are read-only, pass <code class="language-plaintext highlighter-rouge">prevent_writes: true</code>.
This just prevents queries that look like writes from being sent to the database.
You should also configure your replica database to run in read-only mode.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">prevent_writes: </span><span class="kp">true</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># Rails will check each query to ensure it's a read query.</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="horizontal-sharding">Horizontal Sharding</h2>

<p>Horizontal sharding is when you split up your database to reduce the number of rows on each
database server, but maintain the same schema across “shards”. This is commonly called “multi-tenant”
sharding.</p>

<p>The API for supporting horizontal sharding in Rails is similar to the multiple database / vertical
sharding API that’s existed since Rails 6.0.</p>

<p>Shards are declared in the three-tier config like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">production</span><span class="pi">:</span>
  <span class="na">primary</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
  <span class="na">primary_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_database</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">primary_shard_one</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_shard_one</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">migrations_paths</span><span class="pi">:</span> <span class="s">db/migrate_shards</span>
  <span class="na">primary_shard_one_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_shard_one</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">primary_shard_two</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_shard_two</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">migrations_paths</span><span class="pi">:</span> <span class="s">db/migrate_shards</span>
  <span class="na">primary_shard_two_replica</span><span class="pi">:</span>
    <span class="na">database</span><span class="pi">:</span> <span class="s">my_primary_shard_two</span>
    <span class="na">adapter</span><span class="pi">:</span> <span class="s">mysql2</span>
    <span class="na">replica</span><span class="pi">:</span> <span class="kc">true</span>
</code></pre></div></div>

<p>Models are then connected with the <code class="language-plaintext highlighter-rouge">connects_to</code> API via the <code class="language-plaintext highlighter-rouge">shards</code> key:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">primary_abstract_class</span>

  <span class="n">connects_to</span> <span class="ss">database: </span><span class="p">{</span> <span class="ss">writing: :primary</span><span class="p">,</span> <span class="ss">reading: :primary_replica</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ShardRecord</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>

  <span class="n">connects_to</span> <span class="ss">shards: </span><span class="p">{</span>
    <span class="ss">shard_one: </span><span class="p">{</span> <span class="ss">writing: :primary_shard_one</span><span class="p">,</span> <span class="ss">reading: :primary_shard_one_replica</span> <span class="p">},</span>
    <span class="ss">shard_two: </span><span class="p">{</span> <span class="ss">writing: :primary_shard_two</span><span class="p">,</span> <span class="ss">reading: :primary_shard_two_replica</span> <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ShardRecord</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you’re using shards, make sure both <code class="language-plaintext highlighter-rouge">migrations_paths</code> and <code class="language-plaintext highlighter-rouge">schema_dump</code> remain unchanged for
all the shards. When generating a migration you can pass the <code class="language-plaintext highlighter-rouge">--database</code> option and
use one of the shard names. Since they all set the same path, it doesn’t matter which
one you choose.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ bin/rails g scaffold Dog name:string --database primary_shard_one
</code></pre></div></div>

<p>Then models can swap shards manually via the <code class="language-plaintext highlighter-rouge">connected_to</code> API. If
using sharding, both a <code class="language-plaintext highlighter-rouge">role</code> and a <code class="language-plaintext highlighter-rouge">shard</code> must be passed:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ShardRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :writing</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="vi">@person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create!</span> <span class="c1"># Creates a record in shard shard_one</span>
<span class="k">end</span>

<span class="no">ShardRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :writing</span><span class="p">,</span> <span class="ss">shard: :shard_two</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="vi">@person</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span> <span class="c1"># Can't find record, doesn't exist because it was created</span>
                   <span class="c1"># in the shard named ":shard_one".</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The horizontal sharding API also supports read replicas. You can swap the
role and the shard with the <code class="language-plaintext highlighter-rouge">connected_to</code> API.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ShardRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Lookup record from read replica of shard one.</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="activating-automatic-shard-switching">Activating Automatic Shard Switching</h2>

<p>Applications are able to automatically switch shards per request using the <code class="language-plaintext highlighter-rouge">ShardSelector</code>
middleware, which allows an application to provide custom logic for determining the appropriate
shard for each request.</p>

<p>The same generator used for the database selector above can be used to generate an initializer file
for automatic shard swapping:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails g active_record:multi_db
</code></pre></div></div>

<p>Then in the generated <code class="language-plaintext highlighter-rouge">config/initializers/multi_db.rb</code> uncomment and modify the following code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">shard_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">lock: </span><span class="kp">true</span> <span class="p">}</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">shard_resolver</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span> <span class="no">Tenant</span><span class="p">.</span><span class="nf">find_by!</span><span class="p">(</span><span class="ss">host: </span><span class="n">request</span><span class="p">.</span><span class="nf">host</span><span class="p">).</span><span class="nf">shard</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Applications must provide a resolver to provide application-specific logic. An example resolver that
uses a subdomain to determine the shard might look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">shard_resolver</span> <span class="o">=</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">subdomain</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">subdomain</span>
  <span class="n">tenant</span> <span class="o">=</span> <span class="no">Tenant</span><span class="p">.</span><span class="nf">find_by_subdomain!</span><span class="p">(</span><span class="n">subdomain</span><span class="p">)</span>
  <span class="n">tenant</span><span class="p">.</span><span class="nf">shard</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The behavior of <code class="language-plaintext highlighter-rouge">ShardSelector</code> can be altered through some configuration options.</p>

<p><code class="language-plaintext highlighter-rouge">lock</code> is true by default and will prohibit the request from switching shards during the request. If
<code class="language-plaintext highlighter-rouge">lock</code> is false, then shard swapping will be allowed. For tenant-based sharding, <code class="language-plaintext highlighter-rouge">lock</code> should
always be true to prevent application code from mistakenly switching between tenants.</p>

<p><code class="language-plaintext highlighter-rouge">class_name</code> is the name of the abstract connection class to switch. By default, the <code class="language-plaintext highlighter-rouge">ShardSelector</code>
will use <code class="language-plaintext highlighter-rouge">ActiveRecord::Base</code>, but if the application has multiple databases, then this option
should be set to the name of the sharded database’s abstract connection class.</p>

<p>Options may be set in the application configuration. For example, this configuration tells
<code class="language-plaintext highlighter-rouge">ShardSelector</code> to switch shards using <code class="language-plaintext highlighter-rouge">AnimalsRecord.connected_to</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">shard_selector</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">lock: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"AnimalsRecord"</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="granular-database-connection-switching">Granular Database Connection Switching</h2>

<p>Starting from Rails 6.1, it’s possible to switch connections for one database
instead of all databases globally.</p>

<p>With granular database connection switching, any abstract connection class
will be able to switch connections without affecting other connections. This
is useful for switching your <code class="language-plaintext highlighter-rouge">AnimalsRecord</code> queries to read from the replica
while ensuring your <code class="language-plaintext highlighter-rouge">ApplicationRecord</code> queries go to the primary.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">AnimalsRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Dog</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Reads from animals_replica.</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span>  <span class="c1"># Reads from primary.</span>
<span class="k">end</span>
</code></pre></div></div>

<p>It’s also possible to swap connections granularly for shards.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">AnimalsRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># Will read from shard_one_replica. If no connection exists for shard_one_replica,</span>
  <span class="c1"># a ConnectionNotEstablished error will be raised.</span>
  <span class="no">Dog</span><span class="p">.</span><span class="nf">first</span>

  <span class="c1"># Will read from primary writer.</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span>
<span class="k">end</span>
</code></pre></div></div>

<p>To switch only the primary database cluster use <code class="language-plaintext highlighter-rouge">ApplicationRecord</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ApplicationRecord</span><span class="p">.</span><span class="nf">connected_to</span><span class="p">(</span><span class="ss">role: :reading</span><span class="p">,</span> <span class="ss">shard: :shard_one</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">Person</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Reads from primary_shard_one_replica.</span>
  <span class="no">Dog</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Reads from animals_primary.</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ActiveRecord::Base.connected_to</code> maintains the ability to switch
connections globally.</p>

<h3 id="handling-associations-with-joins-across-databases">Handling Associations with Joins across Databases</h3>

<p>As of Rails 7.0+, Active Record has an option for handling associations that would perform
a join across multiple databases. If you have a has many through or a has one through association
that you want to disable joining and perform 2 or more queries, pass the <code class="language-plaintext highlighter-rouge">disable_joins: true</code> option.</p>

<p>For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Dog</span> <span class="o">&lt;</span> <span class="no">AnimalsRecord</span>
  <span class="n">has_many</span> <span class="ss">:treats</span><span class="p">,</span> <span class="ss">through: :humans</span><span class="p">,</span> <span class="ss">disable_joins: </span><span class="kp">true</span>
  <span class="n">has_many</span> <span class="ss">:humans</span>

  <span class="n">has_one</span> <span class="ss">:home</span>
  <span class="n">has_one</span> <span class="ss">:yard</span><span class="p">,</span> <span class="ss">through: :home</span><span class="p">,</span> <span class="ss">disable_joins: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Home</span>
  <span class="n">belongs_to</span> <span class="ss">:dog</span>
  <span class="n">has_one</span> <span class="ss">:yard</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Yard</span>
  <span class="n">belongs_to</span> <span class="ss">:home</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Previously calling <code class="language-plaintext highlighter-rouge">@dog.treats</code> without <code class="language-plaintext highlighter-rouge">disable_joins</code> or <code class="language-plaintext highlighter-rouge">@dog.yard</code> without <code class="language-plaintext highlighter-rouge">disable_joins</code>
would raise an error because databases are unable to handle joins across clusters. With the
<code class="language-plaintext highlighter-rouge">disable_joins</code> option, Rails will generate multiple select queries
to avoid attempting joining across clusters. For the above association, <code class="language-plaintext highlighter-rouge">@dog.treats</code> would generate the
following SQL:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="nv">"humans"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">FROM</span> <span class="nv">"humans"</span> <span class="k">WHERE</span> <span class="nv">"humans"</span><span class="p">.</span><span class="nv">"dog_id"</span> <span class="o">=</span> <span class="o">?</span>  <span class="p">[[</span><span class="nv">"dog_id"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="k">SELECT</span> <span class="nv">"treats"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"treats"</span> <span class="k">WHERE</span> <span class="nv">"treats"</span><span class="p">.</span><span class="nv">"human_id"</span> <span class="k">IN</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">)</span>  <span class="p">[[</span><span class="nv">"human_id"</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="nv">"human_id"</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="nv">"human_id"</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]</span>
</code></pre></div></div>

<p>While <code class="language-plaintext highlighter-rouge">@dog.yard</code> would generate the following SQL:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="nv">"home"</span><span class="p">.</span><span class="nv">"id"</span> <span class="k">FROM</span> <span class="nv">"homes"</span> <span class="k">WHERE</span> <span class="nv">"homes"</span><span class="p">.</span><span class="nv">"dog_id"</span> <span class="o">=</span> <span class="o">?</span> <span class="p">[[</span><span class="nv">"dog_id"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="k">SELECT</span> <span class="nv">"yards"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"yards"</span> <span class="k">WHERE</span> <span class="nv">"yards"</span><span class="p">.</span><span class="nv">"home_id"</span> <span class="o">=</span> <span class="o">?</span> <span class="p">[[</span><span class="nv">"home_id"</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</code></pre></div></div>

<p>There are some important things to be aware of with this option:</p>

<ol>
  <li>There may be performance implications since now two or more queries will be performed (depending
on the association) rather than a join. If the select for <code class="language-plaintext highlighter-rouge">humans</code> returned a high number of IDs
the select for <code class="language-plaintext highlighter-rouge">treats</code> may send too many IDs.</li>
  <li>Since we are no longer performing joins, a query with an order or limit is now sorted in-memory since
order from one table cannot be applied to another table.</li>
  <li>This setting must be added to all associations where you want joining to be disabled.
Rails can’t guess this for you because association loading is lazy, to load <code class="language-plaintext highlighter-rouge">treats</code> in <code class="language-plaintext highlighter-rouge">@dog.treats</code>
Rails already needs to know what SQL should be generated.</li>
</ol>

<h3 id="schema-caching">Schema Caching</h3>

<p>If you want to load a schema cache for each database you must set
<code class="language-plaintext highlighter-rouge">schema_cache_path</code> in each database configuration and set
<code class="language-plaintext highlighter-rouge">config.active_record.lazily_load_schema_cache = true</code> in your application
configuration. Note that this will lazily load the cache when the database
connections are established.</p>

<h2 id="caveats">Caveats</h2>

<h3 id="load-balancing-replicas">Load Balancing Replicas</h3>

<p>Rails doesn’t support automatic load balancing of replicas. This is very
dependent on your infrastructure. We may implement basic, primitive load
balancing in the future, but for an application at scale this should be
something your application handles outside of Rails.</p>
</div>
  </article>
</div>
<footer class="guide-footer">
      <div class="feedback">
        <h3>Geri Bildirim</h3>
        <p>
          Bu kılavuzun kalitesini artırmamıza yardımcı olmak için geri
          bildirimlerinizi bekliyoruz.
        </p>
        <p>
          Lütfen
          <a href="https://github.com/dilankaya127/rails-tr-TR"
            >GitHub Issues</a
          >
          üzerinden katkıda bulunun.
        </p>
      </div>
    </footer>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toc = document.getElementById("toc");
    const headings = document.querySelectorAll(
      ".guide-content h2, .guide-content h3, .guide-content h4"
    );

    if (headings.length > 0) {
      const tocList = document.createElement("ul");
      const headingMap = new Map();

      headings.forEach(function (heading, index) {
        const id = "heading-" + index;
        heading.id = id;

        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = "#" + id;
        a.textContent = heading.textContent;
        a.className = "toc-" + heading.tagName.toLowerCase();

        li.appendChild(a);
        tocList.appendChild(li);

        headingMap.set(id, a);
      });

      toc.appendChild(tocList);

      // Başlıkların görünürlük oranlarını takip et
      const visibilityMap = new Map();

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            const id = entry.target.getAttribute("id");
            visibilityMap.set(id, entry.intersectionRatio);
          });

          // En çok görünür olan başlığı bul
          let mostVisibleId = null;
          let maxRatio = 0;

          visibilityMap.forEach((ratio, id) => {
            if (ratio > maxRatio) {
              mostVisibleId = id;
              maxRatio = ratio;
            }
          });

          if (mostVisibleId) {
            headingMap.forEach((linkEl) => linkEl.classList.remove("active"));
            const activeLink = headingMap.get(mostVisibleId);
            if (activeLink) {
              activeLink.classList.add("active");

              // Ortalamak için:
              const linkTop = activeLink.offsetTop;
              const linkHeight = activeLink.offsetHeight;
              const tocScrollParent = toc;
              const tocHeight = tocScrollParent.offsetHeight;

              tocScrollParent.scrollTo({
                top: linkTop - tocHeight / 2 + linkHeight / 2,
                behavior: "smooth",
              });
            }
          }
        },
        {
          threshold: [0, 0.25, 0.5, 0.75, 1.0],
        }
      );

      headings.forEach((heading) => {
        observer.observe(heading);
      });

      const toggleBtn = document.getElementById("toc-toggle");
      const sidebar = document.querySelector(".guide-sidebar");

      toggleBtn.addEventListener("click", function () {
        sidebar.classList.toggle("open");
      });
      const closeBtn = document.querySelector(".toc-close");

      closeBtn?.addEventListener("click", function () {
        sidebar.classList.remove("open");
      });
    }
  });
</script>
</div>
    </main>

    <footer class="footer">
      <div class="container">
        <p>
          &copy; 2025 Rails Kılavuzları Türkçe Çevirisi.
          <a href="https://github.com/DilanKaya127">Dilan Kaya</a> tarafından
          hazırlanmıştır.
        </p>
        <p>
          Orijinal dokümantasyon
          <a href="https://guides.rubyonrails.org">Ruby on Rails</a> ekibine
          aittir.
        </p>
      </div>
    </footer>

    <script>
      hljs.highlightAll();
    </script>
  </body>
</html>
