<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Association Basics - Rails Dokümantasyonu - Türkçe</title>
    <link rel="stylesheet" href="/rails-tr-TR/assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo">
                    <a href="/rails-tr-TR/">Rails Kılavuzları</a>
                </h1>
                <nav class="nav">
                    <a href="/rails-tr-TR/">Ana Sayfa</a>
                    <a href="https://dilankaya127.github.io">Portföy</a>
                    <a href="https://github.com/dilankaya127/rails-tr-TR">GitHub</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="guide-container">
    <aside class="guide-sidebar">
        <div class="guide-toc">
            <h3>İçindekiler</h3>
            <div id="toc"></div>
        </div>
        
        <div class="guide-nav">
            <h3>Diğer Kılavuzlar</h3>
            <ul>
                <li><a href="/rails-tr-TR/rails-tr-TR/guides/tr/getting_started">Rails ile Başlarken</a></li>
                <li><a href="/rails-tr-TR/rails-tr-TR/guides/en/active_record_basics">Active Record Temelleri</a></li>
                <li><a href="/rails-tr-TR/rails-tr-TR/guides//en/action_controller_overview">Action Controller</a></li>
                <li><a href="/rails-tr-TR/rails-tr-TR/guides/tr/action_cable_overview">Action Cable</a></li>
            </ul>
        </div>
    </aside>

    <article class="guide-content">
        <header class="guide-header">
            <h1>Association Basics</h1>
            
        </header>

        <div class="guide-body">
            <p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1 id="active-record-associations">Active Record Associations</h1>

<p>This guide covers the association features of Active Record.</p>

<p>After reading this guide, you will know how to:</p>

<ul>
  <li>Understand the various types of associations.</li>
  <li>Declare associations between Active Record models.</li>
  <li>Choose the right association type for your models.</li>
  <li>Use Single Table Inheritance.</li>
  <li>Setting up and using Delegated Types.</li>
</ul>

<hr />

<h2 id="associations-overview">Associations Overview</h2>

<p>Active Record associations allow you to define relationships between models.
<em>Associations</em> are implemented as special macro style calls that make it easy to
tell Rails how your models relate to each other, which helps you manage your
data more effectively, and makes common operations simpler and easier to read.</p>

<p>INFO: A macro-style call is a method that generates or modifies other methods at
runtime, allowing for concise and expressive declarations of functionality, such
as defining model associations in Rails. For example, <code class="language-plaintext highlighter-rouge">has_many :comments</code>.</p>

<p>When you set up an association, Rails helps define and manage the <a href="https://en.wikipedia.org/wiki/Primary_key">Primary
Key</a> and <a href="https://en.wikipedia.org/wiki/Foreign_key">Foreign
Key</a> relationships between instances
of the two models, while the database ensures that your data stays consistent
and properly linked.</p>

<p>This makes it easy to keep track of which records are related. It also adds
useful methods to your models so you can work with related data more easily.</p>

<p>Consider a simple Rails application with models for authors and books.</p>

<h3 id="without-associations">Without Associations</h3>

<p>Without associations, creating and deleting books for that author would require
a tedious and manual process. Here’s what that would look like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">references</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre></div></div>

<p>To add a new book for an existing author, you’d need to provide the <code class="language-plaintext highlighter-rouge">author_id</code>
value when creating the book.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">,</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
</code></pre></div></div>

<p>To delete an author and ensure all their books are also deleted, you need to
retrieve all the author’s <code class="language-plaintext highlighter-rouge">books</code>, loop through each <code class="language-plaintext highlighter-rouge">book</code> to destroy it, and
then destroy the author.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@books</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">author_id: </span><span class="vi">@author</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
<span class="vi">@books</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
  <span class="n">book</span><span class="p">.</span><span class="nf">destroy</span>
<span class="k">end</span>
<span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre></div></div>

<h3 id="using-associations">Using Associations</h3>

<p>However, with associations, we can streamline these operations, as well as
others, by explicitly informing Rails about the relationship between the two
models. Here’s the revised code for setting up authors and books using
associations:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre></div></div>

<p>With this change, creating a new book for a particular author is simpler:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
</code></pre></div></div>

<p>Deleting an author and all of its books is much easier:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@author</span><span class="p">.</span><span class="nf">destroy</span>
</code></pre></div></div>

<p>When you set up an association in Rails, you still need to create a
<a href="active_record_migrations.html">migration</a> to ensure that the database is
properly configured to handle the association. This migration will need to add
the necessary foreign key columns to your database tables.</p>

<p>For example, if you set up a <code class="language-plaintext highlighter-rouge">belongs_to :author</code> association in the <code class="language-plaintext highlighter-rouge">Book</code>
model, you would create a migration to add the <code class="language-plaintext highlighter-rouge">author_id</code> column to the <code class="language-plaintext highlighter-rouge">books</code>
table:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rails generate migration AddAuthorToBooks author:references
</code></pre></div></div>

<p>This migration will add the <code class="language-plaintext highlighter-rouge">author_id</code> column and set up the foreign key
relationship in the database, ensuring that your models and database stay in
sync.</p>

<p>To learn more about the different types of associations, you can read the next
section of this guide. Following that, you’ll find some tips and tricks for
working with associations. Finally, there’s a complete reference to the methods
and options for associations in Rails.</p>

<h2 id="types-of-associations">Types of Associations</h2>

<p>Rails supports six types of associations, each with a particular use-case in
mind.</p>

<p>Here is a list of all of the supported types with a link to their API docs for
more detailed information on how to use them, their method parameters, etc.</p>

<ul>
  <li>[<code class="language-plaintext highlighter-rouge">belongs_to</code>][]</li>
  <li>[<code class="language-plaintext highlighter-rouge">has_one</code>][]</li>
  <li>[<code class="language-plaintext highlighter-rouge">has_many</code>][]</li>
  <li>[<code class="language-plaintext highlighter-rouge">has_many :through</code>][<code class="language-plaintext highlighter-rouge">has_many</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">has_one :through</code>][<code class="language-plaintext highlighter-rouge">has_one</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>][]</li>
</ul>

<p>In the remainder of this guide, you’ll learn how to declare and use the various
forms of associations. First, let’s take a quick look at the situations where
each association type is appropriate.</p>

<p>[<code class="language-plaintext highlighter-rouge">belongs_to</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to
[<code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many
[<code class="language-plaintext highlighter-rouge">has_many</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many
[<code class="language-plaintext highlighter-rouge">has_one</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one</p>

<h3 id="belongs_to"><code class="language-plaintext highlighter-rouge">belongs_to</code></h3>

<p>A [<code class="language-plaintext highlighter-rouge">belongs_to</code>][] association sets up a relationship with another model, such
that each instance of the declaring model “belongs to” one instance of the other
model. For example, if your application includes authors and books, and each
book can be assigned to exactly one author, you’d declare the book model this
way:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre></div></div>

<p><img src="images/association_basics/belongs_to.png" alt="belongs_to Association Diagram" /></p>

<p>NOTE: A <code class="language-plaintext highlighter-rouge">belongs_to</code> association <em>must</em> use the singular term. If you use the
plural form, like <code class="language-plaintext highlighter-rouge">belongs_to :authors</code> in the <code class="language-plaintext highlighter-rouge">Book</code> model, and try to create a
book with <code class="language-plaintext highlighter-rouge">Book.create(authors: @author)</code>, Rails will give you an “uninitialized
constant Book::Authors” error. This happens because Rails automatically infers
the class name from the association name. If the association name is <code class="language-plaintext highlighter-rouge">:authors</code>,
Rails will look for a class named <code class="language-plaintext highlighter-rouge">Authors</code> instead of <code class="language-plaintext highlighter-rouge">Author</code>.</p>

<p>The corresponding migration might look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In database terms, the <code class="language-plaintext highlighter-rouge">belongs_to</code> association says that this model’s table
contains a column which represents a reference to another table. This can be
used to set up one-to-one or one-to-many relations, depending on the setup. If
the table <em>of the other class</em> contains the reference in a one-to-one relation,
then you should use <code class="language-plaintext highlighter-rouge">has_one</code> instead.</p>

<p>When used alone, <code class="language-plaintext highlighter-rouge">belongs_to</code> produces a one-directional one-to-one
relationship. Therefore each book in the above example “knows” its author, but
the authors don’t know about their books. To setup a <a href="#bi-directional-associations">bi-directional
association</a> - use <code class="language-plaintext highlighter-rouge">belongs_to</code> in combination
with a <code class="language-plaintext highlighter-rouge">has_one</code> or <code class="language-plaintext highlighter-rouge">has_many</code> on the other model, in this case the Author
model.</p>

<p>NOTE: By default <code class="language-plaintext highlighter-rouge">belongs_to</code> validates the presence of the associated record to
guarantee reference consistency.<br /><br />If <code class="language-plaintext highlighter-rouge">optional</code> is set to true in the
model, then <code class="language-plaintext highlighter-rouge">belongs_to</code> does not guarantee reference consistency. This means
that the foreign key in one table might not reliably point to a valid primary
key in the referenced table.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Hence, depending on the use case, you might also need to add a database-level
foreign key constraint on the reference column, like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This ensures that even though <code class="language-plaintext highlighter-rouge">optional: true</code> allows <code class="language-plaintext highlighter-rouge">author_id</code> to be NULL,
when it’s not NULL, it must still reference a valid record in the authors table.</p>

<h4 id="methods-added-by-belongs_to">Methods Added by <code class="language-plaintext highlighter-rouge">belongs_to</code></h4>

<p>When you declare a <code class="language-plaintext highlighter-rouge">belongs_to</code> association, the declaring class automatically
gains numerous methods related to the association. Some of these are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">association=(associate)</code></li>
  <li><code class="language-plaintext highlighter-rouge">build_association(attributes = {})</code></li>
  <li><code class="language-plaintext highlighter-rouge">create_association(attributes = {})</code></li>
  <li><code class="language-plaintext highlighter-rouge">create_association!(attributes = {})</code></li>
  <li><code class="language-plaintext highlighter-rouge">reload_association</code></li>
  <li><code class="language-plaintext highlighter-rouge">reset_association</code></li>
  <li><code class="language-plaintext highlighter-rouge">association_changed?</code></li>
  <li><code class="language-plaintext highlighter-rouge">association_previously_changed?</code></li>
</ul>

<p>We’ll discuss some of the common methods, but you can find an exhaustive list in
the <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-belongs_to">ActiveRecord Associations
API</a>.</p>

<p>In all of the above methods, <code class="language-plaintext highlighter-rouge">association</code> is replaced with the symbol passed as
the first argument to <code class="language-plaintext highlighter-rouge">belongs_to</code>. For example, given the declaration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/book.rb</span>
<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>

<span class="c1"># app/models/author.rb</span>
<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">validates</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>An instance of the <code class="language-plaintext highlighter-rouge">Book</code> model will have the following methods:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">author</code></li>
  <li><code class="language-plaintext highlighter-rouge">author=</code></li>
  <li><code class="language-plaintext highlighter-rouge">build_author</code></li>
  <li><code class="language-plaintext highlighter-rouge">create_author</code></li>
  <li><code class="language-plaintext highlighter-rouge">create_author!</code></li>
  <li><code class="language-plaintext highlighter-rouge">reload_author</code></li>
  <li><code class="language-plaintext highlighter-rouge">reset_author</code></li>
  <li><code class="language-plaintext highlighter-rouge">author_changed?</code></li>
  <li><code class="language-plaintext highlighter-rouge">author_previously_changed?</code></li>
</ul>

<p>NOTE: When initializing a new <code class="language-plaintext highlighter-rouge">has_one</code> or <code class="language-plaintext highlighter-rouge">belongs_to</code> association you must use
the <code class="language-plaintext highlighter-rouge">build_</code> prefix to build the association, rather than the
<code class="language-plaintext highlighter-rouge">association.build</code> method that would be used for <code class="language-plaintext highlighter-rouge">has_many</code> or
<code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> associations. To create one, use the <code class="language-plaintext highlighter-rouge">create_</code> prefix.</p>

<h5 id="retrieving-the-association">Retrieving the association</h5>

<p>The <code class="language-plaintext highlighter-rouge">association</code> method returns the associated object, if any. If no associated
object is found, it returns <code class="language-plaintext highlighter-rouge">nil</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span>
</code></pre></div></div>

<p>If the associated object has already been retrieved from the database for this
object, the cached version will be returned. To override this behavior (and
force a database read), call <code class="language-plaintext highlighter-rouge">#reload_association</code> on the parent object.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">reload_author</span>
</code></pre></div></div>

<p>To unload the cached version of the associated object—causing the next access,
if any, to query it from the database—call <code class="language-plaintext highlighter-rouge">#reset_association</code> on the parent
object.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@book</span><span class="p">.</span><span class="nf">reset_author</span>
</code></pre></div></div>

<h5 id="assigning-the-association">Assigning the Association</h5>

<p>The <code class="language-plaintext highlighter-rouge">association=</code> method assigns an associated object to this object. Behind
the scenes, this means extracting the primary key from the associated object and
setting this object’s foreign key to the same value.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="vi">@author</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">build_association</code> method returns a new object of the associated type. This
object will be instantiated from the passed attributes, and the link through
this object’s foreign key will be set, but the associated object will <em>not</em> yet
be saved.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">build_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                             <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">create_association</code> method takes it a step further and also saves the
associated object once it passes all of the validations specified on the
associated model.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@author</span> <span class="o">=</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">create_author</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span>
                              <span class="ss">author_name: </span><span class="s2">"John Doe"</span><span class="p">)</span>
</code></pre></div></div>

<p>Finally, <code class="language-plaintext highlighter-rouge">create_association!</code> does the same, but raises
<code class="language-plaintext highlighter-rouge">ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This will raise ActiveRecord::RecordInvalid because the name is blank</span>
<span class="k">begin</span>
  <span class="vi">@book</span><span class="p">.</span><span class="nf">create_author!</span><span class="p">(</span><span class="ss">author_number: </span><span class="mi">123</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">""</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">irb&gt;</span><span class="w"> </span><span class="ss">raise_validation_error: </span><span class="no">Validation</span> <span class="ss">failed: </span><span class="no">Name</span> <span class="n">can</span><span class="err">'</span><span class="n">t</span> <span class="n">be</span> <span class="n">blank</span> <span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="checking-for-association-changes">Checking for Association Changes</h5>

<p>The <code class="language-plaintext highlighter-rouge">association_changed?</code> method returns true if a new associated object has
been assigned and the foreign key will be updated in the next save.</p>

<p>The <code class="language-plaintext highlighter-rouge">association_previously_changed?</code> method returns true if the previous save
updated the association to reference a new associate object.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="c1"># =&gt; #&lt;Author author_number: 123, author_name: "John Doe"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; false</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">second</span> <span class="c1"># =&gt; #&lt;Author author_number: 456, author_name: "Jane Smith"&gt;</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; true</span>

<span class="vi">@book</span><span class="p">.</span><span class="nf">save!</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_changed?</span> <span class="c1"># =&gt; false</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author_previously_changed?</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>NOTE: Do not confuse <code class="language-plaintext highlighter-rouge">model.association_changed?</code> with
<code class="language-plaintext highlighter-rouge">model.association.changed?</code>. The former checks if the association has been
replaced with a new record, while the latter tracks changes to the attributes of
the association.</p>

<h5 id="checking-for-existing-associations">Checking for Existing Associations</h5>

<p>You can see if any associated objects exist by using the <code class="language-plaintext highlighter-rouge">association.nil?</code>
method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="vi">@book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No author found for this book"</span>
<span class="k">end</span>
</code></pre></div></div>

<h5 id="saving-behavior-of-associated-objects">Saving Behavior of Associated Objects</h5>

<p>Assigning an object to a <code class="language-plaintext highlighter-rouge">belongs_to</code> association does <em>not</em> automatically save
either the current object or the associated object. However, when you save the
current object, the association is saved as well.</p>

<h3 id="has_one"><code class="language-plaintext highlighter-rouge">has_one</code></h3>

<p>A [<code class="language-plaintext highlighter-rouge">has_one</code>][] association indicates that one other model has a reference to
this model. That model can be fetched through this association.</p>

<p>For example, if each supplier in your application has only one account, you’d
declare the supplier model like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The main difference from <code class="language-plaintext highlighter-rouge">belongs_to</code> is that the link column (in this case
<code class="language-plaintext highlighter-rouge">supplier_id</code>) is located in the other table, not the table where the <code class="language-plaintext highlighter-rouge">has_one</code>
is declared.</p>

<p><img src="images/association_basics/has_one.png" alt="has_one Association Diagram" /></p>

<p>The corresponding migration might look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">has_one</code> association creates a one-to-one match with another model. In
database terms, this association says that the other class contains the foreign
key. If this class contains the foreign key, then you should use <code class="language-plaintext highlighter-rouge">belongs_to</code>
instead.</p>

<p>Depending on the use case, you might also need to create a unique index and/or a
foreign key constraint on the supplier column for the accounts table. The unique
index ensures that each supplier is associated with only one account and allows
you to query in an efficient manner, while the foreign key constraint ensures
that the <code class="language-plaintext highlighter-rouge">supplier_id</code> in the <code class="language-plaintext highlighter-rouge">accounts</code> table refers to a valid <code class="language-plaintext highlighter-rouge">supplier</code> in
the <code class="language-plaintext highlighter-rouge">suppliers</code> table. This enforces the association at the database level.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">index: </span><span class="p">{</span> <span class="ss">unique: </span><span class="kp">true</span> <span class="p">},</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This relation can be <a href="#bi-directional-associations">bi-directional</a> when used in
combination with <code class="language-plaintext highlighter-rouge">belongs_to</code> on the other model.</p>

<h4 id="methods-added-by-has_one">Methods Added by <a href="#has-one"><code class="language-plaintext highlighter-rouge">has_one</code></a></h4>

<p>When you declare a <code class="language-plaintext highlighter-rouge">has_one</code> association,  the declaring class automatically
gains numerous methods related to the association. Some of these are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">association</code></li>
  <li><code class="language-plaintext highlighter-rouge">association=(associate)</code></li>
  <li><code class="language-plaintext highlighter-rouge">build_association(attributes = {})</code></li>
  <li><code class="language-plaintext highlighter-rouge">create_association(attributes = {})</code></li>
  <li><code class="language-plaintext highlighter-rouge">create_association!(attributes = {})</code></li>
  <li><code class="language-plaintext highlighter-rouge">reload_association</code></li>
  <li><code class="language-plaintext highlighter-rouge">reset_association</code></li>
</ul>

<p>We’ll discuss some of the common methods, but you can find an exhaustive list in
the <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_one">ActiveRecord Associations
API</a>.</p>

<p>Like with the <a href="#methods-added-by-belongs-to"><code class="language-plaintext highlighter-rouge">belongs_to</code> references</a>, in all of
these methods, <code class="language-plaintext highlighter-rouge">association</code> is replaced with the symbol passed as the first
argument to <code class="language-plaintext highlighter-rouge">has_one</code>. For example, given the declaration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/supplier.rb</span>
<span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="c1"># app/models/account.rb</span>
<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:terms</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Each instance of the <code class="language-plaintext highlighter-rouge">Supplier</code> model will have these methods:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">account</code></li>
  <li><code class="language-plaintext highlighter-rouge">account=</code></li>
  <li><code class="language-plaintext highlighter-rouge">build_account</code></li>
  <li><code class="language-plaintext highlighter-rouge">create_account</code></li>
  <li><code class="language-plaintext highlighter-rouge">create_account!</code></li>
  <li><code class="language-plaintext highlighter-rouge">reload_account</code></li>
  <li><code class="language-plaintext highlighter-rouge">reset_account</code></li>
</ul>

<p>NOTE: When initializing a new <code class="language-plaintext highlighter-rouge">has_one</code> or <code class="language-plaintext highlighter-rouge">belongs_to</code> association you must use
the <code class="language-plaintext highlighter-rouge">build_</code> prefix to build the association, rather than the
<code class="language-plaintext highlighter-rouge">association.build</code> method that would be used for <code class="language-plaintext highlighter-rouge">has_many</code> or
<code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> associations. To create one, use the <code class="language-plaintext highlighter-rouge">create_</code> prefix.</p>

<h5 id="retrieving-the-association-1">Retrieving the association</h5>

<p>The <code class="language-plaintext highlighter-rouge">association</code> method returns the associated object, if any. If no associated
object is found, it returns <code class="language-plaintext highlighter-rouge">nil</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span>
</code></pre></div></div>

<p>If the associated object has already been retrieved from the database for this
object, the cached version will be returned. To override this behavior (and
force a database read), call <code class="language-plaintext highlighter-rouge">#reload_association</code> on the parent object.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">reload_account</span>
</code></pre></div></div>

<p>To unload the cached version of the associated object—forcing the next access,
if any, to query it from the database—call <code class="language-plaintext highlighter-rouge">#reset_association</code> on the parent
object.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@supplier</span><span class="p">.</span><span class="nf">reset_account</span>
</code></pre></div></div>

<h5 id="assigning-the-association-1">Assigning the Association</h5>

<p>The <code class="language-plaintext highlighter-rouge">association=</code> method assigns an associated object to this object. Behind
the scenes, this means extracting the primary key from this object and setting
the associated object’s foreign key to the same value.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span> <span class="o">=</span> <span class="vi">@account</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">build_association</code> method returns a new object of the associated type. This
object will be instantiated from the passed attributes, and the link through
this objects foreign key will be set, but the associated object will <em>not</em> yet
be saved.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">build_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">create_association</code> method takes it a step further and also saves the
associated object once it passes all of the validations specified on the
associated model.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@account</span> <span class="o">=</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">create_account</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">"Net 30"</span><span class="p">)</span>
</code></pre></div></div>

<p>Finally, <code class="language-plaintext highlighter-rouge">create_association!</code> does the same as <code class="language-plaintext highlighter-rouge">create_association</code> above,
but raises <code class="language-plaintext highlighter-rouge">ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This will raise ActiveRecord::RecordInvalid because the terms is blank</span>
<span class="k">begin</span>
  <span class="vi">@supplier</span><span class="p">.</span><span class="nf">create_account!</span><span class="p">(</span><span class="ss">terms: </span><span class="s2">""</span><span class="p">)</span>
<span class="k">rescue</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span> <span class="o">=&gt;</span> <span class="n">e</span>
  <span class="nb">puts</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">irb&gt;</span><span class="w"> </span><span class="ss">raise_validation_error: </span><span class="no">Validation</span> <span class="ss">failed: </span><span class="no">Terms</span> <span class="n">can</span><span class="err">'</span><span class="n">t</span> <span class="n">be</span> <span class="n">blank</span> <span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordInvalid</span><span class="p">)</span>
</code></pre></div></div>

<h5 id="checking-for-existing-associations-1">Checking for Existing Associations</h5>

<p>You can see if any associated objects exist by using the <code class="language-plaintext highlighter-rouge">association.nil?</code>
method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="vi">@supplier</span><span class="p">.</span><span class="nf">account</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="vi">@msg</span> <span class="o">=</span> <span class="s2">"No account found for this supplier"</span>
<span class="k">end</span>
</code></pre></div></div>

<h5 id="saving-behavior-of-associated-objects-1">Saving Behavior of Associated Objects</h5>

<p>When you assign an object to a <code class="language-plaintext highlighter-rouge">has_one</code> association, that object is
automatically saved to update its foreign key. Additionally, any object being
replaced is also automatically saved, as its foreign key will change too.</p>

<p>If either of these saves fails due to validation errors, the assignment
statement returns <code class="language-plaintext highlighter-rouge">false</code>, and the assignment itself is canceled.</p>

<p>If the parent object (the one declaring the <code class="language-plaintext highlighter-rouge">has_one</code> association) is unsaved
(that is, <code class="language-plaintext highlighter-rouge">new_record?</code> returns <code class="language-plaintext highlighter-rouge">true</code>) then the child objects are not saved
immediately. They will be automatically saved when the parent object is saved.</p>

<p>If you want to assign an object to a <code class="language-plaintext highlighter-rouge">has_one</code> association without saving the
object, use the <code class="language-plaintext highlighter-rouge">build_association</code> method. This method creates a new, unsaved
instance of the associated object, allowing you to work with it before deciding
to save it.</p>

<p>Use <code class="language-plaintext highlighter-rouge">autosave: false</code> when you want to control the saving behavior of the
associated objects for the model. This setting prevents the associated object
from being saved automatically when the parent object is saved. In contrast, use
<code class="language-plaintext highlighter-rouge">build_association</code> when you need to work with an unsaved associated object and
delay its persistence until you’re ready.</p>

<h3 id="has_many"><code class="language-plaintext highlighter-rouge">has_many</code></h3>

<p>A [<code class="language-plaintext highlighter-rouge">has_many</code>][] association is similar to <code class="language-plaintext highlighter-rouge">has_one</code>, but indicates a
one-to-many relationship with another model. You’ll often find this association
on the “other side” of a <code class="language-plaintext highlighter-rouge">belongs_to</code> association. This association indicates
that each instance of the model has zero or more instances of another model. For
example, in an application containing authors and books, the author model could
be declared like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">has_many</code> establishes a one-to-many relationship between models, allowing each
instance of the declaring model (<code class="language-plaintext highlighter-rouge">Author</code>) to have multiple instances of the
associated model (<code class="language-plaintext highlighter-rouge">Book</code>).</p>

<p>NOTE: Unlike a <code class="language-plaintext highlighter-rouge">has_one</code> and <code class="language-plaintext highlighter-rouge">belongs_to</code> association, the name of the other
model is pluralized when declaring a <code class="language-plaintext highlighter-rouge">has_many</code> association.</p>

<p><img src="images/association_basics/has_many.png" alt="has_many Association Diagram" /></p>

<p>The corresponding migration might look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:authors</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">has_many</code> association creates a one-to-many relationship with another
model. In database terms, this association says that the other class will have a
foreign key that refers to instances of this class.</p>

<p>In this migration, the <code class="language-plaintext highlighter-rouge">authors</code> table is created with a <code class="language-plaintext highlighter-rouge">name</code> column to store
the names of authors. The <code class="language-plaintext highlighter-rouge">books</code> table is also created, and it includes a
<code class="language-plaintext highlighter-rouge">belongs_to :author</code> association. This association establishes a foreign key
relationship between the <code class="language-plaintext highlighter-rouge">books</code> and <code class="language-plaintext highlighter-rouge">authors</code> tables. Specifically, the
<code class="language-plaintext highlighter-rouge">author_id</code> column in the <code class="language-plaintext highlighter-rouge">books</code> table acts as a foreign key, referencing the
<code class="language-plaintext highlighter-rouge">id</code> column in the <code class="language-plaintext highlighter-rouge">authors</code> table. By including this <code class="language-plaintext highlighter-rouge">belongs_to :author</code>
association in the <code class="language-plaintext highlighter-rouge">books</code> table, we ensure that each book is associated with a
single author, enabling a <code class="language-plaintext highlighter-rouge">has_many</code> association from the <code class="language-plaintext highlighter-rouge">Author</code> model. This
setup allows each author to have multiple associated books.</p>

<p>Depending on the use case, it’s usually a good idea to create a non-unique index
and optionally a foreign key constraint on the author column for the books
table. Adding an index on the <code class="language-plaintext highlighter-rouge">author_id</code> column improves query performance when
retrieving books associated with a specific author.</p>

<p>If you wish to enforce <a href="https://en.wikipedia.org/wiki/Referential_integrity">referential
integrity</a> at the database
level, add the <a href="active_record_migrations.html#foreign-keys"><code class="language-plaintext highlighter-rouge">foreign_key: true</code></a>
option to the <code class="language-plaintext highlighter-rouge">reference</code> column declarations above. This will ensure that the
<code class="language-plaintext highlighter-rouge">author_id</code> in the books table must correspond to a valid <code class="language-plaintext highlighter-rouge">id</code> in the <code class="language-plaintext highlighter-rouge">authors</code>
table,</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">index: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="kp">true</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This relation can be <a href="#bi-directional-associations">bi-directional</a> when used in
combination with <code class="language-plaintext highlighter-rouge">belongs_to</code> on the other model.</p>

<h4 id="methods-added-by-has_many">Methods Added by <code class="language-plaintext highlighter-rouge">has_many</code></h4>

<p>When you declare a <code class="language-plaintext highlighter-rouge">has_many</code> association, the declaring class gains numerous
methods related to the association. Some of these are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">collection</code></li>
  <li>[<code class="language-plaintext highlighter-rouge">collection&lt;&lt;(object, ...)</code>][<code class="language-plaintext highlighter-rouge">collection&lt;&lt;</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.delete(object, ...)</code>][<code class="language-plaintext highlighter-rouge">collection.delete</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.destroy(object, ...)</code>][<code class="language-plaintext highlighter-rouge">collection.destroy</code>]</li>
  <li><code class="language-plaintext highlighter-rouge">collection=(objects)</code></li>
  <li><code class="language-plaintext highlighter-rouge">collection_singular_ids</code></li>
  <li><code class="language-plaintext highlighter-rouge">collection_singular_ids=(ids)</code></li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.clear</code>][]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.empty?</code>][]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.size</code>][]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.find(...)</code>][<code class="language-plaintext highlighter-rouge">collection.find</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.where(...)</code>][<code class="language-plaintext highlighter-rouge">collection.where</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.exists?(...)</code>][<code class="language-plaintext highlighter-rouge">collection.exists?</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.build(attributes = {})</code>][<code class="language-plaintext highlighter-rouge">collection.build</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.create(attributes = {})</code>][<code class="language-plaintext highlighter-rouge">collection.create</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.create!(attributes = {})</code>][<code class="language-plaintext highlighter-rouge">collection.create!</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.reload</code>][]</li>
</ul>

<p>We’ll discuss some of the common methods, but you can find an exhaustive list in
the <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_many">ActiveRecord Associations
API</a>.</p>

<p>In all of these methods, <code class="language-plaintext highlighter-rouge">collection</code> is replaced with the symbol passed as the
first argument to <code class="language-plaintext highlighter-rouge">has_many</code>, and <code class="language-plaintext highlighter-rouge">collection_singular</code> is replaced with the
singularized version of that symbol. For example, given the declaration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre></div></div>

<p>An instance of the <code class="language-plaintext highlighter-rouge">Author</code> model can have the following methods:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>books
books&lt;&lt;(object, ...)
books.delete(object, ...)
books.destroy(object, ...)
books=(objects)
book_ids
book_ids=(ids)
books.clear
books.empty?
books.size
books.find(...)
books.where(...)
books.exists?(...)
books.build(attributes = {}, ...)
books.create(attributes = {})
books.create!(attributes = {})
books.reload
</code></pre></div></div>

<p>[<code class="language-plaintext highlighter-rouge">collection&lt;&lt;</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-3C-3C
[<code class="language-plaintext highlighter-rouge">collection.build</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-build
[<code class="language-plaintext highlighter-rouge">collection.clear</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-clear
[<code class="language-plaintext highlighter-rouge">collection.create</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create
[<code class="language-plaintext highlighter-rouge">collection.create!</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-create-21
[<code class="language-plaintext highlighter-rouge">collection.delete</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-delete
[<code class="language-plaintext highlighter-rouge">collection.destroy</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-destroy
[<code class="language-plaintext highlighter-rouge">collection.empty?</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-empty-3F
[<code class="language-plaintext highlighter-rouge">collection.exists?</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/FinderMethods.html#method-i-exists-3F
[<code class="language-plaintext highlighter-rouge">collection.find</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-find
[<code class="language-plaintext highlighter-rouge">collection.reload</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-reload
[<code class="language-plaintext highlighter-rouge">collection.size</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/Associations/CollectionProxy.html#method-i-size
[<code class="language-plaintext highlighter-rouge">collection.where</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/QueryMethods.html#method-i-where</p>

<h5 id="managing-the-collection">Managing the Collection</h5>

<p>The <code class="language-plaintext highlighter-rouge">collection</code> method returns a Relation of all of the associated objects. If
there are no associated objects, it returns an empty Relation.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.delete</code>][] method removes one or more objects from the
collection by setting their foreign keys to <code class="language-plaintext highlighter-rouge">NULL</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre></div></div>

<p>WARNING: Additionally, objects will be destroyed if they’re associated with
<code class="language-plaintext highlighter-rouge">dependent: :destroy</code>, and deleted if they’re associated with <code class="language-plaintext highlighter-rouge">dependent:
:delete_all</code>.</p>

<p>The [<code class="language-plaintext highlighter-rouge">collection.destroy</code>][] method removes one or more objects from the
collection by running <code class="language-plaintext highlighter-rouge">destroy</code> on each object.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@book1</span><span class="p">)</span>
</code></pre></div></div>

<p>WARNING: Objects will <em>always</em> be removed from the database, ignoring the
<code class="language-plaintext highlighter-rouge">:dependent</code> option.</p>

<p>The [<code class="language-plaintext highlighter-rouge">collection.clear</code>][] method removes all objects from the collection
according to the strategy specified by the <code class="language-plaintext highlighter-rouge">dependent</code> option. If no option is
given, it follows the default strategy. The default strategy for <code class="language-plaintext highlighter-rouge">has_many
:through</code> associations is <code class="language-plaintext highlighter-rouge">delete_all</code>, and for <code class="language-plaintext highlighter-rouge">has_many</code> associations is to
set the foreign keys to <code class="language-plaintext highlighter-rouge">NULL</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">clear</span>
</code></pre></div></div>

<p>WARNING: Objects will be deleted if they’re associated with <code class="language-plaintext highlighter-rouge">dependent:
:destroy</code> or <code class="language-plaintext highlighter-rouge">dependent: :destroy_async</code>, just like <code class="language-plaintext highlighter-rouge">dependent: :delete_all</code>.</p>

<p>The [<code class="language-plaintext highlighter-rouge">collection.reload</code>][] method returns a Relation of all of the associated
objects, forcing a database read. If there are no associated objects, it returns
an empty Relation.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span>
</code></pre></div></div>

<h5 id="assigning-the-collection">Assigning the Collection</h5>

<p>The <code class="language-plaintext highlighter-rouge">collection=(objects)</code> method makes the collection contain only the supplied
objects, by adding and deleting as appropriate. The changes are persisted to the
database.</p>

<p>The <code class="language-plaintext highlighter-rouge">collection_singular_ids=(ids)</code> method makes the collection contain only the
objects identified by the supplied primary key values, by adding and deleting as
appropriate. The changes are persisted to the database.</p>

<h5 id="querying-the-collection">Querying the Collection</h5>

<p>The <code class="language-plaintext highlighter-rouge">collection_singular_ids</code> method returns an array of the ids of the objects
in the collection.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@book_ids</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">book_ids</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.empty?</code>][] method returns <code class="language-plaintext highlighter-rouge">true</code> if the collection does not
contain any associated objects.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span> <span class="cp">%&gt;</span>
  No Books Found
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.size</code>][] method returns the number of objects in the
collection.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@book_count</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.find</code>][] method finds objects within the collection’s table.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.where</code>][] method finds objects within the collection based on
the conditions supplied but the objects are loaded lazily meaning that the
database is queried only when the object(s) are accessed.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@available_books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">available: </span><span class="kp">true</span><span class="p">)</span> <span class="c1"># No query yet</span>
<span class="vi">@available_book</span> <span class="o">=</span> <span class="vi">@available_books</span><span class="p">.</span><span class="nf">first</span> <span class="c1"># Now the database will be queried</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.exists?</code>][] method checks whether an object meeting the
supplied conditions exists in the collection’s table.</p>

<h5 id="building-and-creating-associated-objects">Building and Creating Associated Objects</h5>

<p>The [<code class="language-plaintext highlighter-rouge">collection.build</code>][] method returns a single or array of new objects of
the associated type. The object(s) will be instantiated from the passed
attributes, and the link through their foreign key will be created, but the
associated objects will <em>not</em> yet be saved.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                            <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">build</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.create</code>][] method returns a single or array of new objects of
the associated type. The object(s) will be instantiated from the passed
attributes, the link through its foreign key will be created, and, once it
passes all of the validations specified on the associated model, the associated
object <em>will</em> be saved.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@book</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span>
                             <span class="ss">book_number: </span><span class="s2">"A12345"</span><span class="p">)</span>

<span class="vi">@books</span> <span class="o">=</span> <span class="vi">@author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">create</span><span class="p">([</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12346"</span> <span class="p">},</span>
  <span class="p">{</span> <span class="ss">published_at: </span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">,</span> <span class="ss">book_number: </span><span class="s2">"A12347"</span> <span class="p">}</span>
<span class="p">])</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">collection.create!</code> does the same as <code class="language-plaintext highlighter-rouge">collection.create</code>, but raises
<code class="language-plaintext highlighter-rouge">ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<h5 id="when-are-objects-saved">When are Objects Saved?</h5>

<p>When you assign an object to a <code class="language-plaintext highlighter-rouge">has_many</code> association, that object is
automatically saved (in order to update its foreign key). If you assign multiple
objects in one statement, then they are all saved.</p>

<p>If any of these saves fails due to validation errors, then the assignment
statement returns <code class="language-plaintext highlighter-rouge">false</code> and the assignment itself is cancelled.</p>

<p>If the parent object (the one declaring the <code class="language-plaintext highlighter-rouge">has_many</code> association) is unsaved
(that is, <code class="language-plaintext highlighter-rouge">new_record?</code> returns <code class="language-plaintext highlighter-rouge">true</code>) then the child objects are not saved
when they are added. All unsaved members of the association will automatically
be saved when the parent is saved.</p>

<p>If you want to assign an object to a <code class="language-plaintext highlighter-rouge">has_many</code> association without saving the
object, use the <code class="language-plaintext highlighter-rouge">collection.build</code> method.</p>

<h3 id="has_many-through"><code class="language-plaintext highlighter-rouge">has_many :through</code></h3>

<p>A [<code class="language-plaintext highlighter-rouge">has_many :through</code>][<code class="language-plaintext highlighter-rouge">has_many</code>] association is often used to set up a
many-to-many relationship with another model. This association indicates that
the declaring model can be matched with zero or more instances of another model
by proceeding <em>through</em> an intermediate “join” model.</p>

<p>For example, consider a medical practice where patients make appointments to see
physicians. The relevant association declarations could look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Physician</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:patients</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Appointment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:physician</span>
  <span class="n">belongs_to</span> <span class="ss">:patient</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Patient</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:appointments</span>
  <span class="n">has_many</span> <span class="ss">:physicians</span><span class="p">,</span> <span class="ss">through: :appointments</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">has_many :through</code> establishes a many-to-many relationship between models,
allowing instances of one model (Physician) to be associated with multiple
instances of another model (Patient) through a third “join” model (Appointment).</p>

<p>We call <code class="language-plaintext highlighter-rouge">Physician.appointments</code> and <code class="language-plaintext highlighter-rouge">Appointment.patient</code> the <em>through</em> and
<em>source</em> associations of <code class="language-plaintext highlighter-rouge">Physician.patients</code>, respectively.</p>

<p><img src="images/association_basics/has_many_through.png" alt="has_many :through Association
Diagram" /></p>

<p>The corresponding migration might look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:physicians</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:patients</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:appointments</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this migration the <code class="language-plaintext highlighter-rouge">physicians</code> and <code class="language-plaintext highlighter-rouge">patients</code> tables are created with a
<code class="language-plaintext highlighter-rouge">name</code> column. The <code class="language-plaintext highlighter-rouge">appointments</code> table, which acts as the join table, is
created with <code class="language-plaintext highlighter-rouge">physician_id</code> and <code class="language-plaintext highlighter-rouge">patient_id</code> columns, establishing the
many-to-many relationship between <code class="language-plaintext highlighter-rouge">physicians</code> and <code class="language-plaintext highlighter-rouge">patients</code>.</p>

<p>INFO: The through association can be any type of association, including other
through associations, but it cannot be <a href="#polymorphic-associations">polymorphic</a>.
Source associations can be polymorphic as long as you provide a source type.</p>

<p>You could also consider using a <a href="active_record_composite_primary_keys.html">composite primary
key</a> for the join table in the
<code class="language-plaintext highlighter-rouge">has_many :through</code> relationship like below:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="c1">#  ...</span>
    <span class="n">create_table</span> <span class="ss">:appointments</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="p">[</span><span class="ss">:physician_id</span><span class="p">,</span> <span class="ss">:patient_id</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The collection of join models in a <code class="language-plaintext highlighter-rouge">has_many :through</code> association can be
managed using standard <a href="#methods-added-by-has-many"><code class="language-plaintext highlighter-rouge">has_many</code> association
methods</a>. For example, if you assign a list of
patients to a physician like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">physician</span><span class="p">.</span><span class="nf">patients</span> <span class="o">=</span> <span class="n">patients</span>
</code></pre></div></div>

<p>Rails will automatically create new join models for any patients in the new list
that were not previously associated with the physician. Additionally, if any
patients that were previously associated with the physician are not included in
the new list, their join records will be automatically deleted. This simplifies
managing many-to-many relationships by handling the creation and deletion of the
join models for you.</p>

<p>WARNING: Automatic deletion of join models is direct, no destroy callbacks are
triggered. You can read more about callbacks in the <a href="active_record_callbacks.html">Active Record Callbacks
Guide</a>.</p>

<p>The <code class="language-plaintext highlighter-rouge">has_many :through</code> association is also useful for setting up “shortcuts”
through nested <code class="language-plaintext highlighter-rouge">has_many</code> associations. This is particularly beneficial when you
need to access a collection of related records through an intermediary
association.</p>

<p>For example, if a document has many sections, and each section has many
paragraphs, you may sometimes want to get a simple collection of all paragraphs
in the document without having to manually traverse through each section.</p>

<p>You can set this up with a <code class="language-plaintext highlighter-rouge">has_many :through</code> association as follows:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Document</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:sections</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span><span class="p">,</span> <span class="ss">through: :sections</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Section</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:document</span>
  <span class="n">has_many</span> <span class="ss">:paragraphs</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Paragraph</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:section</span>
<span class="k">end</span>
</code></pre></div></div>

<p>With <code class="language-plaintext highlighter-rouge">through: :sections</code> specified, Rails will now understand:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@document</span><span class="p">.</span><span class="nf">paragraphs</span>
</code></pre></div></div>

<p>Whereas, if you had not set up a <code class="language-plaintext highlighter-rouge">has_many :through</code> association, you would have
needed to do something like this to get paragraphs in a document:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">paragraphs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="vi">@document</span><span class="p">.</span><span class="nf">sections</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">section</span><span class="o">|</span>
  <span class="n">paragraphs</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">section</span><span class="p">.</span><span class="nf">paragraphs</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="has_one-through"><code class="language-plaintext highlighter-rouge">has_one :through</code></h3>

<p>A [<code class="language-plaintext highlighter-rouge">has_one :through</code>][<code class="language-plaintext highlighter-rouge">has_one</code>] association sets up a one-to-one relationship
with another model through an intermediary model. This association indicates
that the declaring model can be matched with one instance of another model by
proceeding <em>through</em> a third model.</p>

<p>For example, if each supplier has one account, and each account is associated
with one account history, then the supplier model could look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span><span class="p">,</span> <span class="ss">through: :account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">has_one</span> <span class="ss">:account_history</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">AccountHistory</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:account</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This setup allows a <code class="language-plaintext highlighter-rouge">supplier</code> to directly access its <code class="language-plaintext highlighter-rouge">account_history</code> through
its <code class="language-plaintext highlighter-rouge">account</code>.</p>

<p>We call <code class="language-plaintext highlighter-rouge">Supplier.account</code> and <code class="language-plaintext highlighter-rouge">Account.account_history</code> the <em>through</em> and
<em>source</em> associations of <code class="language-plaintext highlighter-rouge">Supplier.account_history</code>, respectively.</p>

<p><img src="images/association_basics/has_one_through.png" alt="has_one :through Association
Diagram" /></p>

<p>The corresponding migration to set up these associations might look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateAccountHistories</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:account_histories</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:account</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">integer</span> <span class="ss">:credit_rating</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>INFO: The through association must be a <code class="language-plaintext highlighter-rouge">has_one</code>, <code class="language-plaintext highlighter-rouge">has_one :through</code>, or
non-polymorphic <code class="language-plaintext highlighter-rouge">belongs_to</code>. That is, a non-polymorphic singular association.
On the other hand, source associations can be polymorphic as long as you provide
a source type.</p>

<h3 id="has_and_belongs_to_many"><code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code></h3>

<p>A [<code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>][] association creates a direct many-to-many
relationship with another model, with no intervening model. This association
indicates that each instance of the declaring model refers to zero or more
instances of another model.</p>

<p>For example, consider an application with <code class="language-plaintext highlighter-rouge">Assembly</code> and <code class="language-plaintext highlighter-rouge">Part</code> models, where
each assembly can contain many parts, and each part can be used in many
assemblies. You can set up the models as follows:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre></div></div>

<p><img src="images/association_basics/habtm.png" alt="has_and_belongs_to_many Association
Diagram" /></p>

<p>Even though a <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> does not require an intervening model,
it does require a separate table to establish the many-to-many relationship
between the two models involved. This intervening table serves to store the
related data, mapping the associations between instances of the two models. The
table does not necessarily need a primary key since its purpose is solely to
manage the relationship between the associated records. The corresponding
migration might look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateAssembliesAndParts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:part_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="c1"># Create a join table to establish the many-to-many relationship between assemblies and parts.</span>
    <span class="c1"># `id: false` indicates that the table does not need a primary key of its own</span>
    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="c1"># creates foreign keys linking the join table to the `assemblies` and `parts` tables</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:assembly</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:part</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> association creates a many-to-many relationship
with another model. In database terms, this associates two classes via an
intermediate join table that includes foreign keys referring to each of the
classes.</p>

<p>If the join table for a <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> association has additional
columns beyond the two foreign keys, these columns will be added as attributes
to records retrieved via that association. Records returned with additional
attributes will always be read-only, because Rails cannot save changes to those
attributes.</p>

<p>WARNING: The use of extra attributes on the join table in a
<code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> association is deprecated. If you require this sort of
complex behavior on the table that joins two models in a many-to-many
relationship, you should use a <code class="language-plaintext highlighter-rouge">has_many :through</code> association instead of
<code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>.</p>

<h4 id="methods-added-by-has_and_belongs_to_many">Methods Added by <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code></h4>

<p>When you declare a <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> association, the declaring class
gains numerous methods related to the association. Some of these are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">collection</code></li>
  <li>[<code class="language-plaintext highlighter-rouge">collection&lt;&lt;(object, ...)</code>][<code class="language-plaintext highlighter-rouge">collection&lt;&lt;</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.delete(object, ...)</code>][<code class="language-plaintext highlighter-rouge">collection.delete</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.destroy(object, ...)</code>][<code class="language-plaintext highlighter-rouge">collection.destroy</code>]</li>
  <li><code class="language-plaintext highlighter-rouge">collection=(objects)</code></li>
  <li><code class="language-plaintext highlighter-rouge">collection_singular_ids</code></li>
  <li><code class="language-plaintext highlighter-rouge">collection_singular_ids=(ids)</code></li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.clear</code>][]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.empty?</code>][]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.size</code>][]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.find(...)</code>][<code class="language-plaintext highlighter-rouge">collection.find</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.where(...)</code>][<code class="language-plaintext highlighter-rouge">collection.where</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.exists?(...)</code>][<code class="language-plaintext highlighter-rouge">collection.exists?</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.build(attributes = {})</code>][<code class="language-plaintext highlighter-rouge">collection.build</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.create(attributes = {})</code>][<code class="language-plaintext highlighter-rouge">collection.create</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.create!(attributes = {})</code>][<code class="language-plaintext highlighter-rouge">collection.create!</code>]</li>
  <li>[<code class="language-plaintext highlighter-rouge">collection.reload</code>][]</li>
</ul>

<p>We’ll discuss some of the common methods, but you can find an exhaustive list in
the <a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html#method-i-has_and_belongs_to_many">ActiveRecord Associations
API</a>.</p>

<p>In all of these methods, <code class="language-plaintext highlighter-rouge">collection</code> is replaced with the symbol passed as the
first argument to <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>, and <code class="language-plaintext highlighter-rouge">collection_singular</code> is
replaced with the singularized version of that symbol. For example, given the
declaration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre></div></div>

<p>An instance of the <code class="language-plaintext highlighter-rouge">Part</code> model can have the following methods:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>assemblies
assemblies&lt;&lt;(object, ...)
assemblies.delete(object, ...)
assemblies.destroy(object, ...)
assemblies=(objects)
assembly_ids
assembly_ids=(ids)
assemblies.clear
assemblies.empty?
assemblies.size
assemblies.find(...)
assemblies.where(...)
assemblies.exists?(...)
assemblies.build(attributes = {}, ...)
assemblies.create(attributes = {})
assemblies.create!(attributes = {})
assemblies.reload
</code></pre></div></div>

<h5 id="managing-the-collection-1">Managing the Collection</h5>

<p>The <code class="language-plaintext highlighter-rouge">collection</code> method returns a Relation of all of the associated objects. If
there are no associated objects, it returns an empty Relation.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection&lt;&lt;</code>][] method adds one or more objects to the collection by
creating records in the join table.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span> <span class="o">&lt;&lt;</span> <span class="vi">@assembly1</span>
</code></pre></div></div>

<p>NOTE: This method is aliased as <code class="language-plaintext highlighter-rouge">collection.concat</code> and <code class="language-plaintext highlighter-rouge">collection.push</code>.</p>

<p>The [<code class="language-plaintext highlighter-rouge">collection.delete</code>][] method removes one or more objects from the
collection by deleting records in the join table. This does not destroy the
objects.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.destroy</code>][] method removes one or more objects from the
collection by deleting records in the join table. This does not destroy the
objects.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">destroy</span><span class="p">(</span><span class="vi">@assembly1</span><span class="p">)</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.clear</code>][] method removes every object from the collection by
deleting the rows from the joining table. This does not destroy the associated
objects.</p>

<h5 id="assigning-the-collection-1">Assigning the Collection</h5>

<p>The <code class="language-plaintext highlighter-rouge">collection=</code> method makes the collection contain only the supplied objects,
by adding and deleting as appropriate. The changes are persisted to the
database.</p>

<p>The <code class="language-plaintext highlighter-rouge">collection_singular_ids=</code> method makes the collection contain only the
objects identified by the supplied primary key values, by adding and deleting as
appropriate. The changes are persisted to the database.</p>

<h5 id="querying-the-collection-1">Querying the Collection</h5>

<p>The <code class="language-plaintext highlighter-rouge">collection_singular_ids</code> method returns an array of the ids of the objects
in the collection.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@assembly_ids</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assembly_ids</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.empty?</code>][] method returns <code class="language-plaintext highlighter-rouge">true</code> if the collection does not
contain any associated objects.</p>

<pre><code class="language-html+erb">&lt;% if @part.assemblies.empty? %&gt;
  This part is not used in any assemblies
&lt;% end %&gt;
</code></pre>

<p>The [<code class="language-plaintext highlighter-rouge">collection.size</code>][] method returns the number of objects in the
collection.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@assembly_count</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">size</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.find</code>][] method finds objects within the collection’s table.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.where</code>][] method finds objects within the collection based on
the conditions supplied but the objects are loaded lazily meaning that the
database is queried only when the object(s) are accessed.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@new_assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">2</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.exists?</code>][] method checks whether an object meeting the
supplied conditions exists in the collection’s table.</p>

<h5 id="building-and-creating-associated-objects-1">Building and Creating Associated Objects</h5>

<p>The [<code class="language-plaintext highlighter-rouge">collection.build</code>][] method returns a new object of the associated type.
This object will be instantiated from the passed attributes, and the link
through the join table will be created, but the associated object will <em>not</em> yet
be saved.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">build</span><span class="p">({</span> <span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span> <span class="p">})</span>
</code></pre></div></div>

<p>The [<code class="language-plaintext highlighter-rouge">collection.create</code>][] method returns a new object of the associated type.
This object will be instantiated from the passed attributes, the link through
the join table will be created, and, once it passes all of the validations
specified on the associated model, the associated object <em>will</em> be saved.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@assembly</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span> <span class="ss">assembly_name: </span><span class="s2">"Transmission housing"</span> <span class="p">})</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">collection.create!</code> does the same as <code class="language-plaintext highlighter-rouge">collection.create</code>, but raises
<code class="language-plaintext highlighter-rouge">ActiveRecord::RecordInvalid</code> if the record is invalid.</p>

<p>The [<code class="language-plaintext highlighter-rouge">collection.reload</code>][] method returns a Relation of all of the associated
objects, forcing a database read. If there are no associated objects, it returns
an empty Relation.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@assemblies</span> <span class="o">=</span> <span class="vi">@part</span><span class="p">.</span><span class="nf">assemblies</span><span class="p">.</span><span class="nf">reload</span>
</code></pre></div></div>

<h5 id="when-are-objects-saved-1">When are Objects Saved?</h5>

<p>When you assign an object to a <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> association, that
object is automatically saved (in order to update the join table). If you assign
multiple objects in one statement, then they are all saved.</p>

<p>If any of these saves fails due to validation errors, then the assignment
statement returns <code class="language-plaintext highlighter-rouge">false</code> and the assignment itself is cancelled.</p>

<p>If the parent object (the one declaring the <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>
association) is unsaved (that is, <code class="language-plaintext highlighter-rouge">new_record?</code> returns <code class="language-plaintext highlighter-rouge">true</code>) then the child
objects are not saved when they are added. All unsaved members of the
association will automatically be saved when the parent is saved.</p>

<p>If you want to assign an object to a <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> association
without saving the object, use the <code class="language-plaintext highlighter-rouge">collection.build</code> method.</p>

<h2 id="choosing-an-association">Choosing an Association</h2>

<h3 id="belongs_to-vs-has_one"><code class="language-plaintext highlighter-rouge">belongs_to</code> vs <code class="language-plaintext highlighter-rouge">has_one</code></h3>

<p>If you want to set up a one-to-one relationship between two models, you can
choose between a <code class="language-plaintext highlighter-rouge">belongs_to</code> and a <code class="language-plaintext highlighter-rouge">has_one</code> association. How do you know which
one to choose?</p>

<p>The distinction lies in the placement of the foreign key, which goes on the
table of the class declaring the <code class="language-plaintext highlighter-rouge">belongs_to</code> association. However, it’s
essential to understand the semantics to determine the correct associations:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">belongs_to</code>: This association indicates that the current model contains the
foreign key and is a child in the relationship. It references another model,
implying that each instance of this model is linked to one instance of the
other model.</li>
  <li><code class="language-plaintext highlighter-rouge">has_one</code>: This association indicates that the current model is the parent in
the relationship, and it owns one instance of the other model.</li>
</ul>

<p>For example, consider a scenario with suppliers and their accounts. It makes
more sense to say that a supplier has/owns an account (where the supplier is the
parent) rather than an account has/owns a supplier. Therefore, the correct
associations would be:</p>

<ul>
  <li>A supplier has one account.</li>
  <li>An account belongs to one supplier.</li>
</ul>

<p>Here is how you can define these associations in Rails:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
<span class="k">end</span>
</code></pre></div></div>

<p>To implement these associations, you’ll need to create the corresponding
database tables and set up the foreign key. Here’s an example migration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateSuppliers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:suppliers</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">create_table</span> <span class="ss">:accounts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:supplier_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:account_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:accounts</span><span class="p">,</span> <span class="ss">:supplier_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Remember that the foreign key goes on the table of the class declaring the
belongs_to association. In this case the <code class="language-plaintext highlighter-rouge">account</code> table.</p>

<h3 id="has_many-through-vs-has_and_belongs_to_many"><code class="language-plaintext highlighter-rouge">has_many :through</code> vs <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code></h3>

<p>Rails offers two different ways to declare a many-to-many relationship between
models: <code class="language-plaintext highlighter-rouge">has_many :through</code> and <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>. Understanding the
differences and use cases for each can help you choose the best approach for
your application’s needs.</p>

<p>The <code class="language-plaintext highlighter-rouge">has_many :through</code> association sets up a many-to-many relationship through
an intermediary model (also known as a join model). This approach is more
flexible and allows you to add validations, callbacks, and extra attributes to
the join model. The join table needs a <code class="language-plaintext highlighter-rouge">primary_key</code> (or a <a href="active_record_composite_primary_keys.html">composite primary
key</a>).</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:parts</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Manifest</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:assembly</span>
  <span class="n">belongs_to</span> <span class="ss">:part</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:manifests</span>
  <span class="n">has_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">through: :manifests</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You’d use <code class="language-plaintext highlighter-rouge">has_many :through</code> when:</p>

<ul>
  <li>You need to add extra attributes or methods to the join table.</li>
  <li>You require <a href="active_record_validations.html">validations</a> or
<a href="active_record_callbacks.html">callbacks</a> on the join model.</li>
  <li>The join table should be treated as an independent entity with its own
behavior.</li>
</ul>

<p>The <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> association allows you to create a many-to-many
relationship directly between two models without needing an intermediary model.
This method is straightforward and is suitable for simple associations where no
additional attributes or behaviors are required on the join table. For
<code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> associations, you’ll need to create a join table
without a primary key.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You’d use <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> when:</p>

<ul>
  <li>The association is simple and does not require additional attributes or
behaviors on the join table.</li>
  <li>You do not need validations, callbacks, or extra methods on the join table.</li>
</ul>

<h2 id="advanced-associations">Advanced Associations</h2>

<h3 id="polymorphic-associations">Polymorphic Associations</h3>

<p>A slightly more advanced twist on associations is the <em>polymorphic association</em>.
Polymorphic associations in Rails allow a model to belong to multiple other
models through a single association. This can be particularly useful when you
have a model that needs to be linked to different types of models.</p>

<p>For instance, imagine you have a <code class="language-plaintext highlighter-rouge">Picture</code> model that can belong to <strong>either</strong>
an <code class="language-plaintext highlighter-rouge">Employee</code> or a <code class="language-plaintext highlighter-rouge">Product</code>, because each of these can have a profile picture.
Here’s how this could be declared:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Picture</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Product</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="ss">as: :imageable</span>
<span class="k">end</span>
</code></pre></div></div>

<p><img src="images/association_basics/polymorphic.png" alt="Polymorphic Association Diagram" /></p>

<p>In the context above, <code class="language-plaintext highlighter-rouge">imageable</code> is a name chosen for the association. It’s a
symbolic name that represents the polymorphic association between the <code class="language-plaintext highlighter-rouge">Picture</code>
model and other models such as <code class="language-plaintext highlighter-rouge">Employee</code> and <code class="language-plaintext highlighter-rouge">Product</code>. The important thing is
to use the same name (<code class="language-plaintext highlighter-rouge">imageable</code>) consistently across all associated models to
establish the polymorphic association correctly.</p>

<p>When you declare <code class="language-plaintext highlighter-rouge">belongs_to :imageable, polymorphic: true</code> in the <code class="language-plaintext highlighter-rouge">Picture</code>
model, you’re saying that a <code class="language-plaintext highlighter-rouge">Picture</code> can belong to any model (like <code class="language-plaintext highlighter-rouge">Employee</code>
or <code class="language-plaintext highlighter-rouge">Product</code>) through this association.</p>

<p>You can think of a polymorphic <code class="language-plaintext highlighter-rouge">belongs_to</code> declaration as setting up an
interface that any other model can use. This allows you to retrieve a collection
of pictures from an instance of the <code class="language-plaintext highlighter-rouge">Employee</code> model using <code class="language-plaintext highlighter-rouge">@employee.pictures</code>.
Similarly, you can retrieve a collection of pictures from an instance of the
<code class="language-plaintext highlighter-rouge">Product</code> model using <code class="language-plaintext highlighter-rouge">@product.pictures</code>.</p>

<p>Additionally, if you have an instance of the <code class="language-plaintext highlighter-rouge">Picture</code> model, you can get its
parent via <code class="language-plaintext highlighter-rouge">@picture.imageable</code>, which could be an <code class="language-plaintext highlighter-rouge">Employee</code> or a <code class="language-plaintext highlighter-rouge">Product</code>.</p>

<p>To setup a polymorphic association manually you would need to declare both a
foreign key column (<code class="language-plaintext highlighter-rouge">imageable_id</code>) and a type column (<code class="language-plaintext highlighter-rouge">imageable_type</code>) in the
model:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span>  <span class="ss">:imageable_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>  <span class="ss">:imageable_type</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:pictures</span><span class="p">,</span> <span class="p">[</span><span class="ss">:imageable_type</span><span class="p">,</span> <span class="ss">:imageable_id</span><span class="p">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In our example, <code class="language-plaintext highlighter-rouge">imageable_id</code> could be the ID of either an <code class="language-plaintext highlighter-rouge">Employee</code> or a
<code class="language-plaintext highlighter-rouge">Product</code>, and <code class="language-plaintext highlighter-rouge">imageable_type</code> is the name of the associated model’s class, so
either <code class="language-plaintext highlighter-rouge">Employee</code> or <code class="language-plaintext highlighter-rouge">Product</code>.</p>

<p>While creating the polymorphic association manually is acceptable, it is instead
recommended to use <code class="language-plaintext highlighter-rouge">t.references</code> or its alias <code class="language-plaintext highlighter-rouge">t.belongs_to</code> and specify
<code class="language-plaintext highlighter-rouge">polymorphic: true</code> so that Rails knows that the association is polymorphic, and
it automatically adds both the foreign key and type columns to the table.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreatePictures</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:pictures</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:imageable</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>WARNING: Since polymorphic associations rely on storing class names in the
database, that data must remain synchronized with the class name used by the
Ruby code. When renaming a class, make sure to update the data in the
polymorphic type column.</p>

<p>For example, if you change the class name from <code class="language-plaintext highlighter-rouge">Product</code> to <code class="language-plaintext highlighter-rouge">Item</code> then you’d
need to run a migration script to update the <code class="language-plaintext highlighter-rouge">imageable_type</code> column in the
<code class="language-plaintext highlighter-rouge">pictures</code> table (or whichever table is affected) with the new class name.
Additionally, you’ll need to update any other references to the class name
throughout your application code to reflect the change.</p>

<h3 id="models-with-composite-primary-keys">Models with Composite Primary Keys</h3>

<p>Rails can often infer primary key-foreign key relationships between associated
models, but when dealing with composite primary keys, Rails typically defaults
to using only part of the composite key, often the id column, unless explicitly
instructed otherwise.</p>

<p>If you’re working with composite primary keys in your Rails models and need to
ensure the correct handling of associations, please refer to the <a href="active_record_composite_primary_keys.html#associations-between-models-with-composite-primary-keys">Associations
section of the Composite Primary Keys
guide</a>.
This section provides comprehensive guidance on setting up and using
associations with composite primary keys in Rails, including how to specify
composite foreign keys when necessary.</p>

<h3 id="self-joins">Self Joins</h3>

<p>A self-join is a regular join, but the table is joined with itself. This is
useful in situations where there is a hierarchical relationship within a single
table. A common example is an employee management system where an employee can
have a manager, and that manager is also an employee.</p>

<p>Consider an organization where employees can be managers of other employees. We
want to track this relationship using a single <code class="language-plaintext highlighter-rouge">employees</code> table.</p>

<p>In your Rails model, you define the <code class="language-plaintext highlighter-rouge">Employee</code> class to reflect these
relationships:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Employee</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># an employee can have many subordinates.</span>
  <span class="n">has_many</span> <span class="ss">:subordinates</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"manager_id"</span>

  <span class="c1"># an employee can have one manager.</span>
  <span class="n">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Employee"</span><span class="p">,</span> <span class="ss">optional: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">has_many :subordinates</code> sets up a one-to-many relationship where an employee
can have many subordinates. Here, we specify that the related model is also
<code class="language-plaintext highlighter-rouge">Employee</code> (<code class="language-plaintext highlighter-rouge">class_name: "Employee"</code>) and the foreign key used to identify the
manager is <code class="language-plaintext highlighter-rouge">manager_id</code>.</p>

<p><code class="language-plaintext highlighter-rouge">belongs_to :manager</code> sets up a one-to-one relationship where an employee can
belong to one manager. Again, we specify the related model as <code class="language-plaintext highlighter-rouge">Employee</code>.</p>

<p>To support this relationship, we need to add a <code class="language-plaintext highlighter-rouge">manager_id</code> column to the
<code class="language-plaintext highlighter-rouge">employees</code> table. This column references the <code class="language-plaintext highlighter-rouge">id</code> of another employee (the
manager).</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateEmployees</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:employees</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="c1"># Add a belongs_to reference to the manager, which is an employee.</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:manager</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="p">{</span> <span class="ss">to_table: :employees</span> <span class="p">}</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">t.belongs_to :manager</code> adds a <code class="language-plaintext highlighter-rouge">manager_id</code> column to the <code class="language-plaintext highlighter-rouge">employees</code> table.</li>
  <li><code class="language-plaintext highlighter-rouge">foreign_key: { to_table: :employees }</code> ensures that the <code class="language-plaintext highlighter-rouge">manager_id</code> column
references the <code class="language-plaintext highlighter-rouge">id</code> column of the <code class="language-plaintext highlighter-rouge">employees</code> table.</li>
</ul>

<p>NOTE: The <code class="language-plaintext highlighter-rouge">to_table</code> option passed to <code class="language-plaintext highlighter-rouge">foreign_key</code> and more are explained in
[<code class="language-plaintext highlighter-rouge">SchemaStatements#add_reference</code>][connection.add_reference].</p>

<p>With this setup, you can easily access an employee’s subordinates and manager in
your Rails application.</p>

<p>To get an employee’s subordinates:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">employee</span> <span class="o">=</span> <span class="no">Employee</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">subordinates</span> <span class="o">=</span> <span class="n">employee</span><span class="p">.</span><span class="nf">subordinates</span>
</code></pre></div></div>

<p>To get an employee’s manager:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">manager</span> <span class="o">=</span> <span class="n">employee</span><span class="p">.</span><span class="nf">manager</span>
</code></pre></div></div>

<p>[connection.add_reference]:
    https://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html#method-i-add_reference</p>

<h2 id="single-table-inheritance-sti">Single Table Inheritance (STI)</h2>

<p>Single Table Inheritance (STI) is a pattern in Rails that allows multiple models
to be stored in a single database table. This is useful when you have different
types of entities that share common attributes and behavior but also have
specific behaviors.</p>

<p>For example, suppose we have <code class="language-plaintext highlighter-rouge">Car</code>, <code class="language-plaintext highlighter-rouge">Motorcycle</code>, and <code class="language-plaintext highlighter-rouge">Bicycle</code> models. These
models will share fields like <code class="language-plaintext highlighter-rouge">color</code> and <code class="language-plaintext highlighter-rouge">price</code>, but each will have unique
behaviors. They will also each have their own controller.</p>

<h3 id="generating-the-base-vehicle-model">Generating the Base Vehicle Model</h3>

<p>First, we generate the base <code class="language-plaintext highlighter-rouge">Vehicle</code> model with shared fields:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate model vehicle <span class="nb">type</span>:string color:string price:decimal<span class="o">{</span>10.2<span class="o">}</span>
</code></pre></div></div>

<p>Here, the <code class="language-plaintext highlighter-rouge">type</code> field is crucial for STI as it stores the model name (<code class="language-plaintext highlighter-rouge">Car</code>,
<code class="language-plaintext highlighter-rouge">Motorcycle</code>, or <code class="language-plaintext highlighter-rouge">Bicycle</code>). STI requires this field to differentiate between
the different models stored in the same table.</p>

<h3 id="generating-child-models">Generating Child Models</h3>

<p>Next, we generate the <code class="language-plaintext highlighter-rouge">Car</code>, <code class="language-plaintext highlighter-rouge">Motorcycle</code>, and <code class="language-plaintext highlighter-rouge">Bicycle</code> models that inherit
from Vehicle. These models won’t have their own tables; instead, they will use
the <code class="language-plaintext highlighter-rouge">vehicles</code> table.</p>

<p>To generate the <code class="language-plaintext highlighter-rouge">Car</code> model:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate model car <span class="nt">--parent</span><span class="o">=</span>Vehicle
</code></pre></div></div>

<p>For this, we can use the <code class="language-plaintext highlighter-rouge">--parent=PARENT</code> option, which will generate a model
that inherits from the specified parent and without equivalent migration (since
the table already exists).</p>

<p>This generates a <code class="language-plaintext highlighter-rouge">Car</code> model that inherits from <code class="language-plaintext highlighter-rouge">Vehicle</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This means that all behavior added to Vehicle is available for Car too, as
associations, public methods, etc. Creating a car will save it in the <code class="language-plaintext highlighter-rouge">vehicles</code>
table with “Car” as the <code class="language-plaintext highlighter-rouge">type</code> field:</p>

<p>Repeat the same process for <code class="language-plaintext highlighter-rouge">Motorcycle</code> and <code class="language-plaintext highlighter-rouge">Bicycle</code>.</p>

<h3 id="creating-records">Creating Records</h3>

<p>Creating a record for <code class="language-plaintext highlighter-rouge">Car</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Car</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">color: </span><span class="s2">"Red"</span><span class="p">,</span> <span class="ss">price: </span><span class="mi">10000</span><span class="p">)</span>
</code></pre></div></div>

<p>This will generate the following SQL:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="nv">"vehicles"</span> <span class="p">(</span><span class="nv">"type"</span><span class="p">,</span> <span class="nv">"color"</span><span class="p">,</span> <span class="nv">"price"</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">,</span> <span class="s1">'Red'</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="querying-records">Querying Records</h3>

<p>Querying car records will search only for vehicles that are cars:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Car</span><span class="p">.</span><span class="nf">all</span>
</code></pre></div></div>

<p>will run a query like:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="o">*</span> <span class="k">FROM</span> <span class="nv">"vehicles"</span> <span class="k">WHERE</span> <span class="nv">"vehicles"</span><span class="p">.</span><span class="nv">"type"</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">'Car'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="adding-specific-behavior">Adding Specific Behavior</h3>

<p>You can add specific behavior or methods to the child models. For example,
adding a method to the <code class="language-plaintext highlighter-rouge">Car</code> model:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
  <span class="k">def</span> <span class="nf">honk</span>
    <span class="s2">"Beep Beep"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now you can call the <code class="language-plaintext highlighter-rouge">honk</code> method on a <code class="language-plaintext highlighter-rouge">Car</code> instance:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">car</span> <span class="o">=</span> <span class="no">Car</span><span class="p">.</span><span class="nf">first</span>
<span class="n">car</span><span class="p">.</span><span class="nf">honk</span>
<span class="c1"># =&gt; 'Beep Beep'</span>
</code></pre></div></div>

<h3 id="controllers">Controllers</h3>

<p>Each model can have its own controller. For example, the <code class="language-plaintext highlighter-rouge">CarsController</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/cars_controller.rb</span>

<span class="k">class</span> <span class="nc">CarsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@cars</span> <span class="o">=</span> <span class="no">Car</span><span class="p">.</span><span class="nf">all</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="overriding-the-inheritance-column">Overriding the inheritance column</h3>

<p>There may be cases (like when working with a legacy database) where you need to
override the name of the inheritance column. This can be achieved with the
[inheritance_column][] method.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Schema: vehicles[ id, kind, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Vehicle</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">inheritance_column</span> <span class="o">=</span> <span class="s2">"kind"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">Vehicle</span>
<span class="k">end</span>

<span class="no">Car</span><span class="p">.</span><span class="nf">create</span>
<span class="c1"># =&gt; #&lt;Car kind: "Car", color: "Red", price: 10000&gt;</span>
</code></pre></div></div>

<p>In this setup, Rails will use the <code class="language-plaintext highlighter-rouge">kind</code> column to store the model type,
allowing STI to function correctly with the custom column name.</p>

<h3 id="disabling-the-inheritance-column">Disabling the inheritance column</h3>

<p>There may be cases (like when working with a legacy database) where you need to
disable Single Table Inheritance altogether. If you don’t disable STI properly,
you might encounter an [<code class="language-plaintext highlighter-rouge">ActiveRecord::SubclassNotFound</code>][] error.</p>

<p>To disable STI, you can set the [inheritance_column][] to <code class="language-plaintext highlighter-rouge">nil</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Schema: vehicles[ id, type, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Vehicle</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">inheritance_column</span> <span class="o">=</span> <span class="kp">nil</span>
<span class="k">end</span>

<span class="no">Vehicle</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">type: </span><span class="s2">"Car"</span><span class="p">)</span>
<span class="c1"># =&gt; #&lt;Vehicle type: "Car", color: "Red", price: 10000&gt;</span>
</code></pre></div></div>

<p>In this configuration, Rails will treat the type column as a normal attribute
and will not use it for STI purposes. This is useful if you need to work with a
legacy schema that does not follow the STI pattern.</p>

<p>These adjustments provide flexibility when integrating Rails with existing
databases or when specific customization is required for your models.</p>

<p>[inheritance_column]:
    https://api.rubyonrails.org/classes/ActiveRecord/ModelSchema.html#method-c-inheritance_column
[<code class="language-plaintext highlighter-rouge">ActiveRecord::SubclassNotFound</code>]:
    https://api.rubyonrails.org/classes/ActiveRecord/SubclassNotFound.html</p>

<h3 id="considerations">Considerations</h3>

<p><a href="#single-table-inheritance-sti"><code class="language-plaintext highlighter-rouge">Single Table Inheritance (STI)</code></a> works best
when there is little difference between subclasses and their attributes, but it
includes all attributes of all subclasses in a single table.</p>

<p>A disadvantage of this approach is that it can result in table bloat, as the
table will include attributes specific to each subclass, even if they aren’t
used by others. This can be solved by using <a href="#delegated-types"><code class="language-plaintext highlighter-rouge">Delegated
Types</code></a>.</p>

<p>Additionally, if you’re using <a href="#polymorphic-associations">polymorphic
associations</a>, where a model can belong to more than
one other model via a type and an ID, it could become complex to maintain
referential integrity because the association logic must handle different types
correctly.</p>

<p>Finally, if you have specific data integrity checks or validations that differ
between subclasses, you need to ensure these are correctly handled by Rails or
the database, especially when setting up foreign key constraints.</p>

<h2 id="delegated-types">Delegated Types</h2>

<p>Delegated types solves the <a href="#single-table-inheritance-sti"><code class="language-plaintext highlighter-rouge">Single Table Inheritance
(STI)</code></a> problem of table bloat via
<code class="language-plaintext highlighter-rouge">delegated_type</code>. This approach allows us to store shared attributes in a
superclass table and have separate tables for subclass-specific attributes.</p>

<h3 id="setting-up-delegated-types">Setting up Delegated Types</h3>

<p>To use delegated types, we need to model our data as follows:</p>

<ul>
  <li>There is a superclass that stores shared attributes among all subclasses in
its table.</li>
  <li>Each subclass must inherit from the superclass, and will have a separate table
for any additional attributes specific to it.</li>
</ul>

<p>This eliminates the need to define attributes in a single table that are
unintentionally shared among all subclasses.</p>

<h3 id="generating-models">Generating Models</h3>

<p>In order to apply this to our example above, we need to regenerate our models.</p>

<p>First, let’s generate the base <code class="language-plaintext highlighter-rouge">Entry</code> model which will act as our superclass:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate model entry entryable_type:string entryable_id:integer
</code></pre></div></div>

<p>Then, we will generate new <code class="language-plaintext highlighter-rouge">Message</code> and <code class="language-plaintext highlighter-rouge">Comment</code> models for delegation:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate model message subject:string body:string
<span class="nv">$ </span>bin/rails generate model comment content:string
</code></pre></div></div>

<p>After running the generators, our models should look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Schema: entries[ id, entryable_type, entryable_id, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Entry</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="c1"># Schema: messages[ id, subject, body, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>

<span class="c1"># Schema: comments[ id, content, created_at, updated_at ]</span>
<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="declaring-delegated_type">Declaring <code class="language-plaintext highlighter-rouge">delegated_type</code></h3>

<p>First, declare a <code class="language-plaintext highlighter-rouge">delegated_type</code> in the superclass <code class="language-plaintext highlighter-rouge">Entry</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Entry</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">delegated_type</span> <span class="ss">:entryable</span><span class="p">,</span> <span class="ss">types: </span><span class="sx">%w[ Message Comment ]</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">entryable</code> parameter specifies the field to use for delegation, and include
the types <code class="language-plaintext highlighter-rouge">Message</code> and <code class="language-plaintext highlighter-rouge">Comment</code> as the delegate classes. The <code class="language-plaintext highlighter-rouge">entryable_type</code>
and <code class="language-plaintext highlighter-rouge">entryable_id</code> fields store the subclass name and the record ID of the
delegate subclass, respectively.</p>

<h3 id="defining-the-entryable-module">Defining the <code class="language-plaintext highlighter-rouge">Entryable</code> Module</h3>

<p>Next, define a module to implement those delegated types by declaring the <code class="language-plaintext highlighter-rouge">as:
:entryable</code> parameter in the <code class="language-plaintext highlighter-rouge">has_one</code> association.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Entryable</span>
  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>

  <span class="n">included</span> <span class="k">do</span>
    <span class="n">has_one</span> <span class="ss">:entry</span><span class="p">,</span> <span class="ss">as: :entryable</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Include the created module in your subclass:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>
<span class="k">end</span>
</code></pre></div></div>

<p>With this definition complete, our <code class="language-plaintext highlighter-rouge">Entry</code> delegator now provides the following
methods:</p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Return</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry.entryable_types</code></td>
      <td>[“Message”, “Comment”]</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry#entryable_class</code></td>
      <td>Message or Comment</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry#entryable_name</code></td>
      <td>“message” or “comment”</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry.messages</code></td>
      <td><code class="language-plaintext highlighter-rouge">Entry.where(entryable_type: "Message")</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry#message?</code></td>
      <td>Returns true when <code class="language-plaintext highlighter-rouge">entryable_type == "Message"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry#message</code></td>
      <td>Returns the message record, when <code class="language-plaintext highlighter-rouge">entryable_type == "Message"</code>, otherwise <code class="language-plaintext highlighter-rouge">nil</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry#message_id</code></td>
      <td>Returns <code class="language-plaintext highlighter-rouge">entryable_id</code>, when <code class="language-plaintext highlighter-rouge">entryable_type == "Message"</code>, otherwise <code class="language-plaintext highlighter-rouge">nil</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry.comments</code></td>
      <td><code class="language-plaintext highlighter-rouge">Entry.where(entryable_type: "Comment")</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry#comment?</code></td>
      <td>Returns true when <code class="language-plaintext highlighter-rouge">entryable_type == "Comment"</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry#comment</code></td>
      <td>Returns the comment record, when <code class="language-plaintext highlighter-rouge">entryable_type == "Comment"</code>, otherwise <code class="language-plaintext highlighter-rouge">nil</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Entry#comment_id</code></td>
      <td>Returns entryable_id, when <code class="language-plaintext highlighter-rouge">entryable_type == "Comment"</code>, otherwise <code class="language-plaintext highlighter-rouge">nil</code></td>
    </tr>
  </tbody>
</table>

<h3 id="object-creation">Object creation</h3>

<p>When creating a new <code class="language-plaintext highlighter-rouge">Entry</code> object, we can specify the <code class="language-plaintext highlighter-rouge">entryable</code> subclass at
the same time.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Entry</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">entryable: </span><span class="no">Message</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">subject: </span><span class="s2">"hello!"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="adding-further-delegation">Adding further delegation</h3>

<p>We can enhance our <code class="language-plaintext highlighter-rouge">Entry</code> delegator by defining <code class="language-plaintext highlighter-rouge">delegate</code> and using
polymorphism on the subclasses. For example, to delegate the <code class="language-plaintext highlighter-rouge">title</code> method from
<code class="language-plaintext highlighter-rouge">Entry</code> to it’s subclasses:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Entry</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">delegated_type</span> <span class="ss">:entryable</span><span class="p">,</span> <span class="ss">types: </span><span class="sx">%w[ Message Comment ]</span>
  <span class="n">delegate</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">to: :entryable</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Message</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>

  <span class="k">def</span> <span class="nf">title</span>
    <span class="n">subject</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="kp">include</span> <span class="no">Entryable</span>

  <span class="k">def</span> <span class="nf">title</span>
    <span class="n">content</span><span class="p">.</span><span class="nf">truncate</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This setup allows <code class="language-plaintext highlighter-rouge">Entry</code> to delegate the <code class="language-plaintext highlighter-rouge">title</code> method to its subclasses,
where <code class="language-plaintext highlighter-rouge">Message</code> uses <code class="language-plaintext highlighter-rouge">subject</code> and <code class="language-plaintext highlighter-rouge">Comment</code> uses a truncated version of
<code class="language-plaintext highlighter-rouge">content</code>.</p>

<h2 id="tips-tricks-and-warnings">Tips, Tricks, and Warnings</h2>

<p>Here are a few things you should know to make efficient use of Active Record
associations in your Rails applications:</p>

<ul>
  <li>Controlling caching</li>
  <li>Avoiding name collisions</li>
  <li>Updating the schema</li>
  <li>Controlling association scope</li>
  <li>Bi-directional associations</li>
</ul>

<h3 id="controlling-association-caching">Controlling Association Caching</h3>

<p>All of the association methods are built around caching, which keeps the result
of loaded associations for further operations. The cache is even shared across
methods. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># retrieves books from the database</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">load</span>

<span class="c1"># uses the cached copy of books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># uses the cached copy of books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre></div></div>

<p>NOTE: When we use <code class="language-plaintext highlighter-rouge">author.books</code>, the data is not immediately loaded from the
database. Instead, it sets up a query that will be executed when you actually
try to use the data, for example, by calling methods that require data like
each, size, empty?, etc. By calling <code class="language-plaintext highlighter-rouge">author.books.load</code>, before calling other
methods which use the data, you explicitly trigger the query to load the data
from the database immediately. This is useful if you know you will need the data
and want to avoid the potential performance overhead of multiple queries being
triggered as you work with the association.</p>

<p>But what if you want to reload the cache, because data might have been changed
by some other part of the application? Just call
<a href="https://api.rubyonrails.org/classes/ActiveRecord/Relation.html#method-i-reload"><code class="language-plaintext highlighter-rouge">reload</code></a>
on the association:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># retrieves books from the database</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">load</span>

<span class="c1"># uses the cached copy of books</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">size</span>

<span class="c1"># discards the cached copy of books and goes back to the database</span>
<span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">empty?</span>
</code></pre></div></div>

<h3 id="avoiding-name-collisions">Avoiding Name Collisions</h3>

<p>When creating associations in Ruby on Rails models, it’s important to avoid
using names that are already used for instance methods of <code class="language-plaintext highlighter-rouge">ActiveRecord::Base</code>.
This is because creating an association with a name that clashes with an
existing method could lead to unintended consequences, such as overriding the
base method and causing issues with functionality. For example, using names like
<code class="language-plaintext highlighter-rouge">attributes</code> or <code class="language-plaintext highlighter-rouge">connection</code> for associations would be problematic.</p>

<h3 id="updating-the-schema">Updating the Schema</h3>

<p>Associations are extremely useful, they are responsible for defining the
relationships between models but they do not update your database schema. You
are responsible for maintaining your database schema to match your associations.
This usually involves two main tasks: creating foreign keys for <a href="#belongs-to"><code class="language-plaintext highlighter-rouge">belongs_to</code>
associations</a> and setting up the correct join table for <a href="#has-many-through"><code class="language-plaintext highlighter-rouge">has_many
:through</code></a> and
<a href="#has-and-belongs-to-many"><code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code></a> associations. You can read
more about when to use a <code class="language-plaintext highlighter-rouge">has_many :through vs has_and_belongs_to_many</code> <a href="#has-many-through-vs-has-and-belongs-to-many">in the
has many through vs has and belongs to many
section</a>.</p>

<h4 id="creating-foreign-keys-for-belongs_to-associations">Creating Foreign Keys for <code class="language-plaintext highlighter-rouge">belongs_to</code> Associations</h4>

<p>When you declare a <a href="#belongs-to"><code class="language-plaintext highlighter-rouge">belongs_to</code> association</a>, you need to create
foreign keys as appropriate. For example, consider this model:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This declaration needs to be backed up by a corresponding foreign key column in
the books table. For a brand new table, the migration might look something like
this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span>   <span class="ss">:published_at</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span>     <span class="ss">:book_number</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:author</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Whereas for an existing table, it might look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AddAuthorToBooks</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_reference</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">:author</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="creating-join-tables-for-has_and_belongs_to_many-associations">Creating Join Tables for <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> Associations</h4>

<p>If you create a <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> association, you need to explicitly
create the join table. Unless the name of the join table is explicitly specified
by using the <code class="language-plaintext highlighter-rouge">:join_table</code> option, Active Record creates the name by using the
lexical order of the class names. So a join between author and book models will
give the default join table name of “authors_books” because “a” outranks “b” in
lexical ordering.</p>

<p>Whatever the name, you must manually generate the join table with an appropriate
migration. For example, consider these associations:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Assembly</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:parts</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Part</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span>
<span class="k">end</span>
</code></pre></div></div>

<p>These need to be backed up by a migration to create the <code class="language-plaintext highlighter-rouge">assemblies_parts</code>
table.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate migration CreateAssembliesPartsJoinTable assemblies parts
</code></pre></div></div>

<p>You can then fill out the migration and ensure that the table is created without
a primary key.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">id: </span><span class="kp">false</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">bigint</span> <span class="ss">:part_id</span>
    <span class="k">end</span>

    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:assembly_id</span>
    <span class="n">add_index</span> <span class="ss">:assemblies_parts</span><span class="p">,</span> <span class="ss">:part_id</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We pass <code class="language-plaintext highlighter-rouge">id: false</code> to <code class="language-plaintext highlighter-rouge">create_table</code> because the join table does not represent
a model. If you observe any strange behavior in a <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>
association like mangled model IDs, or exceptions about conflicting IDs, chances
are you forgot to set <code class="language-plaintext highlighter-rouge">id: false</code> when creating your migration.</p>

<p>For simplicity, you can also use the method <code class="language-plaintext highlighter-rouge">create_join_table</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateAssembliesPartsJoinTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_join_table</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="ss">:parts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:assembly_id</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">index</span> <span class="ss">:part_id</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can read more about the <code class="language-plaintext highlighter-rouge">create_join_table</code> method in the <a href="active_record_migrations.html#creating-a-join-table">Active Record
Migration Guides</a></p>

<h4 id="creating-join-tables-for-has_many-through-associations">Creating Join Tables for <code class="language-plaintext highlighter-rouge">has_many :through</code> Associations</h4>

<p>The main difference in schema implementation between creating a join table for
<code class="language-plaintext highlighter-rouge">has_many :through</code> vs <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> is that the join table for a
<code class="language-plaintext highlighter-rouge">has_many :through</code> requires an <code class="language-plaintext highlighter-rouge">id</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateAppointments</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:appointments</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:physician</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:patient</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="ss">:appointment_date</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="controlling-association-scope">Controlling Association Scope</h3>

<p>By default, associations look for objects only within the current module’s
scope. This feature is particularly useful when declaring Active Record models
inside a module, as it keeps the associations scoped properly. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>

    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this example, both the <code class="language-plaintext highlighter-rouge">Supplier</code> and <code class="language-plaintext highlighter-rouge">Account</code> classes are defined within
the same module (<code class="language-plaintext highlighter-rouge">MyApplication::Business</code>). This organization allows you to
structure your models into folders based on their scope without needing to
explicitly specify the scope in every association:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/my_application/business/supplier.rb</span>
<span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/my_application/business/account.rb</span>
<span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>It is important to note that while model scoping helps organize your code, it
does not change the naming convention for your database tables. For instance, if
you have a <code class="language-plaintext highlighter-rouge">MyApplication::Business::Supplier</code> model, the corresponding database
table should still follow the naming convention and be named
<code class="language-plaintext highlighter-rouge">my_application_business_suppliers</code>.</p>

<p>However, if the <code class="language-plaintext highlighter-rouge">Supplier</code> and <code class="language-plaintext highlighter-rouge">Account</code> models are defined in different scopes,
the associations will not work by default:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>To associate a model with a model in a different namespace, you must specify the
complete class name in your association declaration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">MyApplication</span>
  <span class="k">module</span> <span class="nn">Business</span>
    <span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Billing::Account"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">module</span> <span class="nn">Billing</span>
    <span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
      <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span>
        <span class="ss">class_name: </span><span class="s2">"MyApplication::Business::Supplier"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>By explicitly declaring the <code class="language-plaintext highlighter-rouge">class_name</code> option, you can create associations
across different namespaces, ensuring the correct models are linked regardless
of their module scope.</p>

<h3 id="bi-directional-associations">Bi-directional Associations</h3>

<p>In Rails, it’s common for associations between models to be bi-directional,
meaning they need to be declared in both related models. Consider the following
example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Active Record will attempt to automatically identify that these two models share
a bi-directional association based on the association name. This information
allows Active Record to:</p>

<ul>
  <li>
    <p>Prevent needless queries for already-loaded data:</p>

    <p>Active Record avoids additional database queries for already-loaded data.</p>

    <div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">all?</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
<span class="gp">  irb&gt;</span><span class="w">   </span><span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">equal?</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="c1"># No additional queries executed here</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="k">end</span>
<span class="go">  =&gt; true
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Prevent inconsistent data</p>

    <p>Since only one copy of the <code class="language-plaintext highlighter-rouge">Author</code> object is loaded, it helps to prevent
  inconsistencies.</p>

    <div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="go">  =&gt; true
</span><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Changed Name"</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">name</span>
<span class="go">  =&gt; true
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Automatic saving of associations in more cases:</p>

    <div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">save!</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="go">  =&gt; true
</span><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="go">  =&gt; true
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Validate the <a href="active_record_validations.html#presence">presence</a> and
<a href="active_record_validations.html#absence">absence</a> of associations in more
cases:</p>

    <div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="no">Book</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="go">  =&gt; false
</span><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
<span class="go">  =&gt; ["Author must exist"]
</span><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="go">  =&gt; true
</span></code></pre></div>    </div>
  </li>
</ul>

<p>Sometimes, you might need to customize the association with options like
<code class="language-plaintext highlighter-rouge">:foreign_key</code> or <code class="language-plaintext highlighter-rouge">:class_name</code>. When you do this, Rails might not automatically
recognize the bi-directional association involving <code class="language-plaintext highlighter-rouge">:through</code> or <code class="language-plaintext highlighter-rouge">:foreign_key</code>
options.</p>

<p>Custom scopes on the opposite association also prevent automatic identification,
as do custom scopes on the association itself unless
[<code class="language-plaintext highlighter-rouge">config.active_record.automatic_scope_inversing</code>][] is set to true.</p>

<p>For example, consider the following model declarations with a custom foreign
key:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Author"</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"author_id"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Due to the <code class="language-plaintext highlighter-rouge">:foreign_key</code> option, Active Record will not automatically recognize
the bi-directional association, which can lead to several issues:</p>

<ul>
  <li>
    <p>Execute needless queries for the same data (in this example causing N+1
queries):</p>

    <div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">any?</span> <span class="k">do</span> <span class="o">|</span><span class="n">book</span><span class="o">|</span>
<span class="gp">  irb&gt;</span><span class="w">   </span><span class="n">book</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">equal?</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="c1"># This executes an author query for every book</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="k">end</span>
<span class="go">  =&gt; false
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Reference multiple copies of a model with inconsistent data:</p>

    <div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">first</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">name</span>
<span class="go">  =&gt; true
</span><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Changed Name"</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">name</span> <span class="o">==</span> <span class="n">book</span><span class="p">.</span><span class="nf">writer</span><span class="p">.</span><span class="nf">name</span>
<span class="go">  =&gt; false
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Fail to autosave associations:</p>

    <div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">save!</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="go">  =&gt; true
</span><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span><span class="p">.</span><span class="nf">persisted?</span>
<span class="go">  =&gt; false
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Fail to validate presence or absence:</p>

    <div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span> <span class="o">=</span> <span class="n">author</span><span class="p">.</span><span class="nf">books</span><span class="p">.</span><span class="nf">new</span>
<span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">valid?</span>
<span class="go">  =&gt; false
</span><span class="gp">  irb&gt;</span><span class="w"> </span><span class="n">book</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">full_messages</span>
<span class="go">  =&gt; ["Author must exist"]
</span></code></pre></div>    </div>
  </li>
</ul>

<p>To resolve these issues, you can explicitly declare bi-directional associations
using the <code class="language-plaintext highlighter-rouge">:inverse_of</code> option:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">inverse_of: </span><span class="s2">"writer"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:writer</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Author"</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"author_id"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>By including the <code class="language-plaintext highlighter-rouge">:inverse_of</code> option in the <code class="language-plaintext highlighter-rouge">has_many</code> association declaration,
Active Record will recognize the bi-directional association and behave as
described in the initial examples above.</p>

<p>[<code class="language-plaintext highlighter-rouge">config.active_record.automatic_scope_inversing</code>]:
    configuring.html#config-active-record-automatic-scope-inversing</p>

<h2 id="association-references">Association References</h2>

<h3 id="options">Options</h3>

<p>While Rails uses intelligent defaults that will work well in most situations,
there may be times when you want to customize the behavior of the association
references. Such customizations can be accomplished by passing options blocks
when you create the association. For example, this association uses two such
options:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span><span class="p">,</span>
    <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Each association supports numerous options which you can read more about in
<a href="https://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html"><code class="language-plaintext highlighter-rouge">Options</code> section of each association in the ActiveRecord Associations
API</a>.
We’ll discuss some of the common use cases below.</p>

<h4 id="class_name"><code class="language-plaintext highlighter-rouge">:class_name</code></h4>

<p>If the name of the other model cannot be derived from the association name, you
can use the <code class="language-plaintext highlighter-rouge">:class_name</code> option to supply the model name. For example, if a
book belongs to an author, but the actual name of the model containing authors
is <code class="language-plaintext highlighter-rouge">Patron</code>, you’d set things up this way:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">class_name: </span><span class="s2">"Patron"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This option is not supported in polymorphic associations, since in that case the
class name of the associated record is stored in the type column.</p>

<h4 id="dependent"><code class="language-plaintext highlighter-rouge">:dependent</code></h4>

<p>Controls what happens to the associated object when its owner is destroyed:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">:destroy</code>, when the object is destroyed, <code class="language-plaintext highlighter-rouge">destroy</code> will be called on its
associated objects. This method not only removes the associated records from
the database but also ensures that any defined callbacks (like
<code class="language-plaintext highlighter-rouge">before_destroy</code> and <code class="language-plaintext highlighter-rouge">after_destroy</code>) are executed. This is useful for
performing custom logic during the deletion process, such as logging or
cleaning up related data.</li>
  <li><code class="language-plaintext highlighter-rouge">:delete</code>, when the object is destroyed, all its associated objects will be
deleted directly from the database without calling their <code class="language-plaintext highlighter-rouge">destroy</code> method.
This method performs a direct deletion and bypasses any callbacks or
validations in the associated models, making it more efficient but potentially
leading to data integrity issues if important cleanup tasks are skipped. Use
<code class="language-plaintext highlighter-rouge">delete</code> when you need to remove records quickly and are confident that no
additional actions are required for the associated records.</li>
  <li><code class="language-plaintext highlighter-rouge">:destroy_async</code>: when the object is destroyed, an
<code class="language-plaintext highlighter-rouge">ActiveRecord::DestroyAssociationAsyncJob</code> job is enqueued which will call
destroy on its associated objects. Active Job must be set up for this to work.
Do not use this option if the association is backed by foreign key constraints
in your database. The foreign key constraint actions will occur inside the
same transaction that deletes its owner.</li>
  <li><code class="language-plaintext highlighter-rouge">:nullify</code> causes the foreign key to be set to <code class="language-plaintext highlighter-rouge">NULL</code>. Polymorphic type
  column is also nullified on polymorphic associations. Callbacks are not
  executed.</li>
  <li><code class="language-plaintext highlighter-rouge">:restrict_with_exception</code> causes an <code class="language-plaintext highlighter-rouge">ActiveRecord::DeleteRestrictionError</code>
  exception to be raised if there is an associated record</li>
  <li><code class="language-plaintext highlighter-rouge">:restrict_with_error</code> causes an error to be added to the owner if there is
  an associated object</li>
</ul>

<p>WARNING: You should not specify this option on a <code class="language-plaintext highlighter-rouge">belongs_to</code> association that
is connected with a <code class="language-plaintext highlighter-rouge">has_many</code> association on the other class. Doing so can lead
to orphaned records in your database because destroying the parent object may
attempt to destroy its children, which in turn may attempt to destroy the parent
again, causing inconsistencies.</p>

<p>Do not leave the <code class="language-plaintext highlighter-rouge">:nullify</code> option for associations with <code class="language-plaintext highlighter-rouge">NOT NULL</code> database
constraints. Setting <code class="language-plaintext highlighter-rouge">dependent</code> to <code class="language-plaintext highlighter-rouge">:destroy</code> is essential; otherwise, the
foreign key of the associated object may be set to <code class="language-plaintext highlighter-rouge">NULL</code>, preventing changes to
it.</p>

<p>NOTE: The <code class="language-plaintext highlighter-rouge">:dependent</code> option is ignored with the <code class="language-plaintext highlighter-rouge">:through</code> option. When using
<code class="language-plaintext highlighter-rouge">:through</code>, the join model must have a <code class="language-plaintext highlighter-rouge">belongs_to</code> association, and the
deletion affects only the join records, not the associated records.</p>

<p>When using <code class="language-plaintext highlighter-rouge">dependent: :destroy</code> on a scoped association, only the scoped
objects are destroyed. For example, in a <code class="language-plaintext highlighter-rouge">Post</code> model defined as <code class="language-plaintext highlighter-rouge">has_many
:comments, -&gt; { where published: true }, dependent: :destroy</code>, calling destroy
on a post will only delete published comments, leaving unpublished comments
intact with a foreign key pointing to the deleted post.</p>

<p>You cannot use the <code class="language-plaintext highlighter-rouge">:dependent</code> option directly on a <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>
association. To manage deletions of join table records, handle them manually or
switch to a <code class="language-plaintext highlighter-rouge">has_many :through</code> association, which provides more flexibility and
supports the <code class="language-plaintext highlighter-rouge">:dependent</code> option.</p>

<h4 id="foreign_key"><code class="language-plaintext highlighter-rouge">:foreign_key</code></h4>

<p>By convention, Rails assumes that the column used to hold the foreign key on
this model is the name of the association with the suffix <code class="language-plaintext highlighter-rouge">_id</code> added. The
<code class="language-plaintext highlighter-rouge">:foreign_key</code> option lets you set the name of the foreign key directly:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">foreign_key: </span><span class="s2">"supp_id"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>NOTE: Rails does not create foreign key columns for you. You need to explicitly
define them in your migrations.</p>

<h4 id="primary_key"><code class="language-plaintext highlighter-rouge">:primary_key</code></h4>

<p>By default, Rails uses the <code class="language-plaintext highlighter-rouge">id</code> column as the primary key for its tables. The
<code class="language-plaintext highlighter-rouge">:primary_key</code> option allows you to specify a different column as the primary
key.</p>

<p>For example, if the <code class="language-plaintext highlighter-rouge">users</code> table uses <code class="language-plaintext highlighter-rouge">guid</code> as the primary key instead of
<code class="language-plaintext highlighter-rouge">id</code>, and you want the <code class="language-plaintext highlighter-rouge">todos</code> table to reference <code class="language-plaintext highlighter-rouge">guid</code> as a foreign key
(<code class="language-plaintext highlighter-rouge">user_id</code>), you can configure it like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">primary_key</span> <span class="o">=</span> <span class="s2">"guid"</span> <span class="c1"># Sets the primary key to guid instead of id</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Todo</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span><span class="p">,</span> <span class="ss">primary_key: </span><span class="s2">"guid"</span> <span class="c1"># References the guid column in users table</span>
<span class="k">end</span>
</code></pre></div></div>

<p>When you execute <code class="language-plaintext highlighter-rouge">@user.todos.create</code>, the <code class="language-plaintext highlighter-rouge">@todo</code> record will have its
<code class="language-plaintext highlighter-rouge">user_id</code> value set to the <code class="language-plaintext highlighter-rouge">guid</code> value of <code class="language-plaintext highlighter-rouge">@user</code>.</p>

<p><code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> does not support the <code class="language-plaintext highlighter-rouge">:primary_key</code> option. For this
type of association, you can achieve similar functionality by using a join table
with has_many <code class="language-plaintext highlighter-rouge">:through</code> association, which gives more flexibility and supports
the <code class="language-plaintext highlighter-rouge">:primary_key</code> option. You can read more about this in the
<a href="#has-many-through"><code class="language-plaintext highlighter-rouge">has_many :through</code> section</a>.</p>

<h4 id="touch"><code class="language-plaintext highlighter-rouge">:touch</code></h4>

<p>If you set the <code class="language-plaintext highlighter-rouge">:touch</code> option to <code class="language-plaintext highlighter-rouge">true</code>, then the <code class="language-plaintext highlighter-rouge">updated_at</code> or <code class="language-plaintext highlighter-rouge">updated_on</code>
timestamp on the associated object will be set to the current time whenever this
object is saved or destroyed:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this case, saving or destroying a book will update the timestamp on the
associated author. You can also specify a particular timestamp attribute to
update:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">touch: :books_updated_at</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> does not support the <code class="language-plaintext highlighter-rouge">:touch</code> option. For this type of
association, you can achieve similar functionality by using a join table with
<code class="language-plaintext highlighter-rouge">has_many :through</code> association. You can read more about this in the
<a href="#has-many-through"><code class="language-plaintext highlighter-rouge">has_many :through</code> section</a>.</p>

<h4 id="validate"><code class="language-plaintext highlighter-rouge">:validate</code></h4>

<p>If you set the <code class="language-plaintext highlighter-rouge">:validate</code> option to <code class="language-plaintext highlighter-rouge">true</code>, then new associated objects will be
validated whenever you save this object. By default, this is <code class="language-plaintext highlighter-rouge">false</code>: new
associated objects will not be validated when this object is saved.</p>

<p><code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> does not support the <code class="language-plaintext highlighter-rouge">:validate</code> option. For this type
of association, you can achieve similar functionality by using a join table with
has_many <code class="language-plaintext highlighter-rouge">:through</code> association. You can read more about this in the
<a href="#has-many-through"><code class="language-plaintext highlighter-rouge">has_many :through</code> section</a>.</p>

<h4 id="inverse_of"><code class="language-plaintext highlighter-rouge">:inverse_of</code></h4>

<p>The <code class="language-plaintext highlighter-rouge">:inverse_of</code> option specifies the name of the <code class="language-plaintext highlighter-rouge">belongs_to</code> association that
is the inverse of this association. See the <a href="#bi-directional-associations">bi-directional
association</a> section for more details.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="ss">inverse_of: :supplier</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span><span class="p">,</span> <span class="ss">inverse_of: :account</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="source_type"><code class="language-plaintext highlighter-rouge">:source_type</code></h4>

<p>The <code class="language-plaintext highlighter-rouge">:source_type</code> option specifies the source association type for a <code class="language-plaintext highlighter-rouge">has_many
:through</code> association that proceeds through a <a href="#polymorphic-associations">polymorphic
association</a>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
  <span class="n">has_many</span> <span class="ss">:paperbacks</span><span class="p">,</span> <span class="ss">through: :books</span><span class="p">,</span> <span class="ss">source: :format</span><span class="p">,</span> <span class="ss">source_type: </span><span class="s2">"Paperback"</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:format</span><span class="p">,</span> <span class="ss">polymorphic: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Hardback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
<span class="k">class</span> <span class="nc">Paperback</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span><span class="p">;</span> <span class="k">end</span>
</code></pre></div></div>

<h4 id="strict_loading"><code class="language-plaintext highlighter-rouge">:strict_loading</code></h4>

<p>Enforces strict loading every time an associated record is loaded through this
association.</p>

<h4 id="association_foreign_key"><code class="language-plaintext highlighter-rouge">:association_foreign_key</code></h4>

<p>The <code class="language-plaintext highlighter-rouge">:association_foreign_key</code> can be found on a <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>
relationship. By convention, Rails assumes that the column in the join table
used to hold the foreign key pointing to the other model is the name of that
model with the suffix <code class="language-plaintext highlighter-rouge">_id</code> added. The <code class="language-plaintext highlighter-rouge">:association_foreign_key</code> option lets
you set the name of the foreign key directly. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:friends</span><span class="p">,</span>
      <span class="ss">class_name: </span><span class="s2">"User"</span><span class="p">,</span>
      <span class="ss">foreign_key: </span><span class="s2">"this_user_id"</span><span class="p">,</span>
      <span class="ss">association_foreign_key: </span><span class="s2">"other_user_id"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>TIP: The <code class="language-plaintext highlighter-rouge">:foreign_key</code> and <code class="language-plaintext highlighter-rouge">:association_foreign_key</code> options are useful when
setting up a many-to-many self-join.</p>

<h4 id="join_table"><code class="language-plaintext highlighter-rouge">:join_table</code></h4>

<p>The <code class="language-plaintext highlighter-rouge">:join_table</code> can be found on a <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> relationship. If
the default name of the join table, based on lexical ordering, is not what you
want, you can use the <code class="language-plaintext highlighter-rouge">:join_table</code> option to override the default.</p>

<h3 id="scopes">Scopes</h3>

<p>Scopes allow you to specify common queries that can be referenced as method
calls on the association objects. This is useful for defining custom queries
that are reused in multiple places in your application. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="general-scopes">General Scopes</h4>

<p>You can use any of the standard <a href="active_record_querying.html">querying methods</a>
inside the scope block. The following ones are discussed below:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">where</code></li>
  <li><code class="language-plaintext highlighter-rouge">includes</code></li>
  <li><code class="language-plaintext highlighter-rouge">readonly</code></li>
  <li><code class="language-plaintext highlighter-rouge">select</code></li>
</ul>

<h5 id="where"><code class="language-plaintext highlighter-rouge">where</code></h5>

<p>The <code class="language-plaintext highlighter-rouge">where</code> method lets you specify the conditions that the associated object
must meet.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="s2">"factory = 'Seattle'"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can also set conditions via a hash:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">factory: </span><span class="s2">"Seattle"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you use a hash-style <code class="language-plaintext highlighter-rouge">where</code>, then record creation via this association will
be automatically scoped using the hash. In this case, using
<code class="language-plaintext highlighter-rouge">@parts.assemblies.create</code> or <code class="language-plaintext highlighter-rouge">@parts.assemblies.build</code> will create assemblies
where the <code class="language-plaintext highlighter-rouge">factory</code> column has the value “Seattle”.</p>

<h5 id="includes"><code class="language-plaintext highlighter-rouge">includes</code></h5>

<p>You can use the <code class="language-plaintext highlighter-rouge">includes</code> method to specify second-order associations that
should be eager-loaded when this association is used. For example, consider
these models:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you frequently retrieve representatives directly from suppliers
(<code class="language-plaintext highlighter-rouge">@supplier.account.representative</code>), then you can make your code somewhat more
efficient by including representatives in the association from suppliers to
accounts:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">includes</span> <span class="ss">:representative</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Account</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:supplier</span>
  <span class="n">belongs_to</span> <span class="ss">:representative</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Representative</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:accounts</span>
<span class="k">end</span>
</code></pre></div></div>

<p>NOTE: There’s no need to use <code class="language-plaintext highlighter-rouge">includes</code> for immediate associations - that is, if
you have <code class="language-plaintext highlighter-rouge">Book belongs_to :author</code>, then the author is eager-loaded
automatically when it’s needed.</p>

<h5 id="readonly"><code class="language-plaintext highlighter-rouge">readonly</code></h5>

<p>If you use <code class="language-plaintext highlighter-rouge">readonly</code>, then the associated object will be read-only when
retrieved via the association.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">readonly</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This is useful when you want to prevent the associated object from being
modified through the association. For example, if you have a <code class="language-plaintext highlighter-rouge">Book</code> model that
<code class="language-plaintext highlighter-rouge">belongs_to :author</code>, you can use <code class="language-plaintext highlighter-rouge">readonly</code> to prevent the author from being
modified through the book:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="vi">@book</span><span class="p">.</span><span class="nf">author</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">first</span>
<span class="vi">@book</span><span class="p">.</span><span class="nf">author</span><span class="p">.</span><span class="nf">save!</span> <span class="c1"># This will raise an ActiveRecord::ReadOnlyRecord error</span>
</code></pre></div></div>

<h5 id="select"><code class="language-plaintext highlighter-rouge">select</code></h5>

<p>The <code class="language-plaintext highlighter-rouge">select</code> method lets you override the SQL <code class="language-plaintext highlighter-rouge">SELECT</code> clause used to retrieve
data about the associated object. By default, Rails retrieves all columns.</p>

<p>For example, if you have an <code class="language-plaintext highlighter-rouge">Author</code> model with many <code class="language-plaintext highlighter-rouge">Book</code>s, but you only want
to retrieve the <code class="language-plaintext highlighter-rouge">title</code> of each book:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="nb">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:title</span><span class="p">)</span> <span class="p">}</span> <span class="c1"># Only select id and title columns</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, when you access an author’s books, only the <code class="language-plaintext highlighter-rouge">id</code> and <code class="language-plaintext highlighter-rouge">title</code> columns will
be retrieved from the <code class="language-plaintext highlighter-rouge">books</code> table.</p>

<p>TIP: If you use the <code class="language-plaintext highlighter-rouge">select</code> method on a <code class="language-plaintext highlighter-rouge">belongs_to</code> association, you should
also set the <code class="language-plaintext highlighter-rouge">:foreign_key</code> option to guarantee correct results. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="nb">select</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:name</span><span class="p">)</span> <span class="p">},</span> <span class="ss">foreign_key: </span><span class="s2">"author_id"</span> <span class="c1"># Only select id and name columns</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this case, when you access a book’s author, only the <code class="language-plaintext highlighter-rouge">id</code> and <code class="language-plaintext highlighter-rouge">name</code> columns
will be retrieved from the <code class="language-plaintext highlighter-rouge">authors</code> table.</p>

<h4 id="collection-scopes">Collection Scopes</h4>

<p><code class="language-plaintext highlighter-rouge">has_many</code> and <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> are associations that deal with
collections of records, so you can use additional methods like <code class="language-plaintext highlighter-rouge">group</code>, <code class="language-plaintext highlighter-rouge">limit</code>,
<code class="language-plaintext highlighter-rouge">order</code>, <code class="language-plaintext highlighter-rouge">select</code>, and <code class="language-plaintext highlighter-rouge">distinct</code> to customize the query used by the
association.</p>

<h5 id="group"><code class="language-plaintext highlighter-rouge">group</code></h5>

<p>The <code class="language-plaintext highlighter-rouge">group</code> method supplies an attribute name to group the result set by, using
a <code class="language-plaintext highlighter-rouge">GROUP BY</code> clause in the finder SQL.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">group</span> <span class="s2">"factory"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<h5 id="limit"><code class="language-plaintext highlighter-rouge">limit</code></h5>

<p>The <code class="language-plaintext highlighter-rouge">limit</code> method lets you restrict the total number of objects that will be
fetched through an association.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Parts</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_and_belongs_to_many</span> <span class="ss">:assemblies</span><span class="p">,</span>
    <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span><span class="p">(</span><span class="s2">"created_at DESC"</span><span class="p">).</span><span class="nf">limit</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<h5 id="order"><code class="language-plaintext highlighter-rouge">order</code></h5>

<p>The <code class="language-plaintext highlighter-rouge">order</code> method dictates the order in which associated objects will be
received (in the syntax used by an SQL <code class="language-plaintext highlighter-rouge">ORDER BY</code> clause).</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">order</span> <span class="s2">"date_confirmed DESC"</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<h5 id="select-1"><code class="language-plaintext highlighter-rouge">select</code></h5>

<p>The <code class="language-plaintext highlighter-rouge">select</code> method lets you override the SQL <code class="language-plaintext highlighter-rouge">SELECT</code> clause that is used to
retrieve data about the associated objects. By default, Rails retrieves all
columns.</p>

<p>WARNING: If you specify your own <code class="language-plaintext highlighter-rouge">select</code>, be sure to include the primary key
and foreign key columns of the associated model. If you do not, Rails will throw
an error.</p>

<h5 id="distinct"><code class="language-plaintext highlighter-rouge">distinct</code></h5>

<p>Use the <code class="language-plaintext highlighter-rouge">distinct</code> method to keep the collection free of duplicates. This is
mostly useful together with the <code class="language-plaintext highlighter-rouge">:through</code> option.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'John'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="gp">=&gt; [#&lt;Article id: 5, name: "a1"&gt;</span><span class="p">,</span> <span class="c1">#&lt;Article id: 5, name: "a1"&gt;]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">12</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">13</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">5</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre></div></div>

<p>In the above case there are two readings and <code class="language-plaintext highlighter-rouge">person.articles</code> brings out both
of them even though these records are pointing to the same article.</p>

<p>Now let’s set <code class="language-plaintext highlighter-rouge">distinct</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span>
  <span class="n">has_many</span> <span class="ss">:readings</span>
  <span class="n">has_many</span> <span class="ss">:articles</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">distinct</span> <span class="p">},</span> <span class="ss">through: :readings</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">to_a</span>
<span class="gp">=&gt; [#&lt;Article id: 7, name: "a1"&gt;</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">Reading</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">to_a</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">16</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">,</span> <span class="kt">#&lt;</span><span class="no">Reading</span> <span class="ss">id: </span><span class="mi">17</span><span class="p">,</span> <span class="ss">person_id: </span><span class="mi">7</span><span class="p">,</span> <span class="ss">article_id: </span><span class="mi">7</span><span class="kt">&gt;</span><span class="p">]</span>
</code></pre></div></div>

<p>In the above case there are still two readings. However <code class="language-plaintext highlighter-rouge">person.articles</code> shows
only one article because the collection loads only unique records.</p>

<p>If you want to make sure that, upon insertion, all of the records in the
persisted association are distinct (so that you can be sure that when you
inspect the association that you will never find duplicate records), you should
add a unique index on the table itself. For example, if you have a table named
<code class="language-plaintext highlighter-rouge">readings</code> and you want to make sure the articles can only be added to a person
once, you could add the following in a migration:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add_index</span> <span class="ss">:readings</span><span class="p">,</span> <span class="p">[</span><span class="ss">:person_id</span><span class="p">,</span> <span class="ss">:article_id</span><span class="p">],</span> <span class="ss">unique: </span><span class="kp">true</span>
</code></pre></div></div>

<p>Once you have this unique index, attempting to add the article to a person twice
will raise an <code class="language-plaintext highlighter-rouge">ActiveRecord::RecordNotUnique</code> error:</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span> <span class="o">=</span> <span class="no">Person</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'Honda'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s1">'a1'</span><span class="p">)</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span>
<span class="go">ActiveRecord::RecordNotUnique
</span></code></pre></div></div>

<p>Note that checking for uniqueness using something like <code class="language-plaintext highlighter-rouge">include?</code> is subject to
race conditions. Do not attempt to use <code class="language-plaintext highlighter-rouge">include?</code> to enforce distinctness in an
association. For instance, using the article example from above, the following
code would be racy because multiple users could be attempting this at the same
time:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">person</span><span class="p">.</span><span class="nf">articles</span> <span class="o">&lt;&lt;</span> <span class="n">article</span> <span class="k">unless</span> <span class="n">person</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="using-the-association-owner">Using the Association Owner</h4>

<p>You can pass the owner of the association as a single argument to the scope
block for even more control over the association scope. However, be aware that
doing this will make preloading the association impossible.</p>

<p>For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one</span> <span class="ss">:account</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">supplier</span><span class="p">)</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="n">supplier</span><span class="p">.</span><span class="nf">active?</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this example, the <code class="language-plaintext highlighter-rouge">account</code> association of the <code class="language-plaintext highlighter-rouge">Supplier</code> model is scoped
based on the <code class="language-plaintext highlighter-rouge">active</code> status of the supplier.</p>

<p>By utilizing association extensions and scoping with the association owner, you
can create more dynamic and context-aware associations in your Rails
applications.</p>

<h3 id="counter-cache">Counter Cache</h3>

<p>The <code class="language-plaintext highlighter-rouge">:counter_cache</code> option in Rails helps improve the efficiency of finding the
number of associated objects. Consider the following models:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre></div></div>

<p>By default, querying <code class="language-plaintext highlighter-rouge">author.books.size</code> results in a database call to perform a
<code class="language-plaintext highlighter-rouge">COUNT(*)</code> query. To optimize this, you can add a counter cache to the
<em>belonging</em> model (in this case, <code class="language-plaintext highlighter-rouge">Book</code>). This way, Rails can return the count
directly from the cache without querying the database.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: </span><span class="kp">true</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre></div></div>

<p>With this declaration, Rails will keep the cache value up to date, and then
return that value in response to the <code class="language-plaintext highlighter-rouge">size</code> method, avoiding the database call.</p>

<p>Although the <code class="language-plaintext highlighter-rouge">:counter_cache</code> option is specified on the model with the
<code class="language-plaintext highlighter-rouge">belongs_to</code> declaration, the actual column must be added to the <em>associated</em>
(in this case <code class="language-plaintext highlighter-rouge">has_many</code>) model. In this example, you need to add a
<code class="language-plaintext highlighter-rouge">books_count</code> column to the <code class="language-plaintext highlighter-rouge">Author</code> model:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">AddBooksCountToAuthors</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">8.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">add_column</span> <span class="ss">:authors</span><span class="p">,</span> <span class="ss">:books_count</span><span class="p">,</span> <span class="ss">:integer</span><span class="p">,</span> <span class="ss">default: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can specify a custom column name in the <code class="language-plaintext highlighter-rouge">counter_cache</code> declaration instead
of using the default <code class="language-plaintext highlighter-rouge">books_count</code>. For example, to use <code class="language-plaintext highlighter-rouge">count_of_books</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">belongs_to</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">counter_cache: :count_of_books</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span>
<span class="k">end</span>
</code></pre></div></div>

<p>NOTE: You only need to specify the <code class="language-plaintext highlighter-rouge">:counter_cache</code> option on the <code class="language-plaintext highlighter-rouge">belongs_to</code>
side of the association.</p>

<p>Using counter caches on existing large tables can be troublesome. To avoid
locking the table for too long, the column values must be backfilled separately
from the column addition. This backfill must also happen before using
<code class="language-plaintext highlighter-rouge">:counter_cache</code>; otherwise, methods like <code class="language-plaintext highlighter-rouge">size</code>, <code class="language-plaintext highlighter-rouge">any?</code>, etc., which rely on
counter caches, may return incorrect results.</p>

<p>To backfill values safely while keeping counter cache columns updated with child
record creation/removal and ensuring methods always get results from the
database (avoiding potentially incorrect counter cache values), use
<code class="language-plaintext highlighter-rouge">counter_cache: { active: false }</code>. This setting ensures that methods always
fetch results from the database, avoiding incorrect values from an uninitialized
counter cache. If you need to specify a custom column name, use <code class="language-plaintext highlighter-rouge">counter_cache:
{ active: false, column: :my_custom_counter }</code>.</p>

<p>If for some reason you change the value of an owner model’s primary key, and do
not also update the foreign keys of the counted models, then the counter cache
may have stale data. In other words, any orphaned models will still count
towards the counter. To fix a stale counter cache, use
<a href="https://api.rubyonrails.org/classes/ActiveRecord/CounterCache/ClassMethods.html#method-i-reset_counters"><code class="language-plaintext highlighter-rouge">reset_counters</code></a>.</p>

<h3 id="callbacks">Callbacks</h3>

<p><a href="active_record_callbacks.html">Normal callbacks</a> hook into the life cycle of
Active Record objects, allowing you to work with those objects at various
points. For example, you can use a <code class="language-plaintext highlighter-rouge">:before_save</code> callback to cause something to
happen just before an object is saved.</p>

<p>Association callbacks are similar to normal callbacks, but they are triggered by
events in the life cycle of a collection associated with an Active Record
object. There are four available association callbacks:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">before_add</code></li>
  <li><code class="language-plaintext highlighter-rouge">after_add</code></li>
  <li><code class="language-plaintext highlighter-rouge">before_remove</code></li>
  <li><code class="language-plaintext highlighter-rouge">after_remove</code></li>
</ul>

<p>You define association callbacks by adding options to the association
declaration. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="ss">before_add: :check_credit_limit</span>

  <span class="k">def</span> <span class="nf">check_credit_limit</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
    <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="k">if</span> <span class="n">limit_reached?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this example, the <code class="language-plaintext highlighter-rouge">Author</code> model has a <code class="language-plaintext highlighter-rouge">has_many</code> association with <code class="language-plaintext highlighter-rouge">books</code>.
The <code class="language-plaintext highlighter-rouge">before_add</code> callback <code class="language-plaintext highlighter-rouge">check_credit_limit</code> is triggered before a book is
added to the collection. If the <code class="language-plaintext highlighter-rouge">limit_reached?</code> method returns <code class="language-plaintext highlighter-rouge">true</code>, the book
is not added to the collection.</p>

<p>By using these association callbacks, you can customize the behavior of your
associations, ensuring that specific actions are taken at key points in the life
cycle of your collections.</p>

<p>Read more about association callbacks in the <a href="active_record_callbacks.html#association-callbacks">Active Record Callbacks
Guide</a></p>

<h3 id="extensions">Extensions</h3>

<p>Rails provides the ability to extend the functionality of association proxy
objects, which manage associations, by adding new finders, creators, or other
methods through anonymous modules. This feature allows you to customize
associations to meet the specific needs of your application.</p>

<p>You can extend a <code class="language-plaintext highlighter-rouge">has_many</code> association with custom methods directly within the
model definition. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">find_by_book_prefix</span><span class="p">(</span><span class="n">book_number</span><span class="p">)</span>
      <span class="n">find_by</span><span class="p">(</span><span class="ss">category_id: </span><span class="n">book_number</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this example, the <code class="language-plaintext highlighter-rouge">find_by_book_prefix</code> method is added to the <code class="language-plaintext highlighter-rouge">books</code>
association of the <code class="language-plaintext highlighter-rouge">Author</code> model. This custom method allows you to find <code class="language-plaintext highlighter-rouge">books</code>
based on a specific prefix of the <code class="language-plaintext highlighter-rouge">book_number</code>.</p>

<p>If you have an extension that should be shared by multiple associations, you can
use a named extension module. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">FindRecentExtension</span>
  <span class="k">def</span> <span class="nf">find_recent</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">"created_at &gt; ?"</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="nf">days</span><span class="p">.</span><span class="nf">ago</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Supplier</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:deliveries</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">FindRecentExtension</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this case, the <code class="language-plaintext highlighter-rouge">FindRecentExtension</code> module is used to add a <code class="language-plaintext highlighter-rouge">find_recent</code>
method to both the <code class="language-plaintext highlighter-rouge">books</code> association in the <code class="language-plaintext highlighter-rouge">Author</code> model and the
<code class="language-plaintext highlighter-rouge">deliveries</code> association in the <code class="language-plaintext highlighter-rouge">Supplier</code> model. This method retrieves records
created within the last five days.</p>

<p>Extensions can interact with the internals of the association proxy using the
<code class="language-plaintext highlighter-rouge">proxy_association</code> accessor. The <code class="language-plaintext highlighter-rouge">proxy_association</code> provides three important
attributes:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">proxy_association.owner</code> returns the object that the association is a part
of.</li>
  <li><code class="language-plaintext highlighter-rouge">proxy_association.reflection</code> returns the reflection object that describes
the association.</li>
  <li><code class="language-plaintext highlighter-rouge">proxy_association.target</code> returns the associated object for <code class="language-plaintext highlighter-rouge">belongs_to</code> or
<code class="language-plaintext highlighter-rouge">has_one</code>, or the collection of associated objects for <code class="language-plaintext highlighter-rouge">has_many</code> or
<code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code>.</li>
</ul>

<p>These attributes allow extensions to access and manipulate the association
proxy’s internal state and behavior.</p>

<p>Here’s an advanced example demonstrating how to use these attributes in an
extension:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">AdvancedExtension</span>
  <span class="k">def</span> <span class="nf">find_and_log</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">where</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">proxy_association</span><span class="p">.</span><span class="nf">owner</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Querying </span><span class="si">#{</span><span class="n">proxy_association</span><span class="p">.</span><span class="nf">reflection</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2"> with </span><span class="si">#{</span><span class="n">query</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">results</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Author</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many</span> <span class="ss">:books</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">extending</span> <span class="no">AdvancedExtension</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In this example, the <code class="language-plaintext highlighter-rouge">find_and_log</code> method performs a query on the association
and logs the query details using the owner’s logger. The method accesses the
owner’s logger via <code class="language-plaintext highlighter-rouge">proxy_association.owner</code> and the association’s name via
<code class="language-plaintext highlighter-rouge">proxy_association.reflection.name</code>.</p>

        </div>

        <footer class="guide-footer">
            <div class="feedback">
                <h3>Geri Bildirim</h3>
                <p>Bu kılavuzun kalitesini artırmamıza yardımcı olmak için geri bildirimlerinizi bekliyoruz.</p>
                <p>Lütfen <a href="https://github.com/dilankaya127/rails-tr-TR">GitHub Issues</a> üzerinden katkıda bulunun.</p>
            </div>
        </footer>
    </article>
</div>

<script>
// İçindekiler tablosunu otomatik oluştur
document.addEventListener('DOMContentLoaded', function() {
    const toc = document.getElementById('toc');
    const headings = document.querySelectorAll('.guide-content h2, .guide-content h3, .guide-content h4');
    
    if (headings.length > 0) {
        const tocList = document.createElement('ul');
        
        headings.forEach(function(heading, index) {
            const id = 'heading-' + index;
            heading.id = id;
            
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = heading.textContent;
            a.className = 'toc-' + heading.tagName.toLowerCase();
            
            li.appendChild(a);
            tocList.appendChild(li);
        });
        
        toc.appendChild(tocList);
    }
});
</script>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Rails Kılavuzları Türkçe Çevirisi. Gönüllüler tarafından hazırlanmıştır.</p>
            <p>Orijinal dokümantasyon <a href="https://guides.rubyonrails.org">Ruby on Rails</a> ekibine aittir.</p>
        </div>
    </footer>

    <script>hljs.highlightAll();</script>
</body>
</html>