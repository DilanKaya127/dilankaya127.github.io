<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgrading Ruby On Rails - Rails Dok√ºmantasyonu - T√ºrk√ße</title>
    <link rel="stylesheet" href="/rails-tr-TR/assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo">
                    <a href="/rails-tr-TR/">Rails Kƒ±lavuzlarƒ±</a>
                </h1>
                <nav class="nav">
                    <a href="/rails-tr-TR/">Ana Sayfa</a>
                    <a href="https://dilankaya127.github.io">Portf√∂y</a>
                    <a href="https://github.com/dilankaya127/rails-tr-TR">GitHub</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="guide-container">
    <aside class="guide-sidebar">
        <div class="guide-toc">
            <h3>ƒ∞√ßindekiler</h3>
            <div id="toc"></div>
        </div>
        
        <div class="guide-nav">
            <h3>Diƒüer Kƒ±lavuzlar</h3>
            <ul>
                <li><a href="/rails-tr-TR/rails-tr-TR/guides/tr/getting_started">Rails ile Ba≈ülarken</a></li>
                <li><a href="/rails-tr-TR/rails-tr-TR/guides/en/active_record_basics">Active Record Temelleri</a></li>
                <li><a href="/rails-tr-TR/rails-tr-TR/guides//en/action_controller_overview">Action Controller</a></li>
                <li><a href="/rails-tr-TR/rails-tr-TR/guides/tr/action_cable_overview">Action Cable</a></li>
            </ul>
        </div>
    </aside>

    <article class="guide-content">
        <header class="guide-header">
            <h1>Upgrading Ruby On Rails</h1>
            
        </header>

        <div class="guide-body">
            <p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1 id="upgrading-ruby-on-rails">Upgrading Ruby on Rails</h1>

<p>This guide provides steps to be followed when you upgrade your applications to a newer version of Ruby on Rails. These steps are also available in individual release guides.</p>

<hr />

<h2 id="general-advice">General Advice</h2>

<p>Before attempting to upgrade an existing application, you should be sure you have a good reason to upgrade. You need to balance several factors: the need for new features, the increasing difficulty of finding support for old code, and your available time and skills, to name a few.</p>

<h3 id="test-coverage">Test Coverage</h3>

<p>The best way to be sure that your application still works after upgrading is to have good test coverage before you start the process. If you don‚Äôt have automated tests that exercise the bulk of your application, you‚Äôll need to spend time manually exercising all the parts that have changed. In the case of a Rails upgrade, that will mean every single piece of functionality in the application. Do yourself a favor and make sure your test coverage is good <em>before</em> you start an upgrade.</p>

<h3 id="ruby-versions">Ruby Versions</h3>

<p>Rails generally stays close to the latest released Ruby version when it‚Äôs released:</p>

<ul>
  <li>Rails 8.0 requires Ruby 3.2.0 or newer.</li>
  <li>Rails 7.2 requires Ruby 3.1.0 or newer.</li>
  <li>Rails 7.0 and 7.1 requires Ruby 2.7.0 or newer.</li>
  <li>Rails 6 requires Ruby 2.5.0 or newer.</li>
  <li>Rails 5 requires Ruby 2.2.2 or newer.</li>
</ul>

<p>It‚Äôs a good idea to upgrade Ruby and Rails separately. Upgrade to the latest Ruby you can first, and then upgrade Rails.</p>

<h3 id="the-upgrade-process">The Upgrade Process</h3>

<p>When changing Rails versions, it‚Äôs best to move slowly, one minor version at a time, in order to make good use of the deprecation warnings. Rails version numbers are in the form Major.Minor.Patch. Major and Minor versions are allowed to make changes to the public API, so this may cause errors in your application. Patch versions only include bug fixes, and don‚Äôt change any public API.</p>

<p>The process should go as follows:</p>

<ol>
  <li>Write tests and make sure they pass.</li>
  <li>Move to the latest patch version after your current version.</li>
  <li>Fix tests and deprecated features.</li>
  <li>Move to the latest patch version of the next minor version.</li>
</ol>

<p>Repeat this process until you reach your target Rails version.</p>

<h4 id="moving-between-versions">Moving between versions</h4>

<p>To move between versions:</p>

<ol>
  <li>Change the Rails version number in the <code class="language-plaintext highlighter-rouge">Gemfile</code> and run <code class="language-plaintext highlighter-rouge">bundle update rails</code>.</li>
  <li>Change the versions for Rails JavaScript packages in <code class="language-plaintext highlighter-rouge">package.json</code> and run <code class="language-plaintext highlighter-rouge">bin/rails javascript:install</code> if running jsbundling-rails.</li>
  <li>Run the <a href="#the-update-task">Update task</a>.</li>
  <li>Run your tests.</li>
</ol>

<p>You can find a list of all released Rails gems <a href="https://rubygems.org/gems/rails/versions">here</a>.</p>

<h3 id="the-update-task">The Update Task</h3>

<p>Rails provides the <code class="language-plaintext highlighter-rouge">bin/rails app:update</code> command. After updating the Rails version
in the <code class="language-plaintext highlighter-rouge">Gemfile</code>, run this command.
This will help you with the creation of new files and changes of old files in an
interactive session.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails app:update
       exist  config
    conflict  config/application.rb
Overwrite /myapp/config/application.rb? <span class="o">(</span>enter <span class="s2">"h"</span> <span class="k">for </span><span class="nb">help</span><span class="o">)</span> <span class="o">[</span>Ynaqdh]
       force  config/application.rb
      create  config/initializers/new_framework_defaults_8_0.rb
...
</code></pre></div></div>

<p>Don‚Äôt forget to review the difference, to see if there were any unexpected changes, and note that the diff and merge tools used during this process can be defined using the <code class="language-plaintext highlighter-rouge">THOR_DIFF</code> and <code class="language-plaintext highlighter-rouge">THOR_MERGE</code> environment variables.</p>

<h3 id="configure-framework-defaults">Configure Framework Defaults</h3>

<p>The new Rails version might have different configuration defaults than the previous version. However, after following the steps described above, your application would still run with configuration defaults from the <em>previous</em> Rails version. That‚Äôs because the value for <code class="language-plaintext highlighter-rouge">config.load_defaults</code> in <code class="language-plaintext highlighter-rouge">config/application.rb</code> has not been changed yet.</p>

<p>To allow you to upgrade to new defaults one by one, the update task has created a file <code class="language-plaintext highlighter-rouge">config/initializers/new_framework_defaults_X_Y.rb</code> (with the desired Rails version in the filename). You should enable the new configuration defaults by uncommenting them in the file; this can be done gradually over several deployments. Once your application is ready to run with new defaults, you can remove this file and flip the <code class="language-plaintext highlighter-rouge">config.load_defaults</code> value.</p>

<h2 id="upgrading-from-rails-80-to-rails-81">Upgrading from Rails 8.0 to Rails 8.1</h2>

<p>For more information on changes made to Rails 8.1 please see the <a href="8_1_release_notes.html">release notes</a>.</p>

<h2 id="upgrading-from-rails-72-to-rails-80">Upgrading from Rails 7.2 to Rails 8.0</h2>

<p>For more information on changes made to Rails 8.0 please see the <a href="8_0_release_notes.html">release notes</a>.</p>

<h2 id="upgrading-from-rails-71-to-rails-72">Upgrading from Rails 7.1 to Rails 7.2</h2>

<p>For more information on changes made to Rails 7.2 please see the <a href="7_2_release_notes.html">release notes</a>.</p>

<h3 id="all-tests-now-respect-the-active_jobqueue_adapter-config">All tests now respect the <code class="language-plaintext highlighter-rouge">active_job.queue_adapter</code> config</h3>

<p>If you have set <code class="language-plaintext highlighter-rouge">config.active_job.queue_adapter</code> in your <code class="language-plaintext highlighter-rouge">config/application.rb</code> or <code class="language-plaintext highlighter-rouge">config/environments/test.rb</code> file,
the adapter you selected was previously not used consistently across all tests. In some tests your adapter would be
used, but other tests would use the <code class="language-plaintext highlighter-rouge">TestAdapter</code>.</p>

<p>In Rails 7.2, all tests will respect the <code class="language-plaintext highlighter-rouge">queue_adapter</code> config if provided. This may cause test errors, if you had
set the <code class="language-plaintext highlighter-rouge">queue_adapter</code> config to something other than <code class="language-plaintext highlighter-rouge">:test</code>, but written tests in a way that was dependent on the <code class="language-plaintext highlighter-rouge">TestAdapter</code>.</p>

<p>If no config is provided, the <code class="language-plaintext highlighter-rouge">TestAdapter</code> will continue to be used.</p>

<h2 id="upgrading-from-rails-70-to-rails-71">Upgrading from Rails 7.0 to Rails 7.1</h2>

<p>For more information on changes made to Rails 7.1 please see the <a href="7_1_release_notes.html">release notes</a>.</p>

<h3 id="development-and-test-environments-secret_key_base-file-changed">Development and test environments secret_key_base file changed</h3>

<p>In development and test environments, the file from which Rails reads the <code class="language-plaintext highlighter-rouge">secret_key_base</code> has been renamed from <code class="language-plaintext highlighter-rouge">tmp/development_secret.txt</code> to <code class="language-plaintext highlighter-rouge">tmp/local_secret.txt</code>.</p>

<p>You can simply rename the previous file to <code class="language-plaintext highlighter-rouge">local_secret.txt</code> to continue using the same secret, or copy the key from the previous file to the new one.</p>

<p>Failure to do so will cause Rails to generate a new secret key in the new file <code class="language-plaintext highlighter-rouge">tmp/local_secret.txt</code> when the app loads.</p>

<p>This will invalidate all existing sessions/cookies in development and test environments, and also cause other signatures derived from <code class="language-plaintext highlighter-rouge">secret_key_base</code> to break, such as Active Storage/Action Text attachments.</p>

<p>Production and other environments are not affected.</p>

<h3 id="autoloaded-paths-are-no-longer-in-load_path">Autoloaded paths are no longer in $LOAD_PATH</h3>

<p>Starting from Rails 7.1, the directories managed by the autoloaders are no
longer added to <code class="language-plaintext highlighter-rouge">$LOAD_PATH</code>. This means it won‚Äôt be possible to load their
files with a manual <code class="language-plaintext highlighter-rouge">require</code> call, which shouldn‚Äôt be done anyway.</p>

<p>Reducing the size of <code class="language-plaintext highlighter-rouge">$LOAD_PATH</code> speeds up <code class="language-plaintext highlighter-rouge">require</code> calls for apps not using
<code class="language-plaintext highlighter-rouge">bootsnap</code>, and reduces the size of the <code class="language-plaintext highlighter-rouge">bootsnap</code> cache for the others.</p>

<p>If you‚Äôd like to have these paths still in <code class="language-plaintext highlighter-rouge">$LOAD_PATH</code>, you can opt-in:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">add_autoload_paths_to_load_path</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<p>but we discourage doing so, classes and modules in the autoload paths are meant
to be autoloaded. That is, just reference them.</p>

<p>The <code class="language-plaintext highlighter-rouge">lib</code> directory is not affected by this flag, it is added to <code class="language-plaintext highlighter-rouge">$LOAD_PATH</code>
always.</p>

<h3 id="configautoload_lib-and-configautoload_lib_once">config.autoload_lib and config.autoload_lib_once</h3>

<p>If your application does not have <code class="language-plaintext highlighter-rouge">lib</code> in the autoload or autoload once paths,
please skip this section. You can find that out by inspecting the output of</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Print autoload paths.</span>
<span class="nv">$ </span>bin/rails runner <span class="s1">'pp Rails.autoloaders.main.dirs'</span>

<span class="c"># Print autoload once paths.</span>
<span class="nv">$ </span>bin/rails runner <span class="s1">'pp Rails.autoloaders.once.dirs'</span>
</code></pre></div></div>

<p>If your application already has <code class="language-plaintext highlighter-rouge">lib</code> in the autoload paths, normally there is
configuration in <code class="language-plaintext highlighter-rouge">config/application.rb</code> that looks something like</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Autoload lib, but do not eager load it (maybe overlooked).</span>
<span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">)</span>
</code></pre></div></div>

<p>or</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Autoload and also eager load lib.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">)</span>
<span class="n">config</span><span class="p">.</span><span class="nf">eager_load_paths</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">)</span>
</code></pre></div></div>

<p>or</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Same, because all eager load paths become autoload paths too.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">eager_load_paths</span> <span class="o">&lt;&lt;</span> <span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">)</span>
</code></pre></div></div>

<p>That still works, but it is recommended to replace those lines with the more
concise</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">autoload_lib</span><span class="p">(</span><span class="ss">ignore: </span><span class="sx">%w(assets tasks)</span><span class="p">)</span>
</code></pre></div></div>

<p>Please, add to the <code class="language-plaintext highlighter-rouge">ignore</code> list any other <code class="language-plaintext highlighter-rouge">lib</code> subdirectories that do not
contain <code class="language-plaintext highlighter-rouge">.rb</code> files, or that should not be reloaded or eager loaded. For
example, if your application has <code class="language-plaintext highlighter-rouge">lib/templates</code>, <code class="language-plaintext highlighter-rouge">lib/generators</code>, or
<code class="language-plaintext highlighter-rouge">lib/middleware</code>, you‚Äôd add their name relative to <code class="language-plaintext highlighter-rouge">lib</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">autoload_lib</span><span class="p">(</span><span class="ss">ignore: </span><span class="sx">%w(assets tasks templates generators middleware)</span><span class="p">)</span>
</code></pre></div></div>

<p>With that one-liner, the (non-ignored) code in <code class="language-plaintext highlighter-rouge">lib</code> will be also eager loaded
if <code class="language-plaintext highlighter-rouge">config.eager_load</code> is <code class="language-plaintext highlighter-rouge">true</code> (the default in <code class="language-plaintext highlighter-rouge">production</code> mode). This is
normally what you want, but if <code class="language-plaintext highlighter-rouge">lib</code> was not added to the eager load paths
before and you still want it that way, please opt-out:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">main</span><span class="p">.</span><span class="nf">do_not_eager_load</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"lib"</span><span class="p">))</span>
</code></pre></div></div>

<p>The method <code class="language-plaintext highlighter-rouge">config.autoload_lib_once</code> is the analogous one if the application
had <code class="language-plaintext highlighter-rouge">lib</code> in <code class="language-plaintext highlighter-rouge">config.autoload_once_paths</code>.</p>

<h3 id="activestoragebasecontroller-no-longer-includes-the-streaming-concern"><code class="language-plaintext highlighter-rouge">ActiveStorage::BaseController</code> no longer includes the streaming concern</h3>

<p>Application controllers that inherit from <code class="language-plaintext highlighter-rouge">ActiveStorage::BaseController</code> and use streaming to implement custom file serving logic must now explicitly include the <code class="language-plaintext highlighter-rouge">ActiveStorage::Streaming</code> module.</p>

<h3 id="memcachestore-and-rediscachestore-now-use-connection-pooling-by-default"><code class="language-plaintext highlighter-rouge">MemCacheStore</code> and <code class="language-plaintext highlighter-rouge">RedisCacheStore</code> now use connection pooling by default</h3>

<p>The <code class="language-plaintext highlighter-rouge">connection_pool</code> gem has been added as a dependency of the <code class="language-plaintext highlighter-rouge">activesupport</code> gem,
and the <code class="language-plaintext highlighter-rouge">MemCacheStore</code> and <code class="language-plaintext highlighter-rouge">RedisCacheStore</code> now use connection pooling by default.</p>

<p>If you don‚Äôt want to use connection pooling, set <code class="language-plaintext highlighter-rouge">:pool</code> option to <code class="language-plaintext highlighter-rouge">false</code> when
configuring your cache store:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">cache_store</span> <span class="o">=</span> <span class="ss">:mem_cache_store</span><span class="p">,</span> <span class="s2">"cache.example.com"</span><span class="p">,</span> <span class="p">{</span> <span class="ss">pool: </span><span class="kp">false</span> <span class="p">}</span>
</code></pre></div></div>

<p>See the <a href="https://guides.rubyonrails.org/v7.1/caching_with_rails.html#connection-pool-options">caching with Rails</a> guide for more information.</p>

<h3 id="sqlite3adapter-now-configured-to-be-used-in-a-strict-strings-mode"><code class="language-plaintext highlighter-rouge">SQLite3Adapter</code> now configured to be used in a strict strings mode</h3>

<p>The use of a strict strings mode disables double-quoted string literals.</p>

<p>SQLite has some quirks around double-quoted string literals.
It first tries to consider double-quoted strings as identifier names, but if they don‚Äôt exist
it then considers them as string literals. Because of this, typos can silently go unnoticed.
For example, it is possible to create an index for a non existing column.
See <a href="https://www.sqlite.org/quirks.html#double_quoted_string_literals_are_accepted">SQLite documentation</a> for more details.</p>

<p>If you don‚Äôt want to use <code class="language-plaintext highlighter-rouge">SQLite3Adapter</code> in a strict mode, you can disable this behavior:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">sqlite3_adapter_strict_strings_by_default</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre></div></div>

<h3 id="support-multiple-preview-paths-for-actionmailerpreview">Support multiple preview paths for <code class="language-plaintext highlighter-rouge">ActionMailer::Preview</code></h3>

<p>Option <code class="language-plaintext highlighter-rouge">config.action_mailer.preview_path</code> is deprecated in favor of <code class="language-plaintext highlighter-rouge">config.action_mailer.preview_paths</code>. Appending paths to this configuration option will cause those paths to be used in the search for mailer previews.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">preview_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib/mailer_previews"</span>
</code></pre></div></div>

<h3 id="configi18nraise_on_missing_translations--true-now-raises-on-any-missing-translation"><code class="language-plaintext highlighter-rouge">config.i18n.raise_on_missing_translations = true</code> now raises on any missing translation.</h3>

<p>Previously it would only raise when called in a view or controller. Now it will raise anytime <code class="language-plaintext highlighter-rouge">I18n.t</code> is provided an unrecognised key.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># with config.i18n.raise_on_missing_translations = true</span>

<span class="c1"># in a view or controller:</span>
<span class="n">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># raises in 7.0, raises in 7.1</span>
<span class="no">I18n</span><span class="p">.</span><span class="nf">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># didn't raise in 7.0, raises in 7.1</span>

<span class="c1"># anywhere:</span>
<span class="no">I18n</span><span class="p">.</span><span class="nf">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># didn't raise in 7.0, raises in 7.1</span>
</code></pre></div></div>

<p>If you don‚Äôt want this behaviour, you can set <code class="language-plaintext highlighter-rouge">config.i18n.raise_on_missing_translations = false</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># with config.i18n.raise_on_missing_translations = false</span>

<span class="c1"># in a view or controller:</span>
<span class="n">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># didn't raise in 7.0, doesn't raise in 7.1</span>
<span class="no">I18n</span><span class="p">.</span><span class="nf">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># didn't raise in 7.0, doesn't raise in 7.1</span>

<span class="c1"># anywhere:</span>
<span class="no">I18n</span><span class="p">.</span><span class="nf">t</span><span class="p">(</span><span class="s2">"missing.key"</span><span class="p">)</span> <span class="c1"># didn't raise in 7.0, doesn't raise in 7.1</span>
</code></pre></div></div>

<p>Alternatively, you can customise the <code class="language-plaintext highlighter-rouge">I18n.exception_handler</code>.
See the <a href="https://guides.rubyonrails.org/v7.1/i18n.html#using-different-exception-handlers">i18n guide</a> for more information.</p>

<p><code class="language-plaintext highlighter-rouge">AbstractController::Translation.raise_on_missing_translations</code> has been removed. This was a private API, if you were
relying on it you should migrate to <code class="language-plaintext highlighter-rouge">config.i18n.raise_on_missing_translations</code> or to a custom exception handler.</p>

<h3 id="binrails-test-now-runs-testprepare-task"><code class="language-plaintext highlighter-rouge">bin/rails test</code> now runs <code class="language-plaintext highlighter-rouge">test:prepare</code> task</h3>

<p>When running tests via <code class="language-plaintext highlighter-rouge">bin/rails test</code>, the <code class="language-plaintext highlighter-rouge">rake test:prepare</code> task will run before tests run. If you‚Äôve enhanced
the <code class="language-plaintext highlighter-rouge">test:prepare</code> task, your enhancements will run before your tests. <code class="language-plaintext highlighter-rouge">tailwindcss-rails</code>, <code class="language-plaintext highlighter-rouge">jsbundling-rails</code>, and <code class="language-plaintext highlighter-rouge">cssbundling-rails</code>
enhance this task, as do other third party gems.</p>

<p>See the <a href="https://guides.rubyonrails.org/testing.html#running-tests-in-continuous-integration-ci">Testing Rails Applications</a> guide for more information.</p>

<p>If you run a single file‚Äôs tests (<code class="language-plaintext highlighter-rouge">bin/rails test test/models/user_test.rb</code>), <code class="language-plaintext highlighter-rouge">test:prepare</code> will not run before it.</p>

<h3 id="import-syntax-from-railsujs-is-modified">Import syntax from <code class="language-plaintext highlighter-rouge">@rails/ujs</code> is modified</h3>

<p>Starting from Rails 7.1, the syntax for importing modules from <code class="language-plaintext highlighter-rouge">@rails/ujs</code> is modified. Rails no longer supports the
direct import of a module from <code class="language-plaintext highlighter-rouge">@rails/ujs</code>.</p>

<p>For example, attempting to import a function from the library will fail:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">fileInputSelector</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/ujs</span><span class="dl">"</span>
<span class="c1">// ERROR: export 'fileInputSelector' (imported as 'fileInputSelector') was not found in '@rails/ujs' (possible exports: default)</span>
</code></pre></div></div>

<p>In Rails 7.1, users should first import the Rails object directly from <code class="language-plaintext highlighter-rouge">@rails/ujs</code>.
Users can then import specific modules from the Rails object.</p>

<p>An example of imports in Rails 7.1 is shown below:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">Rails</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/ujs</span><span class="dl">"</span>
<span class="c1">// Alias the method</span>
<span class="kd">const</span> <span class="nx">fileInputSelector</span> <span class="o">=</span> <span class="nx">Rails</span><span class="p">.</span><span class="nx">fileInputSelector</span>
<span class="c1">// Alternatively, reference it from the Rails object where it is used</span>
<span class="nx">Rails</span><span class="p">.</span><span class="nf">fileInputSelector</span><span class="p">(...)</span>
</code></pre></div></div>

<h3 id="railslogger-now-returns-an-activesupportbroadcastlogger-instance"><code class="language-plaintext highlighter-rouge">Rails.logger</code> now returns an <code class="language-plaintext highlighter-rouge">ActiveSupport::BroadcastLogger</code> instance</h3>

<p>The <code class="language-plaintext highlighter-rouge">ActiveSupport::BroadcastLogger</code> class is a new logger that allows to broadcast logs to different sinks (STDOUT, a log file‚Ä¶) in an easy way.</p>

<p>The API to broadcast logs (using the <code class="language-plaintext highlighter-rouge">ActiveSupport::Logger.broadcast</code> method) was removed and was previously private.
If your application or library was relying on this API, you need to make the following changes:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">logger</span> <span class="o">=</span> <span class="no">Logger</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"some_file.log"</span><span class="p">)</span>

<span class="c1"># Before</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">extend</span><span class="p">(</span><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Logger</span><span class="p">.</span><span class="nf">broadcast</span><span class="p">(</span><span class="n">logger</span><span class="p">))</span>

<span class="c1"># After</span>

<span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">broadcast_to</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
</code></pre></div></div>

<p>If your application had configured a custom logger, <code class="language-plaintext highlighter-rouge">Rails.logger</code> will wrap and proxy all methods to it. No changes on your side are required to make it work.</p>

<p>If you need to access your custom logger instance, you can do so using the <code class="language-plaintext highlighter-rouge">broadcasts</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">logger</span> <span class="o">=</span> <span class="no">MyLogger</span><span class="p">.</span><span class="nf">new</span>

<span class="c1"># Anywhere in your application</span>
<span class="nb">puts</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">class</span> <span class="c1">#=&gt; BroadcastLogger</span>
<span class="nb">puts</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">broadcasts</span> <span class="c1">#=&gt; [MyLogger]</span>
</code></pre></div></div>

<h3 id="active-record-encryption-algorithm-changes">Active Record Encryption algorithm changes</h3>

<p>Active Record Encryption now uses SHA-256 as its hash digest algorithm. If you have data encrypted with previous Rails
versions, there are two scenarios to consider:</p>

<ol>
  <li>
    <p>If you have <code class="language-plaintext highlighter-rouge">config.active_support.key_generator_hash_digest_class</code> configured as SHA-1 (the default
before Rails 7.0), you need to configure SHA-1 for Active Record Encryption too:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">hash_digest_class</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span>
</code></pre></div>    </div>

    <p>If all of your data was encrypted non-deterministicly (the default unless <code class="language-plaintext highlighter-rouge">encrypts</code> is passed <code class="language-plaintext highlighter-rouge">deterministic: true</code>, you can instead configure SHA-256 for Active Record Encryption as in scenario 2 below and also allow columns previously encrypted with SHA-1 to be decrypted by setting:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">support_sha1_for_non_deterministic_encryption</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>If you have <code class="language-plaintext highlighter-rouge">config.active_support.key_generator_hash_digest_class</code> configured as SHA-256 (the new default
in 7.0), then you need to configure SHA-256 for Active Record Encryption:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">hash_digest_class</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>See the <a href="configuring.html#config-active-record-encryption-hash-digest-class">Configuring Rails Applications</a>
guide for more information on <code class="language-plaintext highlighter-rouge">config.active_record.encryption.hash_digest_class</code>.</p>

<p>In addition, a new configuration <a href="configuring.html#config-active-record-encryption-support-sha1-for-non-deterministic-encryption"><code class="language-plaintext highlighter-rouge">config.active_record.encryption.support_sha1_for_non_deterministic_encryption</code></a>
was introduced to resolve <a href="https://github.com/rails/rails/issues/42922">a bug</a> that caused some attributes to be
encrypted using SHA-1 even when SHA-256 was configured via the aforementioned <code class="language-plaintext highlighter-rouge">hash_digest_class</code> configuration.</p>

<p>By default, <code class="language-plaintext highlighter-rouge">config.active_record.encryption.support_sha1_for_non_deterministic_encryption</code> is disabled in
Rails 7.1. If you have data encrypted in a version of Rails &lt; 7.1 that you believe may be affected
by the aforementioned bug, this configuration should be enabled:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">encryption</span><span class="p">.</span><span class="nf">support_sha1_for_non_deterministic_encryption</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<p><strong>If you are working with encrypted data, please carefully review the above.</strong></p>

<h3 id="new-ways-to-handle-exceptions-in-controller-tests-integration-tests-and-system-tests">New ways to handle exceptions in Controller Tests, Integration Tests, and System Tests</h3>

<p>The <code class="language-plaintext highlighter-rouge">config.action_dispatch.show_exceptions</code> configuration controls how Action Pack handles exceptions raised while responding to requests.</p>

<p>Prior to Rails 7.1, setting <code class="language-plaintext highlighter-rouge">config.action_dispatch.show_exceptions = true</code> configured Action Pack to rescue exceptions and render appropriate HTML error pages, like rendering <code class="language-plaintext highlighter-rouge">public/404.html</code> with a <code class="language-plaintext highlighter-rouge">404 Not found</code> status code instead of raising an <code class="language-plaintext highlighter-rouge">ActiveRecord::RecordNotFound</code> exception. Setting <code class="language-plaintext highlighter-rouge">config.action_dispatch.show_exceptions = false</code> configured Action Pack to not rescue the exception. Prior to Rails 7.1, new applications were generated with a line in <code class="language-plaintext highlighter-rouge">config/environments/test.rb</code> that set <code class="language-plaintext highlighter-rouge">config.action_dispatch.show_exceptions = false</code>.</p>

<p>Rails 7.1 changes the acceptable values from <code class="language-plaintext highlighter-rouge">true</code> and <code class="language-plaintext highlighter-rouge">false</code> to <code class="language-plaintext highlighter-rouge">:all</code>, <code class="language-plaintext highlighter-rouge">:rescuable</code>, and <code class="language-plaintext highlighter-rouge">:none</code>.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">:all</code> - render HTML error pages for all exceptions (equivalent to <code class="language-plaintext highlighter-rouge">true</code>)</li>
  <li><code class="language-plaintext highlighter-rouge">:rescuable</code> - render HTML error pages for exceptions declared by <a href="/configuring.html#config-action-dispatch-rescue-responses"><code class="language-plaintext highlighter-rouge">config.action_dispatch.rescue_responses</code></a></li>
  <li><code class="language-plaintext highlighter-rouge">:none</code> (equivalent to <code class="language-plaintext highlighter-rouge">false</code>) - do not rescue from any exceptions</li>
</ul>

<p>Applications generated by Rails 7.1 or later set <code class="language-plaintext highlighter-rouge">config.action_dispatch.show_exceptions = :rescuable</code> in their <code class="language-plaintext highlighter-rouge">config/environments/test.rb</code>. When upgrading, existing applications can change <code class="language-plaintext highlighter-rouge">config.action_dispatch.show_exceptions = :rescuable</code> to utilize the new behavior, or replace the old values with the corresponding new ones (<code class="language-plaintext highlighter-rouge">true</code> replaces <code class="language-plaintext highlighter-rouge">:all</code>, <code class="language-plaintext highlighter-rouge">false</code> replaces <code class="language-plaintext highlighter-rouge">:none</code>).</p>

<h2 id="upgrading-from-rails-61-to-rails-70">Upgrading from Rails 6.1 to Rails 7.0</h2>

<p>For more information on changes made to Rails 7.0 please see the <a href="7_0_release_notes.html">release notes</a>.</p>

<h3 id="actionviewhelpersurlhelperbutton_to-changed-behavior"><code class="language-plaintext highlighter-rouge">ActionView::Helpers::UrlHelper#button_to</code> changed behavior</h3>

<p>Starting from Rails 7.0 <code class="language-plaintext highlighter-rouge">button_to</code> renders a <code class="language-plaintext highlighter-rouge">form</code> tag with <code class="language-plaintext highlighter-rouge">patch</code> HTTP verb if a persisted Active Record object is used to build button URL.
To keep current behavior consider explicitly passing <code class="language-plaintext highlighter-rouge">method:</code> option:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">-button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)])
</span><span class="gi">+button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)], method: :post)
</span></code></pre></div></div>

<p>or using helper to build the URL:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">-button_to("Do a POST", [:my_custom_post_action_on_workshop, Workshop.find(1)])
</span><span class="gi">+button_to("Do a POST", my_custom_post_action_on_workshop_workshop_path(Workshop.find(1)))
</span></code></pre></div></div>

<h3 id="spring">Spring</h3>

<p>If your application uses Spring, it needs to be upgraded to at least version 3.0.0. Otherwise you‚Äôll get</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>undefined method `mechanism=' for ActiveSupport::Dependencies:Module
</code></pre></div></div>

<p>Also, make sure <a href="configuring.html#config-cache-classes"><code class="language-plaintext highlighter-rouge">config.cache_classes</code></a> is set to <code class="language-plaintext highlighter-rouge">false</code> in <code class="language-plaintext highlighter-rouge">config/environments/test.rb</code>.</p>

<h3 id="sprockets-is-now-an-optional-dependency">Sprockets is now an optional dependency</h3>

<p>The gem <code class="language-plaintext highlighter-rouge">rails</code> doesn‚Äôt depend on <code class="language-plaintext highlighter-rouge">sprockets-rails</code> anymore. If your application still needs to use Sprockets,
make sure to add <code class="language-plaintext highlighter-rouge">sprockets-rails</code> to your Gemfile.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s2">"sprockets-rails"</span>
</code></pre></div></div>

<h3 id="applications-need-to-run-in-zeitwerk-mode">Applications need to run in <code class="language-plaintext highlighter-rouge">zeitwerk</code> mode</h3>

<p>Applications still running in <code class="language-plaintext highlighter-rouge">classic</code> mode have to switch to <code class="language-plaintext highlighter-rouge">zeitwerk</code> mode. Please check the <a href="https://guides.rubyonrails.org/v7.0/classic_to_zeitwerk_howto.html">Classic to Zeitwerk HOWTO</a> guide for details.</p>

<h3 id="the-setter-configautoloader-has-been-deleted">The setter <code class="language-plaintext highlighter-rouge">config.autoloader=</code> has been deleted</h3>

<p>In Rails 7 there is no configuration point to set the autoloading mode, <code class="language-plaintext highlighter-rouge">config.autoloader=</code> has been deleted. If you had it set to <code class="language-plaintext highlighter-rouge">:zeitwerk</code> for whatever reason, just remove it.</p>

<h3 id="activesupportdependencies-private-api-has-been-deleted"><code class="language-plaintext highlighter-rouge">ActiveSupport::Dependencies</code> private API has been deleted</h3>

<p>The private API of <code class="language-plaintext highlighter-rouge">ActiveSupport::Dependencies</code> has been deleted. That includes methods like <code class="language-plaintext highlighter-rouge">hook!</code>, <code class="language-plaintext highlighter-rouge">unhook!</code>, <code class="language-plaintext highlighter-rouge">depend_on</code>, <code class="language-plaintext highlighter-rouge">require_or_load</code>, <code class="language-plaintext highlighter-rouge">mechanism</code>, and many others.</p>

<p>A few of highlights:</p>

<ul>
  <li>
    <p>If you used <code class="language-plaintext highlighter-rouge">ActiveSupport::Dependencies.constantize</code> or <code class="language-plaintext highlighter-rouge">ActiveSupport::Dependencies.safe_constantize</code>, just change them to <code class="language-plaintext highlighter-rouge">String#constantize</code> or <code class="language-plaintext highlighter-rouge">String#safe_constantize</code>.</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">constantize</span><span class="p">(</span><span class="s2">"User"</span><span class="p">)</span> <span class="c1"># NO LONGER POSSIBLE</span>
<span class="s2">"User"</span><span class="p">.</span><span class="nf">constantize</span> <span class="c1"># üëç</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Any usage of <code class="language-plaintext highlighter-rouge">ActiveSupport::Dependencies.mechanism</code>, reader or writer, has to be replaced by accessing <code class="language-plaintext highlighter-rouge">config.cache_classes</code> accordingly.</p>
  </li>
  <li>
    <p>If you want to trace the activity of the autoloader, <code class="language-plaintext highlighter-rouge">ActiveSupport::Dependencies.verbose=</code> is no longer available, just throw <code class="language-plaintext highlighter-rouge">Rails.autoloaders.log!</code> in <code class="language-plaintext highlighter-rouge">config/application.rb</code>.</p>
  </li>
</ul>

<p>Auxiliary internal classes or modules are also gone, like <code class="language-plaintext highlighter-rouge">ActiveSupport::Dependencies::Reference</code>, <code class="language-plaintext highlighter-rouge">ActiveSupport::Dependencies::Blamable</code>, and others.</p>

<h3 id="autoloading-during-initialization">Autoloading during initialization</h3>

<p>Applications that autoloaded reloadable constants during initialization outside of <code class="language-plaintext highlighter-rouge">to_prepare</code> blocks got those constants unloaded and had this warning issued since Rails 6.0:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DEPRECATION WARNING: Initialization autoloaded the constant ....

Being able to do this is deprecated. Autoloading during initialization is going
to be an error condition in future versions of Rails.

...
</code></pre></div></div>

<p>If you still get this warning in the logs, please check the section about autoloading when the application boots in the <a href="https://guides.rubyonrails.org/v7.0/autoloading_and_reloading_constants.html#autoloading-when-the-application-boots">autoloading guide</a>. You‚Äôd get a <code class="language-plaintext highlighter-rouge">NameError</code> in Rails 7 otherwise.</p>

<p>Constants managed by the <code class="language-plaintext highlighter-rouge">once</code> autoloader can be autoloaded during initialization, and they can be used normally, no need for a <code class="language-plaintext highlighter-rouge">to_prepare</code> block. However, the <code class="language-plaintext highlighter-rouge">once</code> autoloader is now set up earlier to support that. If the application has custom inflections, and the <code class="language-plaintext highlighter-rouge">once</code> autoloader should be aware of them, you need to move the code in <code class="language-plaintext highlighter-rouge">config/initializers/inflections.rb</code> to the body of the application class definition in <code class="language-plaintext highlighter-rouge">config/application.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">MyApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="c1"># ...</span>

    <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Inflector</span><span class="p">.</span><span class="nf">inflections</span><span class="p">(</span><span class="ss">:en</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">inflect</span><span class="o">|</span>
      <span class="n">inflect</span><span class="p">.</span><span class="nf">acronym</span> <span class="s2">"HTML"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="ability-to-configure-configautoload_once_paths">Ability to configure <code class="language-plaintext highlighter-rouge">config.autoload_once_paths</code></h3>

<p><a href="configuring.html#config-autoload-once-paths"><code class="language-plaintext highlighter-rouge">config.autoload_once_paths</code></a> can be set in the body of the application class defined in <code class="language-plaintext highlighter-rouge">config/application.rb</code> or in the configuration for environments in <code class="language-plaintext highlighter-rouge">config/environments/*</code>.</p>

<p>Similarly, engines can configure that collection in the class body of the engine class or in the configuration for environments.</p>

<p>After that, the collection is frozen, and you can autoload from those paths. In particular, you can autoload from there during initialization. They are managed by the <code class="language-plaintext highlighter-rouge">Rails.autoloaders.once</code> autoloader, which does not reload, only autoloads/eager loads.</p>

<p>If you configured this setting after the environments configuration has been processed and are getting <code class="language-plaintext highlighter-rouge">FrozenError</code>, please just move the code.</p>

<h3 id="actiondispatchrequestcontent_type-now-returns-content-type-header-as-it-is"><code class="language-plaintext highlighter-rouge">ActionDispatch::Request#content_type</code> now returns Content-Type header as it is.</h3>

<p>Previously, <code class="language-plaintext highlighter-rouge">ActionDispatch::Request#content_type</code> returned value does NOT contain charset part.
This behavior changed to returned Content-Type header containing charset part as it is.</p>

<p>If you want just MIME type, please use <code class="language-plaintext highlighter-rouge">ActionDispatch::Request#media_type</code> instead.</p>

<p>Before:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"CONTENT_TYPE"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">,</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv"</span>
</code></pre></div></div>

<p>After:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">request</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Request</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">,</span> <span class="s2">"REQUEST_METHOD"</span> <span class="o">=&gt;</span> <span class="s2">"GET"</span><span class="p">)</span>
<span class="n">request</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present; charset=utf-16"</span>
<span class="n">request</span><span class="p">.</span><span class="nf">media_type</span>   <span class="c1">#=&gt; "text/csv"</span>
</code></pre></div></div>

<h3 id="key-generator-digest-class-change-requires-a-cookie-rotator">Key generator digest class change requires a cookie rotator</h3>

<p>The default digest class for the key generator is changing from SHA1 to SHA256.
This has consequences in any encrypted message generated by Rails, including
encrypted cookies.</p>

<p>In order to be able to read messages using the old digest class it is necessary
to register a rotator. Failing to do so may result in users having their sessions
invalidated during the upgrade.</p>

<p>The following is an example for rotator for the encrypted and the signed cookies.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/cookie_rotator.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">after_initialize</span> <span class="k">do</span>
  <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_rotations</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">cookies</span><span class="o">|</span>
    <span class="n">authenticated_encrypted_cookie_salt</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">authenticated_encrypted_cookie_salt</span>
    <span class="n">signed_cookie_salt</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">signed_cookie_salt</span>

    <span class="n">secret_key_base</span> <span class="o">=</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secret_key_base</span>

    <span class="n">key_generator</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">KeyGenerator</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="n">secret_key_base</span><span class="p">,</span> <span class="ss">iterations: </span><span class="mi">1000</span><span class="p">,</span> <span class="ss">hash_digest_class: </span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA1</span>
    <span class="p">)</span>
    <span class="n">key_len</span> <span class="o">=</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">MessageEncryptor</span><span class="p">.</span><span class="nf">key_len</span>

    <span class="n">old_encrypted_secret</span> <span class="o">=</span> <span class="n">key_generator</span><span class="p">.</span><span class="nf">generate_key</span><span class="p">(</span><span class="n">authenticated_encrypted_cookie_salt</span><span class="p">,</span> <span class="n">key_len</span><span class="p">)</span>
    <span class="n">old_signed_secret</span> <span class="o">=</span> <span class="n">key_generator</span><span class="p">.</span><span class="nf">generate_key</span><span class="p">(</span><span class="n">signed_cookie_salt</span><span class="p">)</span>

    <span class="n">cookies</span><span class="p">.</span><span class="nf">rotate</span> <span class="ss">:encrypted</span><span class="p">,</span> <span class="n">old_encrypted_secret</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">rotate</span> <span class="ss">:signed</span><span class="p">,</span> <span class="n">old_signed_secret</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="digest-class-for-activesupportdigest-changing-to-sha256">Digest class for ActiveSupport::Digest changing to SHA256</h3>

<p>The default digest class for ActiveSupport::Digest is changing from SHA1 to SHA256.
This has consequences for things like Etags that will change and cache keys as well.
Changing these keys can have impact on cache hit rates, so be careful and watch out
for this when upgrading to the new hash.</p>

<h3 id="new-activesupportcache-serialization-format">New ActiveSupport::Cache serialization format</h3>

<p>A faster and more compact serialization format was introduced.</p>

<p>To enable it you must set <code class="language-plaintext highlighter-rouge">config.active_support.cache_format_version = 7.0</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.1</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">cache_format_version</span> <span class="o">=</span> <span class="mf">7.0</span>
</code></pre></div></div>

<p>Or simply:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">7.0</span>
</code></pre></div></div>

<p>However Rails 6.1 applications are not able to read this new serialization format,
so to ensure a seamless upgrade you must first deploy your Rails 7.0 upgrade with
<code class="language-plaintext highlighter-rouge">config.active_support.cache_format_version = 6.1</code>, and then only once all Rails
processes have been updated you can set <code class="language-plaintext highlighter-rouge">config.active_support.cache_format_version = 7.0</code>.</p>

<p>Rails 7.0 is able to read both formats so the cache won‚Äôt be invalidated during the
upgrade.</p>

<h3 id="active-storage-video-preview-image-generation">Active Storage video preview image generation</h3>

<p>Video preview image generation now uses FFmpeg‚Äôs scene change detection to generate
more meaningful preview images. Previously the first frame of the video would be used
and that caused problems if the video faded in from black. This change requires
FFmpeg v3.4+.</p>

<h3 id="active-storage-default-variant-processor-changed-to-vips">Active Storage default variant processor changed to <code class="language-plaintext highlighter-rouge">:vips</code></h3>

<p>For new apps, image transformation will use libvips instead of ImageMagick. This will reduce
the time taken to generate variants as well as CPU and memory usage, improving response
times in apps that rely on Active Storage to serve their images.</p>

<p>The <code class="language-plaintext highlighter-rouge">:mini_magick</code> option is not being deprecated, so it is fine to keep using it.</p>

<p>To migrate an existing app to libvips, set:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">active_storage</span><span class="p">.</span><span class="nf">variant_processor</span> <span class="o">=</span> <span class="ss">:vips</span>
</code></pre></div></div>

<p>You will then need to change existing image transformation code to the
<code class="language-plaintext highlighter-rouge">image_processing</code> macros, and replace ImageMagick‚Äôs options with libvips‚Äô options.</p>

<h4 id="replace-resize-with-resize_to_limit">Replace resize with resize_to_limit</h4>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- variant(resize: "100x")
</span><span class="gi">+ variant(resize_to_limit: [100, nil])
</span></code></pre></div></div>

<p>If you don‚Äôt do this, when you switch to vips you will see this error: <code class="language-plaintext highlighter-rouge">no implicit conversion to float from string</code>.</p>

<h4 id="use-an-array-when-cropping">Use an array when cropping</h4>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- variant(crop: "1920x1080+0+0")
</span><span class="gi">+ variant(crop: [0, 0, 1920, 1080])
</span></code></pre></div></div>

<p>If you don‚Äôt do this when migrating to vips, you will see the following error: <code class="language-plaintext highlighter-rouge">unable to call crop: you supplied 2 arguments, but operation needs 5</code>.</p>

<h4 id="clamp-your-crop-values">Clamp your crop values:</h4>

<p>Vips is more strict than ImageMagick when it comes to cropping:</p>

<ol>
  <li>It will not crop if <code class="language-plaintext highlighter-rouge">x</code> and/or <code class="language-plaintext highlighter-rouge">y</code> are negative values. e.g.: <code class="language-plaintext highlighter-rouge">[-10, -10, 100, 100]</code></li>
  <li>It will not crop if position (<code class="language-plaintext highlighter-rouge">x</code> or <code class="language-plaintext highlighter-rouge">y</code>) plus crop dimension (<code class="language-plaintext highlighter-rouge">width</code>, <code class="language-plaintext highlighter-rouge">height</code>) is larger than the image. e.g.: a 125x125 image and a crop of <code class="language-plaintext highlighter-rouge">[50, 50, 100, 100]</code></li>
</ol>

<p>If you don‚Äôt do this when migrating to vips, you will see the following error: <code class="language-plaintext highlighter-rouge">extract_area: bad extract area</code></p>

<h4 id="adjust-the-background-color-used-for-resize_and_pad">Adjust the background color used for <code class="language-plaintext highlighter-rouge">resize_and_pad</code></h4>

<p>Vips uses black as the default background color <code class="language-plaintext highlighter-rouge">resize_and_pad</code>, instead of white like ImageMagick. Fix that by using the <code class="language-plaintext highlighter-rouge">background</code> option:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- variant(resize_and_pad: [300, 300])
</span><span class="gi">+ variant(resize_and_pad: [300, 300, background: [255]])
</span></code></pre></div></div>

<h4 id="remove-any-exif-based-rotation">Remove any EXIF based rotation</h4>

<p>Vips will auto rotate images using the EXIF value when processing variants. If you were storing rotation values from user uploaded photos to apply rotation with ImageMagick, you must stop doing that:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- variant(format: :jpg, rotate: rotation_value)
</span><span class="gi">+ variant(format: :jpg)
</span></code></pre></div></div>

<h4 id="replace-monochrome-with-colourspace">Replace monochrome with colourspace</h4>

<p>Vips uses a different option to make monochrome images:</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- variant(monochrome: true)
</span><span class="gi">+ variant(colourspace: "b-w")
</span></code></pre></div></div>

<h4 id="switch-to-libvips-options-for-compressing-images">Switch to libvips options for compressing images</h4>

<p>JPEG</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- variant(strip: true, quality: 80, interlace: "JPEG", sampling_factor: "4:2:0", colorspace: "sRGB")
</span><span class="gi">+ variant(saver: { strip: true, quality: 80, interlace: true })
</span></code></pre></div></div>

<p>PNG</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- variant(strip: true, quality: 75)
</span><span class="gi">+ variant(saver: { strip: true, compression: 9 })
</span></code></pre></div></div>

<p>WEBP</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- variant(strip: true, quality: 75, define: { webp: { lossless: false, alpha_quality: 85, thread_level: 1 } })
</span><span class="gi">+ variant(saver: { strip: true, quality: 75, lossless: false, alpha_q: 85, reduction_effort: 6, smart_subsample: true })
</span></code></pre></div></div>

<p>GIF</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">- variant(layers: "Optimize")
</span><span class="gi">+ variant(saver: { optimize_gif_frames: true, optimize_gif_transparency: true })
</span></code></pre></div></div>

<h4 id="deploy-to-production">Deploy to production</h4>

<p>Active Storage encodes into the url for the image the list of transformations that must be performed.
If your app is caching these urls, your images will break after you deploy the new code to production.
Because of this you must manually invalidate your affected cache keys.</p>

<p>For example, if you have something like this in a view:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="vi">@products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">cache</span> <span class="n">product</span> <span class="k">do</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">product</span><span class="p">.</span><span class="nf">cover_photo</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"200x"</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>You can invalidate the cache either by touching the product, or changing the cache key:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="vi">@products</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">product</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="n">cache</span> <span class="p">[</span><span class="s2">"v2"</span><span class="p">,</span> <span class="n">product</span><span class="p">]</span> <span class="k">do</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="n">product</span><span class="p">.</span><span class="nf">cover_photo</span><span class="p">.</span><span class="nf">variant</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="kp">nil</span><span class="p">])</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<h3 id="rails-version-is-now-included-in-the-active-record-schema-dump">Rails version is now included in the Active Record schema dump</h3>

<p>Rails 7.0 changed some default values for some column types. To avoid that application upgrading from 6.1 to 7.0
load the current schema using the new 7.0 defaults, Rails now includes the version of the framework in the schema dump.</p>

<p>Before loading the schema for the first time in Rails 7.0, make sure to run <code class="language-plaintext highlighter-rouge">bin/rails app:update</code> to ensure that the
version of the schema is included in the schema dump.</p>

<p>The schema file will look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This file is auto-generated from the current state of the database. Instead</span>
<span class="c1"># of editing this file, please use the migrations feature of Active Record to</span>
<span class="c1"># incrementally modify your database, and then regenerate this schema definition.</span>
<span class="c1">#</span>
<span class="c1"># This file is the source Rails uses to define your schema when running `bin/rails</span>
<span class="c1"># db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to</span>
<span class="c1"># be faster and is potentially less error prone than running all of your</span>
<span class="c1"># migrations from scratch. Old migrations may fail to apply correctly if those</span>
<span class="c1"># migrations use external dependencies or application code.</span>
<span class="c1">#</span>
<span class="c1"># It's strongly recommended that you check this file into your version control system.</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Schema</span><span class="p">[</span><span class="mf">6.1</span><span class="p">].</span><span class="nf">define</span><span class="p">(</span><span class="ss">version: </span><span class="mi">2022_01_28_123512</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>NOTE: The first time you dump the schema with Rails 7.0, you will see many changes to that file, including
some column information. Make sure to review the new schema file content and commit it to your repository.</p>

<h2 id="upgrading-from-rails-60-to-rails-61">Upgrading from Rails 6.0 to Rails 6.1</h2>

<p>For more information on changes made to Rails 6.1 please see the <a href="6_1_release_notes.html">release notes</a>.</p>

<h3 id="railsapplicationconfig_for-return-value-no-longer-supports-access-with-string-keys"><code class="language-plaintext highlighter-rouge">Rails.application.config_for</code> return value no longer supports access with String keys.</h3>

<p>Given a configuration file like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/example.yml</span>
<span class="na">development</span><span class="pi">:</span>
  <span class="na">options</span><span class="pi">:</span>
    <span class="na">key</span><span class="pi">:</span> <span class="s">value</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config_for</span><span class="p">(</span><span class="ss">:example</span><span class="p">).</span><span class="nf">options</span>
</code></pre></div></div>

<p>This used to return a hash on which you could access values with String keys. That was deprecated in 6.0, and now doesn‚Äôt work anymore.</p>

<p>You can call <code class="language-plaintext highlighter-rouge">with_indifferent_access</code> on the return value of <code class="language-plaintext highlighter-rouge">config_for</code> if you still want to access values with String keys, e.g.:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config_for</span><span class="p">(</span><span class="ss">:example</span><span class="p">).</span><span class="nf">with_indifferent_access</span><span class="p">.</span><span class="nf">dig</span><span class="p">(</span><span class="s2">"options"</span><span class="p">,</span> <span class="s2">"key"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="responses-content-type-when-using-respond_toany">Response‚Äôs Content-Type when using <code class="language-plaintext highlighter-rouge">respond_to#any</code></h3>

<p>The Content-Type header returned in the response can differ from what Rails 6.0 returned,
more specifically if your application uses <code class="language-plaintext highlighter-rouge">respond_to { |format| format.any }</code>.
The Content-Type will now be based on the given block rather than the request‚Äôs format.</p>

<p>Example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">my_action</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">any</span> <span class="p">{</span> <span class="n">render</span><span class="p">(</span><span class="ss">json: </span><span class="p">{</span> <span class="ss">foo: </span><span class="s2">"bar"</span> <span class="p">})</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span><span class="p">(</span><span class="s2">"my_action.csv"</span><span class="p">)</span>
</code></pre></div></div>

<p>Previous behavior was returning a <code class="language-plaintext highlighter-rouge">text/csv</code> response‚Äôs Content-Type which is inaccurate since a JSON response is being rendered.
Current behavior correctly returns a <code class="language-plaintext highlighter-rouge">application/json</code> response‚Äôs Content-Type.</p>

<p>If your application relies on the previous incorrect behavior, you are encouraged to specify
which formats your action accepts, i.e.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">format</span><span class="p">.</span><span class="nf">any</span><span class="p">(</span><span class="ss">:xml</span><span class="p">,</span> <span class="ss">:json</span><span class="p">)</span> <span class="p">{</span> <span class="n">render</span> <span class="n">request</span><span class="p">.</span><span class="nf">format</span><span class="p">.</span><span class="nf">to_sym</span> <span class="o">=&gt;</span> <span class="vi">@people</span> <span class="p">}</span>
</code></pre></div></div>

<h3 id="activesupportcallbackshalted_callback_hook-now-receive-a-second-argument"><code class="language-plaintext highlighter-rouge">ActiveSupport::Callbacks#halted_callback_hook</code> now receive a second argument</h3>

<p>Active Support allows you to override the <code class="language-plaintext highlighter-rouge">halted_callback_hook</code> whenever a callback
halts the chain. This method now receives a second argument which is the name of the callback being halted.
If you have classes that override this method, make sure it accepts two arguments. Note that this is a breaking
change without a prior deprecation cycle (for performance reasons).</p>

<p>Example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">before_create</span> <span class="p">{</span> <span class="kp">throw</span><span class="p">(</span><span class="ss">:abort</span><span class="p">)</span> <span class="p">}</span>

  <span class="k">def</span> <span class="nf">halted_callback_hook</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">callback_name</span><span class="p">)</span> <span class="c1"># =&gt; This method now accepts 2 arguments instead of 1</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">logger</span><span class="p">.</span><span class="nf">info</span><span class="p">(</span><span class="s2">"Book couldn't be </span><span class="si">#{</span><span class="n">callback_name</span><span class="si">}</span><span class="s2">d"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="the-helper-class-method-in-controllers-uses-stringconstantize">The <code class="language-plaintext highlighter-rouge">helper</code> class method in controllers uses <code class="language-plaintext highlighter-rouge">String#constantize</code></h3>

<p>Conceptually, before Rails 6.1</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">helper</span> <span class="s2">"foo/bar"</span>
</code></pre></div></div>

<p>resulted in</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">require_dependency</span> <span class="s2">"foo/bar_helper"</span>
<span class="n">module_name</span> <span class="o">=</span> <span class="s2">"foo/bar_helper"</span><span class="p">.</span><span class="nf">camelize</span>
<span class="n">module_name</span><span class="p">.</span><span class="nf">constantize</span>
</code></pre></div></div>

<p>Now it does this instead:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">prefix</span> <span class="o">=</span> <span class="s2">"foo/bar"</span><span class="p">.</span><span class="nf">camelize</span>
<span class="s2">"</span><span class="si">#{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">Helper"</span><span class="p">.</span><span class="nf">constantize</span>
</code></pre></div></div>

<p>This change is backwards compatible for the majority of applications, in which case you do not need to do anything.</p>

<p>Technically, however, controllers could configure <code class="language-plaintext highlighter-rouge">helpers_path</code> to point to a directory in <code class="language-plaintext highlighter-rouge">$LOAD_PATH</code> that was not in the autoload paths. That use case is no longer supported out of the box. If the helper module is not autoloadable, the application is responsible for loading it before calling <code class="language-plaintext highlighter-rouge">helper</code>.</p>

<h3 id="redirection-to-https-from-http-will-now-use-the-308-http-status-code">Redirection to HTTPS from HTTP will now use the 308 HTTP status code</h3>

<p>The default HTTP status code used in <code class="language-plaintext highlighter-rouge">ActionDispatch::SSL</code> when redirecting non-GET/HEAD requests from HTTP to HTTPS has been changed to <code class="language-plaintext highlighter-rouge">308</code> as defined in https://tools.ietf.org/html/rfc7538.</p>

<h3 id="active-storage-now-requires-image-processing">Active Storage now requires Image Processing</h3>

<p>When processing variants in Active Storage, it‚Äôs now required to have the <a href="https://github.com/janko/image_processing">image_processing gem</a> bundled instead of directly using <code class="language-plaintext highlighter-rouge">mini_magick</code>. Image Processing is configured by default to use <code class="language-plaintext highlighter-rouge">mini_magick</code> behind the scenes, so the easiest way to upgrade is by replacing the <code class="language-plaintext highlighter-rouge">mini_magick</code> gem for the <code class="language-plaintext highlighter-rouge">image_processing</code> gem and making sure to remove the explicit usage of <code class="language-plaintext highlighter-rouge">combine_options</code> since it‚Äôs no longer needed.</p>

<p>For readability, you may wish to change raw <code class="language-plaintext highlighter-rouge">resize</code> calls to <code class="language-plaintext highlighter-rouge">image_processing</code> macros. For example, instead of:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100"</span><span class="p">)</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100&gt;"</span><span class="p">)</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize: </span><span class="s2">"100x100^"</span><span class="p">)</span>
</code></pre></div></div>

<p>you can respectively do:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_fit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_limit: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">video</span><span class="p">.</span><span class="nf">preview</span><span class="p">(</span><span class="ss">resize_to_fill: </span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
</code></pre></div></div>

<h3 id="new-activemodelerror-class">New <code class="language-plaintext highlighter-rouge">ActiveModel::Error</code> class</h3>

<p>Errors are now instances of a new <code class="language-plaintext highlighter-rouge">ActiveModel::Error</code> class, with changes to
the API. Some of these changes may throw errors depending on how you manipulate
errors, while others will print deprecation warnings to be fixed for Rails 7.0.</p>

<p>More information about this change and details about the API changes can be
found <a href="https://github.com/rails/rails/pull/32313">in this PR</a>.</p>

<h2 id="upgrading-from-rails-52-to-rails-60">Upgrading from Rails 5.2 to Rails 6.0</h2>

<p>For more information on changes made to Rails 6.0 please see the <a href="6_0_release_notes.html">release notes</a>.</p>

<h3 id="using-webpacker">Using Webpacker</h3>

<p><a href="https://github.com/rails/webpacker">Webpacker</a>
is the default JavaScript compiler for Rails 6. But if you are upgrading the app, it is not activated by default.
If you want to use Webpacker, then include it in your Gemfile and install it:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s2">"webpacker"</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails webpacker:install
</code></pre></div></div>

<h3 id="force-ssl">Force SSL</h3>

<p>The <code class="language-plaintext highlighter-rouge">force_ssl</code> method on controllers has been deprecated and will be removed in
Rails 6.1. You are encouraged to enable <a href="configuring.html#config-force-ssl"><code class="language-plaintext highlighter-rouge">config.force_ssl</code></a> to enforce HTTPS
connections throughout your application. If you need to exempt certain endpoints
from redirection, you can use <a href="configuring.html#config-ssl-options"><code class="language-plaintext highlighter-rouge">config.ssl_options</code></a> to configure that behavior.</p>

<h3 id="purpose-and-expiry-metadata-is-now-embedded-inside-signed-and-encrypted-cookies-for-increased-security">Purpose and expiry metadata is now embedded inside signed and encrypted cookies for increased security</h3>

<p>To improve security, Rails embeds the purpose and expiry metadata inside encrypted or signed cookies value.</p>

<p>Rails can then thwart attacks that attempt to copy the signed/encrypted value
of a cookie and use it as the value of another cookie.</p>

<p>This new embed metadata make those cookies incompatible with versions of Rails older than 6.0.</p>

<p>If you require your cookies to be read by Rails 5.2 and older, or you are still validating your 6.0 deploy and want
to be able to rollback set
<code class="language-plaintext highlighter-rouge">Rails.application.config.action_dispatch.use_cookies_with_metadata</code> to <code class="language-plaintext highlighter-rouge">false</code>.</p>

<h3 id="all-npm-packages-have-been-moved-to-the-rails-scope">All npm packages have been moved to the <code class="language-plaintext highlighter-rouge">@rails</code> scope</h3>

<p>If you were previously loading any of the <code class="language-plaintext highlighter-rouge">actioncable</code>, <code class="language-plaintext highlighter-rouge">activestorage</code>,
or <code class="language-plaintext highlighter-rouge">rails-ujs</code> packages through npm/yarn, you must update the names of these
dependencies before you can upgrade them to <code class="language-plaintext highlighter-rouge">6.0.0</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>actioncable   ‚Üí @rails/actioncable
activestorage ‚Üí @rails/activestorage
rails-ujs     ‚Üí @rails/ujs
</code></pre></div></div>

<h3 id="action-cable-javascript-api-changes">Action Cable JavaScript API Changes</h3>

<p>The Action Cable JavaScript package has been converted from CoffeeScript
to ES2015, and we now publish the source code in the npm distribution.</p>

<p>This release includes some breaking changes to optional parts of the
Action Cable JavaScript API:</p>

<ul>
  <li>
    <p>Configuration of the WebSocket adapter and logger adapter have been moved
from properties of <code class="language-plaintext highlighter-rouge">ActionCable</code> to properties of <code class="language-plaintext highlighter-rouge">ActionCable.adapters</code>.
If you are configuring these adapters you will need to make
these changes:</p>

    <div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  -    ActionCable.WebSocket = MyWebSocket
  +    ActionCable.adapters.WebSocket = MyWebSocket
</code></pre></div>    </div>

    <div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  -    ActionCable.logger = myLogger
  +    ActionCable.adapters.logger = myLogger
</code></pre></div>    </div>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">ActionCable.startDebugging()</code> and <code class="language-plaintext highlighter-rouge">ActionCable.stopDebugging()</code>
methods have been removed and replaced with the property
<code class="language-plaintext highlighter-rouge">ActionCable.logger.enabled</code>. If you are using these methods you
will need to make these changes:</p>

    <div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  -    ActionCable.startDebugging()
  +    ActionCable.logger.enabled = true
</code></pre></div>    </div>

    <div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  -    ActionCable.stopDebugging()
  +    ActionCable.logger.enabled = false
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="actiondispatchresponsecontent_type-now-returns-the-content-type-header-without-modification"><code class="language-plaintext highlighter-rouge">ActionDispatch::Response#content_type</code> now returns the Content-Type header without modification</h3>

<p>Previously, the return value of <code class="language-plaintext highlighter-rouge">ActionDispatch::Response#content_type</code> did NOT contain the charset part.
This behavior has changed to include the previously omitted charset part as well.</p>

<p>If you want just the MIME type, please use <code class="language-plaintext highlighter-rouge">ActionDispatch::Response#media_type</code> instead.</p>

<p>Before:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present"</span>
</code></pre></div></div>

<p>After:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resp</span> <span class="o">=</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Response</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">"Content-Type"</span> <span class="o">=&gt;</span> <span class="s2">"text/csv; header=present; charset=utf-16"</span><span class="p">)</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">content_type</span> <span class="c1">#=&gt; "text/csv; header=present; charset=utf-16"</span>
<span class="n">resp</span><span class="p">.</span><span class="nf">media_type</span>   <span class="c1">#=&gt; "text/csv"</span>
</code></pre></div></div>

<h3 id="new-confighosts-setting">New <code class="language-plaintext highlighter-rouge">config.hosts</code> setting</h3>

<p>Rails now has a new <code class="language-plaintext highlighter-rouge">config.hosts</code> setting for security purposes. This setting
defaults to <code class="language-plaintext highlighter-rouge">localhost</code> in development. If you use other domains in development
you need to allow them like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/development.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">hosts</span> <span class="o">&lt;&lt;</span> <span class="s2">"dev.myapp.com"</span>
<span class="n">config</span><span class="p">.</span><span class="nf">hosts</span> <span class="o">&lt;&lt;</span> <span class="sr">/[a-z0-9-]+\.myapp\.com/</span> <span class="c1"># Optionally, regexp is allowed as well</span>
</code></pre></div></div>

<p>For other environments <code class="language-plaintext highlighter-rouge">config.hosts</code> is empty by default, which means Rails
won‚Äôt validate the host at all. You can optionally add them if you want to
validate it in production.</p>

<h3 id="autoloading">Autoloading</h3>

<p>The default configuration for Rails 6</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
</code></pre></div></div>

<p>enables <code class="language-plaintext highlighter-rouge">zeitwerk</code> autoloading mode on CRuby. In that mode, autoloading, reloading, and eager loading are managed by <a href="https://github.com/fxn/zeitwerk">Zeitwerk</a>.</p>

<p>If you are using defaults from a previous Rails version, you can enable zeitwerk like so:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">autoloader</span> <span class="o">=</span> <span class="ss">:zeitwerk</span>
</code></pre></div></div>

<h4 id="public-api">Public API</h4>

<p>In general, applications do not need to use the API of Zeitwerk directly. Rails sets things up according to the existing contract: <code class="language-plaintext highlighter-rouge">config.autoload_paths</code>, <code class="language-plaintext highlighter-rouge">config.cache_classes</code>, etc.</p>

<p>While applications should stick to that interface, the actual Zeitwerk loader object can be accessed as</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">autoloaders</span><span class="p">.</span><span class="nf">main</span>
</code></pre></div></div>

<p>That may be handy if you need to preload Single Table Inheritance (STI) classes or configure a custom inflector, for example.</p>

<h4 id="project-structure">Project Structure</h4>

<p>If the application being upgraded autoloads correctly, the project structure should be already mostly compatible.</p>

<p>However, <code class="language-plaintext highlighter-rouge">classic</code> mode infers file names from missing constant names (<code class="language-plaintext highlighter-rouge">underscore</code>), whereas <code class="language-plaintext highlighter-rouge">zeitwerk</code> mode infers constant names from file names (<code class="language-plaintext highlighter-rouge">camelize</code>). These helpers are not always inverse of each other, in particular if acronyms are involved. For instance, <code class="language-plaintext highlighter-rouge">"FOO".underscore</code> is <code class="language-plaintext highlighter-rouge">"foo"</code>, but <code class="language-plaintext highlighter-rouge">"foo".camelize</code> is <code class="language-plaintext highlighter-rouge">"Foo"</code>, not <code class="language-plaintext highlighter-rouge">"FOO"</code>.</p>

<p>Compatibility can be checked with the <code class="language-plaintext highlighter-rouge">zeitwerk:check</code> task:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails zeitwerk:check
Hold on, I am eager loading the application.
All is good!
</code></pre></div></div>

<h4 id="require_dependency">require_dependency</h4>

<p>All known use cases of <code class="language-plaintext highlighter-rouge">require_dependency</code> have been eliminated, you should grep the project and delete them.</p>

<p>If your application uses Single Table Inheritance, please see the <a href="autoloading_and_reloading_constants.html#single-table-inheritance">Single Table Inheritance section</a> of the Autoloading and Reloading Constants (Zeitwerk Mode) guide.</p>

<h4 id="qualified-names-in-class-and-module-definitions">Qualified names in class and module definitions</h4>

<p>You can now robustly use constant paths in class and module definitions:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Autoloading in this class' body matches Ruby semantics now.</span>
<span class="k">class</span> <span class="nc">Admin::UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>A gotcha to be aware of is that, depending on the order of execution, the classic autoloader could sometimes be able to autoload <code class="language-plaintext highlighter-rouge">Foo::Wadus</code> in</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo::Bar</span>
  <span class="nc">Wadus</span>
<span class="k">end</span>
</code></pre></div></div>

<p>That does not match Ruby semantics because <code class="language-plaintext highlighter-rouge">Foo</code> is not in the nesting, and won‚Äôt work at all in <code class="language-plaintext highlighter-rouge">zeitwerk</code> mode. If you find such corner case you can use the qualified name <code class="language-plaintext highlighter-rouge">Foo::Wadus</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Foo::Bar</span>
  <span class="nc">Foo::Wadus</span>
<span class="k">end</span>
</code></pre></div></div>

<p>or add <code class="language-plaintext highlighter-rouge">Foo</code> to the nesting:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">Foo</span>
  <span class="k">class</span> <span class="nc">Bar</span>
    <span class="no">Wadus</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="concerns">Concerns</h4>

<p>You can autoload and eager load from a standard structure like</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app/models
app/models/concerns
</code></pre></div></div>

<p>In that case, <code class="language-plaintext highlighter-rouge">app/models/concerns</code> is assumed to be a root directory (because it belongs to the autoload paths), and it is ignored as namespace. So, <code class="language-plaintext highlighter-rouge">app/models/concerns/foo.rb</code> should define <code class="language-plaintext highlighter-rouge">Foo</code>, not <code class="language-plaintext highlighter-rouge">Concerns::Foo</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">Concerns::</code> namespace worked with the classic autoloader as a side-effect of the implementation, but it was not really an intended behavior. An application using <code class="language-plaintext highlighter-rouge">Concerns::</code> needs to rename those classes and modules to be able to run in <code class="language-plaintext highlighter-rouge">zeitwerk</code> mode.</p>

<h4 id="having-app-in-the-autoload-paths">Having <code class="language-plaintext highlighter-rouge">app</code> in the autoload paths</h4>

<p>Some projects want something like <code class="language-plaintext highlighter-rouge">app/api/base.rb</code> to define <code class="language-plaintext highlighter-rouge">API::Base</code>, and add <code class="language-plaintext highlighter-rouge">app</code> to the autoload paths to accomplish that in <code class="language-plaintext highlighter-rouge">classic</code> mode. Since Rails adds all subdirectories of <code class="language-plaintext highlighter-rouge">app</code> to the autoload paths automatically, we have another situation in which there are nested root directories, so that setup no longer works. Similar principle we explained above with <code class="language-plaintext highlighter-rouge">concerns</code>.</p>

<p>If you want to keep that structure, you‚Äôll need to delete the subdirectory from the autoload paths in an initializer:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Dependencies</span><span class="p">.</span><span class="nf">autoload_paths</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/app/api"</span><span class="p">)</span>
</code></pre></div></div>

<h4 id="autoloaded-constants-and-explicit-namespaces">Autoloaded Constants and Explicit Namespaces</h4>

<p>If a namespace is defined in a file, as <code class="language-plaintext highlighter-rouge">Hotel</code> is here:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app/models/hotel.rb         # Defines Hotel.
app/models/hotel/pricing.rb # Defines Hotel::Pricing.
</code></pre></div></div>

<p>the <code class="language-plaintext highlighter-rouge">Hotel</code> constant has to be set using the <code class="language-plaintext highlighter-rouge">class</code> or <code class="language-plaintext highlighter-rouge">module</code> keywords. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Hotel</span>
<span class="k">end</span>
</code></pre></div></div>

<p>is good.</p>

<p>Alternatives like</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Hotel</span> <span class="o">=</span> <span class="no">Class</span><span class="p">.</span><span class="nf">new</span>
</code></pre></div></div>

<p>or</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Hotel</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span>
</code></pre></div></div>

<p>won‚Äôt work, child objects like <code class="language-plaintext highlighter-rouge">Hotel::Pricing</code> won‚Äôt be found.</p>

<p>This restriction only applies to explicit namespaces. Classes and modules not defining a namespace can be defined using those idioms.</p>

<h4 id="one-file-one-constant-at-the-same-top-level">One file, one constant (at the same top-level)</h4>

<p>In <code class="language-plaintext highlighter-rouge">classic</code> mode you could technically define several constants at the same top-level and have them all reloaded. For example, given</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/foo.rb</span>

<span class="k">class</span> <span class="nc">Foo</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Bar</span>
<span class="k">end</span>
</code></pre></div></div>

<p>while <code class="language-plaintext highlighter-rouge">Bar</code> could not be autoloaded, autoloading <code class="language-plaintext highlighter-rouge">Foo</code> would mark <code class="language-plaintext highlighter-rouge">Bar</code> as autoloaded too. This is not the case in <code class="language-plaintext highlighter-rouge">zeitwerk</code> mode, you need to move <code class="language-plaintext highlighter-rouge">Bar</code> to its own file <code class="language-plaintext highlighter-rouge">bar.rb</code>. One file, one constant.</p>

<p>This only applies to constants at the same top-level as in the example above. Inner classes and modules are fine. For example, consider</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/foo.rb</span>

<span class="k">class</span> <span class="nc">Foo</span>
  <span class="k">class</span> <span class="nc">InnerClass</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If the application reloads <code class="language-plaintext highlighter-rouge">Foo</code>, it will reload <code class="language-plaintext highlighter-rouge">Foo::InnerClass</code> too.</p>

<h4 id="spring-and-the-test-environment">Spring and the <code class="language-plaintext highlighter-rouge">test</code> Environment</h4>

<p>Spring reloads the application code if something changes. In the <code class="language-plaintext highlighter-rouge">test</code> environment you need to enable reloading for that to work:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/test.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">cache_classes</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre></div></div>

<p>Otherwise you‚Äôll get this error:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>reloading is disabled because config.cache_classes is true
</code></pre></div></div>

<h4 id="bootsnap">Bootsnap</h4>

<p>Bootsnap should be at least version 1.4.2.</p>

<p>In addition to that, Bootsnap needs to disable the iseq cache due to a bug in the interpreter if running Ruby 2.5. Please make sure to depend on at least Bootsnap 1.4.4 in that case.</p>

<h4 id="configadd_autoload_paths_to_load_path"><code class="language-plaintext highlighter-rouge">config.add_autoload_paths_to_load_path</code></h4>

<p>The new configuration point <a href="configuring.html#config-add-autoload-paths-to-load-path"><code class="language-plaintext highlighter-rouge">config.add_autoload_paths_to_load_path</code></a> is <code class="language-plaintext highlighter-rouge">true</code> by default for backwards compatibility, but allows you to opt-out from adding the autoload paths to <code class="language-plaintext highlighter-rouge">$LOAD_PATH</code>.</p>

<p>This makes sense in most applications, since you never should require a file in <code class="language-plaintext highlighter-rouge">app/models</code>, for example, and Zeitwerk only uses absolute file names internally.</p>

<p>By opting-out you optimize <code class="language-plaintext highlighter-rouge">$LOAD_PATH</code> lookups (less directories to check), and save Bootsnap work and memory consumption, since it does not need to build an index for these directories.</p>

<h4 id="thread-safety">Thread-safety</h4>

<p>In classic mode, constant autoloading is not thread-safe, though Rails has locks in place for example to make web requests thread-safe when autoloading is enabled, as it is common in the development environment.</p>

<p>Constant autoloading is thread-safe in <code class="language-plaintext highlighter-rouge">zeitwerk</code> mode. For example, you can now autoload in multi-threaded scripts executed by the <code class="language-plaintext highlighter-rouge">runner</code> command.</p>

<h4 id="globs-in-configautoload_paths">Globs in config.autoload_paths</h4>

<p>Beware of configurations like</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">+=</span> <span class="no">Dir</span><span class="p">[</span><span class="s2">"</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib/**/"</span><span class="p">]</span>
</code></pre></div></div>

<p>Every element of <code class="language-plaintext highlighter-rouge">config.autoload_paths</code> should represent the top-level namespace (<code class="language-plaintext highlighter-rouge">Object</code>) and they cannot be nested in consequence (with the exception of <code class="language-plaintext highlighter-rouge">concerns</code> directories explained above).</p>

<p>To fix this, just remove the wildcards:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">autoload_paths</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="si">#{</span><span class="n">config</span><span class="p">.</span><span class="nf">root</span><span class="si">}</span><span class="s2">/lib"</span>
</code></pre></div></div>

<h4 id="eager-loading-and-autoloading-are-consistent">Eager loading and autoloading are consistent</h4>

<p>In <code class="language-plaintext highlighter-rouge">classic</code> mode, if <code class="language-plaintext highlighter-rouge">app/models/foo.rb</code> defines <code class="language-plaintext highlighter-rouge">Bar</code>, you won‚Äôt be able to autoload that file, but eager loading will work because it loads files recursively blindly. This can be a source of errors if you test things first eager loading, execution may fail later autoloading.</p>

<p>In <code class="language-plaintext highlighter-rouge">zeitwerk</code> mode both loading modes are consistent, they fail and err in the same files.</p>

<h4 id="how-to-use-the-classic-autoloader-in-rails-6">How to Use the Classic Autoloader in Rails 6</h4>

<p>Applications can load Rails 6 defaults and still use the classic autoloader by setting <code class="language-plaintext highlighter-rouge">config.autoloader</code> this way:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/application.rb</span>

<span class="n">config</span><span class="p">.</span><span class="nf">load_defaults</span> <span class="mf">6.0</span>
<span class="n">config</span><span class="p">.</span><span class="nf">autoloader</span> <span class="o">=</span> <span class="ss">:classic</span>
</code></pre></div></div>

<p>When using the Classic Autoloader in Rails 6 application it is recommended to set concurrency level to 1 in development environment, for the web servers and background processors, due to the thread-safety concerns.</p>

<h3 id="active-storage-assignment-behavior-change">Active Storage assignment behavior change</h3>

<p>With the configuration defaults for Rails 5.2, assigning to a collection of attachments declared with <code class="language-plaintext highlighter-rouge">has_many_attached</code> appends new files:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_many_attached</span> <span class="ss">:highlights</span>
<span class="k">end</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"funky.jpg"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>

<span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">highlights: </span><span class="p">[</span> <span class="n">blob</span> <span class="p">])</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 2</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "funky.jpg"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre></div></div>

<p>With the configuration defaults for Rails 6.0, assigning to a collection of attachments replaces existing files instead of appending to them. This matches Active Record behavior when assigning to a collection association:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"funky.jpg"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>

<span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span><span class="ss">highlights: </span><span class="p">[</span> <span class="n">blob</span> <span class="p">])</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 1</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">#attach</code> can be used to add new attachments without removing the existing ones:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">blob</span> <span class="o">=</span> <span class="no">ActiveStorage</span><span class="o">::</span><span class="no">Blob</span><span class="p">.</span><span class="nf">create_after_upload!</span><span class="p">(</span><span class="ss">filename: </span><span class="s2">"town.jpg"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">attach</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span>

<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">count</span> <span class="c1"># =&gt; 2</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "funky.jpg"</span>
<span class="n">user</span><span class="p">.</span><span class="nf">highlights</span><span class="p">.</span><span class="nf">second</span><span class="p">.</span><span class="nf">filename</span> <span class="c1"># =&gt; "town.jpg"</span>
</code></pre></div></div>

<p>Existing applications can opt in to this new behavior by setting <a href="configuring.html#config-active-storage-replace-on-assign-to-many"><code class="language-plaintext highlighter-rouge">config.active_storage.replace_on_assign_to_many</code></a> to <code class="language-plaintext highlighter-rouge">true</code>. The old behavior will be deprecated in Rails 7.0 and removed in Rails 7.1.</p>

<h3 id="custom-exception-handling-applications">Custom exception handling applications</h3>

<p>Invalid <code class="language-plaintext highlighter-rouge">Accept</code> or <code class="language-plaintext highlighter-rouge">Content-Type</code> request headers will now raise an exception.
The default <a href="configuring.html#config-exceptions-app"><code class="language-plaintext highlighter-rouge">config.exceptions_app</code></a> specifically handles that error and compensates for it.
Custom exceptions applications will need to handle that error as well, or such requests will cause Rails to use the fallback exceptions application, which returns a <code class="language-plaintext highlighter-rouge">500 Internal Server Error</code>.</p>

<h2 id="upgrading-from-rails-51-to-rails-52">Upgrading from Rails 5.1 to Rails 5.2</h2>

<p>For more information on changes made to Rails 5.2 please see the <a href="5_2_release_notes.html">release notes</a>.</p>

<h3 id="bootsnap-1">Bootsnap</h3>

<p>Rails 5.2 adds bootsnap gem in the <a href="https://github.com/rails/rails/pull/29313">newly generated app‚Äôs Gemfile</a>.
The <code class="language-plaintext highlighter-rouge">app:update</code> command sets it up in <code class="language-plaintext highlighter-rouge">boot.rb</code>. If you want to use it, then add it in the Gemfile:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Reduces boot times through caching; required in config/boot.rb</span>
<span class="n">gem</span> <span class="s2">"bootsnap"</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
</code></pre></div></div>

<p>Otherwise change the <code class="language-plaintext highlighter-rouge">boot.rb</code> to not use bootsnap.</p>

<h3 id="expiry-in-signed-or-encrypted-cookie-is-now-embedded-in-the-cookies-values">Expiry in signed or encrypted cookie is now embedded in the cookies values</h3>

<p>To improve security, Rails now embeds the expiry information also in encrypted or signed cookies value.</p>

<p>This new embedded information makes those cookies incompatible with versions of Rails older than 5.2.</p>

<p>If you require your cookies to be read by 5.1 and older, or you are still validating your 5.2 deploy and want
to allow you to rollback set
<code class="language-plaintext highlighter-rouge">Rails.application.config.action_dispatch.use_authenticated_cookie_encryption</code> to <code class="language-plaintext highlighter-rouge">false</code>.</p>

<h2 id="upgrading-from-rails-50-to-rails-51">Upgrading from Rails 5.0 to Rails 5.1</h2>

<p>For more information on changes made to Rails 5.1 please see the <a href="5_1_release_notes.html">release notes</a>.</p>

<h3 id="top-level-hashwithindifferentaccess-is-soft-deprecated">Top-level <code class="language-plaintext highlighter-rouge">HashWithIndifferentAccess</code> is soft-deprecated</h3>

<p>If your application uses the top-level <code class="language-plaintext highlighter-rouge">HashWithIndifferentAccess</code> class, you
should slowly move your code to instead use <code class="language-plaintext highlighter-rouge">ActiveSupport::HashWithIndifferentAccess</code>.</p>

<p>It is only soft-deprecated, which means that your code will not break at the
moment and no deprecation warning will be displayed, but this constant will be
removed in the future.</p>

<p>Also, if you have pretty old YAML documents containing dumps of such objects,
you may need to load and dump them again to make sure that they reference
the right constant, and that loading them won‚Äôt break in the future.</p>

<h3 id="applicationsecrets-now-loaded-with-all-keys-as-symbols"><code class="language-plaintext highlighter-rouge">application.secrets</code> now loaded with all keys as symbols</h3>

<p>If your application stores nested configuration in <code class="language-plaintext highlighter-rouge">config/secrets.yml</code>, all keys
are now loaded as symbols, so access using strings should be changed.</p>

<p>From:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:smtp_settings</span><span class="p">][</span><span class="s2">"address"</span><span class="p">]</span>
</code></pre></div></div>

<p>To:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">secrets</span><span class="p">[</span><span class="ss">:smtp_settings</span><span class="p">][</span><span class="ss">:address</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="removed-deprecated-support-to-text-and-nothing-in-render">Removed deprecated support to <code class="language-plaintext highlighter-rouge">:text</code> and <code class="language-plaintext highlighter-rouge">:nothing</code> in <code class="language-plaintext highlighter-rouge">render</code></h3>

<p>If your controllers are using <code class="language-plaintext highlighter-rouge">render :text</code>, they will no longer work. The new method
of rendering text with MIME type of <code class="language-plaintext highlighter-rouge">text/plain</code> is to use <code class="language-plaintext highlighter-rouge">render :plain</code>.</p>

<p>Similarly, <code class="language-plaintext highlighter-rouge">render :nothing</code> is also removed and you should use the <code class="language-plaintext highlighter-rouge">head</code> method
to send responses that contain only headers. For example, <code class="language-plaintext highlighter-rouge">head :ok</code> sends a
200 response with no body to render.</p>

<h3 id="removed-deprecated-support-of-redirect_to-back">Removed deprecated support of <code class="language-plaintext highlighter-rouge">redirect_to :back</code></h3>

<p>In Rails 5.0, <code class="language-plaintext highlighter-rouge">redirect_to :back</code> was deprecated. In Rails 5.1, it was removed completely.</p>

<p>As an alternative, use <code class="language-plaintext highlighter-rouge">redirect_back</code>. It‚Äôs important to note that <code class="language-plaintext highlighter-rouge">redirect_back</code> also takes
a <code class="language-plaintext highlighter-rouge">fallback_location</code> option which will be used in case the <code class="language-plaintext highlighter-rouge">HTTP_REFERER</code> is missing.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">redirect_back</span><span class="p">(</span><span class="ss">fallback_location: </span><span class="n">root_path</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="upgrading-from-rails-42-to-rails-50">Upgrading from Rails 4.2 to Rails 5.0</h2>

<p>For more information on changes made to Rails 5.0 please see the <a href="5_0_release_notes.html">release notes</a>.</p>

<h3 id="ruby-222-required">Ruby 2.2.2+ required</h3>

<p>From Ruby on Rails 5.0 onwards, Ruby 2.2.2+ is the only supported Ruby version.
Make sure you are on Ruby 2.2.2 version or greater, before you proceed.</p>

<h3 id="active-record-models-now-inherit-from-applicationrecord-by-default">Active Record Models Now Inherit from ApplicationRecord by Default</h3>

<p>In Rails 4.2, an Active Record model inherits from <code class="language-plaintext highlighter-rouge">ActiveRecord::Base</code>. In Rails 5.0,
all models inherit from <code class="language-plaintext highlighter-rouge">ApplicationRecord</code>.</p>

<p><code class="language-plaintext highlighter-rouge">ApplicationRecord</code> is a new superclass for all app models, analogous to app
controllers subclassing <code class="language-plaintext highlighter-rouge">ApplicationController</code> instead of
<code class="language-plaintext highlighter-rouge">ActionController::Base</code>. This gives apps a single spot to configure app-wide
model behavior.</p>

<p>When upgrading from Rails 4.2 to Rails 5.0, you need to create an
<code class="language-plaintext highlighter-rouge">application_record.rb</code> file in <code class="language-plaintext highlighter-rouge">app/models/</code> and add the following content:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationRecord</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">abstract_class</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Then make sure that all your models inherit from it.</p>

<h3 id="halting-callback-chains-via-throwabort">Halting Callback Chains via <code class="language-plaintext highlighter-rouge">throw(:abort)</code></h3>

<p>In Rails 4.2, when a ‚Äòbefore‚Äô callback returns <code class="language-plaintext highlighter-rouge">false</code> in Active Record
and Active Model, then the entire callback chain is halted. In other words,
successive ‚Äòbefore‚Äô callbacks are not executed, and neither is the action wrapped
in callbacks.</p>

<p>In Rails 5.0, returning <code class="language-plaintext highlighter-rouge">false</code> in an Active Record or Active Model callback
will not have this side effect of halting the callback chain. Instead, callback
chains must be explicitly halted by calling <code class="language-plaintext highlighter-rouge">throw(:abort)</code>.</p>

<p>When you upgrade from Rails 4.2 to Rails 5.0, returning <code class="language-plaintext highlighter-rouge">false</code> in those kind of
callbacks will still halt the callback chain, but you will receive a deprecation
warning about this upcoming change.</p>

<p>When you are ready, you can opt into the new behavior and remove the deprecation
warning by adding the following configuration to your <code class="language-plaintext highlighter-rouge">config/application.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">halt_callback_chains_on_return_false</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre></div></div>

<p>Note that this option will not affect Active Support callbacks since they never
halted the chain when any value was returned.</p>

<p>See <a href="https://github.com/rails/rails/pull/17227">#17227</a> for more details.</p>

<h3 id="activejob-now-inherits-from-applicationjob-by-default">ActiveJob Now Inherits from ApplicationJob by Default</h3>

<p>In Rails 4.2, an Active Job inherits from <code class="language-plaintext highlighter-rouge">ActiveJob::Base</code>. In Rails 5.0, this
behavior has changed to now inherit from <code class="language-plaintext highlighter-rouge">ApplicationJob</code>.</p>

<p>When upgrading from Rails 4.2 to Rails 5.0, you need to create an
<code class="language-plaintext highlighter-rouge">application_job.rb</code> file in <code class="language-plaintext highlighter-rouge">app/jobs/</code> and add the following content:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Then make sure that all your job classes inherit from it.</p>

<p>See <a href="https://github.com/rails/rails/pull/19034">#19034</a> for more details.</p>

<h3 id="rails-controller-testing">Rails Controller Testing</h3>

<h4 id="extraction-of-some-helper-methods-to-rails-controller-testing">Extraction of some helper methods to <code class="language-plaintext highlighter-rouge">rails-controller-testing</code></h4>

<p><code class="language-plaintext highlighter-rouge">assigns</code> and <code class="language-plaintext highlighter-rouge">assert_template</code> have been extracted to the <code class="language-plaintext highlighter-rouge">rails-controller-testing</code> gem. To
continue using these methods in your controller tests, add <code class="language-plaintext highlighter-rouge">gem "rails-controller-testing"</code> to
your <code class="language-plaintext highlighter-rouge">Gemfile</code>.</p>

<p>If you are using RSpec for testing, please see the extra configuration required in the gem‚Äôs
documentation.</p>

<h4 id="new-behavior-when-uploading-files">New behavior when uploading files</h4>

<p>If you are using <code class="language-plaintext highlighter-rouge">ActionDispatch::Http::UploadedFile</code> in your tests to
upload files, you will need to change to use the similar <code class="language-plaintext highlighter-rouge">Rack::Test::UploadedFile</code>
class instead.</p>

<p>See <a href="https://github.com/rails/rails/issues/26404">#26404</a> for more details.</p>

<h3 id="autoloading-is-disabled-after-booting-in-the-production-environment">Autoloading is Disabled After Booting in the Production Environment</h3>

<p>Autoloading is now disabled after booting in the production environment by
default.</p>

<p>Eager loading the application is part of the boot process, so top-level
constants are fine and are still autoloaded, no need to require their files.</p>

<p>Constants in deeper places only executed at runtime, like regular method bodies,
are also fine because the file defining them will have been eager loaded while booting.</p>

<p>For the vast majority of applications this change needs no action. But in the
very rare event that your application needs autoloading while running in
production, set <code class="language-plaintext highlighter-rouge">Rails.application.config.enable_dependency_loading</code> to true.</p>

<h3 id="xml-serialization">XML Serialization</h3>

<p><code class="language-plaintext highlighter-rouge">ActiveModel::Serializers::Xml</code> has been extracted from Rails to the <code class="language-plaintext highlighter-rouge">activemodel-serializers-xml</code>
gem. To continue using XML serialization in your application, add <code class="language-plaintext highlighter-rouge">gem "activemodel-serializers-xml"</code>
to your <code class="language-plaintext highlighter-rouge">Gemfile</code>.</p>

<h3 id="removed-support-for-legacy-mysql-database-adapter">Removed Support for Legacy <code class="language-plaintext highlighter-rouge">mysql</code> Database Adapter</h3>

<p>Rails 5 removes support for the legacy <code class="language-plaintext highlighter-rouge">mysql</code> database adapter. Most users should be able to
use <code class="language-plaintext highlighter-rouge">mysql2</code> instead. It will be converted to a separate gem when we find someone to maintain
it.</p>

<h3 id="removed-support-for-debugger">Removed Support for Debugger</h3>

<p><code class="language-plaintext highlighter-rouge">debugger</code> is not supported by Ruby 2.2 which is required by Rails 5. Use <code class="language-plaintext highlighter-rouge">byebug</code> instead.</p>

<h3 id="use-binrails-for-running-tasks-and-tests">Use <code class="language-plaintext highlighter-rouge">bin/rails</code> for running tasks and tests</h3>

<p>Rails 5 adds the ability to run tasks and tests through <code class="language-plaintext highlighter-rouge">bin/rails</code> instead of rake. Generally
these changes are in parallel with rake, but some were ported over altogether.</p>

<p>To use the new test runner simply type <code class="language-plaintext highlighter-rouge">bin/rails test</code>.</p>

<p><code class="language-plaintext highlighter-rouge">rake dev:cache</code> is now <code class="language-plaintext highlighter-rouge">bin/rails dev:cache</code>.</p>

<p>Run <code class="language-plaintext highlighter-rouge">bin/rails</code> inside your application‚Äôs root directory to see the list of commands available.</p>

<h3 id="actioncontrollerparameters-no-longer-inherits-from-hashwithindifferentaccess"><code class="language-plaintext highlighter-rouge">ActionController::Parameters</code> No Longer Inherits from <code class="language-plaintext highlighter-rouge">HashWithIndifferentAccess</code></h3>

<p>Calling <code class="language-plaintext highlighter-rouge">params</code> in your application will now return an object instead of a hash. If your
parameters are already permitted, then you will not need to make any changes. If you are using <code class="language-plaintext highlighter-rouge">map</code>
and other methods that depend on being able to read the hash regardless of <code class="language-plaintext highlighter-rouge">permitted?</code> you will
need to upgrade your application to first permit and then convert to a hash.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">params</span><span class="p">.</span><span class="nf">permit</span><span class="p">([</span><span class="ss">:proceed_to</span><span class="p">,</span> <span class="ss">:return_to</span><span class="p">]).</span><span class="nf">to_h</span>
</code></pre></div></div>

<h3 id="protect_from_forgery-now-defaults-to-prepend-false"><code class="language-plaintext highlighter-rouge">protect_from_forgery</code> Now Defaults to <code class="language-plaintext highlighter-rouge">prepend: false</code></h3>

<p><code class="language-plaintext highlighter-rouge">protect_from_forgery</code> defaults to <code class="language-plaintext highlighter-rouge">prepend: false</code> which means that it will be inserted into
the callback chain at the point in which you call it in your application. If you want
<code class="language-plaintext highlighter-rouge">protect_from_forgery</code> to always run first, then you should change your application to use
<code class="language-plaintext highlighter-rouge">protect_from_forgery prepend: true</code>.</p>

<h3 id="default-template-handler-is-now-raw">Default Template Handler is Now RAW</h3>

<p>Files without a template handler in their extension will be rendered using the raw handler.
Previously Rails would render files using the ERB template handler.</p>

<p>If you do not want your file to be handled via the raw handler, you should add an extension
to your file that can be parsed by the appropriate template handler.</p>

<h3 id="added-wildcard-matching-for-template-dependencies">Added Wildcard Matching for Template Dependencies</h3>

<p>You can now use wildcard matching for your template dependencies. For example, if you were
defining your templates as such:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/subscribers_changed </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/completed </span><span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/uncompleted </span><span class="cp">%&gt;</span>
</code></pre></div></div>

<p>You can now just call the dependency once with a wildcard.</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="c1"># Template Dependency: recordings/threads/events/* </span><span class="cp">%&gt;</span>
</code></pre></div></div>

<h3 id="actionviewhelpersrecordtaghelper-moved-to-external-gem-record_tag_helper"><code class="language-plaintext highlighter-rouge">ActionView::Helpers::RecordTagHelper</code> moved to external gem (record_tag_helper)</h3>

<p><code class="language-plaintext highlighter-rouge">content_tag_for</code> and <code class="language-plaintext highlighter-rouge">div_for</code> have been removed in favor of just using <code class="language-plaintext highlighter-rouge">content_tag</code>. To continue using the older methods, add the <code class="language-plaintext highlighter-rouge">record_tag_helper</code> gem to your <code class="language-plaintext highlighter-rouge">Gemfile</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s2">"record_tag_helper"</span><span class="p">,</span> <span class="s2">"~&gt; 1.0"</span>
</code></pre></div></div>

<p>See <a href="https://github.com/rails/rails/pull/18411">#18411</a> for more details.</p>

<h3 id="removed-support-for-protected_attributes-gem">Removed Support for <code class="language-plaintext highlighter-rouge">protected_attributes</code> Gem</h3>

<p>The <code class="language-plaintext highlighter-rouge">protected_attributes</code> gem is no longer supported in Rails 5.</p>

<h3 id="removed-support-for-activerecord-deprecated_finders-gem">Removed support for <code class="language-plaintext highlighter-rouge">activerecord-deprecated_finders</code> gem</h3>

<p>The <code class="language-plaintext highlighter-rouge">activerecord-deprecated_finders</code> gem is no longer supported in Rails 5.</p>

<h3 id="activesupporttestcase-default-test-order-is-now-random"><code class="language-plaintext highlighter-rouge">ActiveSupport::TestCase</code> Default Test Order is Now Random</h3>

<p>When tests are run in your application, the default order is now <code class="language-plaintext highlighter-rouge">:random</code>
instead of <code class="language-plaintext highlighter-rouge">:sorted</code>. Use the following config option to set it back to <code class="language-plaintext highlighter-rouge">:sorted</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/test.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_order</span> <span class="o">=</span> <span class="ss">:sorted</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="actioncontrollerlive-became-a-concern"><code class="language-plaintext highlighter-rouge">ActionController::Live</code> became a <code class="language-plaintext highlighter-rouge">Concern</code></h3>

<p>If you include <code class="language-plaintext highlighter-rouge">ActionController::Live</code> in another module that is included in your controller, then you
should also extend the module with <code class="language-plaintext highlighter-rouge">ActiveSupport::Concern</code>. Alternatively, you can use the <code class="language-plaintext highlighter-rouge">self.included</code> hook
to include <code class="language-plaintext highlighter-rouge">ActionController::Live</code> directly to the controller once the <code class="language-plaintext highlighter-rouge">StreamingSupport</code> is included.</p>

<p>This means that if your application used to have its own streaming module, the following code
would break in production:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># This is a work-around for streamed controllers performing authentication with Warden/Devise.</span>
<span class="c1"># See https://github.com/plataformatec/devise/issues/2332</span>
<span class="c1"># Authenticating in the router is another solution as suggested in that issue</span>
<span class="k">class</span> <span class="nc">StreamingSupport</span>
  <span class="kp">include</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Live</span> <span class="c1"># this won't work in production for Rails 5</span>
  <span class="c1"># extend ActiveSupport::Concern # unless you uncomment this line.</span>

  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="k">super</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
  <span class="k">rescue</span> <span class="no">ArgumentError</span> <span class="o">=&gt;</span> <span class="n">e</span>
    <span class="k">if</span> <span class="n">e</span><span class="p">.</span><span class="nf">message</span> <span class="o">==</span> <span class="s2">"uncaught throw :warden"</span>
      <span class="kp">throw</span> <span class="ss">:warden</span>
    <span class="k">else</span>
      <span class="k">raise</span> <span class="n">e</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="new-framework-defaults">New Framework Defaults</h3>

<h4 id="active-record-belongs_to-required-by-default-option">Active Record <code class="language-plaintext highlighter-rouge">belongs_to</code> Required by Default Option</h4>

<p><code class="language-plaintext highlighter-rouge">belongs_to</code> will now trigger a validation error by default if the association is not present.</p>

<p>This can be turned off per-association with <code class="language-plaintext highlighter-rouge">optional: true</code>.</p>

<p>This default will be automatically configured in new applications. If an existing application
wants to add this feature it will need to be turned on in an initializer:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<p>The configuration is by default global for all your models, but you can
override it on a per model basis. This should help you migrate all your models to have their
associations required by default.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Book</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># model is not yet ready to have its association required by default</span>

  <span class="nb">self</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="n">belongs_to</span><span class="p">(</span><span class="ss">:author</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Car</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="c1"># model is ready to have its association required by default</span>

  <span class="nb">self</span><span class="p">.</span><span class="nf">belongs_to_required_by_default</span> <span class="o">=</span> <span class="kp">true</span>
  <span class="n">belongs_to</span><span class="p">(</span><span class="ss">:pilot</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="per-form-csrf-tokens">Per-form CSRF Tokens</h4>

<p>Rails 5 now supports per-form CSRF tokens to mitigate against code-injection attacks with forms
created by JavaScript. With this option turned on, forms in your application will each have their
own CSRF token that is specific to the action and method for that form.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">per_form_csrf_tokens</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<h4 id="forgery-protection-with-origin-check">Forgery Protection with Origin Check</h4>

<p>You can now configure your application to check if the HTTP <code class="language-plaintext highlighter-rouge">Origin</code> header should be checked
against the site‚Äôs origin as an additional CSRF defense. Set the following in your config to
true:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">action_controller</span><span class="p">.</span><span class="nf">forgery_protection_origin_check</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<h4 id="allow-configuration-of-action-mailer-queue-name">Allow Configuration of Action Mailer Queue Name</h4>

<p>The default mailer queue name is <code class="language-plaintext highlighter-rouge">mailers</code>. This configuration option allows you to globally change
the queue name. Set the following in your config:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">deliver_later_queue_name</span> <span class="o">=</span> <span class="ss">:new_queue_name</span>
</code></pre></div></div>

<h4 id="support-fragment-caching-in-action-mailer-views">Support Fragment Caching in Action Mailer Views</h4>

<p>Set <a href="configuring.html#config-action-mailer-perform-caching"><code class="language-plaintext highlighter-rouge">config.action_mailer.perform_caching</code></a> in your config to determine whether your Action Mailer views
should support caching.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">action_mailer</span><span class="p">.</span><span class="nf">perform_caching</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<h4 id="configure-the-output-of-dbstructuredump">Configure the Output of <code class="language-plaintext highlighter-rouge">db:structure:dump</code></h4>

<p>If you‚Äôre using <code class="language-plaintext highlighter-rouge">schema_search_path</code> or other PostgreSQL extensions, you can control how the schema is
dumped. Set to <code class="language-plaintext highlighter-rouge">:all</code> to generate all dumps, or to <code class="language-plaintext highlighter-rouge">:schema_search_path</code> to generate from schema search path.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">dump_schemas</span> <span class="o">=</span> <span class="ss">:all</span>
</code></pre></div></div>

<h4 id="configure-ssl-options-to-enable-hsts-with-subdomains">Configure SSL Options to Enable HSTS with Subdomains</h4>

<p>Set the following in your config to enable HSTS when using subdomains:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">ssl_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">hsts: </span><span class="p">{</span> <span class="ss">subdomains: </span><span class="kp">true</span> <span class="p">}</span> <span class="p">}</span>
</code></pre></div></div>

<h4 id="preserve-timezone-of-the-receiver">Preserve Timezone of the Receiver</h4>

<p>When using Ruby 2.4, you can preserve the timezone of the receiver when calling <code class="language-plaintext highlighter-rouge">to_time</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">to_time_preserves_timezone</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre></div></div>

<h3 id="changes-with-jsonjsonb-serialization">Changes with JSON/JSONB serialization</h3>

<p>In Rails 5.0, how JSON/JSONB attributes are serialized and deserialized changed. Now, if
you set a column equal to a <code class="language-plaintext highlighter-rouge">String</code>, Active Record will no longer turn that string
into a <code class="language-plaintext highlighter-rouge">Hash</code>, and will instead only return the string. This is not limited to code
interacting with models, but also affects <code class="language-plaintext highlighter-rouge">:default</code> column settings in <code class="language-plaintext highlighter-rouge">db/schema.rb</code>.
It is recommended that you do not set columns equal to a <code class="language-plaintext highlighter-rouge">String</code>, but pass a <code class="language-plaintext highlighter-rouge">Hash</code>
instead, which will be converted to and from a JSON string automatically.</p>

<h2 id="upgrading-from-rails-41-to-rails-42">Upgrading from Rails 4.1 to Rails 4.2</h2>

<h3 id="web-console">Web Console</h3>

<p>First, add <code class="language-plaintext highlighter-rouge">gem "web-console", "~&gt; 2.0"</code> to the <code class="language-plaintext highlighter-rouge">:development</code> group in your <code class="language-plaintext highlighter-rouge">Gemfile</code> and run <code class="language-plaintext highlighter-rouge">bundle install</code> (it won‚Äôt have been included when you upgraded Rails). Once it‚Äôs been installed, you can simply drop a reference to the console helper (i.e., <code class="language-plaintext highlighter-rouge">&lt;%= console %&gt;</code>) into any view you want to enable it for. A console will also be provided on any error page you view in your development environment.</p>

<h3 id="responders">Responders</h3>

<p><code class="language-plaintext highlighter-rouge">respond_with</code> and the class-level <code class="language-plaintext highlighter-rouge">respond_to</code> methods have been extracted to the <code class="language-plaintext highlighter-rouge">responders</code> gem. To use them, simply add <code class="language-plaintext highlighter-rouge">gem "responders", "~&gt; 2.0"</code> to your <code class="language-plaintext highlighter-rouge">Gemfile</code>. Calls to <code class="language-plaintext highlighter-rouge">respond_with</code> and <code class="language-plaintext highlighter-rouge">respond_to</code> (again, at the class level) will no longer work without having included the <code class="language-plaintext highlighter-rouge">responders</code> gem in your dependencies:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/users_controller.rb</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:json</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Instance-level <code class="language-plaintext highlighter-rouge">respond_to</code> is unaffected and does not require the additional gem:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/users_controller.rb</span>

<span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">])</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">html</span>
      <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json: </span><span class="vi">@user</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>See <a href="https://github.com/rails/rails/pull/16526">#16526</a> for more details.</p>

<h3 id="error-handling-in-transaction-callbacks">Error handling in transaction callbacks</h3>

<p>Currently, Active Record suppresses errors raised
within <code class="language-plaintext highlighter-rouge">after_rollback</code> or <code class="language-plaintext highlighter-rouge">after_commit</code> callbacks and only prints them to
the logs. In the next version, these errors will no longer be suppressed.
Instead, the errors will propagate normally just like in other Active
Record callbacks.</p>

<p>When you define an <code class="language-plaintext highlighter-rouge">after_rollback</code> or <code class="language-plaintext highlighter-rouge">after_commit</code> callback, you
will receive a deprecation warning about this upcoming change. When
you are ready, you can opt into the new behavior and remove the
deprecation warning by adding following configuration to your
<code class="language-plaintext highlighter-rouge">config/application.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">raise_in_transactional_callbacks</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<p>See <a href="https://github.com/rails/rails/pull/14488">#14488</a> and
<a href="https://github.com/rails/rails/pull/16537">#16537</a> for more details.</p>

<h3 id="ordering-of-test-cases">Ordering of test cases</h3>

<p>In Rails 5.0, test cases will be executed in random order by default. In
anticipation of this change, Rails 4.2 introduced a new configuration option
<code class="language-plaintext highlighter-rouge">active_support.test_order</code> for explicitly specifying the test ordering. This
allows you to either lock down the current behavior by setting the option to
<code class="language-plaintext highlighter-rouge">:sorted</code>, or opt into the future behavior by setting the option to <code class="language-plaintext highlighter-rouge">:random</code>.</p>

<p>If you do not specify a value for this option, a deprecation warning will be
emitted. To avoid this, add the following line to your test environment:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/test.rb</span>
<span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_order</span> <span class="o">=</span> <span class="ss">:sorted</span> <span class="c1"># or `:random` if you prefer</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="serialized-attributes">Serialized attributes</h3>

<p>When using a custom coder (e.g. <code class="language-plaintext highlighter-rouge">serialize :metadata, JSON</code>),
assigning <code class="language-plaintext highlighter-rouge">nil</code> to a serialized attribute will save it to the database
as <code class="language-plaintext highlighter-rouge">NULL</code> instead of passing the <code class="language-plaintext highlighter-rouge">nil</code> value through the coder (e.g. <code class="language-plaintext highlighter-rouge">"null"</code>
when using the <code class="language-plaintext highlighter-rouge">JSON</code> coder).</p>

<h3 id="production-log-level">Production log level</h3>

<p>In Rails 5, the default log level for the production environment will be changed
to <code class="language-plaintext highlighter-rouge">:debug</code> (from <code class="language-plaintext highlighter-rouge">:info</code>). To preserve the current default, add the following
line to your <code class="language-plaintext highlighter-rouge">production.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Set to `:info` to match the current default, or set to `:debug` to opt-into</span>
<span class="c1"># the future default.</span>
<span class="n">config</span><span class="p">.</span><span class="nf">log_level</span> <span class="o">=</span> <span class="ss">:info</span>
</code></pre></div></div>

<h3 id="after_bundle-in-rails-templates"><code class="language-plaintext highlighter-rouge">after_bundle</code> in Rails templates</h3>

<p>If you have a Rails template that adds all the files in version control, it
fails to add the generated binstubs because it gets executed before Bundler:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># template.rb</span>
<span class="n">generate</span><span class="p">(</span><span class="ss">:scaffold</span><span class="p">,</span> <span class="s2">"person name:string"</span><span class="p">)</span>
<span class="n">route</span> <span class="s2">"root to: 'people#index'"</span>
<span class="n">rake</span><span class="p">(</span><span class="s2">"db:migrate"</span><span class="p">)</span>

<span class="n">git</span> <span class="ss">:init</span>
<span class="n">git</span> <span class="ss">add: </span><span class="s2">"."</span>
<span class="n">git</span> <span class="ss">commit: </span><span class="sx">%Q{ -m 'Initial commit' }</span>
</code></pre></div></div>

<p>You can now wrap the <code class="language-plaintext highlighter-rouge">git</code> calls in an <code class="language-plaintext highlighter-rouge">after_bundle</code> block. It will be run
after the binstubs have been generated.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># template.rb</span>
<span class="n">generate</span><span class="p">(</span><span class="ss">:scaffold</span><span class="p">,</span> <span class="s2">"person name:string"</span><span class="p">)</span>
<span class="n">route</span> <span class="s2">"root to: 'people#index'"</span>
<span class="n">rake</span><span class="p">(</span><span class="s2">"db:migrate"</span><span class="p">)</span>

<span class="n">after_bundle</span> <span class="k">do</span>
  <span class="n">git</span> <span class="ss">:init</span>
  <span class="n">git</span> <span class="ss">add: </span><span class="s2">"."</span>
  <span class="n">git</span> <span class="ss">commit: </span><span class="sx">%Q{ -m 'Initial commit' }</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="rails-html-sanitizer">Rails HTML Sanitizer</h3>

<p>There‚Äôs a new choice for sanitizing HTML fragments in your applications. The
venerable html-scanner approach is now officially being deprecated in favor of
<a href="https://github.com/rails/rails-html-sanitizer"><code class="language-plaintext highlighter-rouge">Rails HTML Sanitizer</code></a>.</p>

<p>This means the methods <code class="language-plaintext highlighter-rouge">sanitize</code>, <code class="language-plaintext highlighter-rouge">sanitize_css</code>, <code class="language-plaintext highlighter-rouge">strip_tags</code> and
<code class="language-plaintext highlighter-rouge">strip_links</code> are backed by a new implementation.</p>

<p>This new sanitizer uses <a href="https://github.com/flavorjones/loofah">Loofah</a> internally. Loofah in turn uses Nokogiri, which
wraps XML parsers written in both C and Java, so sanitization should be faster
no matter which Ruby version you run.</p>

<p>The new version updates <code class="language-plaintext highlighter-rouge">sanitize</code>, so it can take a <code class="language-plaintext highlighter-rouge">Loofah::Scrubber</code> for
powerful scrubbing.
<a href="https://github.com/flavorjones/loofah#loofahscrubber">See some examples of scrubbers here</a>.</p>

<p>Two new scrubbers have also been added: <code class="language-plaintext highlighter-rouge">PermitScrubber</code> and <code class="language-plaintext highlighter-rouge">TargetScrubber</code>.
Read the <a href="https://github.com/rails/rails-html-sanitizer">gem‚Äôs readme</a> for more information.</p>

<p>The documentation for <code class="language-plaintext highlighter-rouge">PermitScrubber</code> and <code class="language-plaintext highlighter-rouge">TargetScrubber</code> explains how you
can gain complete control over when and how elements should be stripped.</p>

<p>If your application needs to use the old sanitizer implementation, include <code class="language-plaintext highlighter-rouge">rails-deprecated_sanitizer</code> in your <code class="language-plaintext highlighter-rouge">Gemfile</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s2">"rails-deprecated_sanitizer"</span>
</code></pre></div></div>

<h3 id="rails-dom-testing">Rails DOM Testing</h3>

<p>The <a href="https://api.rubyonrails.org/v4.1/classes/ActionDispatch/Assertions/TagAssertions.html"><code class="language-plaintext highlighter-rouge">TagAssertions</code> module</a> (containing methods such as <code class="language-plaintext highlighter-rouge">assert_tag</code>), <a href="https://github.com/rails/rails/blob/6061472b8c310158a2a2e8e9a6b81a1aef6b60fe/actionpack/lib/action_dispatch/testing/assertions/dom.rb">has been deprecated</a> in favor of the <code class="language-plaintext highlighter-rouge">assert_select</code> methods from the <code class="language-plaintext highlighter-rouge">SelectorAssertions</code> module, which has been extracted into the <a href="https://github.com/rails/rails-dom-testing">rails-dom-testing gem</a>.</p>

<h3 id="masked-authenticity-tokens">Masked Authenticity Tokens</h3>

<p>In order to mitigate SSL attacks, <code class="language-plaintext highlighter-rouge">form_authenticity_token</code> is now masked so that it varies with each request.  Thus, tokens are validated by unmasking and then decrypting.  As a result, any strategies for verifying requests from non-rails forms that relied on a static session CSRF token have to take this into account.</p>

<h3 id="action-mailer">Action Mailer</h3>

<p>Previously, calling a mailer method on a mailer class will result in the
corresponding instance method being executed directly. With the introduction of
Active Job and <code class="language-plaintext highlighter-rouge">#deliver_later</code>, this is no longer true. In Rails 4.2, the
invocation of the instance methods are deferred until either <code class="language-plaintext highlighter-rouge">deliver_now</code> or
<code class="language-plaintext highlighter-rouge">deliver_later</code> is called. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Notifier</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Called"</span>
    <span class="n">mail</span><span class="p">(</span><span class="ss">to: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mail</span> <span class="o">=</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="c1"># Notifier#notify is not yet called at this point</span>
<span class="n">mail</span> <span class="o">=</span> <span class="n">mail</span><span class="p">.</span><span class="nf">deliver_now</span>           <span class="c1"># Prints "Called"</span>
</code></pre></div></div>

<p>This should not result in any noticeable differences for most applications.
However, if you need some non-mailer methods to be executed synchronously, and
you were previously relying on the synchronous proxying behavior, you should
define them as class methods on the mailer class directly:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Notifier</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">broadcast_notifications</span><span class="p">(</span><span class="n">users</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="n">users</span><span class="p">.</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="no">Notifier</span><span class="p">.</span><span class="nf">notify</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="foreign-key-support">Foreign Key Support</h3>

<p>The migration DSL has been expanded to support foreign key definitions. If
you‚Äôve been using the Foreigner gem, you might want to consider removing it.
Note that the foreign key support of Rails is a subset of Foreigner. This means
that not every Foreigner definition can be fully replaced by its Rails
migration DSL counterpart.</p>

<p>The migration procedure is as follows:</p>

<ol>
  <li>remove <code class="language-plaintext highlighter-rouge">gem "foreigner"</code> from the <code class="language-plaintext highlighter-rouge">Gemfile</code>.</li>
  <li>run <code class="language-plaintext highlighter-rouge">bundle install</code>.</li>
  <li>run <code class="language-plaintext highlighter-rouge">bin/rake db:schema:dump</code>.</li>
  <li>make sure that <code class="language-plaintext highlighter-rouge">db/schema.rb</code> contains every foreign key definition with
  the necessary options.</li>
</ol>

<h2 id="upgrading-from-rails-40-to-rails-41">Upgrading from Rails 4.0 to Rails 4.1</h2>

<h3 id="csrf-protection-from-remote-script-tags">CSRF protection from remote <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tags</h3>

<p>Or, ‚Äúwhaaat my tests are failing!!!?‚Äù or ‚Äúmy <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> widget is busted!!‚Äù</p>

<p>Cross-site request forgery (CSRF) protection now covers GET requests with
JavaScript responses, too. This prevents a third-party site from remotely
referencing your JavaScript with a <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tag to extract sensitive data.</p>

<p>This means that your functional and integration tests that use</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">format: :js</span>
</code></pre></div></div>

<p>will now trigger CSRF protection. Switch to</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xhr</span> <span class="ss">:get</span><span class="p">,</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">format: :js</span>
</code></pre></div></div>

<p>to explicitly test an <code class="language-plaintext highlighter-rouge">XmlHttpRequest</code>.</p>

<p>NOTE: Your own <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tags are treated as cross-origin and blocked by
default, too. If you really mean to load JavaScript from <code class="language-plaintext highlighter-rouge">&lt;script&gt;</code> tags,
you must now explicitly skip CSRF protection on those actions.</p>

<h3 id="spring-1">Spring</h3>

<p>If you want to use Spring as your application preloader you need to:</p>

<ol>
  <li>Add <code class="language-plaintext highlighter-rouge">gem "spring", group: :development</code> to your <code class="language-plaintext highlighter-rouge">Gemfile</code>.</li>
  <li>Install spring using <code class="language-plaintext highlighter-rouge">bundle install</code>.</li>
  <li>Generate the Spring binstub with <code class="language-plaintext highlighter-rouge">bundle exec spring binstub</code>.</li>
</ol>

<p>NOTE: User defined rake tasks will run in the <code class="language-plaintext highlighter-rouge">development</code> environment by
default. If you want them to run in other environments consult the
<a href="https://github.com/rails/spring#rake">Spring README</a>.</p>

<h3 id="configsecretsyml"><code class="language-plaintext highlighter-rouge">config/secrets.yml</code></h3>

<p>If you want to use the new <code class="language-plaintext highlighter-rouge">secrets.yml</code> convention to store your application‚Äôs
secrets, you need to:</p>

<ol>
  <li>
    <p>Create a <code class="language-plaintext highlighter-rouge">secrets.yml</code> file in your <code class="language-plaintext highlighter-rouge">config</code> folder with the following content:</p>

    <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">development</span><span class="pi">:</span>
   <span class="na">secret_key_base</span><span class="pi">:</span>

 <span class="na">test</span><span class="pi">:</span>
   <span class="na">secret_key_base</span><span class="pi">:</span>

 <span class="na">production</span><span class="pi">:</span>
   <span class="na">secret_key_base</span><span class="pi">:</span> <span class="s">&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Use your existing <code class="language-plaintext highlighter-rouge">secret_key_base</code> from the <code class="language-plaintext highlighter-rouge">secret_token.rb</code> initializer to
set the <code class="language-plaintext highlighter-rouge">SECRET_KEY_BASE</code> environment variable for whichever users running the
Rails application in production. Alternatively, you can simply copy the existing
<code class="language-plaintext highlighter-rouge">secret_key_base</code> from the <code class="language-plaintext highlighter-rouge">secret_token.rb</code> initializer to <code class="language-plaintext highlighter-rouge">secrets.yml</code>
under the <code class="language-plaintext highlighter-rouge">production</code> section, replacing <code class="language-plaintext highlighter-rouge">&lt;%= ENV["SECRET_KEY_BASE"] %&gt;</code>.</p>
  </li>
  <li>
    <p>Remove the <code class="language-plaintext highlighter-rouge">secret_token.rb</code> initializer.</p>
  </li>
  <li>
    <p>Use <code class="language-plaintext highlighter-rouge">rake secret</code> to generate new keys for the <code class="language-plaintext highlighter-rouge">development</code> and <code class="language-plaintext highlighter-rouge">test</code> sections.</p>
  </li>
  <li>
    <p>Restart your server.</p>
  </li>
</ol>

<h3 id="changes-to-test-helper">Changes to test helper</h3>

<p>If your test helper contains a call to
<code class="language-plaintext highlighter-rouge">ActiveRecord::Migration.check_pending!</code> this can be removed. The check
is now done automatically when you <code class="language-plaintext highlighter-rouge">require "rails/test_help"</code>, although
leaving this line in your helper is not harmful in any way.</p>

<h3 id="cookies-serializer">Cookies serializer</h3>

<p>Applications created before Rails 4.1 uses <code class="language-plaintext highlighter-rouge">Marshal</code> to serialize cookie values into
the signed and encrypted cookie jars. If you want to use the new <code class="language-plaintext highlighter-rouge">JSON</code>-based format
in your application, you can add an initializer file with the following content:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">cookies_serializer</span> <span class="o">=</span> <span class="ss">:hybrid</span>
</code></pre></div></div>

<p>This would transparently migrate your existing <code class="language-plaintext highlighter-rouge">Marshal</code>-serialized cookies into the
new <code class="language-plaintext highlighter-rouge">JSON</code>-based format.</p>

<p>When using the <code class="language-plaintext highlighter-rouge">:json</code> or <code class="language-plaintext highlighter-rouge">:hybrid</code> serializer, you should beware that not all
Ruby objects can be serialized as JSON. For example, <code class="language-plaintext highlighter-rouge">Date</code> and <code class="language-plaintext highlighter-rouge">Time</code> objects
will be serialized as strings, and <code class="language-plaintext highlighter-rouge">Hash</code>es will have their keys stringified.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CookiesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">set_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="o">=</span> <span class="no">Date</span><span class="p">.</span><span class="nf">tomorrow</span> <span class="c1"># =&gt; Thu, 20 Mar 2014</span>
    <span class="n">redirect_to</span> <span class="ss">action: </span><span class="s2">"read_cookie"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">read_cookie</span>
    <span class="n">cookies</span><span class="p">.</span><span class="nf">encrypted</span><span class="p">[</span><span class="ss">:expiration_date</span><span class="p">]</span> <span class="c1"># =&gt; "2014-03-20"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>It‚Äôs advisable that you only store simple data (strings and numbers) in cookies.
If you have to store complex objects, you would need to handle the conversion
manually when reading the values on subsequent requests.</p>

<p>If you use the cookie session store, this would apply to the <code class="language-plaintext highlighter-rouge">session</code> and
<code class="language-plaintext highlighter-rouge">flash</code> hash as well.</p>

<h3 id="flash-structure-changes">Flash structure changes</h3>

<p>Flash message keys are
<a href="https://github.com/rails/rails/commit/a668beffd64106a1e1fedb71cc25eaaa11baf0c1">normalized to strings</a>. They
can still be accessed using either symbols or strings. Looping through the flash
will always yield string keys:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flash</span><span class="p">[</span><span class="s2">"string"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a string"</span>
<span class="n">flash</span><span class="p">[</span><span class="ss">:symbol</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"a symbol"</span>

<span class="c1"># Rails &lt; 4.1</span>
<span class="n">flash</span><span class="p">.</span><span class="nf">keys</span> <span class="c1"># =&gt; ["string", :symbol]</span>

<span class="c1"># Rails &gt;= 4.1</span>
<span class="n">flash</span><span class="p">.</span><span class="nf">keys</span> <span class="c1"># =&gt; ["string", "symbol"]</span>
</code></pre></div></div>

<p>Make sure you are comparing Flash message keys against strings.</p>

<h3 id="changes-in-json-handling">Changes in JSON handling</h3>

<p>There are a few major changes related to JSON handling in Rails 4.1.</p>

<h4 id="multijson-removal">MultiJSON removal</h4>

<p>MultiJSON has reached its <a href="https://github.com/rails/rails/pull/10576">end-of-life</a>
and has been removed from Rails.</p>

<p>If your application currently depends on MultiJSON directly, you have a few options:</p>

<ol>
  <li>
    <p>Add ‚Äòmulti_json‚Äô to your <code class="language-plaintext highlighter-rouge">Gemfile</code>. Note that this might cease to work in the future</p>
  </li>
  <li>
    <p>Migrate away from MultiJSON by using <code class="language-plaintext highlighter-rouge">obj.to_json</code>, and <code class="language-plaintext highlighter-rouge">JSON.parse(str)</code> instead.</p>
  </li>
</ol>

<p>WARNING: Do not simply replace <code class="language-plaintext highlighter-rouge">MultiJson.load</code> with
<code class="language-plaintext highlighter-rouge">JSON.load</code> as that API is meant for deserializing arbitrary Ruby objects and
is generally <a href="https://docs.ruby-lang.org/en/master/JSON.html#method-i-load">unsafe</a>.
Prefer to use <code class="language-plaintext highlighter-rouge">JSON.parse</code>.</p>

<h4 id="json-gem-compatibility">JSON gem compatibility</h4>

<p>Historically, Rails had some compatibility issues with the JSON gem. Using
<code class="language-plaintext highlighter-rouge">JSON.generate</code> and <code class="language-plaintext highlighter-rouge">JSON.dump</code> inside a Rails application could produce
unexpected errors.</p>

<p>Rails 4.1 fixed these issues by isolating its own encoder from the JSON gem. The
JSON gem APIs will function as normal, but they will not have access to any
Rails-specific features. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FooBar</span>
  <span class="k">def</span> <span class="nf">as_json</span><span class="p">(</span><span class="n">options</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
    <span class="p">{</span> <span class="ss">foo: </span><span class="s2">"bar"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">irb&gt;</span><span class="w"> </span><span class="no">FooBar</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">to_json</span>
<span class="p">=&gt;</span> <span class="s2">"{</span><span class="se">\"</span><span class="s2">foo</span><span class="se">\"</span><span class="s2">:</span><span class="se">\"</span><span class="s2">bar</span><span class="se">\"</span><span class="s2">}"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="no">JSON</span><span class="p">.</span><span class="nf">generate</span><span class="p">(</span><span class="no">FooBar</span><span class="p">.</span><span class="nf">new</span><span class="p">)</span>
<span class="p">=&gt;</span> <span class="s2">"</span><span class="se">\"</span><span class="s2">#&lt;FooBar:0x007fa80a481610&gt;</span><span class="se">\"</span><span class="s2">"</span>
</code></pre></div></div>

<h4 id="new-json-encoder">New JSON encoder</h4>

<p>The JSON encoder in Rails 4.1 has been rewritten to take advantage of the JSON
gem. For most applications, this should be a transparent change. However, as
part of the rewrite, the following features have been removed from the encoder:</p>

<ol>
  <li>Circular data structure detection</li>
  <li>Support for the <code class="language-plaintext highlighter-rouge">encode_json</code> hook</li>
  <li>Option to encode <code class="language-plaintext highlighter-rouge">BigDecimal</code> objects as numbers instead of strings</li>
</ol>

<p>If your application depends on one of these features, you can get them back by
adding the <a href="https://github.com/rails/activesupport-json_encoder"><code class="language-plaintext highlighter-rouge">activesupport-json_encoder</code></a>
gem to your <code class="language-plaintext highlighter-rouge">Gemfile</code>.</p>

<h4 id="json-representation-of-time-objects">JSON representation of Time objects</h4>

<p><code class="language-plaintext highlighter-rouge">#as_json</code> for objects with time component (<code class="language-plaintext highlighter-rouge">Time</code>, <code class="language-plaintext highlighter-rouge">DateTime</code>, <code class="language-plaintext highlighter-rouge">ActiveSupport::TimeWithZone</code>)
now returns millisecond precision by default. If you need to keep old behavior with no millisecond
precision, set the following in an initializer:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">ActiveSupport</span><span class="o">::</span><span class="no">JSON</span><span class="o">::</span><span class="no">Encoding</span><span class="p">.</span><span class="nf">time_precision</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></div>

<h3 id="usage-of-return-within-inline-callback-blocks">Usage of <code class="language-plaintext highlighter-rouge">return</code> within inline callback blocks</h3>

<p>Previously, Rails allowed inline callback blocks to use <code class="language-plaintext highlighter-rouge">return</code> this way:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="k">return</span> <span class="kp">false</span> <span class="p">}</span> <span class="c1"># BAD</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This behavior was never intentionally supported. Due to a change in the internals
of <code class="language-plaintext highlighter-rouge">ActiveSupport::Callbacks</code>, this is no longer allowed in Rails 4.1. Using a
<code class="language-plaintext highlighter-rouge">return</code> statement in an inline callback block causes a <code class="language-plaintext highlighter-rouge">LocalJumpError</code> to
be raised when the callback is executed.</p>

<p>Inline callback blocks using <code class="language-plaintext highlighter-rouge">return</code> can be refactored to evaluate to the
returned value:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="p">{</span> <span class="kp">false</span> <span class="p">}</span> <span class="c1"># GOOD</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Alternatively, if <code class="language-plaintext highlighter-rouge">return</code> is preferred it is recommended to explicitly define
a method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ReadOnlyModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">before_save</span> <span class="ss">:before_save_callback</span> <span class="c1"># GOOD</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">before_save_callback</span>
      <span class="kp">false</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This change applies to most places in Rails where callbacks are used, including
Active Record and Active Model callbacks, as well as filters in Action
Controller (e.g. <code class="language-plaintext highlighter-rouge">before_action</code>).</p>

<p>See <a href="https://github.com/rails/rails/pull/13271">this pull request</a> for more
details.</p>

<h3 id="methods-defined-in-active-record-fixtures">Methods defined in Active Record fixtures</h3>

<p>Rails 4.1 evaluates each fixture‚Äôs ERB in a separate context, so helper methods
defined in a fixture will not be available in other fixtures.</p>

<p>Helper methods that are used in multiple fixtures should be defined on modules
included in the newly introduced <code class="language-plaintext highlighter-rouge">ActiveRecord::FixtureSet.context_class</code>, in
<code class="language-plaintext highlighter-rouge">test_helper.rb</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">FixtureFileHelpers</span>
  <span class="k">def</span> <span class="nf">file_sha</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span><span class="p">.</span><span class="nf">hexdigest</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"test/fixtures"</span><span class="p">,</span> <span class="n">path</span><span class="p">)))</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">FixtureSet</span><span class="p">.</span><span class="nf">context_class</span><span class="p">.</span><span class="nf">include</span> <span class="no">FixtureFileHelpers</span>
</code></pre></div></div>

<h3 id="i18n-enforcing-available-locales">I18n enforcing available locales</h3>

<p>Rails 4.1 now defaults the I18n option <code class="language-plaintext highlighter-rouge">enforce_available_locales</code> to <code class="language-plaintext highlighter-rouge">true</code>. This
means that it will make sure that all locales passed to it must be declared in
the <code class="language-plaintext highlighter-rouge">available_locales</code> list.</p>

<p>To disable it (and allow I18n to accept <em>any</em> locale option) add the following
configuration to your application:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">i18n</span><span class="p">.</span><span class="nf">enforce_available_locales</span> <span class="o">=</span> <span class="kp">false</span>
</code></pre></div></div>

<p>Note that this option was added as a security measure, to ensure user input
cannot be used as locale information unless it is previously known. Therefore,
it‚Äôs recommended not to disable this option unless you have a strong reason for
doing so.</p>

<h3 id="mutator-methods-called-on-relation">Mutator methods called on Relation</h3>

<p><code class="language-plaintext highlighter-rouge">Relation</code> no longer has mutator methods like <code class="language-plaintext highlighter-rouge">#map!</code> and <code class="language-plaintext highlighter-rouge">#delete_if</code>. Convert
to an <code class="language-plaintext highlighter-rouge">Array</code> by calling <code class="language-plaintext highlighter-rouge">#to_a</code> before using these methods.</p>

<p>It intends to prevent odd bugs and confusion in code that call mutator
methods directly on the <code class="language-plaintext highlighter-rouge">Relation</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Instead of this</span>
<span class="no">Author</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Hank Moody"</span><span class="p">).</span><span class="nf">compact!</span>

<span class="c1"># Now you have to do this</span>
<span class="n">authors</span> <span class="o">=</span> <span class="no">Author</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Hank Moody"</span><span class="p">).</span><span class="nf">to_a</span>
<span class="n">authors</span><span class="p">.</span><span class="nf">compact!</span>
</code></pre></div></div>

<h3 id="changes-on-default-scopes">Changes on Default Scopes</h3>

<p>Default scopes are no longer overridden by chained conditions.</p>

<p>In previous versions when you defined a <code class="language-plaintext highlighter-rouge">default_scope</code> in a model
it was overridden by chained conditions in the same field. Now it
is merged like any other scope.</p>

<p>Before:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s2">"pending"</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s2">"active"</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s2">"inactive"</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s2">"inactive"</span><span class="p">)</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre></div></div>

<p>After:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s2">"pending"</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s2">"active"</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s2">"inactive"</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s2">"inactive"</span><span class="p">)</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending' AND "users"."state" = 'inactive'</span>
</code></pre></div></div>

<p>To get the previous behavior it is needed to explicitly remove the
<code class="language-plaintext highlighter-rouge">default_scope</code> condition using <code class="language-plaintext highlighter-rouge">unscoped</code>, <code class="language-plaintext highlighter-rouge">unscope</code>, <code class="language-plaintext highlighter-rouge">rewhere</code> or
<code class="language-plaintext highlighter-rouge">except</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">default_scope</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">state: </span><span class="s2">"pending"</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">unscope</span><span class="p">(</span><span class="ss">where: :state</span><span class="p">).</span><span class="nf">where</span><span class="p">(</span><span class="ss">state: </span><span class="s2">"active"</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">scope</span> <span class="ss">:inactive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">rewhere</span> <span class="ss">state: </span><span class="s2">"inactive"</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">User</span><span class="p">.</span><span class="nf">all</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'pending'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">active</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'active'</span>

<span class="no">User</span><span class="p">.</span><span class="nf">inactive</span>
<span class="c1"># SELECT "users".* FROM "users" WHERE "users"."state" = 'inactive'</span>
</code></pre></div></div>

<h3 id="rendering-content-from-string">Rendering content from string</h3>

<p>Rails 4.1 introduces <code class="language-plaintext highlighter-rouge">:plain</code>, <code class="language-plaintext highlighter-rouge">:html</code>, and <code class="language-plaintext highlighter-rouge">:body</code> options to <code class="language-plaintext highlighter-rouge">render</code>. Those
options are now the preferred way to render string-based content, as it allows
you to specify which content type you want the response sent as.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">render :plain</code> will set the content type to <code class="language-plaintext highlighter-rouge">text/plain</code></li>
  <li><code class="language-plaintext highlighter-rouge">render :html</code> will set the content type to <code class="language-plaintext highlighter-rouge">text/html</code></li>
  <li><code class="language-plaintext highlighter-rouge">render :body</code> will <em>not</em> set the content type header.</li>
</ul>

<p>From the security standpoint, if you don‚Äôt expect to have any markup in your
response body, you should be using <code class="language-plaintext highlighter-rouge">render :plain</code> as most browsers will escape
unsafe content in the response for you.</p>

<p>We will be deprecating the use of <code class="language-plaintext highlighter-rouge">render :text</code> in a future version. So please
start using the more precise <code class="language-plaintext highlighter-rouge">:plain</code>, <code class="language-plaintext highlighter-rouge">:html</code>, and <code class="language-plaintext highlighter-rouge">:body</code> options instead.
Using <code class="language-plaintext highlighter-rouge">render :text</code> may pose a security risk, as the content is sent as
<code class="language-plaintext highlighter-rouge">text/html</code>.</p>

<h3 id="postgresql-json-and-hstore-datatypes">PostgreSQL JSON and hstore datatypes</h3>

<p>Rails 4.1 will map <code class="language-plaintext highlighter-rouge">json</code> and <code class="language-plaintext highlighter-rouge">hstore</code> columns to a string-keyed Ruby <code class="language-plaintext highlighter-rouge">Hash</code>.
In earlier versions, a <code class="language-plaintext highlighter-rouge">HashWithIndifferentAccess</code> was used. This means that
symbol access is no longer supported. This is also the case for
<code class="language-plaintext highlighter-rouge">store_accessors</code> based on top of <code class="language-plaintext highlighter-rouge">json</code> or <code class="language-plaintext highlighter-rouge">hstore</code> columns. Make sure to use
string keys consistently.</p>

<h3 id="explicit-block-use-for-activesupportcallbacks">Explicit block use for <code class="language-plaintext highlighter-rouge">ActiveSupport::Callbacks</code></h3>

<p>Rails 4.1 now expects an explicit block to be passed when calling
<code class="language-plaintext highlighter-rouge">ActiveSupport::Callbacks.set_callback</code>. This change stems from
<code class="language-plaintext highlighter-rouge">ActiveSupport::Callbacks</code> being largely rewritten for the 4.1 release.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Previously in Rails 4.0</span>
<span class="n">set_callback</span> <span class="ss">:save</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span> <span class="n">stuff</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">;</span> <span class="n">stuff</span> <span class="p">}</span>

<span class="c1"># Now in Rails 4.1</span>
<span class="n">set_callback</span> <span class="ss">:save</span><span class="p">,</span> <span class="ss">:around</span><span class="p">,</span> <span class="o">-&gt;</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="p">{</span> <span class="n">stuff</span><span class="p">;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="nf">call</span><span class="p">;</span> <span class="n">stuff</span> <span class="p">}</span>
</code></pre></div></div>

<h2 id="upgrading-from-rails-32-to-rails-40">Upgrading from Rails 3.2 to Rails 4.0</h2>

<p>If your application is currently on any version of Rails older than 3.2.x, you should upgrade to Rails 3.2 before attempting one to Rails 4.0.</p>

<p>The following changes are meant for upgrading your application to Rails 4.0.</p>

<h3 id="http-patch">HTTP PATCH</h3>

<p>Rails 4 now uses <code class="language-plaintext highlighter-rouge">PATCH</code> as the primary HTTP verb for updates when a RESTful
resource is declared in <code class="language-plaintext highlighter-rouge">config/routes.rb</code>. The <code class="language-plaintext highlighter-rouge">update</code> action is still used,
and <code class="language-plaintext highlighter-rouge">PUT</code> requests will continue to be routed to the <code class="language-plaintext highlighter-rouge">update</code> action as well.
So, if you‚Äôre using only the standard RESTful routes, no changes need to be made:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resources</span> <span class="ss">:users</span>
</code></pre></div></div>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@user</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="c1"># No change needed; PATCH will be preferred, and PUT will still work.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>However, you will need to make a change if you are using <code class="language-plaintext highlighter-rouge">form_for</code> to update
a resource in conjunction with a custom route using the <code class="language-plaintext highlighter-rouge">PUT</code> HTTP method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">put</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="vi">@user</span> <span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">update_name</span>
    <span class="c1"># Change needed; form_for will try to use a non-existent PATCH route.</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If the action is not being used in a public API and you are free to change the
HTTP method, you can update your route to use <code class="language-plaintext highlighter-rouge">patch</code> instead of <code class="language-plaintext highlighter-rouge">put</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">patch</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="ss">on: :member</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">PUT</code> requests to <code class="language-plaintext highlighter-rouge">/users/:id</code> in Rails 4 get routed to <code class="language-plaintext highlighter-rouge">update</code> as they are
today. So, if you have an API that gets real PUT requests it is going to work.
The router also routes <code class="language-plaintext highlighter-rouge">PATCH</code> requests to <code class="language-plaintext highlighter-rouge">/users/:id</code> to the <code class="language-plaintext highlighter-rouge">update</code> action.</p>

<p>If the action is being used in a public API and you can‚Äôt change to HTTP method
being used, you can update your form to use the <code class="language-plaintext highlighter-rouge">PUT</code> method instead:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="p">[</span> <span class="ss">:update_name</span><span class="p">,</span> <span class="vi">@user</span> <span class="p">],</span> <span class="ss">method: :put</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>For more on PATCH and why this change was made, see <a href="https://rubyonrails.org/2012/2/26/edge-rails-patch-is-the-new-primary-http-method-for-updates">this post</a>
on the Rails blog.</p>

<h4 id="a-note-about-media-types">A note about media types</h4>

<p>The errata for the <code class="language-plaintext highlighter-rouge">PATCH</code> verb <a href="http://www.rfc-editor.org/errata_search.php?rfc=5789">specifies that a ‚Äòdiff‚Äô media type should be
used with <code class="language-plaintext highlighter-rouge">PATCH</code></a>. One
such format is <a href="https://tools.ietf.org/html/rfc6902">JSON Patch</a>. While Rails
does not support JSON Patch natively, it‚Äôs easy enough to add support:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># in your controller:</span>
<span class="k">def</span> <span class="nf">update</span>
  <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
    <span class="nb">format</span><span class="p">.</span><span class="nf">json</span> <span class="k">do</span>
      <span class="c1"># perform a partial update</span>
      <span class="vi">@article</span><span class="p">.</span><span class="nf">update</span> <span class="n">params</span><span class="p">[</span><span class="ss">:article</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="nb">format</span><span class="p">.</span><span class="nf">json_patch</span> <span class="k">do</span>
      <span class="c1"># perform sophisticated change</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/initializers/json_patch.rb</span>
<span class="no">Mime</span><span class="o">::</span><span class="no">Type</span><span class="p">.</span><span class="nf">register</span> <span class="s2">"application/json-patch+json"</span><span class="p">,</span> <span class="ss">:json_patch</span>
</code></pre></div></div>

<p>As JSON Patch was only recently made into an RFC, there aren‚Äôt a lot of great
Ruby libraries yet. Aaron Patterson‚Äôs
<a href="https://github.com/tenderlove/hana">hana</a> is one such gem, but doesn‚Äôt have
full support for the last few changes in the specification.</p>

<h3 id="gemfile">Gemfile</h3>

<p>Rails 4.0 removed the <code class="language-plaintext highlighter-rouge">assets</code> group from <code class="language-plaintext highlighter-rouge">Gemfile</code>. You‚Äôd need to remove that
line from your <code class="language-plaintext highlighter-rouge">Gemfile</code> when upgrading. You should also update your application
file (in <code class="language-plaintext highlighter-rouge">config/application.rb</code>):</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Require the gems listed in Gemfile, including any gems</span>
<span class="c1"># you've limited to :test, :development, or :production.</span>
<span class="no">Bundler</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="o">*</span><span class="no">Rails</span><span class="p">.</span><span class="nf">groups</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="vendorplugins">vendor/plugins</h3>

<p>Rails 4.0 no longer supports loading plugins from <code class="language-plaintext highlighter-rouge">vendor/plugins</code>. You must replace any plugins by extracting them to gems and adding them to your <code class="language-plaintext highlighter-rouge">Gemfile</code>. If you choose not to make them gems, you can move them into, say, <code class="language-plaintext highlighter-rouge">lib/my_plugin/*</code> and add an appropriate initializer in <code class="language-plaintext highlighter-rouge">config/initializers/my_plugin.rb</code>.</p>

<h3 id="active-record">Active Record</h3>

<ul>
  <li>
    <p>Rails 4.0 has removed the identity map from Active Record, due to <a href="https://github.com/rails/rails/commit/302c912bf6bcd0fa200d964ec2dc4a44abe328a6">some inconsistencies with associations</a>. If you have manually enabled it in your application, you will have to remove the following config that has no effect anymore: <code class="language-plaintext highlighter-rouge">config.active_record.identity_map</code>.</p>
  </li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">delete</code> method in collection associations can now receive <code class="language-plaintext highlighter-rouge">Integer</code> or <code class="language-plaintext highlighter-rouge">String</code> arguments as record ids, besides records, pretty much like the <code class="language-plaintext highlighter-rouge">destroy</code> method does. Previously it raised <code class="language-plaintext highlighter-rouge">ActiveRecord::AssociationTypeMismatch</code> for such arguments. From Rails 4.0 on <code class="language-plaintext highlighter-rouge">delete</code> automatically tries to find the records matching the given ids before deleting them.</p>
  </li>
  <li>
    <p>In Rails 4.0 when a column or a table is renamed the related indexes are also renamed. If you have migrations which rename the indexes, they are no longer needed.</p>
  </li>
  <li>
    <p>Rails 4.0 has changed <code class="language-plaintext highlighter-rouge">serialized_attributes</code> and <code class="language-plaintext highlighter-rouge">attr_readonly</code> to class methods only. You shouldn‚Äôt use instance methods since it‚Äôs now deprecated. You should change them to use class methods, e.g. <code class="language-plaintext highlighter-rouge">self.serialized_attributes</code> to <code class="language-plaintext highlighter-rouge">self.class.serialized_attributes</code>.</p>
  </li>
  <li>
    <p>When using the default coder, assigning <code class="language-plaintext highlighter-rouge">nil</code> to a serialized attribute will save it
to the database as <code class="language-plaintext highlighter-rouge">NULL</code> instead of passing the <code class="language-plaintext highlighter-rouge">nil</code> value through YAML (<code class="language-plaintext highlighter-rouge">"--- \n...\n"</code>).</p>
  </li>
  <li>
    <p>Rails 4.0 has removed <code class="language-plaintext highlighter-rouge">attr_accessible</code> and <code class="language-plaintext highlighter-rouge">attr_protected</code> feature in favor of Strong Parameters. You can use the <a href="https://github.com/rails/protected_attributes">Protected Attributes gem</a> for a smooth upgrade path.</p>
  </li>
  <li>
    <p>If you are not using Protected Attributes, you can remove any options related to
this gem such as <code class="language-plaintext highlighter-rouge">whitelist_attributes</code> or <code class="language-plaintext highlighter-rouge">mass_assignment_sanitizer</code> options.</p>
  </li>
  <li>
    <p>Rails 4.0 requires that scopes use a callable object such as a Proc or lambda:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">active: </span><span class="kp">true</span><span class="p">)</span>

  <span class="c1"># becomes</span>
  <span class="n">scope</span> <span class="ss">:active</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span> <span class="ss">active: </span><span class="kp">true</span> <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Rails 4.0 has deprecated <code class="language-plaintext highlighter-rouge">ActiveRecord::Fixtures</code> in favor of <code class="language-plaintext highlighter-rouge">ActiveRecord::FixtureSet</code>.</p>
  </li>
  <li>
    <p>Rails 4.0 has deprecated <code class="language-plaintext highlighter-rouge">ActiveRecord::TestCase</code> in favor of <code class="language-plaintext highlighter-rouge">ActiveSupport::TestCase</code>.</p>
  </li>
  <li>
    <p>Rails 4.0 has deprecated the old-style hash-based finder API. This means that
methods which previously accepted ‚Äúfinder options‚Äù no longer do.  For example, <code class="language-plaintext highlighter-rouge">Book.find(:all, conditions: { name: '1984' })</code> has been deprecated in favor of <code class="language-plaintext highlighter-rouge">Book.where(name: '1984')</code></p>
  </li>
  <li>
    <p>All dynamic methods except for <code class="language-plaintext highlighter-rouge">find_by_...</code> and <code class="language-plaintext highlighter-rouge">find_by_...!</code> are deprecated.
Here‚Äôs how you can handle the changes:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* `find_all_by_...`           becomes `where(...)`.
* `find_last_by_...`          becomes `where(...).last`.
* `scoped_by_...`             becomes `where(...)`.
* `find_or_initialize_by_...` becomes `find_or_initialize_by(...)`.
* `find_or_create_by_...`     becomes `find_or_create_by(...)`.
</code></pre></div>    </div>
  </li>
  <li>
    <p>Note that <code class="language-plaintext highlighter-rouge">where(...)</code> returns a relation, not an array like the old finders. If you require an <code class="language-plaintext highlighter-rouge">Array</code>, use <code class="language-plaintext highlighter-rouge">where(...).to_a</code>.</p>
  </li>
  <li>
    <p>These equivalent methods may not execute the same SQL as the previous implementation.</p>
  </li>
  <li>
    <p>To re-enable the old finders, you can use the <a href="https://github.com/rails/activerecord-deprecated_finders">activerecord-deprecated_finders gem</a>.</p>
  </li>
  <li>
    <p>Rails 4.0 has changed to default join table for <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> relations to strip the common prefix off the second table name. Any existing <code class="language-plaintext highlighter-rouge">has_and_belongs_to_many</code> relationship between models with a common prefix must be specified with the <code class="language-plaintext highlighter-rouge">join_table</code> option. For example:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="k">class</span> <span class="nc">CatalogCategory</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">has_and_belongs_to_many</span> <span class="ss">:catalog_products</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s2">"catalog_categories_catalog_products"</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">CatalogProduct</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">has_and_belongs_to_many</span> <span class="ss">:catalog_categories</span><span class="p">,</span> <span class="ss">join_table: </span><span class="s2">"catalog_categories_catalog_products"</span>
  <span class="k">end</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Note that the prefix takes scopes into account as well, so relations between <code class="language-plaintext highlighter-rouge">Catalog::Category</code> and <code class="language-plaintext highlighter-rouge">Catalog::Product</code> or <code class="language-plaintext highlighter-rouge">Catalog::Category</code> and <code class="language-plaintext highlighter-rouge">CatalogProduct</code> need to be updated similarly.</p>
  </li>
</ul>

<h3 id="active-resource">Active Resource</h3>

<p>Rails 4.0 extracted Active Resource to its own gem. If you still need the feature you can add the <a href="https://github.com/rails/activeresource">Active Resource gem</a> in your <code class="language-plaintext highlighter-rouge">Gemfile</code>.</p>

<h3 id="active-model">Active Model</h3>

<ul>
  <li>
    <p>Rails 4.0 has changed how errors attach with the <code class="language-plaintext highlighter-rouge">ActiveModel::Validations::ConfirmationValidator</code>. Now when confirmation validations fail, the error will be attached to <code class="language-plaintext highlighter-rouge">:#{attribute}_confirmation</code> instead of <code class="language-plaintext highlighter-rouge">attribute</code>.</p>
  </li>
  <li>
    <p>Rails 4.0 has changed <code class="language-plaintext highlighter-rouge">ActiveModel::Serializers::JSON.include_root_in_json</code> default value to <code class="language-plaintext highlighter-rouge">false</code>. Now, Active Model Serializers and Active Record objects have the same default behavior. This means that you can comment or remove the following option in the <code class="language-plaintext highlighter-rouge">config/initializers/wrap_parameters.rb</code> file:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Disable root element in JSON by default.</span>
  <span class="c1"># ActiveSupport.on_load(:active_record) do</span>
  <span class="c1">#   self.include_root_in_json = false</span>
  <span class="c1"># end</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="action-pack">Action Pack</h3>

<ul>
  <li>
    <p>Rails 4.0 introduces <code class="language-plaintext highlighter-rouge">ActiveSupport::KeyGenerator</code> and uses this as a base from which to generate and verify signed cookies (among other things). Existing signed cookies generated with Rails 3.x will be transparently upgraded if you leave your existing <code class="language-plaintext highlighter-rouge">secret_token</code> in place and add the new <code class="language-plaintext highlighter-rouge">secret_key_base</code>.</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># config/initializers/secret_token.rb</span>
  <span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_token</span> <span class="o">=</span> <span class="s2">"existing secret token"</span>
  <span class="no">Myapp</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">secret_key_base</span> <span class="o">=</span> <span class="s2">"new secret key base"</span>
</code></pre></div>    </div>

    <p>Please note that you should wait to set <code class="language-plaintext highlighter-rouge">secret_key_base</code> until you have 100% of your userbase on Rails 4.x and are reasonably sure you will not need to rollback to Rails 3.x. This is because cookies signed based on the new <code class="language-plaintext highlighter-rouge">secret_key_base</code> in Rails 4.x are not backwards compatible with Rails 3.x. You are free to leave your existing <code class="language-plaintext highlighter-rouge">secret_token</code> in place, not set the new <code class="language-plaintext highlighter-rouge">secret_key_base</code>, and ignore the deprecation warnings until you are reasonably sure that your upgrade is otherwise complete.</p>

    <p>If you are relying on the ability for external applications or JavaScript to be able to read your Rails app‚Äôs signed session cookies (or signed cookies in general) you should not set <code class="language-plaintext highlighter-rouge">secret_key_base</code> until you have decoupled these concerns.</p>
  </li>
  <li>
    <p>Rails 4.0 encrypts the contents of cookie-based sessions if <code class="language-plaintext highlighter-rouge">secret_key_base</code> has been set. Rails 3.x signed, but did not encrypt, the contents of cookie-based session. Signed cookies are ‚Äúsecure‚Äù in that they are verified to have been generated by your app and are tamper-proof. However, the contents can be viewed by end users, and encrypting the contents eliminates this caveat/concern without a significant performance penalty.</p>

    <p>Please read <a href="https://github.com/rails/rails/pull/9978">Pull Request #9978</a> for details on the move to encrypted session cookies.</p>
  </li>
  <li>
    <p>Rails 4.0 removed the <code class="language-plaintext highlighter-rouge">ActionController::Base.asset_path</code> option. Use the assets pipeline feature.</p>
  </li>
  <li>
    <p>Rails 4.0 has deprecated <code class="language-plaintext highlighter-rouge">ActionController::Base.page_cache_extension</code> option. Use <code class="language-plaintext highlighter-rouge">ActionController::Base.default_static_extension</code> instead.</p>
  </li>
  <li>
    <p>Rails 4.0 has removed Action and Page caching from Action Pack. You will need to add the <code class="language-plaintext highlighter-rouge">actionpack-action_caching</code> gem in order to use <code class="language-plaintext highlighter-rouge">caches_action</code> and the <code class="language-plaintext highlighter-rouge">actionpack-page_caching</code> to use <code class="language-plaintext highlighter-rouge">caches_page</code> in your controllers.</p>
  </li>
  <li>
    <p>Rails 4.0 has removed the XML parameters parser. You will need to add the <code class="language-plaintext highlighter-rouge">actionpack-xml_parser</code> gem if you require this feature.</p>
  </li>
  <li>
    <p>Rails 4.0 changes the default <code class="language-plaintext highlighter-rouge">layout</code> lookup set using symbols or procs that return nil. To get the ‚Äúno layout‚Äù behavior, return false instead of nil.</p>
  </li>
  <li>
    <p>Rails 4.0 changes the default memcached client from <code class="language-plaintext highlighter-rouge">memcache-client</code> to <code class="language-plaintext highlighter-rouge">dalli</code>. To upgrade, simply add <code class="language-plaintext highlighter-rouge">gem "dalli"</code> to your <code class="language-plaintext highlighter-rouge">Gemfile</code>.</p>
  </li>
  <li>
    <p>Rails 4.0 deprecates the <code class="language-plaintext highlighter-rouge">dom_id</code> and <code class="language-plaintext highlighter-rouge">dom_class</code> methods in controllers (they are fine in views). You will need to include the <code class="language-plaintext highlighter-rouge">ActionView::RecordIdentifier</code> module in controllers requiring this feature.</p>
  </li>
  <li>
    <p>Rails 4.0 deprecates the <code class="language-plaintext highlighter-rouge">:confirm</code> option for the <code class="language-plaintext highlighter-rouge">link_to</code> helper. You should
instead rely on a data attribute (e.g. <code class="language-plaintext highlighter-rouge">data: { confirm: 'Are you sure?' }</code>).
This deprecation also concerns the helpers based on this one (such as <code class="language-plaintext highlighter-rouge">link_to_if</code>
or <code class="language-plaintext highlighter-rouge">link_to_unless</code>).</p>
  </li>
  <li>
    <p>Rails 4.0 changed how <code class="language-plaintext highlighter-rouge">assert_generates</code>, <code class="language-plaintext highlighter-rouge">assert_recognizes</code>, and <code class="language-plaintext highlighter-rouge">assert_routing</code> work. Now all these assertions raise <code class="language-plaintext highlighter-rouge">Assertion</code> instead of <code class="language-plaintext highlighter-rouge">ActionController::RoutingError</code>.</p>
  </li>
  <li>
    <p>Rails 4.0 raises an <code class="language-plaintext highlighter-rouge">ArgumentError</code> if clashing named routes are defined. This can be triggered by explicitly defined named routes or by the <code class="language-plaintext highlighter-rouge">resources</code> method. Here are two examples that clash with routes named <code class="language-plaintext highlighter-rouge">example_path</code>:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">get</span> <span class="s2">"one"</span> <span class="o">=&gt;</span> <span class="s2">"test#example"</span><span class="p">,</span> <span class="ss">as: :example</span>
  <span class="n">get</span> <span class="s2">"two"</span> <span class="o">=&gt;</span> <span class="s2">"test#example"</span><span class="p">,</span> <span class="ss">as: :example</span>
</code></pre></div>    </div>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">resources</span> <span class="ss">:examples</span>
  <span class="n">get</span> <span class="s2">"clashing/:id"</span> <span class="o">=&gt;</span> <span class="s2">"test#example"</span><span class="p">,</span> <span class="ss">as: :example</span>
</code></pre></div>    </div>

    <p>In the first case, you can simply avoid using the same name for multiple
  routes. In the second, you can use the <code class="language-plaintext highlighter-rouge">only</code> or <code class="language-plaintext highlighter-rouge">except</code> options provided by
  the <code class="language-plaintext highlighter-rouge">resources</code> method to restrict the routes created as detailed in the
  <a href="routing.html#restricting-the-routes-created">Routing Guide</a>.</p>
  </li>
  <li>
    <p>Rails 4.0 also changed the way unicode character routes are drawn. Now you can draw unicode character routes directly. If you already draw such routes, you must change them, for example:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">get</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Utils</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="s2">"„Åì„Çì„Å´„Å°„ÅØ"</span><span class="p">),</span> <span class="ss">controller: </span><span class="s2">"welcome"</span><span class="p">,</span> <span class="ss">action: </span><span class="s2">"index"</span>
</code></pre></div>    </div>

    <p>becomes</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">get</span> <span class="s2">"„Åì„Çì„Å´„Å°„ÅØ"</span><span class="p">,</span> <span class="ss">controller: </span><span class="s2">"welcome"</span><span class="p">,</span> <span class="ss">action: </span><span class="s2">"index"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Rails 4.0 requires that routes using <code class="language-plaintext highlighter-rouge">match</code> must specify the request method. For example:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Rails 3.x</span>
  <span class="n">match</span> <span class="s2">"/"</span> <span class="o">=&gt;</span> <span class="s2">"root#index"</span>

  <span class="c1"># becomes</span>
  <span class="n">match</span> <span class="s2">"/"</span> <span class="o">=&gt;</span> <span class="s2">"root#index"</span><span class="p">,</span> <span class="ss">via: :get</span>

  <span class="c1"># or</span>
  <span class="n">get</span> <span class="s2">"/"</span> <span class="o">=&gt;</span> <span class="s2">"root#index"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Rails 4.0 has removed <code class="language-plaintext highlighter-rouge">ActionDispatch::BestStandardsSupport</code> middleware, <code class="language-plaintext highlighter-rouge">&lt;!DOCTYPE html&gt;</code> already triggers standards mode per https://msdn.microsoft.com/en-us/library/jj676915(v=vs.85).aspx and ChromeFrame header has been moved to <code class="language-plaintext highlighter-rouge">config.action_dispatch.default_headers</code>.</p>

    <p>Remember you must also remove any references to the middleware from your application code, for example:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="c1"># Raise exception</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">middleware</span><span class="p">.</span><span class="nf">insert_before</span><span class="p">(</span><span class="no">Rack</span><span class="o">::</span><span class="no">Lock</span><span class="p">,</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">BestStandardsSupport</span><span class="p">)</span>
</code></pre></div>    </div>

    <p>Also check your environment settings for <code class="language-plaintext highlighter-rouge">config.action_dispatch.best_standards_support</code> and remove it if present.</p>
  </li>
  <li>
    <p>Rails 4.0 allows configuration of HTTP headers by setting <code class="language-plaintext highlighter-rouge">config.action_dispatch.default_headers</code>. The defaults are as follows:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">config</span><span class="p">.</span><span class="nf">action_dispatch</span><span class="p">.</span><span class="nf">default_headers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"X-Frame-Options"</span> <span class="o">=&gt;</span> <span class="s2">"SAMEORIGIN"</span><span class="p">,</span>
    <span class="s2">"X-XSS-Protection"</span> <span class="o">=&gt;</span> <span class="s2">"1; mode=block"</span>
  <span class="p">}</span>
</code></pre></div>    </div>

    <p>Please note that if your application is dependent on loading certain pages in a <code class="language-plaintext highlighter-rouge">&lt;frame&gt;</code> or <code class="language-plaintext highlighter-rouge">&lt;iframe&gt;</code>, then you may need to explicitly set <code class="language-plaintext highlighter-rouge">X-Frame-Options</code> to <code class="language-plaintext highlighter-rouge">ALLOW-FROM ...</code> or <code class="language-plaintext highlighter-rouge">ALLOWALL</code>.</p>
  </li>
  <li>
    <p>In Rails 4.0, precompiling assets no longer automatically copies non-JS/CSS assets from <code class="language-plaintext highlighter-rouge">vendor/assets</code> and <code class="language-plaintext highlighter-rouge">lib/assets</code>. Rails application and engine developers should put these assets in <code class="language-plaintext highlighter-rouge">app/assets</code> or configure <a href="configuring.html#config-assets-precompile"><code class="language-plaintext highlighter-rouge">config.assets.precompile</code></a>.</p>
  </li>
  <li>
    <p>In Rails 4.0, <code class="language-plaintext highlighter-rouge">ActionController::UnknownFormat</code> is raised when the action doesn‚Äôt handle the request format. By default, the exception is handled by responding with 406 Not Acceptable, but you can override that now. In Rails 3, 406 Not Acceptable was always returned. No overrides.</p>
  </li>
  <li>
    <p>In Rails 4.0, a generic <code class="language-plaintext highlighter-rouge">ActionDispatch::ParamsParser::ParseError</code> exception is raised when <code class="language-plaintext highlighter-rouge">ParamsParser</code> fails to parse request params. You will want to rescue this exception instead of the low-level <code class="language-plaintext highlighter-rouge">MultiJson::DecodeError</code>, for example.</p>
  </li>
  <li>
    <p>In Rails 4.0, <code class="language-plaintext highlighter-rouge">SCRIPT_NAME</code> is properly nested when engines are mounted on an app that‚Äôs served from a URL prefix. You no longer have to set <code class="language-plaintext highlighter-rouge">default_url_options[:script_name]</code> to work around overwritten URL prefixes.</p>
  </li>
  <li>Rails 4.0 deprecated <code class="language-plaintext highlighter-rouge">ActionController::Integration</code> in favor of <code class="language-plaintext highlighter-rouge">ActionDispatch::Integration</code>.</li>
  <li>Rails 4.0 deprecated <code class="language-plaintext highlighter-rouge">ActionController::IntegrationTest</code> in favor of <code class="language-plaintext highlighter-rouge">ActionDispatch::IntegrationTest</code>.</li>
  <li>Rails 4.0 deprecated <code class="language-plaintext highlighter-rouge">ActionController::PerformanceTest</code> in favor of <code class="language-plaintext highlighter-rouge">ActionDispatch::PerformanceTest</code>.</li>
  <li>Rails 4.0 deprecated <code class="language-plaintext highlighter-rouge">ActionController::AbstractRequest</code> in favor of <code class="language-plaintext highlighter-rouge">ActionDispatch::Request</code>.</li>
  <li>Rails 4.0 deprecated <code class="language-plaintext highlighter-rouge">ActionController::Request</code> in favor of <code class="language-plaintext highlighter-rouge">ActionDispatch::Request</code>.</li>
  <li>Rails 4.0 deprecated <code class="language-plaintext highlighter-rouge">ActionController::AbstractResponse</code> in favor of <code class="language-plaintext highlighter-rouge">ActionDispatch::Response</code>.</li>
  <li>Rails 4.0 deprecated <code class="language-plaintext highlighter-rouge">ActionController::Response</code> in favor of <code class="language-plaintext highlighter-rouge">ActionDispatch::Response</code>.</li>
  <li>Rails 4.0 deprecated <code class="language-plaintext highlighter-rouge">ActionController::Routing</code> in favor of <code class="language-plaintext highlighter-rouge">ActionDispatch::Routing</code>.</li>
</ul>

<h3 id="active-support">Active Support</h3>

<p>Rails 4.0 removes the <code class="language-plaintext highlighter-rouge">j</code> alias for <code class="language-plaintext highlighter-rouge">ERB::Util#json_escape</code> since <code class="language-plaintext highlighter-rouge">j</code> is already used for <code class="language-plaintext highlighter-rouge">ActionView::Helpers::JavaScriptHelper#escape_javascript</code>.</p>

<h4 id="cache">Cache</h4>

<p>The caching method changed between Rails 3.x and 4.0. You should <a href="https://guides.rubyonrails.org/v4.0/caching_with_rails.html#activesupport-cache-store">change the cache namespace</a> and roll out with a cold cache.</p>

<h3 id="helpers-loading-order">Helpers Loading Order</h3>

<p>The order in which helpers from more than one directory are loaded has changed in Rails 4.0. Previously, they were gathered and then sorted alphabetically. After upgrading to Rails 4.0, helpers will preserve the order of loaded directories and will be sorted alphabetically only within each directory. Unless you explicitly use the <code class="language-plaintext highlighter-rouge">helpers_path</code> parameter, this change will only impact the way of loading helpers from engines. If you rely on the ordering, you should check if correct methods are available after upgrade. If you would like to change the order in which engines are loaded, you can use <code class="language-plaintext highlighter-rouge">config.railties_order=</code> method.</p>

<h3 id="active-record-observer-and-action-controller-sweeper">Active Record Observer and Action Controller Sweeper</h3>

<p><code class="language-plaintext highlighter-rouge">ActiveRecord::Observer</code> and <code class="language-plaintext highlighter-rouge">ActionController::Caching::Sweeper</code> have been extracted to the <code class="language-plaintext highlighter-rouge">rails-observers</code> gem. You will need to add the <code class="language-plaintext highlighter-rouge">rails-observers</code> gem if you require these features.</p>

<h3 id="sprockets-rails">sprockets-rails</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">assets:precompile:primary</code> and <code class="language-plaintext highlighter-rouge">assets:precompile:all</code> have been removed. Use <code class="language-plaintext highlighter-rouge">assets:precompile</code> instead.</li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">config.assets.compress</code> option should be changed to <a href="configuring.html#config-assets-js-compressor"><code class="language-plaintext highlighter-rouge">config.assets.js_compressor</code></a> like so for instance:</p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">js_compressor</span> <span class="o">=</span> <span class="ss">:uglifier</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="sass-rails">sass-rails</h3>

<ul>
  <li><code class="language-plaintext highlighter-rouge">asset-url</code> with two arguments is deprecated. For example: <code class="language-plaintext highlighter-rouge">asset-url("rails.png", image)</code> becomes <code class="language-plaintext highlighter-rouge">asset-url("rails.png")</code>.</li>
</ul>

<h2 id="upgrading-from-rails-31-to-rails-32">Upgrading from Rails 3.1 to Rails 3.2</h2>

<p>If your application is currently on any version of Rails older than 3.1.x, you
should upgrade to Rails 3.1 before attempting an update to Rails 3.2.</p>

<p>The following changes are meant for upgrading your application to the latest
3.2.x version of Rails.</p>

<h3 id="gemfile-1">Gemfile</h3>

<p>Make the following changes to your <code class="language-plaintext highlighter-rouge">Gemfile</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s2">"rails"</span><span class="p">,</span> <span class="s2">"3.2.21"</span>

<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s2">"sass-rails"</span><span class="p">,</span>   <span class="s2">"~&gt; 3.2.6"</span>
  <span class="n">gem</span> <span class="s2">"coffee-rails"</span><span class="p">,</span> <span class="s2">"~&gt; 3.2.2"</span>
  <span class="n">gem</span> <span class="s2">"uglifier"</span><span class="p">,</span>     <span class="s2">"&gt;= 1.0.3"</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="configenvironmentsdevelopmentrb">config/environments/development.rb</h3>

<p>There are a couple of new configuration settings that you should add to your development environment:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Raise exception on mass assignment protection for Active Record models</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>

<span class="c1"># Log the query plan for queries taking more than this (works</span>
<span class="c1"># with SQLite, MySQL, and PostgreSQL)</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">auto_explain_threshold_in_seconds</span> <span class="o">=</span> <span class="mf">0.5</span>
</code></pre></div></div>

<h3 id="configenvironmentstestrb">config/environments/test.rb</h3>

<p>The <code class="language-plaintext highlighter-rouge">mass_assignment_sanitizer</code> configuration setting should also be added to <code class="language-plaintext highlighter-rouge">config/environments/test.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Raise exception on mass assignment protection for Active Record models</span>
<span class="n">config</span><span class="p">.</span><span class="nf">active_record</span><span class="p">.</span><span class="nf">mass_assignment_sanitizer</span> <span class="o">=</span> <span class="ss">:strict</span>
</code></pre></div></div>

<h3 id="vendorplugins-1">vendor/plugins</h3>

<p>Rails 3.2 deprecates <code class="language-plaintext highlighter-rouge">vendor/plugins</code> and Rails 4.0 will remove them completely. While it‚Äôs not strictly necessary as part of a Rails 3.2 upgrade, you can start replacing any plugins by extracting them to gems and adding them to your <code class="language-plaintext highlighter-rouge">Gemfile</code>. If you choose not to make them gems, you can move them into, say, <code class="language-plaintext highlighter-rouge">lib/my_plugin/*</code> and add an appropriate initializer in <code class="language-plaintext highlighter-rouge">config/initializers/my_plugin.rb</code>.</p>

<h3 id="active-record-1">Active Record</h3>

<p>Option <code class="language-plaintext highlighter-rouge">:dependent =&gt; :restrict</code> has been removed from <code class="language-plaintext highlighter-rouge">belongs_to</code>. If you want to prevent deleting the object if there are any associated objects, you can set <code class="language-plaintext highlighter-rouge">:dependent =&gt; :destroy</code> and return <code class="language-plaintext highlighter-rouge">false</code> after checking for existence of association from any of the associated object‚Äôs destroy callbacks.</p>

<h2 id="upgrading-from-rails-30-to-rails-31">Upgrading from Rails 3.0 to Rails 3.1</h2>

<p>If your application is currently on any version of Rails older than 3.0.x, you should upgrade to Rails 3.0 before attempting an update to Rails 3.1.</p>

<p>The following changes are meant for upgrading your application to Rails 3.1.12, the last 3.1.x version of Rails.</p>

<h3 id="gemfile-2">Gemfile</h3>

<p>Make the following changes to your <code class="language-plaintext highlighter-rouge">Gemfile</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s2">"rails"</span><span class="p">,</span> <span class="s2">"3.1.12"</span>
<span class="n">gem</span> <span class="s2">"mysql2"</span>

<span class="c1"># Needed for the new asset pipeline</span>
<span class="n">group</span> <span class="ss">:assets</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s2">"sass-rails"</span><span class="p">,</span>   <span class="s2">"~&gt; 3.1.7"</span>
  <span class="n">gem</span> <span class="s2">"coffee-rails"</span><span class="p">,</span> <span class="s2">"~&gt; 3.1.1"</span>
  <span class="n">gem</span> <span class="s2">"uglifier"</span><span class="p">,</span>     <span class="s2">"&gt;= 1.0.3"</span>
<span class="k">end</span>

<span class="c1"># jQuery is the default JavaScript library in Rails 3.1</span>
<span class="n">gem</span> <span class="s2">"jquery-rails"</span>
</code></pre></div></div>

<h3 id="configapplicationrb">config/application.rb</h3>

<p>The asset pipeline requires the following additions:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">version</span> <span class="o">=</span> <span class="s2">"1.0"</span>
</code></pre></div></div>

<p>If your application is using an ‚Äú/assets‚Äù route for a resource you may want to change the prefix used for assets to avoid conflicts:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Defaults to '/assets'</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">prefix</span> <span class="o">=</span> <span class="s2">"/asset-files"</span>
</code></pre></div></div>

<h3 id="configenvironmentsdevelopmentrb-1">config/environments/development.rb</h3>

<p>Remove the RJS setting <code class="language-plaintext highlighter-rouge">config.action_view.debug_rjs = true</code>.</p>

<p>Add these settings if you enable the asset pipeline:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Do not compress assets</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># Expands the lines which load the assets</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">debug</span> <span class="o">=</span> <span class="kp">true</span>
</code></pre></div></div>

<h3 id="configenvironmentsproductionrb">config/environments/production.rb</h3>

<p>Again, most of the changes below are for the asset pipeline. You can read more about these in the <a href="asset_pipeline.html">Asset Pipeline</a> guide.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compress JavaScripts and CSS</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compress</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># Don't fallback to assets pipeline if a precompiled asset is missed</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">compile</span> <span class="o">=</span> <span class="kp">false</span>

<span class="c1"># Generate digests for assets URLs</span>
<span class="n">config</span><span class="p">.</span><span class="nf">assets</span><span class="p">.</span><span class="nf">digest</span> <span class="o">=</span> <span class="kp">true</span>

<span class="c1"># Defaults to Rails.root.join("public/assets")</span>
<span class="c1"># config.assets.manifest = YOUR_PATH</span>

<span class="c1"># Precompile additional assets (application.js, application.css, and all non-JS/CSS are already added)</span>
<span class="c1"># config.assets.precompile += %w( admin.js admin.css )</span>

<span class="c1"># Force all access to the app over SSL, use Strict-Transport-Security, and use secure cookies.</span>
<span class="c1"># config.force_ssl = true</span>
</code></pre></div></div>

<h3 id="configenvironmentstestrb-1">config/environments/test.rb</h3>

<p>You can help test performance with these additions to your test environment:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Configure static asset server for tests with Cache-Control for performance</span>
<span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">enabled</span> <span class="o">=</span> <span class="kp">true</span>
<span class="n">config</span><span class="p">.</span><span class="nf">public_file_server</span><span class="p">.</span><span class="nf">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s2">"Cache-Control"</span> <span class="o">=&gt;</span> <span class="s2">"public, max-age=3600"</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="configinitializerswrap_parametersrb">config/initializers/wrap_parameters.rb</h3>

<p>Add this file with the following contents, if you wish to wrap parameters into a nested hash. This is on by default in new applications.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Be sure to restart your server when you modify this file.</span>
<span class="c1"># This file contains settings for ActionController::ParamsWrapper which</span>
<span class="c1"># is enabled by default.</span>

<span class="c1"># Enable parameter wrapping for JSON. You can disable this by setting :format to an empty array.</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:action_controller</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">wrap_parameters</span> <span class="ss">format: </span><span class="p">[</span><span class="ss">:json</span><span class="p">]</span>
<span class="k">end</span>

<span class="c1"># Disable root element in JSON by default.</span>
<span class="no">ActiveSupport</span><span class="p">.</span><span class="nf">on_load</span><span class="p">(</span><span class="ss">:active_record</span><span class="p">)</span> <span class="k">do</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">include_root_in_json</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="configinitializerssession_storerb">config/initializers/session_store.rb</h3>

<p>You need to change your session key to something new, or remove all sessions:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># in config/initializers/session_store.rb</span>
<span class="no">AppName</span><span class="o">::</span><span class="no">Application</span><span class="p">.</span><span class="nf">config</span><span class="p">.</span><span class="nf">session_store</span> <span class="ss">:cookie_store</span><span class="p">,</span> <span class="ss">key: </span><span class="s2">"SOMETHINGNEW"</span>
</code></pre></div></div>

<p>or</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rake db:sessions:clear
</code></pre></div></div>

<h3 id="remove-cache-and-concat-options-in-asset-helpers-references-in-views">Remove :cache and :concat options in asset helpers references in views</h3>

<ul>
  <li>With the Asset Pipeline the :cache and :concat options aren‚Äôt used anymore, delete these options from your views.</li>
</ul>

        </div>

        <footer class="guide-footer">
            <div class="feedback">
                <h3>Geri Bildirim</h3>
                <p>Bu kƒ±lavuzun kalitesini artƒ±rmamƒ±za yardƒ±mcƒ± olmak i√ßin geri bildirimlerinizi bekliyoruz.</p>
                <p>L√ºtfen <a href="https://github.com/dilankaya127/rails-tr-TR">GitHub Issues</a> √ºzerinden katkƒ±da bulunun.</p>
            </div>
        </footer>
    </article>
</div>

<script>
// ƒ∞√ßindekiler tablosunu otomatik olu≈ütur
document.addEventListener('DOMContentLoaded', function() {
    const toc = document.getElementById('toc');
    const headings = document.querySelectorAll('.guide-content h2, .guide-content h3, .guide-content h4');
    
    if (headings.length > 0) {
        const tocList = document.createElement('ul');
        
        headings.forEach(function(heading, index) {
            const id = 'heading-' + index;
            heading.id = id;
            
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = heading.textContent;
            a.className = 'toc-' + heading.tagName.toLowerCase();
            
            li.appendChild(a);
            tocList.appendChild(li);
        });
        
        toc.appendChild(tocList);
    }
});
</script>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Rails Kƒ±lavuzlarƒ± T√ºrk√ße √áevirisi. G√∂n√ºll√ºler tarafƒ±ndan hazƒ±rlanmƒ±≈ütƒ±r.</p>
            <p>Orijinal dok√ºmantasyon <a href="https://guides.rubyonrails.org">Ruby on Rails</a> ekibine aittir.</p>
        </div>
    </footer>

    <script>hljs.highlightAll();</script>
</body>
</html>