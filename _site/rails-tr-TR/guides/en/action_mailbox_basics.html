<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action Mailbox Basics - </title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo">
                    <a href="/">Rails Kılavuzları</a>
                </h1>
                <nav class="nav">
                    <a href="/">Ana Sayfa</a>
                    <a href="https://dilankaya127.github.io">Portföy</a>
                    <a href="https://github.com/dilankaya127/rails-tr-TR">GitHub</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="guide-container">
    <aside class="guide-sidebar">
        <div class="guide-toc">
            <h3>İçindekiler</h3>
            <div id="toc"></div>
        </div>
        
        <div class="guide-nav">
            <h3>Diğer Kılavuzlar</h3>
            <ul>
                <li><a href="/rails-tr-TR/guides/tr/getting_started">Rails ile Başlarken</a></li>
                <li><a href="/rails-tr-TR/guides/en/active_record_basics">Active Record Temelleri</a></li>
                <li><a href="/rails-tr-TR/guides//en/action_controller_overview">Action Controller</a></li>
                <li><a href="/rails-tr-TR/guides/tr/action_cable_overview">Action Cable</a></li>
            </ul>
        </div>
    </aside>

    <article class="guide-content">
        <header class="guide-header">
            <h1>Action Mailbox Basics</h1>
            
        </header>

        <div class="guide-body">
            <p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1 id="action-mailbox-basics">Action Mailbox Basics</h1>

<p>This guide provides you with all you need to get started in receiving emails to
your application.</p>

<p>After reading this guide, you will know:</p>

<ul>
  <li>How to receive email within a Rails application.</li>
  <li>How to configure Action Mailbox.</li>
  <li>How to generate and route emails to a mailbox.</li>
  <li>How to test incoming emails.</li>
</ul>

<hr />

<h2 id="what-is-action-mailbox">What is Action Mailbox?</h2>

<p>Action Mailbox routes incoming emails to controller-like mailboxes for
processing in your Rails application. Action Mailbox is for receiving email,
while <a href="action_mailer_basics.html">Action Mailer</a> is for <em>sending</em> them.</p>

<p>The inbound emails are routed asynchronously using <a href="active_job_basics.html">Active
Job</a> to one or several dedicated mailboxes. These emails
are turned into
<a href="https://api.rubyonrails.org/classes/ActionMailbox/InboundEmail.html"><code class="language-plaintext highlighter-rouge">InboundEmail</code></a>
records using <a href="active_record_basics.html">Active Record</a>, which are capable of
interacting directly with the rest of your domain model.</p>

<p><code class="language-plaintext highlighter-rouge">InboundEmail</code> records also provide lifecycle tracking, storage of the original
email via <a href="active_storage_overview.html">Active Storage</a>, and responsible data
handling with on-by-default <a href="#incineration-of-inboundemails">incineration</a>.</p>

<p>Action Mailbox ships with ingresses which enable your application to receive
emails from external email providers such as Mailgun, Mandrill, Postmark, and
SendGrid. You can also handle inbound emails directly via the built-in Exim,
Postfix, and Qmail ingresses.</p>

<h2 id="setup">Setup</h2>

<p>Action Mailbox has a few moving parts. First, you’ll run the installer. Next,
you’ll choose and configure an ingress for handling incoming email. You’re then
ready to add Action Mailbox routing, create mailboxes, and start processing
incoming emails.</p>

<p>To start, let’s install Action Mailbox:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails action_mailbox:install
</code></pre></div></div>

<p>This will create an <code class="language-plaintext highlighter-rouge">application_mailbox.rb</code> file and copy over migrations.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails db:migrate
</code></pre></div></div>

<p>This will run the Action Mailbox and Active Storage migrations.</p>

<p>The Action Mailbox table <code class="language-plaintext highlighter-rouge">action_mailbox_inbound_emails</code> stores incoming
messages and their processing status.</p>

<p>At this point, you can start your Rails server and check out
<code class="language-plaintext highlighter-rouge">http://localhost:3000/rails/conductor/action_mailbox/inbound_emails</code>. See
<a href="#local-development-and-testing">Local Development and Testing</a> for more.</p>

<p>The next step is to configure an ingress in your Rails application to specify
how incoming emails should be received.</p>

<h2 id="ingress-configuration">Ingress Configuration</h2>

<p>Configuring ingress involves setting up credentials and endpoint information for
the chosen email service. Here are the steps for each of the supported
ingresses.</p>

<h3 id="exim">Exim</h3>

<p>Tell Action Mailbox to accept emails from an SMTP relay:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:relay</span>
</code></pre></div></div>

<p>Generate a strong password that Action Mailbox can use to authenticate requests
to the relay ingress.</p>

<p>Use <code class="language-plaintext highlighter-rouge">bin/rails credentials:edit</code> to add the password to your application’s
encrypted credentials under <code class="language-plaintext highlighter-rouge">action_mailbox.ingress_password</code>, where Action
Mailbox will automatically find it:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">ingress_password</span><span class="pi">:</span> <span class="s">...</span>
</code></pre></div></div>

<p>Alternatively, provide the password in the <code class="language-plaintext highlighter-rouge">RAILS_INBOUND_EMAIL_PASSWORD</code>
environment variable.</p>

<p>Configure Exim to pipe inbound emails to <code class="language-plaintext highlighter-rouge">bin/rails
action_mailbox:ingress:exim</code>, providing the <code class="language-plaintext highlighter-rouge">URL</code> of the relay ingress and the
<code class="language-plaintext highlighter-rouge">INGRESS_PASSWORD</code> you previously generated. If your application lived at
<code class="language-plaintext highlighter-rouge">https://example.com</code>, the full command would look like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails action_mailbox:ingress:exim <span class="nv">URL</span><span class="o">=</span>https://example.com/rails/action_mailbox/relay/inbound_emails <span class="nv">INGRESS_PASSWORD</span><span class="o">=</span>...
</code></pre></div></div>

<h3 id="mailgun">Mailgun</h3>

<p>Give Action Mailbox your Mailgun Signing key (which you can find under Settings
-&gt; Security &amp; Users -&gt; API security in Mailgun), so it can authenticate requests
to the Mailgun ingress.</p>

<p>Use <code class="language-plaintext highlighter-rouge">bin/rails credentials:edit</code> to add your Signing key to your application’s
encrypted credentials under <code class="language-plaintext highlighter-rouge">action_mailbox.mailgun_signing_key</code>, where Action
Mailbox will automatically find it:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">mailgun_signing_key</span><span class="pi">:</span> <span class="s">...</span>
</code></pre></div></div>

<p>Alternatively, provide your Signing key in the <code class="language-plaintext highlighter-rouge">MAILGUN_INGRESS_SIGNING_KEY</code>
environment variable.</p>

<p>Tell Action Mailbox to accept emails from Mailgun:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:mailgun</span>
</code></pre></div></div>

<p><a href="https://documentation.mailgun.com/docs/mailgun/user-manual/receive-forward-store/">Configure
Mailgun</a>
to forward inbound emails to
<code class="language-plaintext highlighter-rouge">/rails/action_mailbox/mailgun/inbound_emails/mime</code>. If your application lived
at <code class="language-plaintext highlighter-rouge">https://example.com</code>, you would specify the fully-qualified URL
<code class="language-plaintext highlighter-rouge">https://example.com/rails/action_mailbox/mailgun/inbound_emails/mime</code>.</p>

<h3 id="mandrill">Mandrill</h3>

<p>Give Action Mailbox your Mandrill API key, so it can authenticate requests to
the Mandrill ingress.</p>

<p>Use <code class="language-plaintext highlighter-rouge">bin/rails credentials:edit</code> to add your API key to your application’s
encrypted credentials under <code class="language-plaintext highlighter-rouge">action_mailbox.mandrill_api_key</code>, where Action
Mailbox will automatically find it:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">mandrill_api_key</span><span class="pi">:</span> <span class="s">...</span>
</code></pre></div></div>

<p>Alternatively, provide your API key in the <code class="language-plaintext highlighter-rouge">MANDRILL_INGRESS_API_KEY</code>
environment variable.</p>

<p>Tell Action Mailbox to accept emails from Mandrill:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:mandrill</span>
</code></pre></div></div>

<p><a href="https://mandrill.zendesk.com/hc/en-us/articles/205583197-Inbound-Email-Processing-Overview">Configure
Mandrill</a>
to route inbound emails to <code class="language-plaintext highlighter-rouge">/rails/action_mailbox/mandrill/inbound_emails</code>. If
your application lived at <code class="language-plaintext highlighter-rouge">https://example.com</code>, you would specify the
fully-qualified URL
<code class="language-plaintext highlighter-rouge">https://example.com/rails/action_mailbox/mandrill/inbound_emails</code>.</p>

<h3 id="postfix">Postfix</h3>

<p>Tell Action Mailbox to accept emails from an SMTP relay:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:relay</span>
</code></pre></div></div>

<p>Generate a strong password that Action Mailbox can use to authenticate requests
to the relay ingress.</p>

<p>Use <code class="language-plaintext highlighter-rouge">bin/rails credentials:edit</code> to add the password to your application’s
encrypted credentials under <code class="language-plaintext highlighter-rouge">action_mailbox.ingress_password</code>, where Action
Mailbox will automatically find it:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">ingress_password</span><span class="pi">:</span> <span class="s">...</span>
</code></pre></div></div>

<p>Alternatively, provide the password in the <code class="language-plaintext highlighter-rouge">RAILS_INBOUND_EMAIL_PASSWORD</code>
environment variable.</p>

<p><a href="https://serverfault.com/questions/258469/how-to-configure-postfix-to-pipe-all-incoming-email-to-a-script">Configure
Postfix</a>
to pipe inbound emails to <code class="language-plaintext highlighter-rouge">bin/rails action_mailbox:ingress:postfix</code>, providing
the <code class="language-plaintext highlighter-rouge">URL</code> of the Postfix ingress and the <code class="language-plaintext highlighter-rouge">INGRESS_PASSWORD</code> you previously
generated. If your application lived at <code class="language-plaintext highlighter-rouge">https://example.com</code>, the full command
would look like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails action_mailbox:ingress:postfix <span class="nv">URL</span><span class="o">=</span>https://example.com/rails/action_mailbox/relay/inbound_emails <span class="nv">INGRESS_PASSWORD</span><span class="o">=</span>...
</code></pre></div></div>

<h3 id="postmark">Postmark</h3>

<p>Tell Action Mailbox to accept emails from Postmark:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:postmark</span>
</code></pre></div></div>

<p>Generate a strong password that Action Mailbox can use to authenticate requests
to the Postmark ingress.</p>

<p>Use <code class="language-plaintext highlighter-rouge">bin/rails credentials:edit</code> to add the password to your application’s
encrypted credentials under <code class="language-plaintext highlighter-rouge">action_mailbox.ingress_password</code>, where Action
Mailbox will automatically find it:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">ingress_password</span><span class="pi">:</span> <span class="s">...</span>
</code></pre></div></div>

<p>Alternatively, provide the password in the <code class="language-plaintext highlighter-rouge">RAILS_INBOUND_EMAIL_PASSWORD</code>
environment variable.</p>

<p><a href="https://postmarkapp.com/manual#configure-your-inbound-webhook-url">Configure Postmark inbound
webhook</a> to
forward inbound emails to <code class="language-plaintext highlighter-rouge">/rails/action_mailbox/postmark/inbound_emails</code> with
the username <code class="language-plaintext highlighter-rouge">actionmailbox</code> and the password you previously generated. If your
application lived at <code class="language-plaintext highlighter-rouge">https://example.com</code>, you would configure Postmark with
the following fully-qualified URL:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://actionmailbox:PASSWORD@example.com/rails/action_mailbox/postmark/inbound_emails
</code></pre></div></div>

<p>NOTE: When configuring your Postmark inbound webhook, be sure to check the box
labeled <strong>“Include raw email content in JSON payload”</strong>. Action Mailbox needs
the raw email content to work.</p>

<h3 id="qmail">Qmail</h3>

<p>Tell Action Mailbox to accept emails from an SMTP relay:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:relay</span>
</code></pre></div></div>

<p>Generate a strong password that Action Mailbox can use to authenticate requests
to the relay ingress.</p>

<p>Use <code class="language-plaintext highlighter-rouge">bin/rails credentials:edit</code> to add the password to your application’s
encrypted credentials under <code class="language-plaintext highlighter-rouge">action_mailbox.ingress_password</code>, where Action
Mailbox will automatically find it:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">ingress_password</span><span class="pi">:</span> <span class="s">...</span>
</code></pre></div></div>

<p>Alternatively, provide the password in the <code class="language-plaintext highlighter-rouge">RAILS_INBOUND_EMAIL_PASSWORD</code>
environment variable.</p>

<p>Configure Qmail to pipe inbound emails to <code class="language-plaintext highlighter-rouge">bin/rails
action_mailbox:ingress:qmail</code>, providing the <code class="language-plaintext highlighter-rouge">URL</code> of the relay ingress and the
<code class="language-plaintext highlighter-rouge">INGRESS_PASSWORD</code> you previously generated. If your application lived at
<code class="language-plaintext highlighter-rouge">https://example.com</code>, the full command would look like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails action_mailbox:ingress:qmail <span class="nv">URL</span><span class="o">=</span>https://example.com/rails/action_mailbox/relay/inbound_emails <span class="nv">INGRESS_PASSWORD</span><span class="o">=</span>...
</code></pre></div></div>

<h3 id="sendgrid">SendGrid</h3>

<p>Tell Action Mailbox to accept emails from SendGrid:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/production.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">action_mailbox</span><span class="p">.</span><span class="nf">ingress</span> <span class="o">=</span> <span class="ss">:sendgrid</span>
</code></pre></div></div>

<p>Generate a strong password that Action Mailbox can use to authenticate requests
to the SendGrid ingress.</p>

<p>Use <code class="language-plaintext highlighter-rouge">bin/rails credentials:edit</code> to add the password to your application’s
encrypted credentials under <code class="language-plaintext highlighter-rouge">action_mailbox.ingress_password</code>, where Action
Mailbox will automatically find it:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">action_mailbox</span><span class="pi">:</span>
  <span class="na">ingress_password</span><span class="pi">:</span> <span class="s">...</span>
</code></pre></div></div>

<p>Alternatively, provide the password in the <code class="language-plaintext highlighter-rouge">RAILS_INBOUND_EMAIL_PASSWORD</code>
environment variable.</p>

<p><a href="https://sendgrid.com/docs/for-developers/parsing-email/setting-up-the-inbound-parse-webhook/">Configure SendGrid Inbound
Parse</a>
to forward inbound emails to <code class="language-plaintext highlighter-rouge">/rails/action_mailbox/sendgrid/inbound_emails</code>
with the username <code class="language-plaintext highlighter-rouge">actionmailbox</code> and the password you previously generated. If
your application lived at <code class="language-plaintext highlighter-rouge">https://example.com</code>, you would configure SendGrid
with the following URL:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://actionmailbox:PASSWORD@example.com/rails/action_mailbox/sendgrid/inbound_emails
</code></pre></div></div>

<p>NOTE: When configuring your SendGrid Inbound Parse webhook, be sure to check the
box labeled <strong>“Post the raw, full MIME message.”</strong> Action Mailbox needs the raw
MIME message to work.</p>

<h2 id="processing-incoming-email">Processing Incoming Email</h2>

<p>Processing incoming emails usually entails using the email content to create
models, update views, queue background work, etc. in your Rails application.</p>

<p>Before you can start processing incoming emails, you’ll need to setup Action
Mailbox routing and create mailboxes.</p>

<h3 id="configure-routing">Configure Routing</h3>

<p>After an incoming email is received via the configured ingress, it needs to be
forwarded to a mailbox for actual processing by your application. Much like the
<a href="routing.html">Rails router</a> that dispatches URLs to controllers, routing in
Action Mailbox defines which emails go to which mailboxes for processing. Routes
are added to the <code class="language-plaintext highlighter-rouge">application_mailbox.rb</code> file using regular expressions:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/mailboxes/application_mailbox.rb</span>
<span class="k">class</span> <span class="nc">ApplicationMailbox</span> <span class="o">&lt;</span> <span class="no">ActionMailbox</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">routing</span><span class="p">(</span><span class="sr">/^save@/i</span>     <span class="o">=&gt;</span> <span class="ss">:forwards</span><span class="p">)</span>
  <span class="n">routing</span><span class="p">(</span><span class="sr">/@replies\./i</span> <span class="o">=&gt;</span> <span class="ss">:replies</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The regular expression matches the incoming email’s <code class="language-plaintext highlighter-rouge">to</code>, <code class="language-plaintext highlighter-rouge">cc</code>, or <code class="language-plaintext highlighter-rouge">bcc</code> fields.
For example, the above will match any email sent to <code class="language-plaintext highlighter-rouge">save@</code> to a “forwards”
mailbox. There are other ways to route an email, see
<a href="https://api.rubyonrails.org/classes/ActionMailbox/Base.html"><code class="language-plaintext highlighter-rouge">ActionMailbox::Base</code></a>
for more.</p>

<p>We need to create that “forwards” mailbox next.</p>

<h3 id="create-a-mailbox">Create a Mailbox</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Generate new mailbox</span>
<span class="nv">$ </span>bin/rails generate mailbox forwards
</code></pre></div></div>

<p>This creates <code class="language-plaintext highlighter-rouge">app/mailboxes/forwards_mailbox.rb</code>, with a <code class="language-plaintext highlighter-rouge">ForwardsMailbox</code> class
and a <code class="language-plaintext highlighter-rouge">process</code> method.</p>

<h3 id="process-email">Process Email</h3>

<p>When processing an <code class="language-plaintext highlighter-rouge">InboundEmail</code>, you can get the parsed version of the email
as a <a href="https://github.com/mikel/mail"><code class="language-plaintext highlighter-rouge">Mail</code></a> object with <code class="language-plaintext highlighter-rouge">InboundEmail#mail</code>.
You can also get the raw source directly using the <code class="language-plaintext highlighter-rouge">#source</code> method. With the
<code class="language-plaintext highlighter-rouge">Mail</code> object, you can access the relevant fields, such as <code class="language-plaintext highlighter-rouge">mail.to</code>,
<code class="language-plaintext highlighter-rouge">mail.body.decoded</code>, etc.</p>

<div class="language-irb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">mail</span>
<span class="gp">=&gt; #&lt;Mail::Message:33780, Multipart: false, Headers: &lt;Date: Wed, 31 Jan 2024 22:18:40 -0600&gt;, &lt;From: someone@hey.com&gt;, &lt;To: save@example.com&gt;, &lt;Message-ID: &lt;65bb1ba066830_50303a70397e@Bhumis-MacBook-Pro.local.mail&gt;&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="no">In</span><span class="o">-</span><span class="no">Reply</span><span class="o">-</span><span class="no">To</span><span class="p">:</span> <span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="no">Subject</span><span class="p">:</span> <span class="no">Hello</span> <span class="no">Action</span> <span class="no">Mailbox</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="no">Mime</span><span class="o">-</span><span class="no">Version</span><span class="p">:</span> <span class="mf">1.0</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="no">Content</span><span class="o">-</span><span class="no">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span><span class="p">;</span> <span class="n">charset</span><span class="o">=</span><span class="no">UTF</span><span class="o">-</span><span class="mi">8</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="no">Content</span><span class="o">-</span><span class="no">Transfer</span><span class="o">-</span><span class="no">Encoding</span><span class="p">:</span> <span class="mi">7</span><span class="n">bit</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">x</span><span class="o">-</span><span class="n">original</span><span class="o">-</span><span class="ss">to: </span><span class="o">&gt;&gt;</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">mail</span><span class="p">.</span><span class="nf">to</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"save@example.com"</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">mail</span><span class="p">.</span><span class="nf">from</span>
<span class="p">=&gt;</span> <span class="p">[</span><span class="s2">"someone@hey.com"</span><span class="p">]</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">mail</span><span class="p">.</span><span class="nf">date</span>
<span class="p">=&gt;</span> <span class="no">Wed</span><span class="p">,</span> <span class="mi">31</span> <span class="no">Jan</span> <span class="mi">2024</span> <span class="mi">22</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span><span class="mi">40</span> <span class="o">-</span><span class="mo">0600</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">mail</span><span class="p">.</span><span class="nf">subject</span>
<span class="p">=&gt;</span> <span class="s2">"Hello Action Mailbox"</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">mail</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">decoded</span>
<span class="p">=&gt;</span> <span class="s2">"This is the body of the email message."</span>
<span class="c"># mail.decoded, a shorthand for mail.body.decoded, also works
</span><span class="gp">irb&gt;</span><span class="w"> </span><span class="n">mail</span><span class="p">.</span><span class="nf">decoded</span>
<span class="p">=&gt;</span> <span class="s2">"This is the body of the email message."</span>
<span class="gp">irb&gt;</span><span class="w"> </span><span class="n">mail</span><span class="p">.</span><span class="nf">body</span>
<span class="gp">=&gt; &lt;Mail::Body:0x00007fc74cbf46c0 @boundary=nil, @preamble=nil, @epilogue=nil, @charset="US-ASCII", @part_sort_order=["text/plain", "text/enriched", "text/html", "multipart/alternative"], @parts=[], @raw_source="This is the body of the email message.", @ascii_only=true, @encoding="7bit"&gt;</span><span class="w">
</span></code></pre></div></div>

<h3 id="inbound-email-status">Inbound Email Status</h3>

<p>While the email is being routed to a matching mailbox and processed, Action
Mailbox updates the email status stored in <code class="language-plaintext highlighter-rouge">action_mailbox_inbound_emails</code> table
with one of the following values:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pending</code>: Received by one of the ingress controllers and scheduled for
routing.</li>
  <li><code class="language-plaintext highlighter-rouge">processing</code>: During active processing, while a specific mailbox is running
its <code class="language-plaintext highlighter-rouge">process</code> method.</li>
  <li><code class="language-plaintext highlighter-rouge">delivered</code>: Successfully processed by the specific mailbox.</li>
  <li><code class="language-plaintext highlighter-rouge">failed</code>: An exception was raised during the specific mailbox’s execution of
the <code class="language-plaintext highlighter-rouge">process</code> method.</li>
  <li><code class="language-plaintext highlighter-rouge">bounced</code>: Rejected processing by the specific mailbox and bounced to sender.</li>
</ul>

<p>If the email is marked either <code class="language-plaintext highlighter-rouge">delivered</code>, <code class="language-plaintext highlighter-rouge">failed</code>, or <code class="language-plaintext highlighter-rouge">bounced</code> it’s
considered “processed” and marked for
<a href="#incineration-of-inboundemails">incineration</a>.</p>

<h2 id="example">Example</h2>

<p>Here is an example of an Action Mailbox that processes emails to create
“forwards” for the user’s project.</p>

<p>The <code class="language-plaintext highlighter-rouge">before_processing</code> callback is used to ensure that certain conditions are
met before <code class="language-plaintext highlighter-rouge">process</code> method is called. In this case, <code class="language-plaintext highlighter-rouge">before_processing</code> checks
that the user has at least one project. Other supported <a href="https://api.rubyonrails.org/classes/ActionMailbox/Callbacks.html">Action Mailbox
callbacks</a> are
<code class="language-plaintext highlighter-rouge">after_processing</code> and <code class="language-plaintext highlighter-rouge">around_processing</code>.</p>

<p>The email can be bounced using <code class="language-plaintext highlighter-rouge">bounced_with</code> if the “forwarder” has no
projects. The “forwarder” is a <code class="language-plaintext highlighter-rouge">User</code> with the same email as <code class="language-plaintext highlighter-rouge">mail.from</code>.</p>

<p>If the “forwarder” does have at least one project, the <code class="language-plaintext highlighter-rouge">record_forward</code> method
creates an Active Record model in the application using the email data
<code class="language-plaintext highlighter-rouge">mail.subject</code> and <code class="language-plaintext highlighter-rouge">mail.decoded</code>. Otherwise, it sends an email, using Action
Mailer, requesting the “forwarder” to choose a project.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/mailboxes/forwards_mailbox.rb</span>
<span class="k">class</span> <span class="nc">ForwardsMailbox</span> <span class="o">&lt;</span> <span class="no">ApplicationMailbox</span>
  <span class="c1"># Callbacks specify prerequisites to processing</span>
  <span class="n">before_processing</span> <span class="ss">:require_projects</span>

  <span class="k">def</span> <span class="nf">process</span>
    <span class="c1"># Record the forward on the one project, or…</span>
    <span class="k">if</span> <span class="n">forwarder</span><span class="p">.</span><span class="nf">projects</span><span class="p">.</span><span class="nf">one?</span>
      <span class="n">record_forward</span>
    <span class="k">else</span>
      <span class="c1"># …involve a second Action Mailer to ask which project to forward into.</span>
      <span class="n">request_forwarding_project</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="k">def</span> <span class="nf">require_projects</span>
      <span class="k">if</span> <span class="n">forwarder</span><span class="p">.</span><span class="nf">projects</span><span class="p">.</span><span class="nf">none?</span>
        <span class="c1"># Use Action Mailers to bounce incoming emails back to sender – this halts processing</span>
        <span class="n">bounce_with</span> <span class="no">Forwards</span><span class="o">::</span><span class="no">BounceMailer</span><span class="p">.</span><span class="nf">no_projects</span><span class="p">(</span><span class="n">inbound_email</span><span class="p">,</span> <span class="ss">forwarder: </span><span class="n">forwarder</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">record_forward</span>
      <span class="n">forwarder</span><span class="p">.</span><span class="nf">forwards</span><span class="p">.</span><span class="nf">create</span> <span class="ss">subject: </span><span class="n">mail</span><span class="p">.</span><span class="nf">subject</span><span class="p">,</span> <span class="ss">content: </span><span class="n">mail</span><span class="p">.</span><span class="nf">decoded</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">request_forwarding_project</span>
      <span class="no">Forwards</span><span class="o">::</span><span class="no">RoutingMailer</span><span class="p">.</span><span class="nf">choose_project</span><span class="p">(</span><span class="n">inbound_email</span><span class="p">,</span> <span class="ss">forwarder: </span><span class="n">forwarder</span><span class="p">).</span><span class="nf">deliver_now</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">forwarder</span>
      <span class="vi">@forwarder</span> <span class="o">||=</span> <span class="no">User</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="ss">email_address: </span><span class="n">mail</span><span class="p">.</span><span class="nf">from</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="local-development-and-testing">Local Development and Testing</h2>

<p>It’s helpful to be able to test incoming emails in development without actually
sending and receiving real emails. To accomplish this, there’s a conductor
controller mounted at <code class="language-plaintext highlighter-rouge">/rails/conductor/action_mailbox/inbound_emails</code>, which
gives you an index of all the InboundEmails in the system, their state of
processing, and a form to create a new InboundEmail as well.</p>

<p>Here is and example of testing an inbound email with Action Mailbox TestHelpers.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ForwardsMailboxTest</span> <span class="o">&lt;</span> <span class="no">ActionMailbox</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"directly recording a client forward for a forwarder and forwardee corresponding to one project"</span> <span class="k">do</span>
    <span class="n">assert_difference</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">people</span><span class="p">(</span><span class="ss">:david</span><span class="p">).</span><span class="nf">buckets</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">recordings</span><span class="p">.</span><span class="nf">count</span> <span class="p">}</span> <span class="k">do</span>
      <span class="n">receive_inbound_email_from_mail</span> <span class="p">\</span>
        <span class="ss">to: </span><span class="s2">"save@example.com"</span><span class="p">,</span>
        <span class="ss">from: </span><span class="n">people</span><span class="p">(</span><span class="ss">:david</span><span class="p">).</span><span class="nf">email_address</span><span class="p">,</span>
        <span class="ss">subject: </span><span class="s2">"Fwd: Status update?"</span><span class="p">,</span>
        <span class="ss">body: </span><span class="o">&lt;&lt;~</span><span class="no">BODY</span><span class="sh">
          --- Begin forwarded message ---
          From: Frank Holland &lt;frank@microsoft.com&gt;

          What's the status?
</span><span class="no">        BODY</span>
    <span class="k">end</span>

    <span class="n">recording</span> <span class="o">=</span> <span class="n">people</span><span class="p">(</span><span class="ss">:david</span><span class="p">).</span><span class="nf">buckets</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span><span class="nf">recordings</span><span class="p">.</span><span class="nf">last</span>
    <span class="n">assert_equal</span> <span class="n">people</span><span class="p">(</span><span class="ss">:david</span><span class="p">),</span> <span class="n">recording</span><span class="p">.</span><span class="nf">creator</span>
    <span class="n">assert_equal</span> <span class="s2">"Status update?"</span><span class="p">,</span> <span class="n">recording</span><span class="p">.</span><span class="nf">forward</span><span class="p">.</span><span class="nf">subject</span>
    <span class="n">assert_match</span> <span class="s2">"What's the status?"</span><span class="p">,</span> <span class="n">recording</span><span class="p">.</span><span class="nf">forward</span><span class="p">.</span><span class="nf">content</span><span class="p">.</span><span class="nf">to_s</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Please refer to the <a href="https://api.rubyonrails.org/classes/ActionMailbox/TestHelper.html">ActionMailbox::TestHelper
API</a> for
further test helper methods.</p>

<h2 id="incineration-of-inboundemails">Incineration of InboundEmails</h2>

<p>By default, an <code class="language-plaintext highlighter-rouge">InboundEmail</code> that has been processed will be incinerated after
30 days. The <code class="language-plaintext highlighter-rouge">InboundEmail</code> is considered as processed when its status changes
to <code class="language-plaintext highlighter-rouge">delivered</code>, <code class="language-plaintext highlighter-rouge">failed</code>, or <code class="language-plaintext highlighter-rouge">bounced</code>.</p>

<p>The actual incineration is done via the
<a href="https://api.rubyonrails.org/classes/ActionMailbox/IncinerationJob.html"><code class="language-plaintext highlighter-rouge">IncinerationJob</code></a>
that’s scheduled to run after
<a href="configuring.html#config-action-mailbox-incinerate-after"><code class="language-plaintext highlighter-rouge">config.action_mailbox.incinerate_after</code></a>
time. This value is set to <code class="language-plaintext highlighter-rouge">30.days</code> by default, but you can change it in your
production.rb configuration. (Note that this far-future incineration scheduling
relies on your job queue being able to hold jobs for that long.)</p>

<p>Default data incineration ensures that you’re not holding on to people’s data
unnecessarily after they may have canceled their accounts or deleted their
content.</p>

<p>The intention with Action Mailbox processing is that as you process an email,
you should extract all the data you need from the email and persist it into
domain models in your application. The <code class="language-plaintext highlighter-rouge">InboundEmail</code> stays in the system for
the configured time to allow for debugging and forensics and then will be
deleted.</p>

        </div>

        <footer class="guide-footer">
            <div class="feedback">
                <h3>Geri Bildirim</h3>
                <p>Bu kılavuzun kalitesini artırmamıza yardımcı olmak için geri bildirimlerinizi bekliyoruz.</p>
                <p>Lütfen <a href="https://github.com/dilankaya127/rails-tr-TR">GitHub Issues</a> üzerinden katkıda bulunun.</p>
            </div>
        </footer>
    </article>
</div>

<script>
// İçindekiler tablosunu otomatik oluştur
document.addEventListener('DOMContentLoaded', function() {
    const toc = document.getElementById('toc');
    const headings = document.querySelectorAll('.guide-content h2, .guide-content h3, .guide-content h4');
    
    if (headings.length > 0) {
        const tocList = document.createElement('ul');
        
        headings.forEach(function(heading, index) {
            const id = 'heading-' + index;
            heading.id = id;
            
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = heading.textContent;
            a.className = 'toc-' + heading.tagName.toLowerCase();
            
            li.appendChild(a);
            tocList.appendChild(li);
        });
        
        toc.appendChild(tocList);
    }
});
</script>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Rails Kılavuzları Türkçe Çevirisi. Gönüllüler tarafından hazırlanmıştır.</p>
            <p>Orijinal dokümantasyon <a href="https://guides.rubyonrails.org">Ruby on Rails</a> ekibine aittir.</p>
        </div>
    </footer>

    <script>hljs.highlightAll();</script>
</body>
</html>