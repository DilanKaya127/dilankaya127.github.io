<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing - Rails Dokümantasyonu - Türkçe</title>
    <link rel="stylesheet" href="/rails-tr-TR/assets/css/main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <h1 class="logo">
                    <a href="/rails-tr-TR/">Rails Kılavuzları</a>
                </h1>
                <nav class="nav">
                    <a href="/rails-tr-TR/">Ana Sayfa</a>
                    <a href="https://dilankaya127.github.io">Portföy</a>
                    <a href="https://github.com/dilankaya127/rails-tr-TR">GitHub</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="guide-container">
    <aside class="guide-sidebar">
        <div class="guide-toc">
            <h3>İçindekiler</h3>
            <div id="toc"></div>
        </div>
        
        <div class="guide-nav">
            <h3>Diğer Kılavuzlar</h3>
            <ul>
                <li><a href="/rails-tr-TR/guides/getting_started">Rails ile Başlarken</a></li>
                <li><a href="/rails-tr-TR/guides/active_record_basics">Active Record Temelleri</a></li>
                <li><a href="/rails-tr-TR/guides/action_controller_overview">Action Controller</a></li>
                <li><a href="/rails-tr-TR/guides/action_view_overview">Action View</a></li>
                <li><a href="/rails-tr-TR/guides/routing">Yönlendirme</a></li>
                <li><a href="/rails-tr-TR/guides/action_cable_overview">Action Cable</a></li>
            </ul>
        </div>
    </aside>

    <article class="guide-content">
        <header class="guide-header">
            <h1>Testing</h1>
            
        </header>

        <div class="guide-body">
            <p><strong>DO NOT READ THIS FILE ON GITHUB, GUIDES ARE PUBLISHED ON <a href="https://guides.rubyonrails.org">https://guides.rubyonrails.org</a>.</strong></p>

<h1 id="testing-rails-applications">Testing Rails Applications</h1>

<p>This guide explores how to write tests in Rails.</p>

<p>After reading this guide, you will know:</p>

<ul>
  <li>Rails testing terminology.</li>
  <li>How to write unit, functional, integration, and system tests for your
application.</li>
  <li>Other popular testing approaches and plugins.</li>
</ul>

<hr />

<h2 id="why-write-tests">Why Write Tests?</h2>

<p>Writing automated tests can be a faster way of ensuring your code continues to
work as expected than manual testing through the browser or the console. Failing
tests can quickly reveal issues, allowing you to identify and fix bugs early in
the development process. This practice not only improves the reliability of your
code but also improves confidence in your changes.</p>

<p>Rails makes it easy to write tests. You can read more about Rails’ built in
support for testing in the next section.</p>

<h2 id="introduction-to-testing">Introduction to Testing</h2>

<p>With Rails, testing is central to the development process right from the
creation of a new application.</p>

<h3 id="test-setup">Test Setup</h3>

<p>Rails creates a <code class="language-plaintext highlighter-rouge">test</code> directory for you as soon as you create a Rails project
using <code class="language-plaintext highlighter-rouge">bin/rails new</code> <em>application_name</em>. If you list the contents of this directory
then you will see:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-F</span> <span class="nb">test
</span>application_system_test_case.rb  controllers/                     helpers/                         mailers/                         system/                          fixtures/                        integration/                     models/                          test_helper.rb
</code></pre></div></div>

<h3 id="test-directories">Test Directories</h3>

<p>The <code class="language-plaintext highlighter-rouge">helpers</code>, <code class="language-plaintext highlighter-rouge">mailers</code>, and <code class="language-plaintext highlighter-rouge">models</code> directories store tests for <a href="#testing-view-helpers">view
helpers</a>, <a href="#testing-mailers">mailers</a>, and
<a href="#testing-models">models</a>, respectively.</p>

<p>The <code class="language-plaintext highlighter-rouge">controllers</code> directory is used for
<a href="#functional-testing-for-controllers">tests related to controllers</a>, routes, and
views, where HTTP requests will be simulated and assertions made on the
outcomes.</p>

<p>The <code class="language-plaintext highlighter-rouge">integration</code> directory is reserved for <a href="#integration-testing">tests that cover
interactions between controllers</a>.</p>

<p>The <code class="language-plaintext highlighter-rouge">system</code> test directory holds <a href="#system-testing">system tests</a>, which are
used for full browser testing of your application. System tests allow you to
test your application the way your users experience it and help you test your
JavaScript as well. System tests inherit from
<a href="https://github.com/teamcapybara/capybara">Capybara</a> and perform in-browser
tests for your application.</p>

<p><a href="https://api.rubyonrails.org/v3.1/classes/ActiveRecord/Fixtures.html">Fixtures</a>
are a way of mocking up data to use in your tests, so that you don’t have to use
‘real’ data. They are stored in the <code class="language-plaintext highlighter-rouge">fixtures</code> directory, and you can read more
about them in the <a href="#fixtures">Fixtures</a> section below.</p>

<p>A <code class="language-plaintext highlighter-rouge">jobs</code> directory will also be created for your job tests when you first
<a href="active_job_basics.html#create-the-job">generate a job</a>.</p>

<p>The <code class="language-plaintext highlighter-rouge">test_helper.rb</code> file holds the default configuration for your tests.</p>

<p>The <code class="language-plaintext highlighter-rouge">application_system_test_case.rb</code> holds the default configuration for your
system tests.</p>

<h3 id="the-test-environment">The Test Environment</h3>

<p>By default, every Rails application has three environments: development, test,
and production.</p>

<p>Each environment’s configuration can be modified similarly. In this case, we can
modify our test environment by changing the options found in
<code class="language-plaintext highlighter-rouge">config/environments/test.rb</code>.</p>

<p>NOTE: Your tests are run under <code class="language-plaintext highlighter-rouge">RAILS_ENV=test</code>. This is set by Rails automatically.</p>

<h3 id="writing-your-first-test">Writing Your First Test</h3>

<p>We introduced the <code class="language-plaintext highlighter-rouge">bin/rails generate model</code> command in the <a href="getting_started.html#creating-a-database-model">Getting Started
with Rails</a> guide.
Alongside creating a model, this command also creates a test stub in the <code class="language-plaintext highlighter-rouge">test</code>
directory:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate model article title:string body:text
...
create  app/models/article.rb
create  <span class="nb">test</span>/models/article_test.rb
...
</code></pre></div></div>

<p>The default test stub in <code class="language-plaintext highlighter-rouge">test/models/article_test.rb</code> looks like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ArticleTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># test "the truth" do</span>
  <span class="c1">#   assert true</span>
  <span class="c1"># end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>A line by line examination of this file will help get you oriented to Rails
testing code and terminology.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>
</code></pre></div></div>

<p>Requiring the file, <code class="language-plaintext highlighter-rouge">test_helper.rb</code>, loads the default configuration to run
tests. All methods added to this file are also available in tests when this file
is included.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ArticleTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This is called a test case, because the <code class="language-plaintext highlighter-rouge">ArticleTest</code> class inherits from
<code class="language-plaintext highlighter-rouge">ActiveSupport::TestCase</code>. It therefore also has all the methods from
<code class="language-plaintext highlighter-rouge">ActiveSupport::TestCase</code> available to it. <a href="#assertions-in-test-cases">Later in this
guide</a>, we’ll see some of the methods this gives us.</p>

<p>Any method defined within a class inherited from <code class="language-plaintext highlighter-rouge">Minitest::Test</code> (which is the
superclass of <code class="language-plaintext highlighter-rouge">ActiveSupport::TestCase</code>) that begins with <code class="language-plaintext highlighter-rouge">test_</code> is simply
called a test. So, methods defined as <code class="language-plaintext highlighter-rouge">test_password</code> and <code class="language-plaintext highlighter-rouge">test_valid_password</code>
are test names and are run automatically when the test case is run.</p>

<p>Rails also adds a <code class="language-plaintext highlighter-rouge">test</code> method that takes a test name and a block. It generates
a standard <code class="language-plaintext highlighter-rouge">Minitest::Unit</code> test with method names prefixed with <code class="language-plaintext highlighter-rouge">test_</code>,
allowing you to focus on writing the test logic without having to think about
naming the methods. For example, you can write:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"the truth"</span> <span class="k">do</span>
  <span class="n">assert</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Which is approximately the same as writing this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test_the_truth</span>
  <span class="n">assert</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Although you can still use regular method definitions, using the <code class="language-plaintext highlighter-rouge">test</code> macro
allows for a more readable test name.</p>

<p>NOTE: The method name is generated by replacing spaces with underscores. The
result does not need to be a valid Ruby identifier, as Ruby allows any string to
serve as a method name, including those containing punctuation characters. While
this may require using <code class="language-plaintext highlighter-rouge">define_method</code> and <code class="language-plaintext highlighter-rouge">send</code> to define and invoke such
methods, there are few formal restrictions on the names themselves.</p>

<p>This part of a test is called an ‘assertion’:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">assert</span> <span class="kp">true</span>
</code></pre></div></div>

<p>An assertion is a line of code that evaluates an object (or expression) for
expected results. For example, an assertion can check:</p>

<ul>
  <li>does this value equal that value?</li>
  <li>is this object nil?</li>
  <li>does this line of code throw an exception?</li>
  <li>is the user’s password greater than 5 characters?</li>
</ul>

<p>Every test may contain one or more assertions, with no restriction as to how
many assertions are allowed. Only when all the assertions are successful will
the test pass.</p>

<h4 id="your-first-failing-test">Your First Failing Test</h4>

<p>To see how a test failure is reported, you can add a failing test to the
<code class="language-plaintext highlighter-rouge">article_test.rb</code> test case. In this example, it is asserted that the article
will not save without meeting certain criteria; hence, if the article saves
successfully, the test will fail, demonstrating a test failure.</p>

<pre><code class="language-ruby#4-7">require "test_helper"

class ArticleTest &lt; ActiveSupport::TestCase
  test "should not save article without title" do
    article = Article.new
    assert_not article.save
  end
end
</code></pre>

<p>Here is the output if this newly added test is run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/models/article_test.rb
Running 1 tests <span class="k">in </span>a single process <span class="o">(</span>parallelization threshold is 50<span class="o">)</span>
Run options: <span class="nt">--seed</span> 44656

<span class="c"># Running:</span>

F

Failure:
ArticleTest#test_should_not_save_article_without_title <span class="o">[</span>/path/to/blog/test/models/article_test.rb:4]:
Expected <span class="nb">true </span>to be nil or <span class="nb">false


</span>bin/rails <span class="nb">test test</span>/models/article_test.rb:4



Finished <span class="k">in </span>0.023918s, 41.8090 runs/s, 41.8090 assertions/s.

1 runs, 1 assertions, 1 failures, 0 errors, 0 skips
</code></pre></div></div>

<p>In the output, <code class="language-plaintext highlighter-rouge">F</code> indicates a test failure. The section under <code class="language-plaintext highlighter-rouge">Failure</code>
includes the name of the failing test, followed by a stack trace and a message
showing the actual value and the expected value from the assertion. The default
assertion messages offer just enough information to help identify the error. For
improved readability, every assertion allows an optional message parameter to
customize the failure message, as shown below:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"should not save article without title"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">new</span>
  <span class="n">assert_not</span> <span class="n">article</span><span class="p">.</span><span class="nf">save</span><span class="p">,</span> <span class="s2">"Saved the article without a title"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Running this test shows the friendlier assertion message:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Failure:
ArticleTest#test_should_not_save_article_without_title [/path/to/blog/test/models/article_test.rb:6]:
Saved the article without a title
</code></pre></div></div>

<p>To get this test to pass a model-level validation can be added for the <code class="language-plaintext highlighter-rouge">title</code>
field.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now the test should pass, as the article in our test has not been initialized
with a <code class="language-plaintext highlighter-rouge">title</code>, so the model validation will prevent the save. This can be
verified by running the test again:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/models/article_test.rb:6
Running 1 tests <span class="k">in </span>a single process <span class="o">(</span>parallelization threshold is 50<span class="o">)</span>
Run options: <span class="nt">--seed</span> 31252

<span class="c"># Running:</span>

<span class="nb">.</span>

Finished <span class="k">in </span>0.027476s, 36.3952 runs/s, 36.3952 assertions/s.

1 runs, 1 assertions, 0 failures, 0 errors, 0 skips
</code></pre></div></div>

<p>The small green dot displayed means that the test has passed successfully.</p>

<p>TIP: In the process above, a test was written first which fails for a desired
functionality, then after, some code was written which adds the functionality.
Finally, the test was run again to ensure it passes. This approach to software
development is referred to as <em>Test-Driven Development</em> (TDD).</p>

<h4 id="reporting-errors">Reporting Errors</h4>

<p>To see how an error gets reported, here’s a test containing an error:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"should report error"</span> <span class="k">do</span>
  <span class="c1"># some_undefined_variable is not defined elsewhere in the test case</span>
  <span class="n">some_undefined_variable</span>
  <span class="n">assert</span> <span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now you can see even more output in the console from running the tests:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/models/article_test.rb
Running 2 tests <span class="k">in </span>a single process <span class="o">(</span>parallelization threshold is 50<span class="o">)</span>
Run options: <span class="nt">--seed</span> 1808

<span class="c"># Running:</span>

E

Error:
ArticleTest#test_should_report_error:
NameError: undefined <span class="nb">local </span>variable or method <span class="s1">'some_undefined_variable'</span> <span class="k">for</span> <span class="c">#&lt;ArticleTest:0x007fee3aa71798&gt;</span>
    <span class="nb">test</span>/models/article_test.rb:11:in <span class="s1">'block in &lt;class:ArticleTest&gt;'</span>


bin/rails <span class="nb">test test</span>/models/article_test.rb:9

<span class="nb">.</span>

Finished <span class="k">in </span>0.040609s, 49.2500 runs/s, 24.6250 assertions/s.

2 runs, 1 assertions, 0 failures, 1 errors, 0 skips
</code></pre></div></div>

<p>Notice the ‘E’ in the output. It denotes a test with an error. The green dot
above the ‘Finished’ line denotes the one passing test.</p>

<p>NOTE: The execution of each test method stops as soon as any error or an
assertion failure is encountered, and the test suite continues with the next
method. All test methods are executed in random order. The
[<code class="language-plaintext highlighter-rouge">config.active_support.test_order</code>][] option can be used to configure test
order.</p>

<p>When a test fails you are presented with the corresponding backtrace. By
default, Rails filters the backtrace and will only print lines relevant to your
application. This eliminates noise and helps you to focus on your code. However,
in situations when you want to see the full backtrace, set the <code class="language-plaintext highlighter-rouge">-b</code> (or
<code class="language-plaintext highlighter-rouge">--backtrace</code>) argument to enable this behavior:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test</span> <span class="nt">-b</span> <span class="nb">test</span>/models/article_test.rb
</code></pre></div></div>

<p>If you want this test to pass you can modify it to use <code class="language-plaintext highlighter-rouge">assert_raises</code> (so you
are now checking for the presence of the error) like so:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"should report error"</span> <span class="k">do</span>
  <span class="c1"># some_undefined_variable is not defined elsewhere in the test case</span>
  <span class="n">assert_raises</span><span class="p">(</span><span class="no">NameError</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">some_undefined_variable</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This test should now pass.</p>

<p>[<code class="language-plaintext highlighter-rouge">config.active_support.test_order</code>]:
    configuring.html#config-active-support-test-order</p>

<h3 id="minitest-assertions">Minitest Assertions</h3>

<p>By now you’ve caught a glimpse of some of the assertions that are available.
Assertions are the foundation blocks of testing. They are the ones that actually
perform the checks to ensure that things are going as planned.</p>

<p>Here’s an extract of the assertions you can use with
<a href="https://github.com/minitest/minitest"><code class="language-plaintext highlighter-rouge">minitest</code></a>, the default testing library
used by Rails. The <code class="language-plaintext highlighter-rouge">[msg]</code> parameter is an optional string message you can
specify to make your test failure messages clearer.</p>

<table>
  <thead>
    <tr>
      <th>Assertion</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert(test, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">test</code> is true.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not(test, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">test</code> is false.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_equal(expected, actual, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">expected == actual</code> is true.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_equal(expected, actual, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">expected != actual</code> is true.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_same(expected, actual, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">expected.equal?(actual)</code> is true.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_same(expected, actual, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">expected.equal?(actual)</code> is false.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_nil(obj, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj.nil?</code> is true.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_nil(obj, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj.nil?</code> is false.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_empty(obj, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj</code> is <code class="language-plaintext highlighter-rouge">empty?</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_empty(obj, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj</code> is not <code class="language-plaintext highlighter-rouge">empty?</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_match(regexp, string, [msg])</code></td>
      <td>Ensures that a string matches the regular expression.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_no_match(regexp, string, [msg])</code></td>
      <td>Ensures that a string doesn’t match the regular expression.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_includes(collection, obj, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj</code> is in <code class="language-plaintext highlighter-rouge">collection</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_includes(collection, obj, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj</code> is not in <code class="language-plaintext highlighter-rouge">collection</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_in_delta(expected, actual, [delta], [msg])</code></td>
      <td>Ensures that the numbers <code class="language-plaintext highlighter-rouge">expected</code> and <code class="language-plaintext highlighter-rouge">actual</code> are within <code class="language-plaintext highlighter-rouge">delta</code> of each other.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_in_delta(expected, actual, [delta], [msg])</code></td>
      <td>Ensures that the numbers <code class="language-plaintext highlighter-rouge">expected</code> and <code class="language-plaintext highlighter-rouge">actual</code> are not within <code class="language-plaintext highlighter-rouge">delta</code> of each other.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_in_epsilon(expected, actual, [epsilon], [msg])</code></td>
      <td>Ensures that the numbers <code class="language-plaintext highlighter-rouge">expected</code> and <code class="language-plaintext highlighter-rouge">actual</code> have a relative error less than <code class="language-plaintext highlighter-rouge">epsilon</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_in_epsilon(expected, actual, [epsilon], [msg])</code></td>
      <td>Ensures that the numbers <code class="language-plaintext highlighter-rouge">expected</code> and <code class="language-plaintext highlighter-rouge">actual</code> have a relative error not less than <code class="language-plaintext highlighter-rouge">epsilon</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_throws(symbol, [msg]) { block }</code></td>
      <td>Ensures that the given block throws the symbol.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_raises(exception1, exception2, ...) { block }</code></td>
      <td>Ensures that the given block raises one of the given exceptions.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_instance_of(class, obj, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj</code> is an instance of <code class="language-plaintext highlighter-rouge">class</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_instance_of(class, obj, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj</code> is not an instance of <code class="language-plaintext highlighter-rouge">class</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_kind_of(class, obj, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj</code> is an instance of <code class="language-plaintext highlighter-rouge">class</code> or is descending from it.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_kind_of(class, obj, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj</code> is not an instance of <code class="language-plaintext highlighter-rouge">class</code> and is not descending from it.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_respond_to(obj, symbol, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj</code> responds to <code class="language-plaintext highlighter-rouge">symbol</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_respond_to(obj, symbol, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj</code> does not respond to <code class="language-plaintext highlighter-rouge">symbol</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_operator(obj1, operator, [obj2], [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj1.operator(obj2)</code> is true.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_operator(obj1, operator, [obj2], [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj1.operator(obj2)</code> is false.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_predicate(obj, predicate, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj.predicate</code> is true, e.g. <code class="language-plaintext highlighter-rouge">assert_predicate str, :empty?</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_not_predicate(obj, predicate, [msg])</code></td>
      <td>Ensures that <code class="language-plaintext highlighter-rouge">obj.predicate</code> is false, e.g. <code class="language-plaintext highlighter-rouge">assert_not_predicate str, :empty?</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_error_reported(class) { block }</code></td>
      <td>Ensures that the error class has been reported, e.g. <code class="language-plaintext highlighter-rouge">assert_error_reported IOError { Rails.error.report(IOError.new("Oops")) }</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_no_error_reported { block }</code></td>
      <td>Ensures that no errors have been reported, e.g. <code class="language-plaintext highlighter-rouge">assert_no_error_reported { perform_service }</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">flunk([msg])</code></td>
      <td>Ensures failure. This is useful to explicitly mark a test that isn’t finished yet.</td>
    </tr>
  </tbody>
</table>

<p>The above are a subset of assertions that minitest supports. For an exhaustive
and more up-to-date list, please check the <a href="http://docs.seattlerb.org/minitest/Minitest">minitest API
documentation</a>, specifically
<a href="http://docs.seattlerb.org/minitest/Minitest/Assertions.html"><code class="language-plaintext highlighter-rouge">Minitest::Assertions</code></a>.</p>

<p>With minitest you can add your own assertions. In fact, that’s exactly what
Rails does. It includes some specialized assertions to make your life easier.</p>

<p>NOTE: Creating your own assertions is a topic that we won’t cover in depth in
this guide.</p>

<h3 id="rails-specific-assertions">Rails-Specific Assertions</h3>

<p>Rails adds some custom assertions of its own to the <code class="language-plaintext highlighter-rouge">minitest</code> framework:</p>

<table>
  <thead>
    <tr>
      <th>Assertion</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActiveSupport/Testing/Assertions.html#method-i-assert_difference)"><code class="language-plaintext highlighter-rouge">assert_difference(expressions, difference = 1, message = nil) {...}</code></a></td>
      <td>Test numeric difference between the return value of an expression as a result of what is evaluated in the yielded block.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActiveSupport/Testing/Assertions.html#method-i-assert_no_difference"><code class="language-plaintext highlighter-rouge">assert_no_difference(expressions, message = nil, &amp;block)</code></a></td>
      <td>Asserts that the numeric result of evaluating an expression is not changed before and after invoking the passed in block.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActiveSupport/Testing/Assertions.html#method-i-assert_changes"><code class="language-plaintext highlighter-rouge">assert_changes(expressions, message = nil, from:, to:, &amp;block)</code></a></td>
      <td>Test that the result of evaluating an expression is changed after invoking the passed in block.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActiveSupport/Testing/Assertions.html#method-i-assert_no_changes"><code class="language-plaintext highlighter-rouge">assert_no_changes(expressions, message = nil, &amp;block)</code></a></td>
      <td>Test the result of evaluating an expression is not changed after invoking the passed in block.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActiveSupport/Testing/Assertions.html#method-i-assert_nothing_raised"><code class="language-plaintext highlighter-rouge">assert_nothing_raised { block }</code></a></td>
      <td>Ensures that the given block doesn’t raise any exceptions.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActionDispatch/Assertions/RoutingAssertions.html#method-i-assert_recognizes"><code class="language-plaintext highlighter-rouge">assert_recognizes(expected_options, path, extras = {}, message = nil)</code></a></td>
      <td>Asserts that the routing of the given path was handled correctly and that the parsed options (given in the expected_options hash) match path. Basically, it asserts that Rails recognizes the route given by expected_options.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActionDispatch/Assertions/RoutingAssertions.html#method-i-assert_generates"><code class="language-plaintext highlighter-rouge">assert_generates(expected_path, options, defaults = {}, extras = {}, message = nil)</code></a></td>
      <td>Asserts that the provided options can be used to generate the provided path. This is the inverse of assert_recognizes. The extra parameter is used to tell the request the names and values of additional request parameters that would be in a query string. The message parameter allows you to specify a custom error message for assertion failures.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActionDispatch/Assertions/RoutingAssertions.html#method-i-assert_routing"><code class="language-plaintext highlighter-rouge">assert_routing(expected_path, options, defaults = {}, extras = {}, message = nil)</code></a></td>
      <td>Asserts that <code class="language-plaintext highlighter-rouge">path</code> and <code class="language-plaintext highlighter-rouge">options</code> match both ways; in other words, it verifies that <code class="language-plaintext highlighter-rouge">path</code> generates <code class="language-plaintext highlighter-rouge">options</code> and then that <code class="language-plaintext highlighter-rouge">options</code> generates <code class="language-plaintext highlighter-rouge">path</code>. This essentially combines <code class="language-plaintext highlighter-rouge">assert_recognizes</code> and <code class="language-plaintext highlighter-rouge">assert_generates</code> into one step. The extras hash allows you to specify options that would normally be provided as a query string to the action. The message parameter allows you to specify a custom error message to display upon failure.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActionDispatch/Assertions/ResponseAssertions.html#method-i-assert_response"><code class="language-plaintext highlighter-rouge">assert_response(type, message = nil)</code></a></td>
      <td>Asserts that the response comes with a specific status code. You can specify <code class="language-plaintext highlighter-rouge">:success</code> to indicate 200-299, <code class="language-plaintext highlighter-rouge">:redirect</code> to indicate 300-399, <code class="language-plaintext highlighter-rouge">:missing</code> to indicate 404, or <code class="language-plaintext highlighter-rouge">:error</code> to match the 500-599 range. You can also pass an explicit status number or its symbolic equivalent. For more information, see <a href="https://rubydoc.info/gems/rack/Rack/Utils#HTTP_STATUS_CODES-constant">full list of status codes</a> and how their <a href="https://rubydoc.info/gems/rack/Rack/Utils#SYMBOL_TO_STATUS_CODE-constant">mapping</a> works.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActionDispatch/Assertions/ResponseAssertions.html#method-i-assert_redirected_to"><code class="language-plaintext highlighter-rouge">assert_redirected_to(options = {}, message = nil)</code></a></td>
      <td>Asserts that the response is a redirect to a URL matching the given options. You can also pass named routes such as <code class="language-plaintext highlighter-rouge">assert_redirected_to root_path</code> and Active Record objects such as <code class="language-plaintext highlighter-rouge">assert_redirected_to @article</code>.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActiveRecord/Assertions/QueryAssertions.html#method-i-assert_queries_count"><code class="language-plaintext highlighter-rouge">assert_queries_count(count = nil, include_schema: false, &amp;block)</code></a></td>
      <td>Asserts that <code class="language-plaintext highlighter-rouge">&amp;block</code> generates an <code class="language-plaintext highlighter-rouge">int</code> number of SQL queries.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActiveRecord/Assertions/QueryAssertions.html#method-i-assert_no_queries"><code class="language-plaintext highlighter-rouge">assert_no_queries(include_schema: false, &amp;block)</code></a></td>
      <td>Asserts that <code class="language-plaintext highlighter-rouge">&amp;block</code> generates no SQL queries.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActiveRecord/Assertions/QueryAssertions.html#method-i-assert_queries_match"><code class="language-plaintext highlighter-rouge">assert_queries_match(pattern, count: nil, include_schema: false, &amp;block)</code></a></td>
      <td>Asserts that <code class="language-plaintext highlighter-rouge">&amp;block</code> generates SQL queries that match the pattern.</td>
    </tr>
    <tr>
      <td><a href="https://api.rubyonrails.org/classes/ActiveRecord/Assertions/QueryAssertions.html#method-i-assert_no_queries_match"><code class="language-plaintext highlighter-rouge">assert_no_queries_match(pattern, &amp;block)</code></a></td>
      <td>Asserts that <code class="language-plaintext highlighter-rouge">&amp;block</code> generates no SQL queries that match the pattern.</td>
    </tr>
  </tbody>
</table>

<p>You’ll see the usage of some of these assertions in the next chapter.</p>

<h3 id="assertions-in-test-cases">Assertions in Test Cases</h3>

<p>All the basic assertions such as <code class="language-plaintext highlighter-rouge">assert_equal</code> defined in
<code class="language-plaintext highlighter-rouge">Minitest::Assertions</code> are also available in the classes we use in our own test
cases. In fact, Rails provides the following classes for you to inherit from:</p>

<ul>
  <li><a href="https://api.rubyonrails.org/classes/ActiveSupport/TestCase.html"><code class="language-plaintext highlighter-rouge">ActiveSupport::TestCase</code></a></li>
  <li><a href="https://api.rubyonrails.org/classes/ActionMailer/TestCase.html"><code class="language-plaintext highlighter-rouge">ActionMailer::TestCase</code></a></li>
  <li><a href="https://api.rubyonrails.org/classes/ActionView/TestCase.html"><code class="language-plaintext highlighter-rouge">ActionView::TestCase</code></a></li>
  <li><a href="https://api.rubyonrails.org/classes/ActiveJob/TestCase.html"><code class="language-plaintext highlighter-rouge">ActiveJob::TestCase</code></a></li>
  <li><a href="https://api.rubyonrails.org/classes/ActionDispatch/Integration/Session.html"><code class="language-plaintext highlighter-rouge">ActionDispatch::Integration::Session</code></a></li>
  <li><a href="https://api.rubyonrails.org/classes/ActionDispatch/SystemTestCase.html"><code class="language-plaintext highlighter-rouge">ActionDispatch::SystemTestCase</code></a></li>
  <li><a href="https://api.rubyonrails.org/classes/Rails/Generators/TestCase.html"><code class="language-plaintext highlighter-rouge">Rails::Generators::TestCase</code></a></li>
</ul>

<p>Each of these classes include <code class="language-plaintext highlighter-rouge">Minitest::Assertions</code>, allowing us to use all of
the basic assertions in your tests.</p>

<p>TIP: For more information on <code class="language-plaintext highlighter-rouge">minitest</code>, refer to the <a href="http://docs.seattlerb.org/minitest">minitest
documentation</a>.</p>

<h3 id="the-rails-test-runner">The Rails Test Runner</h3>

<p>We can run all of our tests at once by using the <code class="language-plaintext highlighter-rouge">bin/rails test</code> command.</p>

<p>Or we can run a single test file by appending the filename to the <code class="language-plaintext highlighter-rouge">bin/rails
test</code> command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/models/article_test.rb
Running 1 tests <span class="k">in </span>a single process <span class="o">(</span>parallelization threshold is 50<span class="o">)</span>
Run options: <span class="nt">--seed</span> 1559

<span class="c"># Running:</span>

..

Finished <span class="k">in </span>0.027034s, 73.9810 runs/s, 110.9715 assertions/s.

2 runs, 3 assertions, 0 failures, 0 errors, 0 skips
</code></pre></div></div>

<p>This will run all test methods from the test case.</p>

<p>You can also run a particular test method from the test case by providing the
<code class="language-plaintext highlighter-rouge">-n</code> or <code class="language-plaintext highlighter-rouge">--name</code> flag and the test’s method name.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/models/article_test.rb <span class="nt">-n</span> test_the_truth
Running 1 tests <span class="k">in </span>a single process <span class="o">(</span>parallelization threshold is 50<span class="o">)</span>
Run options: <span class="nt">-n</span> test_the_truth <span class="nt">--seed</span> 43583

<span class="c"># Running:</span>

<span class="nb">.</span>

Finished tests <span class="k">in </span>0.009064s, 110.3266 tests/s, 110.3266 assertions/s.

1 tests, 1 assertions, 0 failures, 0 errors, 0 skips
</code></pre></div></div>

<p>You can also run a test at a specific line by providing the line number.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/models/article_test.rb:6 <span class="c"># run specific test and line</span>
</code></pre></div></div>

<p>You can also run a range of tests by providing the line range.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/models/article_test.rb:6-20 <span class="c"># runs tests from line 6 to 20</span>
</code></pre></div></div>

<p>You can also run an entire directory of tests by providing the path to the
directory.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/controllers <span class="c"># run all tests from specific directory</span>
</code></pre></div></div>

<p>The test runner also provides a lot of other features like failing fast, showing
verbose progress, and so on. Check the documentation of the test runner using
the command below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test</span> <span class="nt">-h</span>
Usage:
  bin/rails <span class="nb">test</span> <span class="o">[</span>PATHS...]

Run tests except system tests

Examples:
    You can run a single <span class="nb">test </span>by appending a line number to a filename:

        bin/rails <span class="nb">test test</span>/models/user_test.rb:27

    You can run multiple tests with <span class="k">in </span>a line range by appending the line range to a filename:

        bin/rails <span class="nb">test test</span>/models/user_test.rb:10-20

    You can run multiple files and directories at the same <span class="nb">time</span>:

        bin/rails <span class="nb">test test</span>/controllers <span class="nb">test</span>/integration/login_test.rb

    By default <span class="nb">test </span>failures and errors are reported inline during a run.

minitest options:
    <span class="nt">-h</span>, <span class="nt">--help</span>                       Display this help.
        <span class="nt">--no-plugins</span>                 Bypass minitest plugin auto-loading <span class="o">(</span>or <span class="nb">set</span> <span class="nv">$MT_NO_PLUGINS</span><span class="o">)</span><span class="nb">.</span>
    <span class="nt">-s</span>, <span class="nt">--seed</span> SEED                  Sets random seed. Also via env. Eg: <span class="nv">SEED</span><span class="o">=</span>n rake
    <span class="nt">-v</span>, <span class="nt">--verbose</span>                    Verbose. Show progress processing files.
        <span class="nt">--show-skips</span>                 Show skipped at the end of run.
    <span class="nt">-n</span>, <span class="nt">--name</span> PATTERN               Filter run on /regexp/ or string.
        <span class="nt">--exclude</span> PATTERN            Exclude /regexp/ or string from run.
    <span class="nt">-S</span>, <span class="nt">--skip</span> CODES                 Skip reporting of certain types of results <span class="o">(</span>eg E<span class="o">)</span><span class="nb">.</span>

Known extensions: rails, pride
    <span class="nt">-w</span>, <span class="nt">--warnings</span>                   Run with Ruby warnings enabled
    <span class="nt">-e</span>, <span class="nt">--environment</span> ENV            Run tests <span class="k">in </span>the ENV environment
    <span class="nt">-b</span>, <span class="nt">--backtrace</span>                  Show the <span class="nb">complete </span>backtrace
    <span class="nt">-d</span>, <span class="nt">--defer-output</span>               Output <span class="nb">test </span>failures and errors after the <span class="nb">test </span>run
    <span class="nt">-f</span>, <span class="nt">--fail-fast</span>                  Abort <span class="nb">test </span>run on first failure or error
    <span class="nt">-c</span>, <span class="nt">--</span><span class="o">[</span>no-]color                 Enable color <span class="k">in </span>the output
        <span class="nt">--profile</span> <span class="o">[</span>COUNT]            Enable profiling of tests and list the slowest <span class="nb">test </span>cases <span class="o">(</span>default: 10<span class="o">)</span>
    <span class="nt">-p</span>, <span class="nt">--pride</span>                      Pride. Show your testing pride!
</code></pre></div></div>

<h2 id="the-test-database">The Test Database</h2>

<p>Just about every Rails application interacts heavily with a database and so your
tests will need a database to interact with as well. This section covers how to
set up this test database and populate it with sample data.</p>

<p>As mentioned in the <a href="#the-test-environment">Test Environment section</a>, every
Rails application has three environments: development, test, and production. The
database for each one of them is configured in <code class="language-plaintext highlighter-rouge">config/database.yml</code>.</p>

<p>A dedicated test database allows you to set up and interact with test data in
isolation. This way your tests can interact with test data with confidence,
without worrying about the data in the development or production databases.</p>

<h3 id="maintaining-the-test-database-schema">Maintaining the Test Database Schema</h3>

<p>In order to run your tests, your test database needs the current schema. The
test helper checks whether your test database has any pending migrations. It
will try to load your <code class="language-plaintext highlighter-rouge">db/schema.rb</code> or <code class="language-plaintext highlighter-rouge">db/structure.sql</code> into the test
database. If migrations are still pending, an error will be raised. Usually this
indicates that your schema is not fully migrated. Running the migrations (using
<code class="language-plaintext highlighter-rouge">bin/rails db:migrate RAILS_ENV=test</code>) will bring the schema up to date.</p>

<p>NOTE: If there were modifications to existing migrations, the test database
needs to be rebuilt. This can be done by executing <code class="language-plaintext highlighter-rouge">bin/rails test:db</code>.</p>

<h3 id="fixtures">Fixtures</h3>

<p>For good tests, you’ll need to give some thought to setting up test data. In
Rails, you can handle this by defining and customizing fixtures. You can find
comprehensive documentation in the <a href="https://api.rubyonrails.org/classes/ActiveRecord/FixtureSet.html">Fixtures API
documentation</a>.</p>

<h4 id="what-are-fixtures">What are Fixtures?</h4>

<p><em>Fixtures</em> is a fancy word for a consistent set of test data. Fixtures allow you to populate your
testing database with predefined data before your tests run. Fixtures are
database independent and written in YAML. There is one file per model.</p>

<p>NOTE: Fixtures are not designed to create every object that your tests need, and
are best managed when only used for default data that can be applied to the
common case.</p>

<p>Fixtures are stored in your <code class="language-plaintext highlighter-rouge">test/fixtures</code> directory.</p>

<h4 id="yaml">YAML</h4>

<p><a href="https://en.wikipedia.org/wiki/YAML">YAML</a> is a human-readable data serialization language.
YAML-formatted fixtures are a human-friendly way to describe your sample data.
These types of fixtures have the <strong>.yml</strong> file extension (as in <code class="language-plaintext highlighter-rouge">users.yml</code>).</p>

<p>Here’s a sample YAML fixture file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># lo &amp; behold! I am a YAML comment!</span>
<span class="na">david</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">David Heinemeier Hansson</span>
  <span class="na">birthday</span><span class="pi">:</span> <span class="s">1979-10-15</span>
  <span class="na">profession</span><span class="pi">:</span> <span class="s">Systems development</span>

<span class="na">steve</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Steve Ross Kellock</span>
  <span class="na">birthday</span><span class="pi">:</span> <span class="s">1974-09-27</span>
  <span class="na">profession</span><span class="pi">:</span> <span class="s">guy with keyboard</span>
</code></pre></div></div>

<p>Each fixture is given a name followed by an indented list of colon-separated
key/value pairs. Records are typically separated by a blank line. You can place
comments in a fixture file by using the # character in the first column.</p>

<p>If you are working with <a href="association_basics.html">associations</a>, you can define
a reference node between two different fixtures. Here’s an example with a
<code class="language-plaintext highlighter-rouge">belongs_to</code>/<code class="language-plaintext highlighter-rouge">has_many</code> association:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/fixtures/categories.yml</span>
<span class="na">web_frameworks</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">Web Frameworks</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/fixtures/articles.yml</span>
<span class="na">first</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">Welcome to Rails!</span>
  <span class="na">category</span><span class="pi">:</span> <span class="s">web_frameworks</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/fixtures/action_text/rich_texts.yml</span>
<span class="na">first_content</span><span class="pi">:</span>
  <span class="na">record</span><span class="pi">:</span> <span class="s">first (Article)</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">content</span>
  <span class="na">body</span><span class="pi">:</span> <span class="s">&lt;div&gt;Hello, from &lt;strong&gt;a fixture&lt;/strong&gt;&lt;/div&gt;</span>
</code></pre></div></div>

<p>Notice the <code class="language-plaintext highlighter-rouge">category</code> key of the <code class="language-plaintext highlighter-rouge">first</code> Article found in
<code class="language-plaintext highlighter-rouge">fixtures/articles.yml</code> has a value of <code class="language-plaintext highlighter-rouge">web_frameworks</code>, and that the <code class="language-plaintext highlighter-rouge">record</code> key of the
<code class="language-plaintext highlighter-rouge">first_content</code> entry found in <code class="language-plaintext highlighter-rouge">fixtures/action_text/rich_texts.yml</code> has a value
of <code class="language-plaintext highlighter-rouge">first (Article)</code>. This hints to Active Record to load the Category <code class="language-plaintext highlighter-rouge">web_frameworks</code>
found in <code class="language-plaintext highlighter-rouge">fixtures/categories.yml</code> for the former, and Action Text to load the
Article <code class="language-plaintext highlighter-rouge">first</code> found in <code class="language-plaintext highlighter-rouge">fixtures/articles.yml</code> for the latter.</p>

<p>NOTE: For associations to reference one another by name, you can use the fixture
name instead of specifying the <code class="language-plaintext highlighter-rouge">id:</code> attribute on the associated fixtures. Rails
will auto-assign a primary key to be consistent between runs. For more
information on this association behavior please read the <a href="https://api.rubyonrails.org/classes/ActiveRecord/FixtureSet.html">Fixtures API
documentation</a>.</p>

<h4 id="file-attachment-fixtures">File Attachment Fixtures</h4>

<p>Like other Active Record-backed models, Active Storage attachment records
inherit from ActiveRecord::Base instances and can therefore be populated by
fixtures.</p>

<p>Consider an <code class="language-plaintext highlighter-rouge">Article</code> model that has an associated image as a <code class="language-plaintext highlighter-rouge">thumbnail</code>
attachment, along with fixture data YAML:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Article</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">has_one_attached</span> <span class="ss">:thumbnail</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/fixtures/articles.yml</span>
<span class="na">first</span><span class="pi">:</span>
  <span class="na">title</span><span class="pi">:</span> <span class="s">An Article</span>
</code></pre></div></div>

<p>Assuming that there is an [image/png][] encoded file at
<code class="language-plaintext highlighter-rouge">test/fixtures/files/first.png</code>, the following YAML fixture entries will
generate the related <code class="language-plaintext highlighter-rouge">ActiveStorage::Blob</code> and <code class="language-plaintext highlighter-rouge">ActiveStorage::Attachment</code>
records:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/fixtures/active_storage/blobs.yml</span>
<span class="na">first_thumbnail_blob: &lt;%= ActiveStorage::FixtureSet.blob filename</span><span class="pi">:</span> <span class="s2">"</span><span class="s">first.png"</span> <span class="err">%</span><span class="pi">&gt;</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/fixtures/active_storage/attachments.yml</span>
<span class="na">first_thumbnail_attachment</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thumbnail</span>
  <span class="na">record</span><span class="pi">:</span> <span class="s">first (Article)</span>
  <span class="na">blob</span><span class="pi">:</span> <span class="s">first_thumbnail_blob</span>
</code></pre></div></div>

<p>[image/png]:
    https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types#image_types</p>

<h4 id="embedding-code-in-fixtures">Embedding Code in Fixtures</h4>

<p>ERB allows you to embed Ruby code within templates. The YAML fixture format is
pre-processed with ERB when Rails loads fixtures. This allows you to use Ruby to
help you generate some sample data. For example, the following code generates a
thousand users:</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%</span> <span class="mi">1000</span><span class="p">.</span><span class="nf">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="cp">%&gt;</span>
  user_<span class="cp">&lt;%=</span> <span class="n">n</span> <span class="cp">%&gt;</span>:
    username: <span class="cp">&lt;%=</span> <span class="s2">"user</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">"</span> <span class="cp">%&gt;</span>
    email: <span class="cp">&lt;%=</span> <span class="s2">"user</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<h4 id="fixtures-in-action">Fixtures in Action</h4>

<p>Rails automatically loads all fixtures from the <code class="language-plaintext highlighter-rouge">test/fixtures</code> directory by
default. Loading involves three steps:</p>

<ol>
  <li>Remove any existing data from the table corresponding to the fixture</li>
  <li>Load the fixture data into the table</li>
  <li>Dump the fixture data into a method in case you want to access it directly</li>
</ol>

<p>TIP: In order to remove existing data from the database, Rails tries to disable
referential integrity triggers (like foreign keys and check constraints). If you
are getting permission errors on running tests, make sure the database user has
the permission to disable these triggers in the testing environment. (In
PostgreSQL, only superusers can disable all triggers. Read more about
<a href="https://www.postgresql.org/docs/current/sql-altertable.html">permissions in the PostgreSQL
docs</a>).</p>

<h4 id="fixtures-are-active-record-objects">Fixtures are Active Record Objects</h4>

<p>Fixtures are instances of Active Record. As mentioned above, you can access the
object directly because it is automatically available as a method whose scope is
local to the test case. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># this will return the User object for the fixture named david</span>
<span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">)</span>

<span class="c1"># this will return the property for david called id</span>
<span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">).</span><span class="nf">id</span>

<span class="c1"># methods available to the User object can also be accessed</span>
<span class="n">david</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">)</span>
<span class="n">david</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">david</span><span class="p">.</span><span class="nf">partner</span><span class="p">)</span>
</code></pre></div></div>

<p>To get multiple fixtures at once, you can pass in a list of fixture names. For
example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># this will return an array containing the fixtures david and steve</span>
<span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">,</span> <span class="ss">:steve</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="transactions">Transactions</h3>

<p>By default, Rails automatically wraps tests in a database transaction that is
rolled back once completed. This makes tests independent of each other and means
that changes to the database are only visible within a single test.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"newly created users are active by default"</span> <span class="k">do</span>
    <span class="c1"># Since the test is implicitly wrapped in a database transaction, the user</span>
    <span class="c1"># created here won't be seen by other tests.</span>
    <span class="n">assert</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">.</span><span class="nf">active?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The method
<a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html#method-i-current_transaction"><code class="language-plaintext highlighter-rouge">ActiveRecord::Base.current_transaction</code></a>
still acts as intended, though:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"Active Record current_transaction method works as expected"</span> <span class="k">do</span>
    <span class="c1"># The implicit transaction around tests does not interfere with the</span>
    <span class="c1"># application-level semantics of the current_transaction.</span>
    <span class="n">assert</span> <span class="no">User</span><span class="p">.</span><span class="nf">current_transaction</span><span class="p">.</span><span class="nf">blank?</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If there are <a href="active_record_multiple_databases.html">multiple writing databases</a>
in place, tests are wrapped in as many respective transactions, and all of them
are rolled back.</p>

<h4 id="opting-out-of-test-transactions">Opting-out of Test Transactions</h4>

<p>Individual test cases can opt-out:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MyTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># No implicit database transaction wraps the tests in this test case.</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">use_transactional_tests</span> <span class="o">=</span> <span class="kp">false</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="testing-models">Testing Models</h2>

<p>Model tests are used to test the models of your application and their associated
logic. You can test this logic using the assertions and fixtures that we’ve
explored in the sections above.</p>

<p>Rails model tests are stored under the <code class="language-plaintext highlighter-rouge">test/models</code> directory. Rails provides a
generator to create a model test skeleton for you.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate test_unit:model article
create  <span class="nb">test</span>/models/article_test.rb
</code></pre></div></div>

<p>This command will generate the following file:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># article_test.rb</span>
<span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ArticleTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="c1"># test "the truth" do</span>
  <span class="c1">#   assert true</span>
  <span class="c1"># end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Model tests don’t have their own superclass like <code class="language-plaintext highlighter-rouge">ActionMailer::TestCase</code>.
Instead, they inherit from
<a href="https://api.rubyonrails.org/classes/ActiveSupport/TestCase.html"><code class="language-plaintext highlighter-rouge">ActiveSupport::TestCase</code></a>.</p>

<h2 id="functional-testing-for-controllers">Functional Testing for Controllers</h2>

<p>When writing functional tests, you are focusing on testing how controller
actions handle the requests and the expected result or response. Functional
controller tests are sometimes used in cases where system tests are not
appropriate, e.g., to confirm an API response.</p>

<h3 id="what-to-include-in-your-functional-tests">What to Include in Your Functional Tests</h3>

<p>You could test for things such as:</p>

<ul>
  <li>was the web request successful?</li>
  <li>was the user redirected to the right page?</li>
  <li>was the user successfully authenticated?</li>
  <li>was the correct information displayed in the response?</li>
</ul>

<p>The easiest way to see functional tests in action is to generate a controller
using the scaffold generator:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate scaffold_controller article
...
create  app/controllers/articles_controller.rb
...
invoke  test_unit
create    <span class="nb">test</span>/controllers/articles_controller_test.rb
...
</code></pre></div></div>

<p>This will generate the controller code and tests for an <code class="language-plaintext highlighter-rouge">Article</code> resource. You
can take a look at the file <code class="language-plaintext highlighter-rouge">articles_controller_test.rb</code> in the
<code class="language-plaintext highlighter-rouge">test/controllers</code> directory.</p>

<p>If you already have a controller and just want to generate the test scaffold
code for each of the seven default actions, you can use the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate test_unit:scaffold article
...
invoke  test_unit
create    <span class="nb">test</span>/controllers/articles_controller_test.rb
...
</code></pre></div></div>

<p>NOTE: if you are generating test scaffold code, you will see an <code class="language-plaintext highlighter-rouge">@article</code> value
is set and used throughout the test file. This instance of <code class="language-plaintext highlighter-rouge">article</code> uses the
attributes nested within a <code class="language-plaintext highlighter-rouge">:one</code> key in the <code class="language-plaintext highlighter-rouge">test/fixtures/articles.yml</code> file.
Make sure you have set the key and related values in this file before you try to
run the tests.</p>

<p>Let’s take a look at one such test, <code class="language-plaintext highlighter-rouge">test_should_get_index</code> from the file
<code class="language-plaintext highlighter-rouge">articles_controller_test.rb</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># articles_controller_test.rb</span>
<span class="k">class</span> <span class="nc">ArticlesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"should get index"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">articles_url</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In the <code class="language-plaintext highlighter-rouge">test_should_get_index</code> test, Rails simulates a request on the action
called <code class="language-plaintext highlighter-rouge">index</code>, making sure the request was successful, and also ensuring that
the right response body has been generated.</p>

<p>The <code class="language-plaintext highlighter-rouge">get</code> method kicks off the web request and populates the results into the
<code class="language-plaintext highlighter-rouge">@response</code>. It can accept up to 6 arguments:</p>

<ul>
  <li>The URI of the controller action you are requesting. This can be in the form
of a string or a route helper (e.g. <code class="language-plaintext highlighter-rouge">articles_url</code>).</li>
  <li><code class="language-plaintext highlighter-rouge">params</code>: option with a hash of request parameters to pass into the action
(e.g. query string parameters or article variables).</li>
  <li><code class="language-plaintext highlighter-rouge">headers</code>: for setting the headers that will be passed with the request.</li>
  <li><code class="language-plaintext highlighter-rouge">env</code>: for customizing the request environment as needed.</li>
  <li><code class="language-plaintext highlighter-rouge">xhr</code>: whether the request is AJAX request or not. Can be set to true for
marking the request as AJAX.</li>
  <li><code class="language-plaintext highlighter-rouge">as</code>: for encoding the request with different content type.</li>
</ul>

<p>All of these keyword arguments are optional.</p>

<p>Example: Calling the <code class="language-plaintext highlighter-rouge">:show</code> action (via a <code class="language-plaintext highlighter-rouge">get</code> request) for the first
<code class="language-plaintext highlighter-rouge">Article</code>, passing in an <code class="language-plaintext highlighter-rouge">HTTP_REFERER</code> header:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">first</span><span class="p">),</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s2">"HTTP_REFERER"</span> <span class="o">=&gt;</span> <span class="s2">"http://example.com/home"</span> <span class="p">}</span>
</code></pre></div></div>

<p>Another example: Calling the <code class="language-plaintext highlighter-rouge">:update</code> action (via a <code class="language-plaintext highlighter-rouge">patch</code> request) for the
last <code class="language-plaintext highlighter-rouge">Article</code>, passing in new text for the <code class="language-plaintext highlighter-rouge">title</code> in <code class="language-plaintext highlighter-rouge">params</code>, as an AJAX
request:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">patch</span> <span class="n">article_url</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">last</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"updated"</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">xhr: </span><span class="kp">true</span>
</code></pre></div></div>

<p>One more example: Calling the <code class="language-plaintext highlighter-rouge">:create</code> action (via a <code class="language-plaintext highlighter-rouge">post</code> request) to create
a new article, passing in text for the <code class="language-plaintext highlighter-rouge">title</code> in <code class="language-plaintext highlighter-rouge">params</code>, as JSON request:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">post</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"Ahoy!"</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">as: :json</span>
</code></pre></div></div>

<p>NOTE: If you try running the <code class="language-plaintext highlighter-rouge">test_should_create_article</code> test from
<code class="language-plaintext highlighter-rouge">articles_controller_test.rb</code> it will (correctly) fail due to the newly added
model-level validation.</p>

<p>Now to modify the <code class="language-plaintext highlighter-rouge">test_should_create_article</code> test in
<code class="language-plaintext highlighter-rouge">articles_controller_test.rb</code> so that this test passes:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"should create article"</span> <span class="k">do</span>
  <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">body: </span><span class="s2">"Rails is awesome!"</span><span class="p">,</span> <span class="ss">title: </span><span class="s2">"Hello Rails"</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can now run this test and it will pass.</p>

<p>NOTE: If you followed the steps in the <a href="getting_started.html#adding-authentication">Basic
Authentication</a> section, you’ll need
to add authorization to every request header to get all the tests passing:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">post</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">body: </span><span class="s2">"Rails is awesome!"</span><span class="p">,</span> <span class="ss">title: </span><span class="s2">"Hello Rails"</span> <span class="p">}</span> <span class="p">},</span> <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">HttpAuthentication</span><span class="o">::</span><span class="no">Basic</span><span class="p">.</span><span class="nf">encode_credentials</span><span class="p">(</span><span class="s2">"dhh"</span><span class="p">,</span> <span class="s2">"secret"</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<h3 id="http-request-types-for-functional-tests">HTTP Request Types for Functional Tests</h3>

<p>If you’re familiar with the HTTP protocol, you’ll know that <code class="language-plaintext highlighter-rouge">get</code> is a type of
request. There are 6 request types supported in Rails functional tests:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">get</code></li>
  <li><code class="language-plaintext highlighter-rouge">post</code></li>
  <li><code class="language-plaintext highlighter-rouge">patch</code></li>
  <li><code class="language-plaintext highlighter-rouge">put</code></li>
  <li><code class="language-plaintext highlighter-rouge">head</code></li>
  <li><code class="language-plaintext highlighter-rouge">delete</code></li>
</ul>

<p>All of the request types have equivalent methods that you can use. In a typical
CRUD application you’ll be using <code class="language-plaintext highlighter-rouge">post</code>, <code class="language-plaintext highlighter-rouge">get</code>, <code class="language-plaintext highlighter-rouge">put</code>, and <code class="language-plaintext highlighter-rouge">delete</code> most
often.</p>

<p>NOTE: Functional tests do not verify whether the specified request type is
accepted by the action; instead, they focus on the result. For testing the
request type, request tests are available, making your tests more purposeful.</p>

<h3 id="testing-xhr-ajax-requests">Testing XHR (AJAX) Requests</h3>

<p>An AJAX request (Asynchronous JavaScript and XML) is a technique where content is
fetched from the server using asynchronous HTTP requests and the relevant parts
of the page are updated without requiring a full page load.</p>

<p>To test AJAX requests, you can specify the <code class="language-plaintext highlighter-rouge">xhr: true</code> option to <code class="language-plaintext highlighter-rouge">get</code>, <code class="language-plaintext highlighter-rouge">post</code>,
<code class="language-plaintext highlighter-rouge">patch</code>, <code class="language-plaintext highlighter-rouge">put</code>, and <code class="language-plaintext highlighter-rouge">delete</code> methods. For example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"AJAX request"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">),</span> <span class="ss">xhr: </span><span class="kp">true</span>

  <span class="n">assert_equal</span> <span class="s2">"hello world"</span><span class="p">,</span> <span class="vi">@response</span><span class="p">.</span><span class="nf">body</span>
  <span class="n">assert_equal</span> <span class="s2">"text/javascript"</span><span class="p">,</span> <span class="vi">@response</span><span class="p">.</span><span class="nf">media_type</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="testing-other-request-objects">Testing Other Request Objects</h3>

<p>After any request has been made and processed, you will have 3 Hash objects
ready for use:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">cookies</code> - Any cookies that are set</li>
  <li><code class="language-plaintext highlighter-rouge">flash</code> - Any objects living in the flash</li>
  <li><code class="language-plaintext highlighter-rouge">session</code> - Any object living in session variables</li>
</ul>

<p>As is the case with normal Hash objects, you can access the values by
referencing the keys by string. You can also reference them by symbol name. For
example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flash</span><span class="p">[</span><span class="s2">"gordon"</span><span class="p">]</span>               <span class="c1"># or flash[:gordon]</span>
<span class="n">session</span><span class="p">[</span><span class="s2">"shmession"</span><span class="p">]</span>          <span class="c1"># or session[:shmession]</span>
<span class="n">cookies</span><span class="p">[</span><span class="s2">"are_good_for_u"</span><span class="p">]</span>     <span class="c1"># or cookies[:are_good_for_u]</span>
</code></pre></div></div>

<h3 id="instance-variables">Instance Variables</h3>

<p>You also have access to three instance variables in your functional tests after
a request is made:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">@controller</code> - The controller processing the request</li>
  <li><code class="language-plaintext highlighter-rouge">@request</code> - The request object</li>
  <li><code class="language-plaintext highlighter-rouge">@response</code> - The response object</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ArticlesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"should get index"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="n">articles_url</span>

    <span class="n">assert_equal</span> <span class="s2">"index"</span><span class="p">,</span> <span class="vi">@controller</span><span class="p">.</span><span class="nf">action_name</span>
    <span class="n">assert_equal</span> <span class="s2">"application/x-www-form-urlencoded"</span><span class="p">,</span> <span class="vi">@request</span><span class="p">.</span><span class="nf">media_type</span>
    <span class="n">assert_match</span> <span class="s2">"Articles"</span><span class="p">,</span> <span class="vi">@response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="setting-headers-and-cgi-variables">Setting Headers and CGI Variables</h3>

<p>HTTP headers are pieces of information sent along with HTTP requests to provide
important metadata. CGI variables are environment variables used to exchange
information between the web server and the application.</p>

<p>HTTP headers and CGI variables can be tested by being passed as headers:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># setting an HTTP Header</span>
<span class="n">get</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s2">"Content-Type"</span><span class="p">:</span> <span class="s2">"text/plain"</span> <span class="p">}</span> <span class="c1"># simulate the request with custom header</span>

<span class="c1"># setting a CGI variable</span>
<span class="n">get</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">headers: </span><span class="p">{</span> <span class="s2">"HTTP_REFERER"</span><span class="p">:</span> <span class="s2">"http://example.com/home"</span> <span class="p">}</span> <span class="c1"># simulate the request with custom env variable</span>
</code></pre></div></div>

<h3 id="testing-flash-notices">Testing <code class="language-plaintext highlighter-rouge">flash</code> Notices</h3>

<p>As can be seen in the <a href="#testing-other-request-objects">testing other request objects
section</a>, one of the three hash objects that is
accessible in the tests is <code class="language-plaintext highlighter-rouge">flash</code>. This section outlines how to test the
appearance of a <code class="language-plaintext highlighter-rouge">flash</code> message in our blog application whenever someone
successfully creates a new article.</p>

<p>First, an assertion should be added to the <code class="language-plaintext highlighter-rouge">test_should_create_article</code> test:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"should create article"</span> <span class="k">do</span>
  <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">post</span> <span class="n">articles_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"Some title"</span> <span class="p">}</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="no">Article</span><span class="p">.</span><span class="nf">last</span><span class="p">)</span>
  <span class="n">assert_equal</span> <span class="s2">"Article was successfully created."</span><span class="p">,</span> <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If the test is run now, it should fail:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/controllers/articles_controller_test.rb <span class="nt">-n</span> test_should_create_article
Running 1 tests <span class="k">in </span>a single process <span class="o">(</span>parallelization threshold is 50<span class="o">)</span>
Run options: <span class="nt">-n</span> test_should_create_article <span class="nt">--seed</span> 32266

<span class="c"># Running:</span>

F

Finished <span class="k">in </span>0.114870s, 8.7055 runs/s, 34.8220 assertions/s.

  1<span class="o">)</span> Failure:
ArticlesControllerTest#test_should_create_article <span class="o">[</span>/test/controllers/articles_controller_test.rb:16]:
<span class="nt">---</span> expected
+++ actual
@@ <span class="nt">-1</span> +1 @@
-<span class="s2">"Article was successfully created."</span>
+nil

1 runs, 4 assertions, 1 failures, 0 errors, 0 skips
</code></pre></div></div>

<p>Now implement the flash message in the controller. The <code class="language-plaintext highlighter-rouge">:create</code> action should
look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">article_params</span><span class="p">)</span>

  <span class="k">if</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">save</span>
    <span class="n">flash</span><span class="p">[</span><span class="ss">:notice</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Article was successfully created."</span>
    <span class="n">redirect_to</span> <span class="vi">@article</span>
  <span class="k">else</span>
    <span class="n">render</span> <span class="s2">"new"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, if the tests are run they should pass:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test test</span>/controllers/articles_controller_test.rb <span class="nt">-n</span> test_should_create_article
Running 1 tests <span class="k">in </span>a single process <span class="o">(</span>parallelization threshold is 50<span class="o">)</span>
Run options: <span class="nt">-n</span> test_should_create_article <span class="nt">--seed</span> 18981

<span class="c"># Running:</span>

<span class="nb">.</span>

Finished <span class="k">in </span>0.081972s, 12.1993 runs/s, 48.7972 assertions/s.

1 runs, 4 assertions, 0 failures, 0 errors, 0 skips
</code></pre></div></div>

<p>NOTE: If you generated your controller using the scaffold generator, the flash
message will already be implemented in your <code class="language-plaintext highlighter-rouge">create</code> action.</p>

<h3 id="tests-for-show-update-and-delete-actions">Tests for <code class="language-plaintext highlighter-rouge">show</code>, <code class="language-plaintext highlighter-rouge">update</code>, and <code class="language-plaintext highlighter-rouge">delete</code> Actions</h3>

<p>So far in the guide tests for the <code class="language-plaintext highlighter-rouge">:index</code> as well as the<code class="language-plaintext highlighter-rouge">:create</code> action have
been outlined. What about the other actions?</p>

<p>You can write a test for <code class="language-plaintext highlighter-rouge">:show</code> as follows:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"should show article"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
  <span class="n">assert_response</span> <span class="ss">:success</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you remember from our discussion earlier on <a href="#fixtures">fixtures</a>, the
<code class="language-plaintext highlighter-rouge">articles()</code> method will provide access to the articles fixtures.</p>

<p>How about deleting an existing article?</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"should delete article"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">delete</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">assert_redirected_to</span> <span class="n">articles_path</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Here is a test for updating an existing article:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"should update article"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>

  <span class="n">patch</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"updated"</span> <span class="p">}</span> <span class="p">}</span>

  <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
  <span class="c1"># Reload article to refresh data and assert that title is updated.</span>
  <span class="n">article</span><span class="p">.</span><span class="nf">reload</span>
  <span class="n">assert_equal</span> <span class="s2">"updated"</span><span class="p">,</span> <span class="n">article</span><span class="p">.</span><span class="nf">title</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Notice that there is some duplication in these three tests - they both access
the same article fixture data. It is possible to DRY (‘Don’t Repeat
Yourself’) the implementation by using the <code class="language-plaintext highlighter-rouge">setup</code> and <code class="language-plaintext highlighter-rouge">teardown</code> methods
provided by <code class="language-plaintext highlighter-rouge">ActiveSupport::Callbacks</code>.</p>

<p>The tests might look like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ArticlesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># called before every single test</span>
  <span class="n">setup</span> <span class="k">do</span>
    <span class="vi">@article</span> <span class="o">=</span> <span class="n">articles</span><span class="p">(</span><span class="ss">:one</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="c1"># called after every single test</span>
  <span class="n">teardown</span> <span class="k">do</span>
    <span class="c1"># when controller is using cache it may be a good idea to reset it afterwards</span>
    <span class="no">Rails</span><span class="p">.</span><span class="nf">cache</span><span class="p">.</span><span class="nf">clear</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should show article"</span> <span class="k">do</span>
    <span class="c1"># Reuse the @article instance variable from setup</span>
    <span class="n">get</span> <span class="n">article_url</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should destroy article"</span> <span class="k">do</span>
    <span class="n">assert_difference</span><span class="p">(</span><span class="s2">"Article.count"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="n">article_url</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">assert_redirected_to</span> <span class="n">articles_path</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"should update article"</span> <span class="k">do</span>
    <span class="n">patch</span> <span class="n">article_url</span><span class="p">(</span><span class="vi">@article</span><span class="p">),</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"updated"</span> <span class="p">}</span> <span class="p">}</span>

    <span class="n">assert_redirected_to</span> <span class="n">article_path</span><span class="p">(</span><span class="vi">@article</span><span class="p">)</span>
    <span class="c1"># Reload association to fetch updated data and assert that title is updated.</span>
    <span class="vi">@article</span><span class="p">.</span><span class="nf">reload</span>
    <span class="n">assert_equal</span> <span class="s2">"updated"</span><span class="p">,</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">title</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>NOTE: Similar to other callbacks in Rails, the <code class="language-plaintext highlighter-rouge">setup</code> and <code class="language-plaintext highlighter-rouge">teardown</code> methods
can also accept a block, lambda, or a method name as a symbol to be called.</p>

<h2 id="integration-testing">Integration Testing</h2>

<p>Integration tests take functional controller tests one step further - they focus
on testing how several parts of an application interact, and are generally used
to test important workflows. Rails integration tests are stored in the
<code class="language-plaintext highlighter-rouge">test/integration</code> directory.</p>

<p>Rails provides a generator to create an integration test skeleton as follows:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate integration_test user_flows
      invoke  test_unit
      create  <span class="nb">test</span>/integration/user_flows_test.rb
</code></pre></div></div>

<p>Here’s what a freshly generated integration test looks like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UserFlowsTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="c1"># test "the truth" do</span>
  <span class="c1">#   assert true</span>
  <span class="c1"># end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Here the test is inheriting from
<a href="https://api.rubyonrails.org/classes/ActionDispatch/IntegrationTest.html"><code class="language-plaintext highlighter-rouge">ActionDispatch::IntegrationTest</code></a>.
This makes some additional <a href="testing.html#helpers-available-for-integration-tests">helpers available for integration
tests</a> alongside the
standard testing helpers.</p>

<h3 id="implementing-an-integration-test">Implementing an Integration Test</h3>

<p>Let’s add an integration test to our blog application, by starting with a basic
workflow of creating a new blog article to verify that everything is working
properly.</p>

<p>Start by generating the integration test skeleton:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate integration_test blog_flow
</code></pre></div></div>

<p>It should have created a test file placeholder. With the output of the previous
command you should see:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      invoke  test_unit
      create    test/integration/blog_flow_test.rb
</code></pre></div></div>

<p>Now open that file and write the first assertion:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">BlogFlowTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"can see the welcome page"</span> <span class="k">do</span>
    <span class="n">get</span> <span class="s2">"/"</span>
    <span class="n">assert_dom</span> <span class="s2">"h1"</span><span class="p">,</span> <span class="s2">"Welcome#index"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you visit the root path, you should see <code class="language-plaintext highlighter-rouge">welcome/index.html.erb</code> rendered for
the view. So this assertion should pass.</p>

<p>NOTE: The assertion <code class="language-plaintext highlighter-rouge">assert_dom</code> (aliased to <code class="language-plaintext highlighter-rouge">assert_select</code>) is available in integration tests to check
the presence of key HTML elements and their content.</p>

<h4 id="creating-articles-integration">Creating Articles Integration</h4>

<p>To test the ability to create a new article in our blog and display the
resulting article, see the example below:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"can create an article"</span> <span class="k">do</span>
  <span class="n">get</span> <span class="s2">"/articles/new"</span>
  <span class="n">assert_response</span> <span class="ss">:success</span>

  <span class="n">post</span> <span class="s2">"/articles"</span><span class="p">,</span>
    <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"can create"</span><span class="p">,</span> <span class="ss">body: </span><span class="s2">"article successfully."</span> <span class="p">}</span> <span class="p">}</span>
  <span class="n">assert_response</span> <span class="ss">:redirect</span>
  <span class="n">follow_redirect!</span>
  <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="n">assert_dom</span> <span class="s2">"p"</span><span class="p">,</span> <span class="s2">"Title:</span><span class="se">\n</span><span class="s2">  can create"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">:new</code> action of our Articles controller is called first, and the response
should be successful.</p>

<p>Next, a <code class="language-plaintext highlighter-rouge">post</code> request is made to the <code class="language-plaintext highlighter-rouge">:create</code> action of the Articles
controller:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">post</span> <span class="s2">"/articles"</span><span class="p">,</span>
  <span class="ss">params: </span><span class="p">{</span> <span class="ss">article: </span><span class="p">{</span> <span class="ss">title: </span><span class="s2">"can create"</span><span class="p">,</span> <span class="ss">body: </span><span class="s2">"article successfully."</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">assert_response</span> <span class="ss">:redirect</span>
<span class="n">follow_redirect!</span>
</code></pre></div></div>

<p>The two lines following the request are to handle the redirect setup when
creating a new article.</p>

<p>NOTE: Don’t forget to call <code class="language-plaintext highlighter-rouge">follow_redirect!</code> if you plan to make subsequent
requests after a redirect is made.</p>

<p>Finally it can be asserted that the response was successful and the
newly-created article is readable on the page.</p>

<p>A very small workflow for visiting our blog and creating a new article was
successfully tested above. To extend this, additional tests could be added for
features like adding comments, editing comments or removing articles.
Integration tests are a great place to experiment with all kinds of use cases
for our applications.</p>

<h3 id="helpers-available-for-integration-tests">Helpers Available for Integration Tests</h3>

<p>There are numerous helpers to choose from for use in integration tests. Some
include:</p>

<ul>
  <li>
    <p><a href="https://api.rubyonrails.org/classes/ActionDispatch/Integration/Runner.html"><code class="language-plaintext highlighter-rouge">ActionDispatch::Integration::Runner</code></a>
for helpers relating to the integration test runner, including creating a new
session.</p>
  </li>
  <li>
    <p><a href="https://api.rubyonrails.org/classes/ActionDispatch/Integration/RequestHelpers.html"><code class="language-plaintext highlighter-rouge">ActionDispatch::Integration::RequestHelpers</code></a>
for performing requests.</p>
  </li>
  <li>
    <p><a href="https://api.rubyonrails.org/classes/ActionDispatch/TestProcess/FixtureFile.html"><code class="language-plaintext highlighter-rouge">ActionDispatch::TestProcess::FixtureFile</code></a>
for uploading files.</p>
  </li>
  <li>
    <p><a href="https://api.rubyonrails.org/classes/ActionDispatch/Integration/Session.html"><code class="language-plaintext highlighter-rouge">ActionDispatch::Integration::Session</code></a>
to modify sessions or the state of the integration tests.</p>
  </li>
</ul>

<h2 id="system-testing">System Testing</h2>

<p>Similarly to integration testing, system testing allows you to test how the
components of your app work together, but from the point of view of a user. It
does this by running tests in either a real or a headless browser (a browser
which runs in the background without opening a visible window). System tests use
<a href="https://www.rubydoc.info/github/jnicklas/capybara">Capybara</a> under the hood.</p>

<p>Rails system tests are stored in the <code class="language-plaintext highlighter-rouge">test/system</code> directory in your
application. To generate a system test skeleton, run the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate system_test <span class="nb">users
      </span>invoke test_unit
      create <span class="nb">test</span>/system/users_test.rb
</code></pre></div></div>

<p>Here’s what a freshly generated system test looks like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"application_system_test_case"</span>

<span class="k">class</span> <span class="nc">UsersTest</span> <span class="o">&lt;</span> <span class="no">ApplicationSystemTestCase</span>
  <span class="c1"># test "visiting the index" do</span>
  <span class="c1">#   visit users_url</span>
  <span class="c1">#</span>
  <span class="c1">#   assert_dom "h1", text: "Users"</span>
  <span class="c1"># end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>By default, system tests are run with the Selenium driver, using the Chrome
browser, and a screen size of 1400x1400. The next section explains how to change
the default settings.</p>

<h3 id="changing-the-default-settings">Changing the Default Settings</h3>

<p>Rails makes changing the default settings for system tests very simple. All the
setup is abstracted away so you can focus on writing your tests.</p>

<p>When you generate a new application or scaffold, an
<code class="language-plaintext highlighter-rouge">application_system_test_case.rb</code> file is created in the test directory. This is
where all the configuration for your system tests should live.</p>

<p>If you want to change the default settings, you can change what the system tests
are “driven by”. If you want to change the driver from Selenium to Cuprite,
you’d add the <a href="https://github.com/rubycdp/cuprite"><code class="language-plaintext highlighter-rouge">cuprite</code></a> gem to your
<code class="language-plaintext highlighter-rouge">Gemfile</code>. Then in your <code class="language-plaintext highlighter-rouge">application_system_test_case.rb</code> file you’d do the
following:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>
<span class="nb">require</span> <span class="s2">"capybara/cuprite"</span>

<span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:cuprite</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The driver name is a required argument for <code class="language-plaintext highlighter-rouge">driven_by</code>. The optional arguments
that can be passed to <code class="language-plaintext highlighter-rouge">driven_by</code> are <code class="language-plaintext highlighter-rouge">:using</code> for the browser (this will only
be used by Selenium), <code class="language-plaintext highlighter-rouge">:screen_size</code> to change the size of the screen for
screenshots, and <code class="language-plaintext highlighter-rouge">:options</code> which can be used to set options supported by the
driver.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using: :firefox</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you want to use a headless browser, you could use Headless Chrome or Headless
Firefox by adding <code class="language-plaintext highlighter-rouge">headless_chrome</code> or <code class="language-plaintext highlighter-rouge">headless_firefox</code> in the <code class="language-plaintext highlighter-rouge">:using</code>
argument.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using: :headless_chrome</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you want to use a remote browser, e.g. <a href="https://github.com/SeleniumHQ/docker-selenium">Headless Chrome in
Docker</a>, you have to add a remote
<code class="language-plaintext highlighter-rouge">url</code> and set <code class="language-plaintext highlighter-rouge">browser</code> as remote through <code class="language-plaintext highlighter-rouge">options</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">url</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s2">"SELENIUM_REMOTE_URL"</span><span class="p">,</span> <span class="kp">nil</span><span class="p">)</span>
  <span class="n">options</span> <span class="o">=</span> <span class="k">if</span> <span class="n">url</span>
    <span class="p">{</span> <span class="ss">browser: :remote</span><span class="p">,</span> <span class="ss">url: </span><span class="n">url</span> <span class="p">}</span>
  <span class="k">else</span>
    <span class="p">{</span> <span class="ss">browser: :chrome</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using: :headless_chrome</span><span class="p">,</span> <span class="ss">options: </span><span class="n">options</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now you should get a connection to the remote browser.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ SELENIUM_REMOTE_URL</span><span class="o">=</span>http://localhost:4444/wd/hub bin/rails <span class="nb">test</span>:system
</code></pre></div></div>

<p>If your application is remote, e.g. within a Docker container, Capybara needs
more input about how to <a href="https://github.com/teamcapybara/capybara#calling-remote-servers">call remote
servers</a>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ApplicationSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">setup</span> <span class="k">do</span>
      <span class="no">Capybara</span><span class="p">.</span><span class="nf">server_host</span> <span class="o">=</span> <span class="s2">"0.0.0.0"</span> <span class="c1"># bind to all interfaces</span>
      <span class="no">Capybara</span><span class="p">.</span><span class="nf">app_host</span> <span class="o">=</span> <span class="s2">"http://</span><span class="si">#{</span><span class="no">IPSocket</span><span class="p">.</span><span class="nf">getaddress</span><span class="p">(</span><span class="no">Socket</span><span class="p">.</span><span class="nf">gethostname</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span> <span class="k">if</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"SELENIUM_REMOTE_URL"</span><span class="p">].</span><span class="nf">present?</span>
    <span class="k">end</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now you should get a connection to a remote browser and server, regardless if it
is running in a Docker container or CI.</p>

<p>If your Capybara configuration requires more setup than provided by Rails, this
additional configuration can be added into the <code class="language-plaintext highlighter-rouge">application_system_test_case.rb</code>
file.</p>

<p>Please see <a href="https://github.com/teamcapybara/capybara#setup">Capybara’s
documentation</a> for additional
settings.</p>

<h3 id="implementing-a-system-test">Implementing a System Test</h3>

<p>This section will demonstrate how to add a system test to your application,
which tests a visit to the index page to create a new blog article.</p>

<p>If you used the scaffold generator, a system test skeleton was automatically
created for you. If you didn’t use the scaffold generator, start by creating a
system test skeleton.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails generate system_test articles
</code></pre></div></div>

<p>It should have created a test file placeholder. With the output of the previous
command you should see:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      invoke  test_unit
      create    test/system/articles_test.rb
</code></pre></div></div>

<p>Now, let’s open that file and write the first assertion:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"application_system_test_case"</span>

<span class="k">class</span> <span class="nc">ArticlesTest</span> <span class="o">&lt;</span> <span class="no">ApplicationSystemTestCase</span>
  <span class="nb">test</span> <span class="s2">"viewing the index"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">articles_path</span>
    <span class="n">assert_selector</span> <span class="s2">"h1"</span><span class="p">,</span> <span class="ss">text: </span><span class="s2">"Articles"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The test should see that there is an <code class="language-plaintext highlighter-rouge">h1</code> on the articles index page and pass.</p>

<p>Run the system tests.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test</span>:system
</code></pre></div></div>

<p>NOTE: By default, running <code class="language-plaintext highlighter-rouge">bin/rails test</code> won’t run your system tests. Make
sure to run <code class="language-plaintext highlighter-rouge">bin/rails test:system</code> to actually run them. You can also run
<code class="language-plaintext highlighter-rouge">bin/rails test:all</code> to run all tests, including system tests.</p>

<h4 id="creating-articles-system-test">Creating Articles System Test</h4>

<p>Now you can test the flow for creating a new article.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"should create Article"</span> <span class="k">do</span>
  <span class="n">visit</span> <span class="n">articles_path</span>

  <span class="n">click_on</span> <span class="s2">"New Article"</span>

  <span class="n">fill_in</span> <span class="s2">"Title"</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"Creating an Article"</span>
  <span class="n">fill_in</span> <span class="s2">"Body"</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"Created this article successfully!"</span>

  <span class="n">click_on</span> <span class="s2">"Create Article"</span>

  <span class="n">assert_text</span> <span class="s2">"Creating an Article"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The first step is to call <code class="language-plaintext highlighter-rouge">visit articles_path</code>. This will take the test to the
articles index page.</p>

<p>Then the <code class="language-plaintext highlighter-rouge">click_on "New Article"</code> will find the “New Article” button on the
index page. This will redirect the browser to <code class="language-plaintext highlighter-rouge">/articles/new</code>.</p>

<p>Then the test will fill in the title and body of the article with the specified
text. Once the fields are filled in, “Create Article” is clicked on which will
send a POST request to <code class="language-plaintext highlighter-rouge">/articles/create</code>.</p>

<p>This redirects the user back to the articles index page, and there it is
asserted that the text from the new article’s title is on the articles index
page.</p>

<h4 id="testing-for-multiple-screen-sizes">Testing for Multiple Screen Sizes</h4>

<p>If you want to test for mobile sizes in addition to testing for desktop, you can
create another class that inherits from <code class="language-plaintext highlighter-rouge">ActionDispatch::SystemTestCase</code> and use
it in your test suite. In this example, a file called
<code class="language-plaintext highlighter-rouge">mobile_system_test_case.rb</code> is created in the <code class="language-plaintext highlighter-rouge">/test</code> directory with the
following configuration.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">MobileSystemTestCase</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using: :chrome</span><span class="p">,</span> <span class="ss">screen_size: </span><span class="p">[</span><span class="mi">375</span><span class="p">,</span> <span class="mi">667</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>To use this configuration, create a test inside <code class="language-plaintext highlighter-rouge">test/system</code> that inherits from
<code class="language-plaintext highlighter-rouge">MobileSystemTestCase</code>. Now you can test your app using multiple different
configurations.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"mobile_system_test_case"</span>

<span class="k">class</span> <span class="nc">PostsTest</span> <span class="o">&lt;</span> <span class="no">MobileSystemTestCase</span>
  <span class="nb">test</span> <span class="s2">"visiting the index"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">posts_url</span>
    <span class="n">assert_selector</span> <span class="s2">"h1"</span><span class="p">,</span> <span class="ss">text: </span><span class="s2">"Posts"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h4 id="capybara-assertions">Capybara Assertions</h4>

<p>Here’s an extract of the assertions provided by
<a href="https://rubydoc.info/github/teamcapybara/capybara/master/Capybara/Minitest/Assertions"><code class="language-plaintext highlighter-rouge">Capybara</code></a>
which can be used in system tests.</p>

<table>
  <thead>
    <tr>
      <th>Assertion</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_button(locator = nil, **options, &amp;optional_filter_block)</code></td>
      <td>Checks if the page has a button with the given text, value or id.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_current_path(string, **options)</code></td>
      <td>Asserts that the page has the given path.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_field(locator = nil, **options, &amp;optional_filter_block)</code></td>
      <td>Checks if the page has a form field with the given label, name or id.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_link(locator = nil, **options, &amp;optional_filter_block)</code></td>
      <td>Checks if the page has a link with the given text or id.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_selector(*args, &amp;optional_filter_block)</code></td>
      <td>Asserts that a given selector is on the page.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_table(locator = nil, **options, &amp;optional_filter_block</code></td>
      <td>Checks if the page has a table with the given id or caption.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_text(type, text, **options)</code></td>
      <td>Asserts that the page has the given text content.</td>
    </tr>
  </tbody>
</table>

<h4 id="screenshot-helper">Screenshot Helper</h4>

<p>The
<a href="https://api.rubyonrails.org/v5.1.7/classes/ActionDispatch/SystemTesting/TestHelpers/ScreenshotHelper.html"><code class="language-plaintext highlighter-rouge">ScreenshotHelper</code></a>
is a helper designed to capture screenshots of your tests. This can be helpful
for viewing the browser at the point a test failed, or to view screenshots later
for debugging.</p>

<p>Two methods are provided: <code class="language-plaintext highlighter-rouge">take_screenshot</code> and <code class="language-plaintext highlighter-rouge">take_failed_screenshot</code>.
<code class="language-plaintext highlighter-rouge">take_failed_screenshot</code> is automatically included in <code class="language-plaintext highlighter-rouge">before_teardown</code> inside
Rails.</p>

<p>The <code class="language-plaintext highlighter-rouge">take_screenshot</code> helper method can be included anywhere in your tests to
take a screenshot of the browser.</p>

<h4 id="taking-it-further">Taking It Further</h4>

<p>System testing is similar to <a href="#integration-testing">integration testing</a> in that
it tests the user’s interaction with your controller, model, and view, but
system testing tests your application as if a real user were using it. With
system tests, you can test anything that a user would do in your application
such as commenting, deleting articles, publishing draft articles, etc.</p>

<h2 id="test-helpers">Test Helpers</h2>

<p>To avoid code duplication, you can add your own test helpers. Here is an example
for signing in:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/test_helper.rb</span>

<span class="k">module</span> <span class="nn">SignInHelper</span>
  <span class="k">def</span> <span class="nf">sign_in_as</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">post</span> <span class="n">sign_in_url</span><span class="p">(</span><span class="ss">email: </span><span class="n">user</span><span class="p">.</span><span class="nf">email</span><span class="p">,</span> <span class="ss">password: </span><span class="n">user</span><span class="p">.</span><span class="nf">password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">ActionDispatch::IntegrationTest</span>
  <span class="kp">include</span> <span class="no">SignInHelper</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ProfileControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"should show profile"</span> <span class="k">do</span>
    <span class="c1"># helper is now reusable from any controller test case</span>
    <span class="n">sign_in_as</span> <span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">)</span>

    <span class="n">get</span> <span class="n">profile_url</span>
    <span class="n">assert_response</span> <span class="ss">:success</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="using-separate-files">Using Separate Files</h3>

<p>If you find your helpers are cluttering <code class="language-plaintext highlighter-rouge">test_helper.rb</code>, you can extract them
into separate files. A good place to store them is <code class="language-plaintext highlighter-rouge">test/lib</code> or
<code class="language-plaintext highlighter-rouge">test/test_helpers</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/test_helpers/multiple_assertions.rb</span>
<span class="k">module</span> <span class="nn">MultipleAssertions</span>
  <span class="k">def</span> <span class="nf">assert_multiple_of_forty_two</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="n">assert</span> <span class="p">(</span><span class="n">number</span> <span class="o">%</span> <span class="mi">42</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">"expected </span><span class="si">#{</span><span class="n">number</span><span class="si">}</span><span class="s2"> to be a multiple of 42"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>These helpers can then be explicitly required and included as needed:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>
<span class="nb">require</span> <span class="s2">"test_helpers/multiple_assertions"</span>

<span class="k">class</span> <span class="nc">NumberTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">MultipleAssertions</span>

  <span class="nb">test</span> <span class="s2">"420 is a multiple of 42"</span> <span class="k">do</span>
    <span class="n">assert_multiple_of_forty_two</span> <span class="mi">420</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>They can also continue to be included directly into the relevant parent classes:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/test_helper.rb</span>
<span class="nb">require</span> <span class="s2">"test_helpers/sign_in_helper"</span>

<span class="k">class</span> <span class="nc">ActionDispatch::IntegrationTest</span>
  <span class="kp">include</span> <span class="no">SignInHelper</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="eagerly-requiring-helpers">Eagerly Requiring Helpers</h3>

<p>You may find it convenient to eagerly require helpers in <code class="language-plaintext highlighter-rouge">test_helper.rb</code> so
your test files have implicit access to them. This can be accomplished using
globbing, as follows</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/test_helper.rb</span>
<span class="no">Dir</span><span class="p">[</span><span class="no">Rails</span><span class="p">.</span><span class="nf">root</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"test"</span><span class="p">,</span> <span class="s2">"test_helpers"</span><span class="p">,</span> <span class="s2">"**"</span><span class="p">,</span> <span class="s2">"*.rb"</span><span class="p">)].</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="nb">require</span> <span class="n">file</span> <span class="p">}</span>
</code></pre></div></div>

<p>This has the downside of increasing the boot-up time, as opposed to manually
requiring only the necessary files in your individual tests.</p>

<h2 id="testing-routes">Testing Routes</h2>

<p>Like everything else in your Rails application, you can test your routes. Route
tests are stored in <code class="language-plaintext highlighter-rouge">test/controllers/</code> or are part of controller tests. If your
application has complex routes, Rails provides a number of useful helpers to
test them.</p>

<p>For more information on routing assertions available in Rails, see the API
documentation for
<a href="https://api.rubyonrails.org/classes/ActionDispatch/Assertions/RoutingAssertions.html"><code class="language-plaintext highlighter-rouge">ActionDispatch::Assertions::RoutingAssertions</code></a>.</p>

<h2 id="testing-views">Testing Views</h2>

<p>Testing the response to your request by asserting the presence of key HTML
elements and their content is one way to test the views of your application.
Like route tests, view tests are stored in <code class="language-plaintext highlighter-rouge">test/controllers/</code> or are part of
controller tests.</p>

<h3 id="querying-the-html">Querying the HTML</h3>

<p>Methods like <code class="language-plaintext highlighter-rouge">assert_dom</code> and <code class="language-plaintext highlighter-rouge">assert_dom_equal</code> allow you to query HTML
elements of the response by using a simple yet powerful syntax.</p>

<p><code class="language-plaintext highlighter-rouge">assert_dom</code> is an assertion that will return true if matching elements are
found. For example, you could verify that the page title is “Welcome to the
Rails Testing Guide” as follows:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">assert_dom</span> <span class="s2">"title"</span><span class="p">,</span> <span class="s2">"Welcome to the Rails Testing Guide"</span>
</code></pre></div></div>

<p>You can also use nested <code class="language-plaintext highlighter-rouge">assert_dom</code> blocks for deeper investigation.</p>

<p>In the following example, the inner <code class="language-plaintext highlighter-rouge">assert_dom</code> for <code class="language-plaintext highlighter-rouge">li.menu_item</code> runs within
the collection of elements selected by the outer block:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">assert_dom</span> <span class="s2">"ul.navigation"</span> <span class="k">do</span>
  <span class="n">assert_dom</span> <span class="s2">"li.menu_item"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>A collection of selected elements may also be iterated through so that
<code class="language-plaintext highlighter-rouge">assert_dom</code> may be called separately for each element. For example, if the
response contains two ordered lists, each with four nested list elements then
the following tests will both pass.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">assert_dom</span> <span class="s2">"ol"</span> <span class="k">do</span> <span class="o">|</span><span class="n">elements</span><span class="o">|</span>
  <span class="n">elements</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">element</span><span class="o">|</span>
    <span class="n">assert_dom</span> <span class="n">element</span><span class="p">,</span> <span class="s2">"li"</span><span class="p">,</span> <span class="mi">4</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">assert_dom</span> <span class="s2">"ol"</span> <span class="k">do</span>
  <span class="n">assert_dom</span> <span class="s2">"li"</span><span class="p">,</span> <span class="mi">8</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">assert_dom_equal</code> method compares two HTML strings to see if they are
equal:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">assert_dom_equal</span> <span class="s1">'&lt;a href="http://www.further-reading.com"&gt;Read more&lt;/a&gt;'</span><span class="p">,</span>
  <span class="n">link_to</span><span class="p">(</span><span class="s2">"Read more"</span><span class="p">,</span> <span class="s2">"http://www.further-reading.com"</span><span class="p">)</span>
</code></pre></div></div>

<p>For more advanced usage, refer to the <a href="https://github.com/rails/rails-dom-testing"><code class="language-plaintext highlighter-rouge">rails-dom-testing</code>
documentation</a>.</p>

<p>In order to integrate with <a href="https://github.com/rails/rails-dom-testing">rails-dom-testing</a>, tests that inherit from
<code class="language-plaintext highlighter-rouge">ActionView::TestCase</code> declare a <code class="language-plaintext highlighter-rouge">document_root_element</code> method that returns the
rendered content as an instance of a
<a href="https://www.rubydoc.info/github/sparklemotion/nokogiri/Nokogiri/XML/Node">Nokogiri::XML::Node</a>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"renders a link to itself"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">title: </span><span class="s2">"Hello, world"</span>

  <span class="n">render</span> <span class="s2">"articles/article"</span><span class="p">,</span> <span class="ss">article: </span><span class="n">article</span>
  <span class="n">anchor</span> <span class="o">=</span> <span class="n">document_root_element</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="s2">"a"</span><span class="p">)</span>

  <span class="n">assert_equal</span> <span class="n">article</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">anchor</span><span class="p">.</span><span class="nf">text</span>
  <span class="n">assert_equal</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">),</span> <span class="n">anchor</span><span class="p">[</span><span class="s2">"href"</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If your application depends on <a href="https://github.com/sparklemotion/nokogiri/releases/tag/v1.14.0">Nokogiri &gt;=
1.14.0</a> or
higher, and <a href="https://github.com/minitest/minitest/blob/v5.18.0/History.rdoc#5180--2023-03-04-">minitest &gt;=
5.18.0</a>,
<code class="language-plaintext highlighter-rouge">document_root_element</code> supports <a href="https://docs.ruby-lang.org/en/master/syntax/pattern_matching_rdoc.html">Ruby’s Pattern
Matching</a>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"renders a link to itself"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">title: </span><span class="s2">"Hello, world"</span>

  <span class="n">render</span> <span class="s2">"articles/article"</span><span class="p">,</span> <span class="ss">article: </span><span class="n">article</span>
  <span class="n">anchor</span> <span class="o">=</span> <span class="n">document_root_element</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="s2">"a"</span><span class="p">)</span>
  <span class="n">url</span> <span class="o">=</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>

  <span class="n">assert_pattern</span> <span class="k">do</span>
    <span class="n">anchor</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">content: </span><span class="s2">"Hello, world"</span><span class="p">,</span> <span class="ss">attributes: </span><span class="p">[{</span> <span class="ss">name: </span><span class="s2">"href"</span><span class="p">,</span> <span class="ss">value: </span><span class="n">url</span> <span class="p">}]</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you’d like to access the same <a href="https://rubydoc.info/github/teamcapybara/capybara/master/Capybara/Minitest/Assertions">Capybara-powered
Assertions</a>
that your <a href="#system-testing">System Testing</a> tests utilize, you can define a base
class that inherits from <code class="language-plaintext highlighter-rouge">ActionView::TestCase</code> and transforms the
<code class="language-plaintext highlighter-rouge">document_root_element</code> into a <code class="language-plaintext highlighter-rouge">page</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/view_partial_test_case.rb</span>

<span class="nb">require</span> <span class="s2">"test_helper"</span>
<span class="nb">require</span> <span class="s2">"capybara/minitest"</span>

<span class="k">class</span> <span class="nc">ViewPartialTestCase</span> <span class="o">&lt;</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">Capybara</span><span class="o">::</span><span class="no">Minitest</span><span class="o">::</span><span class="no">Assertions</span>

  <span class="k">def</span> <span class="nf">page</span>
    <span class="no">Capybara</span><span class="p">.</span><span class="nf">string</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c1"># test/views/article_partial_test.rb</span>

<span class="nb">require</span> <span class="s2">"view_partial_test_case"</span>

<span class="k">class</span> <span class="nc">ArticlePartialTest</span> <span class="o">&lt;</span> <span class="no">ViewPartialTestCase</span>
  <span class="nb">test</span> <span class="s2">"renders a link to itself"</span> <span class="k">do</span>
    <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">title: </span><span class="s2">"Hello, world"</span>

    <span class="n">render</span> <span class="s2">"articles/article"</span><span class="p">,</span> <span class="ss">article: </span><span class="n">article</span>

    <span class="n">assert_link</span> <span class="n">article</span><span class="p">.</span><span class="nf">title</span><span class="p">,</span> <span class="ss">href: </span><span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>More information about the assertions included by Capybara can be found in the
<a href="#capybara-assertions">Capybara Assertions</a> section.</p>

<h3 id="parsing-view-content">Parsing View Content</h3>

<p>Starting in Action View version 7.1, the <code class="language-plaintext highlighter-rouge">rendered</code> helper method returns an
object capable of parsing the view partial’s rendered content.</p>

<p>To transform the <code class="language-plaintext highlighter-rouge">String</code> content returned by the <code class="language-plaintext highlighter-rouge">rendered</code> method into an
object, define a parser by calling
<a href="https://api.rubyonrails.org/classes/ActionView/TestCase/Behavior/ClassMethods.html#method-i-register_parser"><code class="language-plaintext highlighter-rouge">register_parser</code></a>.
Calling <code class="language-plaintext highlighter-rouge">register_parser :rss</code> defines a <code class="language-plaintext highlighter-rouge">rendered.rss</code> helper method. For
example, to parse rendered <a href="https://www.rssboard.org/rss-specification">RSS content</a> into an object with <code class="language-plaintext highlighter-rouge">rendered.rss</code>,
register a call to <code class="language-plaintext highlighter-rouge">RSS::Parser.parse</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">register_parser</span> <span class="ss">:rss</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="n">rendered</span> <span class="p">{</span> <span class="no">RSS</span><span class="o">::</span><span class="no">Parser</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span> <span class="p">}</span>

<span class="nb">test</span> <span class="s2">"renders RSS"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Hello, world"</span><span class="p">)</span>

  <span class="n">render</span> <span class="ss">formats: :rss</span><span class="p">,</span> <span class="ss">partial: </span><span class="n">article</span>

  <span class="n">assert_equal</span> <span class="s2">"Hello, world"</span><span class="p">,</span> <span class="n">rendered</span><span class="p">.</span><span class="nf">rss</span><span class="p">.</span><span class="nf">items</span><span class="p">.</span><span class="nf">last</span><span class="p">.</span><span class="nf">title</span>
<span class="k">end</span>
</code></pre></div></div>

<p>By default, <code class="language-plaintext highlighter-rouge">ActionView::TestCase</code> defines a parser for:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">:html</code> - returns an instance of
<a href="https://nokogiri.org/rdoc/Nokogiri/XML/Node.html">Nokogiri::XML::Node</a></li>
  <li><code class="language-plaintext highlighter-rouge">:json</code> - returns an instance of
<a href="https://api.rubyonrails.org/classes/ActiveSupport/HashWithIndifferentAccess.html">ActiveSupport::HashWithIndifferentAccess</a></li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"renders HTML"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Hello, world"</span><span class="p">)</span>

  <span class="n">render</span> <span class="ss">partial: </span><span class="s2">"articles/article"</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">article: </span><span class="n">article</span> <span class="p">}</span>

  <span class="n">assert_pattern</span> <span class="p">{</span> <span class="n">rendered</span><span class="p">.</span><span class="nf">html</span><span class="p">.</span><span class="nf">at</span><span class="p">(</span><span class="s2">"main h1"</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">content: </span><span class="s2">"Hello, world"</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>

<span class="nb">test</span> <span class="s2">"renders JSON"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span><span class="p">(</span><span class="ss">title: </span><span class="s2">"Hello, world"</span><span class="p">)</span>

  <span class="n">render</span> <span class="ss">formats: :json</span><span class="p">,</span> <span class="ss">partial: </span><span class="s2">"articles/article"</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">article: </span><span class="n">article</span> <span class="p">}</span>

  <span class="n">assert_pattern</span> <span class="p">{</span> <span class="n">rendered</span><span class="p">.</span><span class="nf">json</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">title: </span><span class="s2">"Hello, world"</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="additional-view-based-assertions">Additional View-Based Assertions</h3>

<p>There are more assertions that are primarily used in testing views:</p>

<table>
  <thead>
    <tr>
      <th>Assertion</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_dom_email</code></td>
      <td>Allows you to make assertions on the body of an e-mail.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assert_dom_encoded</code></td>
      <td>Allows you to make assertions on encoded HTML. It does this by un-encoding the contents of each element and then calling the block with all the un-encoded elements.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">css_select(selector)</code> or <code class="language-plaintext highlighter-rouge">css_select(element, selector)</code></td>
      <td>Returns an array of all the elements selected by the <em>selector</em>. In the second variant it first matches the base <em>element</em> and tries to match the <em>selector</em> expression on any of its children. If there are no matches both variants return an empty array.</td>
    </tr>
  </tbody>
</table>

<p>Here’s an example of using <code class="language-plaintext highlighter-rouge">assert_dom_email</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">assert_dom_email</span> <span class="k">do</span>
  <span class="n">assert_dom</span> <span class="s2">"small"</span><span class="p">,</span> <span class="s2">"Please click the 'Unsubscribe' link if you want to opt-out."</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="testing-view-partials">Testing View Partials</h3>

<p><a href="layouts_and_rendering.html#using-partials">Partial</a> templates - usually called
“partials” - can break the rendering process into more manageable chunks. With
partials, you can extract sections of code from your views to separate files and
reuse them in multiple places.</p>

<p>View tests provide an opportunity to test that partials render content the way
you expect. View partial tests can be stored in <code class="language-plaintext highlighter-rouge">test/views/</code> and inherit from
<code class="language-plaintext highlighter-rouge">ActionView::TestCase</code>.</p>

<p>To render a partial, call <code class="language-plaintext highlighter-rouge">render</code> like you would in a template. The content is
available through the test-local <code class="language-plaintext highlighter-rouge">rendered</code> method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ArticlePartialTest</span> <span class="o">&lt;</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"renders a link to itself"</span> <span class="k">do</span>
    <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">title: </span><span class="s2">"Hello, world"</span>

    <span class="n">render</span> <span class="s2">"articles/article"</span><span class="p">,</span> <span class="ss">article: </span><span class="n">article</span>

    <span class="n">assert_includes</span> <span class="n">rendered</span><span class="p">,</span> <span class="n">article</span><span class="p">.</span><span class="nf">title</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Tests that inherit from <code class="language-plaintext highlighter-rouge">ActionView::TestCase</code> also have access to
<a href="#testing-views"><code class="language-plaintext highlighter-rouge">assert_dom</code></a> and the <a href="#additional-view-based-assertions">other additional view-based
assertions</a> provided by
<a href="https://github.com/rails/rails-dom-testing">rails-dom-testing</a>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"renders a link to itself"</span> <span class="k">do</span>
  <span class="n">article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">create!</span> <span class="ss">title: </span><span class="s2">"Hello, world"</span>

  <span class="n">render</span> <span class="s2">"articles/article"</span><span class="p">,</span> <span class="ss">article: </span><span class="n">article</span>

  <span class="n">assert_dom</span> <span class="s2">"a[href=?]"</span><span class="p">,</span> <span class="n">article_url</span><span class="p">(</span><span class="n">article</span><span class="p">),</span> <span class="ss">text: </span><span class="n">article</span><span class="p">.</span><span class="nf">title</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="testing-view-helpers">Testing View Helpers</h3>

<p>A helper is a module where you can define methods which are available in your
views.</p>

<p>In order to test helpers, all you need to do is check that the output of the
helper method matches what you’d expect. Tests related to the helpers are
located under the <code class="language-plaintext highlighter-rouge">test/helpers</code> directory.</p>

<p>Given we have the following helper:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">UsersHelper</span>
  <span class="k">def</span> <span class="nf">link_to_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">link_to</span> <span class="s2">"</span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">last_name</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We can test the output of this method like this:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UsersHelperTest</span> <span class="o">&lt;</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"should return the user's full name"</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">users</span><span class="p">(</span><span class="ss">:david</span><span class="p">)</span>

    <span class="n">assert_dom_equal</span> <span class="sx">%{&lt;a href="/user/</span><span class="si">#{</span><span class="n">user</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="sx">"&gt;David Heinemeier Hansson&lt;/a&gt;}</span><span class="p">,</span> <span class="n">link_to_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Moreover, since the test class extends from <code class="language-plaintext highlighter-rouge">ActionView::TestCase</code>, you have
access to Rails’ helper methods such as <code class="language-plaintext highlighter-rouge">link_to</code> or <code class="language-plaintext highlighter-rouge">pluralize</code>.</p>

<h2 id="testing-mailers">Testing Mailers</h2>

<p>Your mailer classes - like every other part of your Rails application - should
be tested to ensure that they are working as expected.</p>

<p>The goals of testing your mailer classes are to ensure that:</p>

<ul>
  <li>emails are being processed (created and sent)</li>
  <li>the email content is correct (subject, sender, body, etc)</li>
  <li>the right emails are being sent at the right times</li>
</ul>

<p>There are two aspects of testing your mailer, the unit tests and the functional
tests. In the unit tests, you run the mailer in isolation with tightly
controlled inputs and compare the output to a known value (a
<a href="#fixtures">fixture</a>). In the functional tests you don’t so much test the
details produced by the mailer; instead, you test that the controllers and
models are using the mailer in the right way. You test to prove that the right
email was sent at the right time.</p>

<h3 id="unit-testing">Unit Testing</h3>

<p>In order to test that your mailer is working as expected, you can use unit tests
to compare the actual results of the mailer with pre-written examples of what
should be produced.</p>

<h4 id="mailer-fixtures">Mailer Fixtures</h4>

<p>For the purposes of unit testing a mailer, fixtures are used to provide an
example of how the output <em>should</em> look. Because these are example emails, and
not Active Record data like the other fixtures, they are kept in their own
subdirectory apart from the other fixtures. The name of the directory within
<code class="language-plaintext highlighter-rouge">test/fixtures</code> directly corresponds to the name of the mailer. So, for a mailer
named <code class="language-plaintext highlighter-rouge">UserMailer</code>, the fixtures should reside in <code class="language-plaintext highlighter-rouge">test/fixtures/user_mailer</code>
directory.</p>

<p>If you generated your mailer, the generator does not create stub fixtures for
the mailers actions. You’ll have to create those files yourself as described
above.</p>

<h4 id="the-basic-test-case">The Basic Test Case</h4>

<p>Here’s a unit test to test a mailer named <code class="language-plaintext highlighter-rouge">UserMailer</code> whose action <code class="language-plaintext highlighter-rouge">invite</code> is
used to send an invitation to a friend:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"invite"</span> <span class="k">do</span>
    <span class="c1"># Create the email and store it for further assertions</span>
    <span class="n">email</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="p">.</span><span class="nf">create_invite</span><span class="p">(</span><span class="s2">"me@example.com"</span><span class="p">,</span>
                                     <span class="s2">"friend@example.com"</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>

    <span class="c1"># Send the email, then test that it got queued</span>
    <span class="n">assert_emails</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">email</span><span class="p">.</span><span class="nf">deliver_now</span>
    <span class="k">end</span>

    <span class="c1"># Test the body of the sent email contains what we expect it to</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="s2">"me@example.com"</span><span class="p">],</span> <span class="n">email</span><span class="p">.</span><span class="nf">from</span>
    <span class="n">assert_equal</span> <span class="p">[</span><span class="s2">"friend@example.com"</span><span class="p">],</span> <span class="n">email</span><span class="p">.</span><span class="nf">to</span>
    <span class="n">assert_equal</span> <span class="s2">"You have been invited by me@example.com"</span><span class="p">,</span> <span class="n">email</span><span class="p">.</span><span class="nf">subject</span>
    <span class="n">assert_equal</span> <span class="n">read_fixture</span><span class="p">(</span><span class="s2">"invite"</span><span class="p">).</span><span class="nf">join</span><span class="p">,</span> <span class="n">email</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">to_s</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>In the test the email is created and the returned object is stored in the
<code class="language-plaintext highlighter-rouge">email</code> variable. The first assert checks it was sent, then, in the second batch
of assertions, the email contents are checked. The helper <code class="language-plaintext highlighter-rouge">read_fixture</code> is used
to read in the content from this file.</p>

<p>NOTE: <code class="language-plaintext highlighter-rouge">email.body.to_s</code> is present when there’s only one (HTML or text) part
present. If the mailer provides both, you can test your fixture against specific
parts with <code class="language-plaintext highlighter-rouge">email.text_part.body.to_s</code> or <code class="language-plaintext highlighter-rouge">email.html_part.body.to_s</code>.</p>

<p>Here’s the content of the <code class="language-plaintext highlighter-rouge">invite</code> fixture:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hi friend@example.com,

You have been invited.

Cheers!
</code></pre></div></div>

<h4 id="configuring-the-delivery-method-for-test">Configuring the Delivery Method for Test</h4>

<p>The line <code class="language-plaintext highlighter-rouge">ActionMailer::Base.delivery_method = :test</code> in
<code class="language-plaintext highlighter-rouge">config/environments/test.rb</code> sets the delivery method to test mode so that the
email will not actually be delivered (useful to avoid spamming your users while
testing). Instead, the email will be appended to an array
(<code class="language-plaintext highlighter-rouge">ActionMailer::Base.deliveries</code>).</p>

<p>NOTE: The <code class="language-plaintext highlighter-rouge">ActionMailer::Base.deliveries</code> array is only reset automatically in
<code class="language-plaintext highlighter-rouge">ActionMailer::TestCase</code> and <code class="language-plaintext highlighter-rouge">ActionDispatch::IntegrationTest</code> tests. If you
want to have a clean slate outside these test cases, you can reset it manually
with: <code class="language-plaintext highlighter-rouge">ActionMailer::Base.deliveries.clear</code></p>

<h4 id="testing-enqueued-emails">Testing Enqueued Emails</h4>

<p>You can use the <code class="language-plaintext highlighter-rouge">assert_enqueued_email_with</code> assertion to confirm that the email
has been enqueued with all of the expected mailer method arguments and/or
parameterized mailer parameters. This allows you to match any emails that have
been enqueued with the <code class="language-plaintext highlighter-rouge">deliver_later</code> method.</p>

<p>As with the basic test case, we create the email and store the returned object
in the <code class="language-plaintext highlighter-rouge">email</code> variable. The following examples include variations of passing
arguments and/or parameters.</p>

<p>This example will assert that the email has been enqueued with the correct
arguments:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"invite"</span> <span class="k">do</span>
    <span class="c1"># Create the email and store it for further assertions</span>
    <span class="n">email</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="p">.</span><span class="nf">create_invite</span><span class="p">(</span><span class="s2">"me@example.com"</span><span class="p">,</span> <span class="s2">"friend@example.com"</span><span class="p">)</span>

    <span class="c1"># Test that the email got enqueued with the correct arguments</span>
    <span class="n">assert_enqueued_email_with</span> <span class="no">UserMailer</span><span class="p">,</span> <span class="ss">:create_invite</span><span class="p">,</span> <span class="ss">args: </span><span class="p">[</span><span class="s2">"me@example.com"</span><span class="p">,</span> <span class="s2">"friend@example.com"</span><span class="p">]</span> <span class="k">do</span>
      <span class="n">email</span><span class="p">.</span><span class="nf">deliver_later</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This example will assert that a mailer has been enqueued with the correct mailer
method named arguments by passing a hash of the arguments as <code class="language-plaintext highlighter-rouge">args</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"invite"</span> <span class="k">do</span>
    <span class="c1"># Create the email and store it for further assertions</span>
    <span class="n">email</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="p">.</span><span class="nf">create_invite</span><span class="p">(</span><span class="ss">from: </span><span class="s2">"me@example.com"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"friend@example.com"</span><span class="p">)</span>

    <span class="c1"># Test that the email got enqueued with the correct named arguments</span>
    <span class="n">assert_enqueued_email_with</span> <span class="no">UserMailer</span><span class="p">,</span> <span class="ss">:create_invite</span><span class="p">,</span>
    <span class="ss">args: </span><span class="p">[{</span> <span class="ss">from: </span><span class="s2">"me@example.com"</span><span class="p">,</span> <span class="ss">to: </span><span class="s2">"friend@example.com"</span> <span class="p">}]</span> <span class="k">do</span>
      <span class="n">email</span><span class="p">.</span><span class="nf">deliver_later</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This example will assert that a parameterized mailer has been enqueued with the
correct parameters and arguments. The mailer parameters are passed as <code class="language-plaintext highlighter-rouge">params</code>
and the mailer method arguments as <code class="language-plaintext highlighter-rouge">args</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"invite"</span> <span class="k">do</span>
    <span class="c1"># Create the email and store it for further assertions</span>
    <span class="n">email</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">all: </span><span class="s2">"good"</span><span class="p">).</span><span class="nf">create_invite</span><span class="p">(</span><span class="s2">"me@example.com"</span><span class="p">,</span> <span class="s2">"friend@example.com"</span><span class="p">)</span>

    <span class="c1"># Test that the email got enqueued with the correct mailer parameters and arguments</span>
    <span class="n">assert_enqueued_email_with</span> <span class="no">UserMailer</span><span class="p">,</span> <span class="ss">:create_invite</span><span class="p">,</span>
    <span class="ss">params: </span><span class="p">{</span> <span class="ss">all: </span><span class="s2">"good"</span> <span class="p">},</span> <span class="ss">args: </span><span class="p">[</span><span class="s2">"me@example.com"</span><span class="p">,</span> <span class="s2">"friend@example.com"</span><span class="p">]</span> <span class="k">do</span>
      <span class="n">email</span><span class="p">.</span><span class="nf">deliver_later</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This example shows an alternative way to test that a parameterized mailer has
been enqueued with the correct parameters:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UserMailerTest</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"invite"</span> <span class="k">do</span>
    <span class="c1"># Create the email and store it for further assertions</span>
    <span class="n">email</span> <span class="o">=</span> <span class="no">UserMailer</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">to: </span><span class="s2">"friend@example.com"</span><span class="p">).</span><span class="nf">create_invite</span>

    <span class="c1"># Test that the email got enqueued with the correct mailer parameters</span>
    <span class="n">assert_enqueued_email_with</span> <span class="no">UserMailer</span><span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="ss">to: </span><span class="s2">"friend@example.com"</span><span class="p">),</span> <span class="ss">:create_invite</span> <span class="k">do</span>
      <span class="n">email</span><span class="p">.</span><span class="nf">deliver_later</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="functional-and-system-testing">Functional and System Testing</h3>

<p>Unit testing allows us to test the attributes of the email while functional and
system testing allows us to test whether user interactions appropriately trigger
the email to be delivered. For example, you can check that the invite friend
operation is sending an email appropriately:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Integration Test</span>
<span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UsersControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">IntegrationTest</span>
  <span class="nb">test</span> <span class="s2">"invite friend"</span> <span class="k">do</span>
    <span class="c1"># Asserts the difference in the ActionMailer::Base.deliveries</span>
    <span class="n">assert_emails</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">post</span> <span class="n">invite_friend_url</span><span class="p">,</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">email: </span><span class="s2">"friend@example.com"</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># System Test</span>
<span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">UsersTest</span> <span class="o">&lt;</span> <span class="no">ActionDispatch</span><span class="o">::</span><span class="no">SystemTestCase</span>
  <span class="n">driven_by</span> <span class="ss">:selenium</span><span class="p">,</span> <span class="ss">using: :headless_chrome</span>

  <span class="nb">test</span> <span class="s2">"inviting a friend"</span> <span class="k">do</span>
    <span class="n">visit</span> <span class="n">invite_users_url</span>
    <span class="n">fill_in</span> <span class="s2">"Email"</span><span class="p">,</span> <span class="ss">with: </span><span class="s2">"friend@example.com"</span>
    <span class="n">assert_emails</span> <span class="mi">1</span> <span class="k">do</span>
      <span class="n">click_on</span> <span class="s2">"Invite"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>NOTE: The <code class="language-plaintext highlighter-rouge">assert_emails</code> method is not tied to a particular deliver method and
will work with emails delivered with either the <code class="language-plaintext highlighter-rouge">deliver_now</code> or <code class="language-plaintext highlighter-rouge">deliver_later</code>
method. If we explicitly want to assert that the email has been enqueued we can
use the <code class="language-plaintext highlighter-rouge">assert_enqueued_email_with</code> (<a href="#testing-enqueued-emails">examples
above</a>) or <code class="language-plaintext highlighter-rouge">assert_enqueued_emails</code> methods. More
information can be found in the
<a href="https://api.rubyonrails.org/classes/ActionMailer/TestHelper.html">documentation</a>.</p>

<h2 id="testing-jobs">Testing Jobs</h2>

<p>Jobs can be tested in isolation (focusing on the job’s behavior) and in context
(focusing on the calling code’s behavior).</p>

<h3 id="testing-jobs-in-isolation">Testing Jobs in Isolation</h3>

<p>When you generate a job, an associated test file will also be generated in the
<code class="language-plaintext highlighter-rouge">test/jobs</code> directory.</p>

<p>Here is a test you could write for a billing job:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">BillingJobTest</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"account is charged"</span> <span class="k">do</span>
    <span class="n">perform_enqueued_jobs</span> <span class="k">do</span>
      <span class="no">BillingJob</span><span class="p">.</span><span class="nf">perform_later</span><span class="p">(</span><span class="n">account</span><span class="p">,</span> <span class="n">product</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">assert</span> <span class="n">account</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">charged_for?</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The default queue adapter for tests will not perform jobs until
[<code class="language-plaintext highlighter-rouge">perform_enqueued_jobs</code>][] is called. Additionally, it will clear all jobs
before each test is run so that tests do not interfere with each other.</p>

<p>The test uses <code class="language-plaintext highlighter-rouge">perform_enqueued_jobs</code> and [<code class="language-plaintext highlighter-rouge">perform_later</code>][] instead of
[<code class="language-plaintext highlighter-rouge">perform_now</code>][] so that if retries are configured, retry failures are caught
by the test instead of being re-enqueued and ignored.</p>

<p>[<code class="language-plaintext highlighter-rouge">perform_enqueued_jobs</code>]:
    https://api.rubyonrails.org/classes/ActiveJob/TestHelper.html#method-i-perform_enqueued_jobs
[<code class="language-plaintext highlighter-rouge">perform_later</code>]:
    https://api.rubyonrails.org/classes/ActiveJob/Enqueuing/ClassMethods.html#method-i-perform_later
[<code class="language-plaintext highlighter-rouge">perform_now</code>]:
    https://api.rubyonrails.org/classes/ActiveJob/Execution/ClassMethods.html#method-i-perform_now</p>

<h3 id="testing-jobs-in-context">Testing Jobs in Context</h3>

<p>It’s good practice to test that jobs are correctly enqueued, for example, by a
controller action. The [<code class="language-plaintext highlighter-rouge">ActiveJob::TestHelper</code>][] module provides several
methods that can help with this, such as [<code class="language-plaintext highlighter-rouge">assert_enqueued_with</code>][].</p>

<p>Here is an example that tests an account model method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">AccountTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">TestHelper</span>

  <span class="nb">test</span> <span class="s2">"#charge_for enqueues billing job"</span> <span class="k">do</span>
    <span class="n">assert_enqueued_with</span><span class="p">(</span><span class="ss">job: </span><span class="no">BillingJob</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">account</span><span class="p">.</span><span class="nf">charge_for</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">assert_not</span> <span class="n">account</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">charged_for?</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>

    <span class="n">perform_enqueued_jobs</span>

    <span class="n">assert</span> <span class="n">account</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">charged_for?</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>[<code class="language-plaintext highlighter-rouge">ActiveJob::TestHelper</code>]:
    https://api.rubyonrails.org/classes/ActiveJob/TestHelper.html
[<code class="language-plaintext highlighter-rouge">assert_enqueued_with</code>]:
    https://api.rubyonrails.org/classes/ActiveJob/TestHelper.html#method-i-assert_enqueued_with</p>

<h3 id="testing-that-exceptions-are-raised">Testing that Exceptions are Raised</h3>

<p>Testing that your job raises an exception in certain cases can be tricky,
especially when you have retries configured. The <code class="language-plaintext highlighter-rouge">perform_enqueued_jobs</code> helper
fails any test where a job raises an exception, so to have the test succeed when
the exception is raised you have to call the job’s <code class="language-plaintext highlighter-rouge">perform</code> method directly.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">BillingJobTest</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"does not charge accounts with insufficient funds"</span> <span class="k">do</span>
    <span class="n">assert_raises</span><span class="p">(</span><span class="no">InsufficientFundsError</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">BillingJob</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">empty_account</span><span class="p">,</span> <span class="n">product</span><span class="p">).</span><span class="nf">perform</span>
    <span class="k">end</span>
    <span class="n">assert_not</span> <span class="n">account</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">charged_for?</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This method is not recommended in general, as it circumvents some parts of the
framework, such as argument serialization.</p>

<h2 id="testing-action-cable">Testing Action Cable</h2>

<p>Since Action Cable is used at different levels inside your application, you’ll
need to test both the channels, connection classes themselves, and that other
entities broadcast correct messages.</p>

<h3 id="connection-test-case">Connection Test Case</h3>

<p>By default, when you generate a new Rails application with Action Cable, a test
for the base connection class (<code class="language-plaintext highlighter-rouge">ApplicationCable::Connection</code>) is generated as
well under <code class="language-plaintext highlighter-rouge">test/channels/application_cable</code> directory.</p>

<p>Connection tests aim to check whether a connection’s identifiers get assigned
properly or that any improper connection requests are rejected. Here is an
example:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ApplicationCable::ConnectionTest</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Connection</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"connects with params"</span> <span class="k">do</span>
    <span class="c1"># Simulate a connection opening by calling the `connect` method</span>
    <span class="n">connect</span> <span class="ss">params: </span><span class="p">{</span> <span class="ss">user_id: </span><span class="mi">42</span> <span class="p">}</span>

    <span class="c1"># You can access the Connection object via `connection` in tests</span>
    <span class="n">assert_equal</span> <span class="n">connection</span><span class="p">.</span><span class="nf">user_id</span><span class="p">,</span> <span class="s2">"42"</span>
  <span class="k">end</span>

  <span class="nb">test</span> <span class="s2">"rejects connection without params"</span> <span class="k">do</span>
    <span class="c1"># Use `assert_reject_connection` matcher to verify that</span>
    <span class="c1"># connection is rejected</span>
    <span class="n">assert_reject_connection</span> <span class="p">{</span> <span class="n">connect</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>You can also specify request cookies the same way you do in integration tests:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">test</span> <span class="s2">"connects with cookies"</span> <span class="k">do</span>
  <span class="n">cookies</span><span class="p">.</span><span class="nf">signed</span><span class="p">[</span><span class="ss">:user_id</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"42"</span>

  <span class="n">connect</span>

  <span class="n">assert_equal</span> <span class="n">connection</span><span class="p">.</span><span class="nf">user_id</span><span class="p">,</span> <span class="s2">"42"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>See the API documentation for
<a href="https://api.rubyonrails.org/classes/ActionCable/Connection/TestCase.html"><code class="language-plaintext highlighter-rouge">ActionCable::Connection::TestCase</code></a>
for more information.</p>

<h3 id="channel-test-case">Channel Test Case</h3>

<p>By default, when you generate a channel, an associated test will be generated as
well under the <code class="language-plaintext highlighter-rouge">test/channels</code> directory. Here’s an example test with a chat
channel:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ChatChannelTest</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Channel</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"subscribes and stream for room"</span> <span class="k">do</span>
    <span class="c1"># Simulate a subscription creation by calling `subscribe`</span>
    <span class="n">subscribe</span> <span class="ss">room: </span><span class="s2">"15"</span>

    <span class="c1"># You can access the Channel object via `subscription` in tests</span>
    <span class="n">assert</span> <span class="n">subscription</span><span class="p">.</span><span class="nf">confirmed?</span>
    <span class="n">assert_has_stream</span> <span class="s2">"chat_15"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This test is pretty simple and only asserts that the channel subscribes the
connection to a particular stream.</p>

<p>You can also specify the underlying connection identifiers. Here’s an example
test with a web notifications channel:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">WebNotificationsChannelTest</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">Channel</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"subscribes and stream for user"</span> <span class="k">do</span>
    <span class="n">stub_connection</span> <span class="ss">current_user: </span><span class="n">users</span><span class="p">(</span><span class="ss">:john</span><span class="p">)</span>

    <span class="n">subscribe</span>

    <span class="n">assert_has_stream_for</span> <span class="n">users</span><span class="p">(</span><span class="ss">:john</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>See the API documentation for
<a href="https://api.rubyonrails.org/classes/ActionCable/Channel/TestCase.html"><code class="language-plaintext highlighter-rouge">ActionCable::Channel::TestCase</code></a>
for more information.</p>

<h3 id="custom-assertions-and-testing-broadcasts-inside-other-components">Custom Assertions And Testing Broadcasts Inside Other Components</h3>

<p>Action Cable ships with a bunch of custom assertions that can be used to lessen
the verbosity of tests. For a full list of available assertions, see the API
documentation for
<a href="https://api.rubyonrails.org/classes/ActionCable/TestHelper.html"><code class="language-plaintext highlighter-rouge">ActionCable::TestHelper</code></a>.</p>

<p>It’s a good practice to ensure that the correct message has been broadcasted
inside other components (e.g. inside your controllers). This is precisely where
the custom assertions provided by Action Cable are pretty useful. For instance,
within a model:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ProductTest</span> <span class="o">&lt;</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"broadcast status after charge"</span> <span class="k">do</span>
    <span class="n">assert_broadcast_on</span><span class="p">(</span><span class="s2">"products:</span><span class="si">#{</span><span class="n">product</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="ss">type: </span><span class="s2">"charged"</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">product</span><span class="p">.</span><span class="nf">charge</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you want to test the broadcasting made with <code class="language-plaintext highlighter-rouge">Channel.broadcast_to</code>, you
should use <code class="language-plaintext highlighter-rouge">Channel.broadcasting_for</code> to generate an underlying stream name:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/jobs/chat_relay_job.rb</span>
<span class="k">class</span> <span class="nc">ChatRelayJob</span> <span class="o">&lt;</span> <span class="no">ApplicationJob</span>
  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="no">ChatChannel</span><span class="p">.</span><span class="nf">broadcast_to</span> <span class="n">room</span><span class="p">,</span> <span class="ss">text: </span><span class="n">message</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># test/jobs/chat_relay_job_test.rb</span>
<span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ChatRelayJobTest</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="kp">include</span> <span class="no">ActionCable</span><span class="o">::</span><span class="no">TestHelper</span>

  <span class="nb">test</span> <span class="s2">"broadcast message to room"</span> <span class="k">do</span>
    <span class="n">room</span> <span class="o">=</span> <span class="n">rooms</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span>

    <span class="n">assert_broadcast_on</span><span class="p">(</span><span class="no">ChatChannel</span><span class="p">.</span><span class="nf">broadcasting_for</span><span class="p">(</span><span class="n">room</span><span class="p">),</span> <span class="ss">text: </span><span class="s2">"Hi!"</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">ChatRelayJob</span><span class="p">.</span><span class="nf">perform_now</span><span class="p">(</span><span class="n">room</span><span class="p">,</span> <span class="s2">"Hi!"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="running-tests-in-continuous-integration-ci">Running tests in Continuous Integration (CI)</h2>

<p>Continuous Integration (CI) is a development practice where changes are
frequently integrated into the main codebase, and as such, are automatically
tested before merge.</p>

<p>To run all tests in a CI environment, there’s just one command you need:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>bin/rails <span class="nb">test</span>
</code></pre></div></div>

<p>If you are using <a href="#system-testing">System Tests</a>, <code class="language-plaintext highlighter-rouge">bin/rails test</code> will not run
them, since they can be slow. To also run them, add another CI step that runs
<code class="language-plaintext highlighter-rouge">bin/rails test:system</code>, or change your first step to <code class="language-plaintext highlighter-rouge">bin/rails test:all</code>,
which runs all tests including system tests.</p>

<h2 id="parallel-testing">Parallel Testing</h2>

<p>Running tests in parallel reduces the time it takes your entire test suite to
run. While forking processes is the default method, threading is supported as
well.</p>

<h3 id="parallel-testing-with-processes">Parallel Testing with Processes</h3>

<p>The default parallelization method is to fork processes using Ruby’s DRb system.
The processes are forked based on the number of workers provided. The default
number is the actual core count on the machine, but can be changed by the number
passed to the <code class="language-plaintext highlighter-rouge">parallelize</code> method.</p>

<p>To enable parallelization add the following to your <code class="language-plaintext highlighter-rouge">test_helper.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="n">parallelize</span><span class="p">(</span><span class="ss">workers: </span><span class="mi">2</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The number of workers passed is the number of times the process will be forked.
You may want to parallelize your local test suite differently from your CI, so
an environment variable is provided to be able to easily change the number of
workers a test run should use:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ PARALLEL_WORKERS</span><span class="o">=</span>15 bin/rails <span class="nb">test</span>
</code></pre></div></div>

<p>When parallelizing tests, Active Record automatically handles creating a
database and loading the schema into the database for each process. The
databases will be suffixed with the number corresponding to the worker. For
example, if you have 2 workers the tests will create <code class="language-plaintext highlighter-rouge">test-database-0</code> and
<code class="language-plaintext highlighter-rouge">test-database-1</code> respectively.</p>

<p>If the number of workers passed is 1 or fewer the processes will not be forked
and the tests will not be parallelized and they will use the original
<code class="language-plaintext highlighter-rouge">test-database</code> database.</p>

<p>Two hooks are provided, one runs when the process is forked, and one runs before
the forked process is closed. These can be useful if your app uses multiple
databases or performs other tasks that depend on the number of workers.</p>

<p>The <code class="language-plaintext highlighter-rouge">parallelize_setup</code> method is called right after the processes are forked.
The <code class="language-plaintext highlighter-rouge">parallelize_teardown</code> method is called right before the processes are
closed.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="n">parallelize_setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">worker</span><span class="o">|</span>
    <span class="c1"># setup databases</span>
  <span class="k">end</span>

  <span class="n">parallelize_teardown</span> <span class="k">do</span> <span class="o">|</span><span class="n">worker</span><span class="o">|</span>
    <span class="c1"># cleanup databases</span>
  <span class="k">end</span>

  <span class="n">parallelize</span><span class="p">(</span><span class="ss">workers: :number_of_processors</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>These methods are not needed or available when using parallel testing with
threads.</p>

<h3 id="parallel-testing-with-threads">Parallel Testing with Threads</h3>

<p>If you prefer using threads or are using JRuby, a threaded parallelization
option is provided. The threaded parallelizer is backed by minitest’s
<code class="language-plaintext highlighter-rouge">Parallel::Executor</code>.</p>

<p>To change the parallelization method to use threads over forks put the following
in your <code class="language-plaintext highlighter-rouge">test_helper.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="n">parallelize</span><span class="p">(</span><span class="ss">workers: :number_of_processors</span><span class="p">,</span> <span class="ss">with: :threads</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Rails applications generated from JRuby or TruffleRuby will automatically
include the <code class="language-plaintext highlighter-rouge">with: :threads</code> option.</p>

<p>NOTE: As in the section above, you can also use the environment variable
<code class="language-plaintext highlighter-rouge">PARALLEL_WORKERS</code> in this context, to change the number of workers your test
run should use.</p>

<h3 id="testing-parallel-transactions">Testing Parallel Transactions</h3>

<p>When you want to test code that runs parallel database transactions in threads,
those can block each other because they are already nested under the implicit
test transaction.</p>

<p>To workaround this, you can disable transactions in a test case class by setting
<code class="language-plaintext highlighter-rouge">self.use_transactional_tests = false</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">WorkerTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">self</span><span class="p">.</span><span class="nf">use_transactional_tests</span> <span class="o">=</span> <span class="kp">false</span>

  <span class="nb">test</span> <span class="s2">"parallel transactions"</span> <span class="k">do</span>
    <span class="c1"># start some threads that create transactions</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>NOTE: With disabled transactional tests, you have to clean up any data tests
create as changes are not automatically rolled back after the test completes.</p>

<h3 id="threshold-to-parallelize-tests">Threshold to Parallelize tests</h3>

<p>Running tests in parallel adds an overhead in terms of database setup and
fixture loading. Because of this, Rails won’t parallelize executions that
involve fewer than 50 tests.</p>

<p>You can configure this threshold in your <code class="language-plaintext highlighter-rouge">test.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">active_support</span><span class="p">.</span><span class="nf">test_parallelization_threshold</span> <span class="o">=</span> <span class="mi">100</span>
</code></pre></div></div>

<p>And also when setting up parallelization at the test case level:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ActiveSupport::TestCase</span>
  <span class="n">parallelize</span> <span class="ss">threshold: </span><span class="mi">100</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="testing-eager-loading">Testing Eager Loading</h2>

<p>Normally, applications do not eager load in the <code class="language-plaintext highlighter-rouge">development</code> or <code class="language-plaintext highlighter-rouge">test</code>
environments to speed things up. But they do in the <code class="language-plaintext highlighter-rouge">production</code> environment.</p>

<p>If some file in the project cannot be loaded for whatever reason, it is
important to detect it before deploying to production.</p>

<h3 id="continuous-integration">Continuous Integration</h3>

<p>If your project has CI in place, eager loading in CI is an easy way to ensure
the application eager loads.</p>

<p>CIs typically set an environment variable to indicate the test suite is running
there. For example, it could be <code class="language-plaintext highlighter-rouge">CI</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/environments/test.rb</span>
<span class="n">config</span><span class="p">.</span><span class="nf">eager_load</span> <span class="o">=</span> <span class="no">ENV</span><span class="p">[</span><span class="s2">"CI"</span><span class="p">].</span><span class="nf">present?</span>
</code></pre></div></div>

<p>Starting with Rails 7, newly generated applications are configured that way by
default.</p>

<p>If your project does not have continuous integration, you can still eager load
in the test suite by calling <code class="language-plaintext highlighter-rouge">Rails.application.eager_load!</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s2">"test_helper"</span>

<span class="k">class</span> <span class="nc">ZeitwerkComplianceTest</span> <span class="o">&lt;</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">TestCase</span>
  <span class="nb">test</span> <span class="s2">"eager loads all files without errors"</span> <span class="k">do</span>
    <span class="n">assert_nothing_raised</span> <span class="p">{</span> <span class="no">Rails</span><span class="p">.</span><span class="nf">application</span><span class="p">.</span><span class="nf">eager_load!</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="additional-testing-resources">Additional Testing Resources</h2>

<h3 id="errors">Errors</h3>

<p>In system tests, integration tests and functional controller tests, Rails will
attempt to rescue from errors raised and respond with HTML error pages by
default. This behavior can be controlled by the
<a href="/configuring.html#config-action-dispatch-show-exceptions"><code class="language-plaintext highlighter-rouge">config.action_dispatch.show_exceptions</code></a>
configuration.</p>

<h3 id="testing-time-dependent-code">Testing Time-Dependent Code</h3>

<p>Rails provides built-in helper methods that enable you to assert that your
time-sensitive code works as expected.</p>

<p>The following example uses the [<code class="language-plaintext highlighter-rouge">travel_to</code>][travel_to] helper:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Given a user is eligible for gifting a month after they register.</span>
<span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">name: </span><span class="s2">"Gaurish"</span><span class="p">,</span> <span class="ss">activation_date: </span><span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2004</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">))</span>
<span class="n">assert_not</span> <span class="n">user</span><span class="p">.</span><span class="nf">applicable_for_gifting?</span>

<span class="n">travel_to</span> <span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2004</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># Inside the `travel_to` block `Date.current` is stubbed</span>
  <span class="n">assert_equal</span> <span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2004</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="n">user</span><span class="p">.</span><span class="nf">activation_date</span>
  <span class="n">assert</span> <span class="n">user</span><span class="p">.</span><span class="nf">applicable_for_gifting?</span>
<span class="k">end</span>

<span class="c1"># The change was visible only inside the `travel_to` block.</span>
<span class="n">assert_equal</span> <span class="no">Date</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">2004</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="n">user</span><span class="p">.</span><span class="nf">activation_date</span>
</code></pre></div></div>

<p>Please see [<code class="language-plaintext highlighter-rouge">ActiveSupport::Testing::TimeHelpers</code>][time_helpers_api] API
reference for more information about the available time helpers.</p>

<p>[travel_to]:
    https://api.rubyonrails.org/classes/ActiveSupport/Testing/TimeHelpers.html#method-i-travel_to
[time_helpers_api]:
    https://api.rubyonrails.org/classes/ActiveSupport/Testing/TimeHelpers.html</p>

        </div>

        <footer class="guide-footer">
            <div class="feedback">
                <h3>Geri Bildirim</h3>
                <p>Bu kılavuzun kalitesini artırmamıza yardımcı olmak için geri bildirimlerinizi bekliyoruz.</p>
                <p>Lütfen <a href="https://github.com/dilankaya127/rails-tr-TR/issues">GitHub Issues</a> üzerinden katkıda bulunun.</p>
            </div>
        </footer>
    </article>
</div>

<script>
// İçindekiler tablosunu otomatik oluştur
document.addEventListener('DOMContentLoaded', function() {
    const toc = document.getElementById('toc');
    const headings = document.querySelectorAll('.guide-content h2, .guide-content h3, .guide-content h4');
    
    if (headings.length > 0) {
        const tocList = document.createElement('ul');
        
        headings.forEach(function(heading, index) {
            const id = 'heading-' + index;
            heading.id = id;
            
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = '#' + id;
            a.textContent = heading.textContent;
            a.className = 'toc-' + heading.tagName.toLowerCase();
            
            li.appendChild(a);
            tocList.appendChild(li);
        });
        
        toc.appendChild(tocList);
    }
});
</script>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Rails Kılavuzları Türkçe Çevirisi. Gönüllüler tarafından hazırlanmıştır.</p>
            <p>Orijinal dokümantasyon <a href="https://guides.rubyonrails.org">Ruby on Rails</a> ekibine aittir.</p>
        </div>
    </footer>

    <script>hljs.highlightAll();</script>
</body>
</html>